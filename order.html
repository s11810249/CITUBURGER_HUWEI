<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>線上點餐 | 城市漢堡 虎尾光復店</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif; 
            background-color: #F8F9FA; 
            color: #1E293B; 
            letter-spacing: 0px !important; 
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        /* Marquee Animation */
        @keyframes marquee-scroll-wait { 
            0% { transform: translateX(0); } 
            15% { transform: translateX(0); } 
            100% { transform: translateX(-100%); }
        }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-slide-up { animation: slideInUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-bounce-subtle { animation: bounce-subtle 0.2s ease-in-out; }
        @keyframes bounce-subtle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .header-curve {
            border-bottom-left-radius: 2.5rem;
            border-bottom-right-radius: 2.5rem;
        }

        /* Checkbox custom style */
        .custom-checkbox:checked {
            background-color: #5B2274;
            border-color: #5B2274;
        }
        
        /* Ticket style for coupons */
        .coupon-ticket {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), radial-gradient(circle at 100% 50%, transparent 10px, white 11px);
            background-position: 0 0, 0 0;
            background-size: 100% 100%;
            background-repeat: no-repeat;
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #5B2274; }
        input:checked + .slider:before { transform: translateX(20px); }
        
        :root {
            --brand-color: #5B2274;
            --brand-light: #F5EEF8;
        }

        /* Icon 呼吸燈動畫 */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(91, 34, 116, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(91, 34, 116, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(91, 34, 116, 0); }
        }
        
        .status-icon-anim {
            animation: pulse-ring 2s infinite;
        }

        /* 進度條平滑過渡 */
        .progress-bar-fill {
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s;
        }

        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        .body-lock {
            overflow: hidden !important;
            height: 100vh !important;
            touch-action: none;
        }
        .full-width-note {
            width: 100% !important;
            max-width: 100% !important;
        }
        /* 載入畫面 */
        .splash-screen {
            position: fixed;
            inset: 0;
            background-color: #5B2274;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

    </style>
</head>
<body class="select-none">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInWithCredential, OAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, setDoc, updateDoc, enableIndexedDbPersistence, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA9x0gk2zQBJr1vkNLAoBodbBQ3_D2aXag",
            authDomain: "cityburger-huwei.firebaseapp.com",
            projectId: "cityburger-huwei",
            storageBucket: "cityburger-huwei.firebasestorage.app",
            messagingSenderId: "546465207310",
            appId: "1:546465207310:web:4b742f2a3b883dee58585f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        try {
            enableIndexedDbPersistence(db).catch((err) => {});
        } catch (e) { console.warn(e); }
        
        window.db = db;
        window.auth = auth;
        window.signInWithCredential = signInWithCredential;
        window.OAuthProvider = OAuthProvider;
        window.appId = "cityburger-huwei-v1";
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.collection = collection;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.getDocs = getDocs;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useLayoutEffect } = React;
        const BRAND_COLOR = "#5B2274";
        
        // ==========================================
        //  請填入您的 LIFF IDs
        // ==========================================
        // 點餐用 LIFF ID (主選單/訂單模式)
        const LIFF_ID_ORDER = "YOUR_ORDER_LIFF_ID"; 
        // 瀏覽用 LIFF ID (單純瀏覽菜單/非點餐模式)
        const LIFF_ID_BROWSE = "YOUR_BROWSE_LIFF_ID";

        const getOptimizedImage = (url, width = 600) => {
            if (!url) return 'https://placehold.co/400x300?text=No+Image';
            if (url.includes('cloudinary.com')) {
                const parts = url.split('/upload/');
                if (parts.length === 2) {
                    return `${parts[0]}/upload/w_${width},q_auto,f_auto/${parts[1]}`;
                }
            }
            return url;
        };

        const Icon = ({ name, size = 18, className = "", fill = "none" }) => {
            const [iconData, setIconData] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const icon = window.lucide.icons[name] || window.lucide.icons[pascalName] || window.lucide.icons[name.charAt(0).toUpperCase() + name.slice(1)];
                    setIconData(icon || null);
                }
            }, [name]);
            if (!iconData) return <span style={{ width: size, height: size }} className={`inline-block ${className}`}></span>;
            return React.createElement('svg', { 
                xmlns: "http://www.w3.org/2000/svg", 
                width: size, 
                height: size, 
                viewBox: "0 0 24 24", 
                fill: fill, 
                stroke: "currentColor", 
                strokeWidth: "2", 
                strokeLinecap: "round", 
                strokeLinejoin: "round", 
                className 
            }, iconData.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i })));
        };

        const SearchIcon = ({ active }) => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={active ? BRAND_COLOR : "#94A3B8"} strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="transition-colors duration-300">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.3-4.3"></path>
            </svg>
        );

        const TAG_COLORS = {
            red: 'bg-red-500 text-white',
            orange: 'bg-orange-400 text-white',
            green: 'bg-emerald-500 text-white',
            blue: 'bg-blue-500 text-white',
            purple: 'bg-purple-500 text-white',
            black: 'bg-slate-800 text-white'
        };

        const SmartMarquee = ({ announcements }) => {
            const [index, setIndex] = useState(0);
            const [shouldScroll, setShouldScroll] = useState(false);
            const containerRef = useRef(null);
            const textRef = useRef(null);
            const items = useMemo(() => announcements.filter(a => a && a.trim() !== ''), [announcements]);
            const currentText = items[index];

            useEffect(() => { setIndex(0); }, [items.length]);

            const handleNext = () => {
                setIndex((prev) => (prev + 1) % items.length);
                setShouldScroll(false);
            };

            useLayoutEffect(() => {
                if (containerRef.current && textRef.current && currentText) {
                    const containerWidth = containerRef.current.offsetWidth;
                    const textWidth = textRef.current.offsetWidth;
                    if (textWidth > containerWidth) {
                        setShouldScroll(true);
                    } else {
                        setShouldScroll(false);
                        const timer = setTimeout(handleNext, 4000);
                        return () => clearTimeout(timer);
                    }
                }
            }, [index, currentText]);

            useEffect(() => {
                if (items.length === 0 || !shouldScroll) return;
                const container = containerRef.current;
                const text = textRef.current;
                if (!container || !text) return;

                text.style.transform = 'translateX(0)';
                text.style.opacity = '0';
                const fadeIn = text.animate([{ opacity: 0 }, { opacity: 1 }], { duration: 500, fill: 'forwards' });

                fadeIn.onfinish = () => {
                    const containerWidth = container.offsetWidth;
                    const textWidth = text.offsetWidth;
                    const distance = textWidth - containerWidth;
                    if (distance > 0) {
                        const speed = 40;
                        const scrollDuration = (distance / speed) * 1000;
                        const waitStart = 2000;
                        const waitEnd = 2000;
                        const totalDuration = waitStart + scrollDuration + waitEnd;
                        const scrollAnim = text.animate([
                            { transform: 'translateX(0)', offset: 0 },
                            { transform: 'translateX(0)', offset: waitStart / totalDuration }, 
                            { transform: `translateX(-${distance}px)`, offset: (waitStart + scrollDuration) / totalDuration },
                            { transform: `translateX(-${distance}px)`, offset: 1 }
                        ], { duration: totalDuration, fill: 'forwards' });
                        scrollAnim.onfinish = () => {
                            const fadeOut = text.animate([{ opacity: 1 }, { opacity: 0 }], { duration: 500, fill: 'forwards' });
                            fadeOut.onfinish = () => { handleNext(); };
                        };
                    }
                };
                return () => { text.getAnimations().forEach(anim => anim.cancel()); };
            }, [index, items, shouldScroll]);

            if (items.length === 0) return null;

            return (
                <div className="bg-white rounded-xl shadow-lg p-3 flex items-center gap-3 border border-slate-100 mx-6 -mt-5 mb-2 relative z-40 overflow-hidden">
                    <div className="bg-amber-100 p-1.5 rounded-lg text-amber-600 shrink-0 relative z-10"><Icon name="megaphone" size={14} /></div>
                    <div className="flex-1 h-6 relative overflow-hidden flex items-center" ref={containerRef}>
                        <div ref={textRef} className={`whitespace-nowrap text-[15px] font-bold text-slate-700 ${!shouldScroll ? 'animate-fade-in' : ''}`} style={{ willChange: 'transform, opacity' }}>
                            {currentText}
                        </div>
                    </div>
                </div>
            );
        };

        const OrderHistoryItem = ({ order, onOpenDetail }) => {
            const todayStr = new Date().toLocaleString("zh-TW", { timeZone: "Asia/Taipei", year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            const isFuture = order.userInfo.pickupDate > todayStr;
            
            // 狀態文字對應邏輯
            const getStatusLabel = () => {
                if (order.status === 'cancelled') return '訂單已取消';
                if (order.status === 'completed') return '訂單已完成';
                if (order.status === 'ready') return '餐點已完成';
                if (order.status === 'confirmed') return '餐點製作中';
                if (order.status === 'pending') return isFuture ? '預約訂單已成立' : '訂單待店家確認';
                return '處理中';
            };

            const formatTime = (iso) => {
                if(!iso) return "";
                const d = new Date(iso);
                return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            };

            const pickupTimeDisplay = `${order.userInfo.pickupDate.replace(/-/g, '/')} ${order.userInfo.pickupTime === 'ASAP' ? '盡快取餐' : order.userInfo.pickupTime}`;

            return (
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between mb-3">
                    <div className="flex-1 space-y-1">
                        <div className="flex items-center gap-2">
                            <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${
                                ['cancelled'].includes(order.status) ? 'bg-red-50 text-red-500' : 
                                ['completed'].includes(order.status) ? 'bg-slate-100 text-slate-500' : 'bg-purple-50 text-[#5B2274]'
                            }`}>
                                {getStatusLabel()}
                            </span>
                        </div>
                        <p className="text-[11px] font-bold text-slate-400">訂購：{formatTime(order.createdAt)}</p>
                        <p className="text-[11px] font-bold text-slate-400">取餐：{pickupTimeDisplay}</p>
                        <p className="text-sm font-black text-slate-800">金額：${order.totalPrice}</p>
                    </div>
                    <button 
                        onClick={() => onOpenDetail(order)}
                        className="ml-4 px-4 py-2 bg-slate-50 text-[#5B2274] border border-purple-100 rounded-xl font-bold text-xs active:scale-95 transition-transform"
                    >
                        查看詳情
                    </button>
                </div>
            );
        };
        
        const OrderDetailModal = ({ order, onClose, onReorder, onCancel }) => {
            if (!order) return null;

            const todayStr = new Date().toLocaleString("zh-TW", { timeZone: "Asia/Taipei", year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            const isFuture = order.userInfo.pickupDate > todayStr;

            // --- 視覺配置表 (對應你提供的模板) ---
            const getStatusConfig = () => {
                switch (order.status) {
                    case 'cancelled':
                        return { title: '訂單已取消', desc: '很抱歉，此訂單已被取消。如有疑問請直接致電店家。', icon: 'CircleX', color: 'text-red-500', bg: 'bg-red-100', bar: '#9CA3AF', width: '100%', anim: false };
                    case 'completed':
                        return { title: '訂單已完成', desc: '感謝您的訂購，期待再次為您服務！', icon: 'CheckCircle', color: 'text-blue-600', bg: 'bg-blue-100', bar: '#2563EB', width: '100%', anim: false };
                    case 'ready':
                        return { title: '餐點已完成', desc: '您的餐點已準備好，請前往櫃台取餐。', icon: 'ShoppingBag', color: 'text-green-500', bg: 'bg-green-100', bar: '#10B981', width: '100%', anim: true };
                    case 'confirmed':
                        return { title: '餐點製作中', desc: '廚房正在精心製作您的餐點，香氣四溢！', icon: 'Flame', color: 'text-orange-500', bg: 'bg-orange-100', bar: '#F97316', width: '60%', anim: true };
                    case 'pending':
                    default:
                        return isFuture 
                            ? { title: '預約訂單已成立', desc: '店家已收到預約，將於指定時間開始製作餐點。', icon: 'Clock', color: 'text-teal-600', bg: 'bg-teal-100', bar: '#0D9488', width: '5%', anim: false }
                            : { title: '訂單待店家確認', desc: '店家正在確認您的訂單內容，請稍候。', icon: 'ClipboardList', color: 'text-[#5B2274]', bg: 'bg-purple-100', bar: '#5B2274', width: '15%', anim: false };
                }
            };

            const config = getStatusConfig();
            const formatTime = (iso) => {
                if(!iso) return "-";
                const d = new Date(iso);
                return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            };

            return (
                <div className="fixed inset-0 bg-[#F3F4F6] z-[100] flex flex-col animate-fade-in overflow-hidden">
                    {/* [導航欄] */}
                    <nav className="bg-white shadow-sm shrink-0">
                        <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
                            <button onClick={onClose} className="text-gray-600 active:scale-90 transition-transform">
                                <Icon name="ArrowLeft" size={24} />
                            </button>
                            <h1 className="text-lg font-bold text-gray-800">訂單進度</h1>
                            <div className="w-6"></div>
                        </div>
                    </nav>

                    <div className="flex-1 overflow-y-auto no-scrollbar">
                        <div className="max-w-md mx-auto pb-10">
                            
                            {/* [區塊 1] 狀態展示 (動態變更區域) */}
                            <div className="bg-white p-6 mb-2 rounded-b-3xl shadow-sm relative overflow-hidden text-center">
                                <div className="absolute -top-10 -right-10 w-32 h-32 bg-purple-50 rounded-full opacity-50"></div>
                                
                                <div className={`w-20 h-20 mx-auto ${config.bg} rounded-full flex items-center justify-center mb-4 transition-all duration-300 ${config.anim ? 'status-icon-anim' : ''}`}>
                                    <Icon name={config.icon} size={32} className={config.color} />
                                </div>

                                <h2 className={`text-2xl font-bold mb-1 ${order.status === 'cancelled' ? 'text-red-600' : 'text-gray-800'}`}>{config.title}</h2>
                                <p className="text-gray-500 text-sm mb-6 px-4">{config.desc}</p>

                                {/* 進度條 */}
                                <div className="w-full bg-gray-200 rounded-full h-2.5 mb-2 overflow-hidden">
                                    <div className="h-full rounded-full progress-bar-fill" style={{ width: config.width, backgroundColor: config.bar }}></div>
                                </div>
                                
                                {order.status !== 'cancelled' && (
                                    <div className="flex justify-between text-xs text-gray-400 font-medium px-1">
                                        <span>確認中</span>
                                        <span>準備中</span>
                                        <span>可取餐</span>
                                    </div>
                                )}
                            </div>

                            {/* [區塊 2] 店家資訊卡 */}
                            <div className="mx-4 mt-4 bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">
                                        <Icon name="Store" size={20} />
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-gray-800 text-sm">城市漢堡 虎尾光復店</h3>
                                        <p className="text-xs text-gray-500">訂單編號 #{order.orderId}</p>
                                    </div>
                                </div>
                                <a href={`tel:${window.settings?.phone || '056323111'}`} className="w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-[#5B2274]">
                                    <Icon name="Phone" size={16} />
                                </a>
                            </div>

                            {/* [區塊 3] 訂單明細 */}
                            <div className="mx-4 mt-4 mb-4 bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 border-b border-gray-100 pb-2 flex items-center gap-2">
                                    <Icon name="Utensils" size={18} className="text-[#5B2274]" /> 餐點明細
                                </h3>
                                
                                {order.items.map((item, i) => (
                                    <div key={i} className="flex items-start gap-3 mb-4">
                                        <div className="bg-gray-100 px-2 py-1 rounded text-xs font-bold text-gray-600 h-fit">{item.qty}x</div>
                                        <div className="flex-1">
                                            <div className="flex justify-between items-start">
                                                <span className="font-bold text-gray-800 text-sm">{item.name} {item.variantName && `(${item.variantName})`}</span>
                                                <span className="font-bold text-gray-800 text-sm">${item.totalPrice}</span>
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1 space-y-0.5 font-medium">
                                                {item.addons?.length > 0 && <p className="text-purple-600">附餐：{item.addons.map(a => a.name).join(' / ')}</p>}
                                                {item.sideGroups && Object.values(item.sideGroups).map((side, sIdx) => (
                                                    <p key={sIdx}>• {side.name} {side.variantName && `(${side.variantName})`} {side.addons?.length > 0 && ` [${side.addons.map(a=>a.name).join('/')}]`}</p>
                                                ))}
                                                {item.set && (
                                                    <div className="mt-1 text-[#5B2274] bg-purple-50 p-2 rounded-lg">
                                                        <p className="font-bold text-[11px]">套餐：{item.set.name}</p>
                                                        {Object.values(item.setChoices || {}).map((choice, cIdx) => (
                                                            <p key={cIdx} className="ml-2 text-[10px]">• {choice.name} {choice.variantName && `(${choice.variantName})`}</p>
                                                        ))}
                                                    </div>
                                                )}
                                                {item.note && <p className="text-orange-500 italic">備註：{item.note}</p>}
                                            </div>
                                        </div>
                                    </div>
                                ))}

                                <hr className="border-dashed border-gray-200 my-4" />

                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between text-gray-600">
                                        <span>小計</span>
                                        <span>${order.originalPrice || order.totalPrice}</span>
                                    </div>
                                    {order.discountAmount > 0 && (
                                        <div className="flex justify-between text-red-500 font-medium">
                                            <div className="flex items-center gap-1"><Icon name="Ticket" size={14} /><span>折扣優惠 ({order.discountApplied === 'loyalty' ? '集點卡' : '優惠券'})</span></div>
                                            <span>-${order.discountAmount}</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between text-gray-800 font-bold text-lg mt-2 pt-2 border-t border-gray-100">
                                        <span>總金額</span>
                                        <span className="text-[#5B2274]">${order.totalPrice}</span>
                                    </div>
                                </div>
                            </div>

                            {/* [區塊 4] 底部動作欄 */}
                            <div className="mx-4 mt-6">
                                {(['completed', 'cancelled'].includes(order.status)) ? (
                                    <button onClick={() => { onReorder(order); onClose(); }} className="w-full py-3.5 rounded-xl font-bold text-white shadow-lg bg-[#5B2274] active:scale-95 transition-all flex justify-center items-center gap-2">
                                        <Icon name="RotateCcw" size={20} /> 再次訂購
                                    </button>
                                ) : (
                                    (order.status === 'pending' && isFuture) && (
                                        <button onClick={() => { onCancel(order); onClose(); }} className="w-full py-3.5 rounded-xl font-bold text-white shadow-lg bg-red-500 active:bg-red-600 transition-colors flex justify-center items-center gap-2">
                                            <Icon name="Ban" size={20} /> 取消訂單
                                        </button>
                                    )
                                )}
                            </div>

                            {/* 時間資訊 */}
                            <div className="text-center mt-8 space-y-1">
                                <p className="text-[10px] font-bold text-gray-300 uppercase tracking-widest">Order Details</p>
                                <p className="text-[11px] font-bold text-gray-400">下單時間：{formatTime(order.createdAt)}</p>
                                <p className="text-[11px] font-bold text-gray-400 mb-10">預計取餐：{order.userInfo.pickupDate.replace(/-/g,'/')} {order.userInfo.pickupTime}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        function App() {
            const [settings, setSettings] = useState({ phone: '', address: '', mapsUrl: '', openTime: '06:00', closeTime: '13:30', closedDays: [], statusMode: 'auto', announcements: [], specialDates: [], productTags: [], addonGroups: [] });
            const [categories, setCategories] = useState([]);
            const [lineDisplayName, setLineDisplayName] = useState('');
            const [products, setProducts] = useState([]);
            const [sets, setSets] = useState([]);
            const [addons, setAddons] = useState([]);
            const [materials, setMaterials] = useState([]);
            const [coupons, setCoupons] = useState([]); 
            const [currentView, setCurrentView] = useState('menu'); 
            const [activeCategory, setActiveCategory] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [isSearchActive, setIsSearchActive] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null); 
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [showCartModal, setShowCartModal] = useState(false);
            const [showSubmitConfirm, setShowSubmitConfirm] = useState(false); 
            const [selectionModal, setSelectionModal] = useState(null); 
            const [configuringProduct, setConfiguringProduct] = useState(null); 
            const [messageModal, setMessageModal] = useState({ show: false, content: '' });
            const [cancelConfirmModal, setCancelConfirmModal] = useState({ show: false, order: null });
            const [selectedOrderDetail, setSelectedOrderDetail] = useState(null);
            const [favorites, setFavorites] = useState([]);
            const [orderHistory, setOrderHistory] = useState([]);
            const [userInfo, setUserInfo] = useState({ name: '', phone: '', remember: false, contactMethod: 'line' });
            const [pickupDate, setPickupDate] = useState('');
            const [isASAP, setIsASAP] = useState(false);
            const [pickupHour, setPickupHour] = useState('');
            const [pickupMinute, setPickupMinute] = useState('');
            const [myCoupons, setMyCoupons] = useState([]); 
            const [cart, setCart] = useState([]);
            const [selectedCoupon, setSelectedCoupon] = useState(null);
            const [couponInput, setCouponInput] = useState('');
            const [useLoyaltyCard, setUseLoyaltyCard] = useState(false);
            const [editingCartItem, setEditingCartItem] = useState(null); 
            const [itemCount, setItemCount] = useState(1);
            const [selectedVariant, setSelectedVariant] = useState(null);
            const [selectedAddons, setSelectedAddons] = useState([]);
            const [selectedSideGroups, setSelectedSideGroups] = useState({}); 
            const [selectedSet, setSelectedSet] = useState(null);
            const [selectedSetChoices, setSelectedSetChoices] = useState({}); 
            const [itemNote, setItemNote] = useState('');
            const [expandedSetId, setExpandedSetId] = useState(null);
            const [isInitLoading, setIsInitLoading] = useState(true);

            const getTaiwanDate = () => {
                const d = new Date();
                return new Date(d.toLocaleString("en-US", { timeZone: "Asia/Taipei" }));
            };

            // New States for Auth & Mode
            const [currentUser, setCurrentUser] = useState(null);
            const [appMode, setAppMode] = useState('order'); // 'order' or 'browse'

            const categoryRefs = useRef({});
            const menuRef = useRef(null);
            const isClickScroll = useRef(false);

            useEffect(() => {
                const savedFavs = localStorage.getItem('cb_favorites');
                if (savedFavs) setFavorites(JSON.parse(savedFavs));
                const savedHistory = localStorage.getItem('cb_history');
                if (savedHistory) setOrderHistory(JSON.parse(savedHistory));
                const savedUser = localStorage.getItem('cb_user_info');
                if (savedUser) setUserInfo(JSON.parse(savedUser));
                const savedCoupons = localStorage.getItem('cb_my_coupons');
                if (savedCoupons) setMyCoupons(JSON.parse(savedCoupons));
            }, []);

            useEffect(() => { localStorage.setItem('cb_favorites', JSON.stringify(favorites)); }, [favorites]);
            useEffect(() => { localStorage.setItem('cb_my_coupons', JSON.stringify(myCoupons)); }, [myCoupons]);
            
            // ==========================================
            //  LIFF Initialization & Firebase Auth Bridge (修正版)
            // ==========================================
            useEffect(() => {
                // 1. 等待 settings 從 Firestore 載入完成 (必須要有 liffId)
                if (!settings.liffId) return;

                const initLiff = async () => {
                    try {
                        const params = new URLSearchParams(window.location.search);
                        const mode = params.get('mode');
                        setAppMode(mode || 'order');

                        // 2. 從 settings 動態取得 LIFF ID，而非使用寫死的常數
                        const currentLiffId = (mode === 'browse' && settings.liffIdBrowse) 
                            ? settings.liffIdBrowse 
                            : settings.liffId;

                        // 避免重複初始化 (檢查 liff.id 是否已存在)
                        if (window.liff && window.liff.id !== currentLiffId) {
                            await window.liff.init({ liffId: currentLiffId });
                            
                            if (window.liff.isLoggedIn()) {
                                // 取得 LINE 個人資料
                                const profile = await window.liff.getProfile();
                                setLineDisplayName(profile.displayName);

                                // 3. Firebase Bridge: 使用 LINE ID Token 交換 Firebase 憑證
                                const idToken = window.liff.getIDToken();
                                const { auth, signInWithCredential, OAuthProvider } = window;
                                
                                const provider = new OAuthProvider('oidc.line');
                                const credential = provider.credential({
                                    idToken: idToken,
                                });

                                // 登入 Firebase
                                try {
                                    const result = await signInWithCredential(auth, credential);
                                    setCurrentUser(result.user);
                                    console.log("Firebase Auth Success:", result.user.uid);
                                    // 這裡成功後，Firestore 的 request.auth.uid 就會等於這個 uid
                                } catch (authError) {
                                    console.error("Firebase Auth Error:", authError);
                                    showAlert("登入驗證失敗，請重新開啟");
                                }
                            } else {
                                // 如果未登入，且在點餐模式，強制登入
                                if (mode !== 'browse') {
                                    window.liff.login();
                                }
                            }
                        }
                    } catch (err) {
                        console.error('LIFF Init Error:', err);
                    }
                };
                
                initLiff();
            }, [settings.liffId, settings.liffIdBrowse]);

            useEffect(() => {
                const { db, appId, onSnapshot, doc, collection } = window;
                if (!db) return;
                const unsubs = [];
                const sub = (coll, setter) => unsubs.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', coll), snap => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if(coll === 'categories') {
                        list.sort((a,b) => a.sortOrder - b.sortOrder);
                        if(!activeCategory && list.length > 0) setActiveCategory(list[0].id);
                    }
                    if(coll === 'products' || coll === 'sets') list.sort((a,b) => a.sortOrder - b.sortOrder);
                    if(coll === 'materials' || coll === 'addons') list.sort((a,b) => (a.sortOrder||0) - (b.sortOrder||0));
                    setter(list);
                }));

                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), d => { 
                    if (d.exists()) setSettings(d.data()); 
                    else onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), gd => { if(gd.exists()) setSettings(gd.data()); });
                });

                sub('categories', setCategories);
                sub('products', setProducts);
                sub('sets', setSets);
                sub('addons', setAddons);
                sub('materials', setMaterials);
                sub('coupons', setCoupons);

                return () => unsubs.forEach(fn => fn());
            }, []);
            
            // ==========================================
            //  Order History Query (Security Rules Compliant)
            // ==========================================
            useEffect(() => {
                const { db, appId, doc, onSnapshot } = window;
                if (!db || !currentUser) return;
            
                // 監聽該使用者的個人設定文件
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid);
                const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        setUserInfo(prev => ({
                            ...prev,
                            name: userData.savedName || '',    // 載入上次手填的姓名
                            phone: userData.savedPhone || '',
                            contactMethod: userData.contactMethod || 'line',
                            remember: true 
                        }));
                    }
                });
                return () => unsubscribe();
            }, [currentUser]);
            
            useEffect(() => {
                const { db, appId, onSnapshot, collection, query, where } = window;
                
                // Only query if we have a valid authenticated Firebase user
                if(!db || !currentUser) return;

                // Query by customerUid instead of phone number
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'orders'), 
                    where('customerUid', '==', currentUser.uid)
                );
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const liveOrders = snapshot.docs.map(d => ({...d.data(), id: d.id}));
                    setOrderHistory(prev => {
                        // Merge logic to keep local details but update status
                        // Or simply replace if we trust the cloud query fully
                        // Here we'll just use the live list for simplicity and correctness
                        return liveOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    });
                });
                return () => unsubscribe();
            }, [currentUser]); // Dependency updated to currentUser

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const orderIdFromUrl = params.get('id');
                
                // 只有當 categories 載入完成 (代表基礎資料已到) 才進行判斷
                if (categories.length > 0) {
                    if (orderIdFromUrl) {
                        // 嘗試從歷史紀錄找 (如果已登入且有權限)
                        // 若尚未載入完成 orderHistory，這裡可能會先略過，但下方 orderHistory 的 useEffect 會補抓
                        const targetOrder = orderHistory.find(o => o.id === orderIdFromUrl);
                        if (targetOrder) {
                            setSelectedOrderDetail(targetOrder);
                            // 清除網址參數
                            const newUrl = window.location.origin + window.location.pathname;
                            window.history.replaceState(null, '', newUrl);
                        }
                    }
                    // 資料載入完成，關閉 Splash
                    setTimeout(() => setIsInitLoading(false), 800);
                }
            }, [categories, orderHistory]);

            useEffect(() => {
                const isLocked = selectedItem || showCartModal || selectedOrderDetail || showInfoModal || selectionModal || showSubmitConfirm;
                if (isLocked) {
                    document.body.classList.add('body-lock');
                } else {
                    document.body.classList.remove('body-lock');
                }
                return () => document.body.classList.remove('body-lock');
            }, [selectedItem, showCartModal, selectedOrderDetail, showInfoModal, selectionModal, showSubmitConfirm]);

            const showAlert = (msg) => { setMessageModal({ show: true, content: msg }); };
            const dayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];

            const getAvailableDates = () => {
                const dates = [];
                const nowTw = getTaiwanDate(); // 使用剛剛新增的台灣時間工具
                let dayOffset = 0;
                let foundCount = 0;

                // 使用 while 迴圈，直到找到 3 個有營業的日子為止
                // 設定 dayOffset < 14 是為了避免設定錯誤導致無窮迴圈
                while (foundCount < 3 && dayOffset < 14) {
                    const d = new Date(nowTw);
                    d.setDate(nowTw.getDate() + dayOffset);
                    
                    // 格式化成 YYYY-MM-DD
                    const dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                    const dayOfWeek = d.getDay();
                    
                    let isAvailable = true;

                    // 1. 檢查每週固定公休
                    if (settings.closedDays?.includes(dayOfWeek)) isAvailable = false;
                    
                    // 2. 檢查特殊日期設定
                    const special = settings.specialDates?.find(sd => sd.date === dateStr);
                    if (special) {
                        if (special.type === 'closed') isAvailable = false;
                        else if (special.type === 'open') isAvailable = true;
                    }

                    // 3. 如果是「今天」，檢查是否已經超過最後點餐時間
                    if (dayOffset === 0 && isAvailable) {
                        const currentMinutes = nowTw.getHours() * 60 + nowTw.getMinutes();
                        const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                        // 最後點餐時間為打烊前 15 分鐘
                        const lastOrderTime = (eh * 60 + em) - 15;
                        if (currentMinutes > lastOrderTime) isAvailable = false; 
                    }

                    if (isAvailable) {
                        // 產生顯示文字 (今天、明天、日期+星期)
                        let label = "";
                        if (dayOffset === 0) label = `今天 (${d.getMonth()+1}/${d.getDate()})`;
                        else if (dayOffset === 1) label = `明天 (${d.getMonth()+1}/${d.getDate()})`;
                        else label = `${d.getMonth()+1}/${d.getDate()} (${dayNames[dayOfWeek]})`;

                        dates.push({ value: dateStr, label: label });
                        foundCount++;
                    }
                    
                    dayOffset++;
                }
                return dates;
            };

            const checkIsOpenNow = () => {
                const now = new Date();
                const [oh, om] = (settings.openTime || "06:00").split(':').map(Number);
                const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
                return currentTotalMinutes >= (oh * 60 + om) && currentTotalMinutes <= (eh * 60 + em);
            };

            const getAvailableHours = (dateStr) => {
                if (!dateStr) return [];
                const hours = [];
                const [oh, om] = (settings.openTime || "06:00").split(':').map(Number);
                const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                let startH = oh;
                const endH = eh;
                
                // ★ 改用台灣時間
                const now = getTaiwanDate();
                const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                
                const isToday = dateStr === todayStr;
                if (isToday) {
                    const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
                    let nextSlot = currentTotalMinutes + 15;
                    nextSlot = Math.ceil(nextSlot / 5) * 5;
                    startH = Math.floor(nextSlot / 60);
                }
                for (let h = startH; h <= endH; h++) { hours.push(h); }
                return hours;
            };

            const getAvailableMinutes = (dateStr, hour) => {
                if (!dateStr || hour === '') return [];
                const minutes = [];
                const h = parseInt(hour);
                const [oh, om] = (settings.openTime || "06:00").split(':').map(Number);
                const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                
                // ★ 改用台灣時間
                const now = getTaiwanDate();
                const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                
                const isToday = dateStr === todayStr;
                const minTotal = oh * 60 + om + 15;
                const maxTotal = eh * 60 + em - 15;
                for (let m = 0; m < 60; m += 5) {
                    const currentSlotTotal = h * 60 + m;
                    if (currentSlotTotal < minTotal || currentSlotTotal > maxTotal) continue;
                    if (isToday) {
                         const nowTotal = now.getHours() * 60 + now.getMinutes();
                         if (currentSlotTotal < nowTotal + 15) continue;
                    }
                    minutes.push(m);
                }
                return minutes;
            };

            useEffect(() => { if (showCartModal) { const dates = getAvailableDates(); if (dates.length > 0 && !pickupDate) { setPickupDate(dates[0].value); } } }, [showCartModal, settings]);
            useEffect(() => { if (pickupDate) { setPickupHour(''); setPickupMinute(''); } }, [pickupDate]);
            useEffect(() => { if (pickupDate && !isASAP && pickupHour === '') { const hours = getAvailableHours(pickupDate); if (hours.length > 0) { for (let h of hours) { const mins = getAvailableMinutes(pickupDate, h); if (mins.length > 0) { setPickupHour(h); setPickupMinute(mins[0]); break; } } } } }, [pickupDate, isASAP]);

            const getDisplayPrice = (p) => { if (p.variants && p.variants.length > 0) { const prices = p.variants.map(v => v.price); const min = Math.min(...prices); const max = Math.max(...prices); if (min === max) return `$${min}`; return `$${min} 起`; } return `$${p.price}`; };

            const checkAvailability = (product) => {
                const outMaterialIds = materials.filter(m => m.isOut).map(m => m.id);
                if (product.materials && product.materials.some(id => outMaterialIds.includes(id))) return 'all_out'; 
                if (product.variants && product.variants.length > 0) {
                    const availableVariants = product.variants.filter(v => { const vMats = v.materials || []; return !vMats.some(id => outMaterialIds.includes(id)); });
                    if (availableVariants.length === 0) return 'all_out'; 
                    if (availableVariants.length < product.variants.length) return 'partial'; 
                }
                return 'ok';
            };

            const isOpenStatus = useMemo(() => {
                if (settings.statusMode === 'open') return true;
                if (settings.statusMode === 'closed') return false;
                const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Taipei" }));
                const todayStr = now.toISOString().split('T')[0];
                const currentTime = now.getHours() * 60 + now.getMinutes();
                const currentDay = now.getDay(); 
                const special = settings.specialDates?.find(sd => sd.date === todayStr);
                if (special) {
                    if (special.type === 'closed') return false;
                    const [sh, sm] = (settings.openTime || "06:00").split(':').map(Number);
                    const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                    return currentTime >= (sh*60+sm) && currentTime <= (eh*60+em);
                }
                if (settings.closedDays?.includes(currentDay)) return false;
                const [sh, sm] = (settings.openTime || "06:00").split(':').map(Number);
                const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                return currentTime >= (sh*60+sm) && currentTime <= (eh*60+em);
            }, [settings]);

            const filteredMenu = useMemo(() => {
                const term = searchTerm.trim().toLowerCase();
                return categories.map(cat => ({ ...cat, items: products.filter(p => { const matchSearch = !term || p.name.toLowerCase().includes(term); return p.categoryId === cat.id && !p.isHidden && matchSearch; }).sort((a,b) => a.sortOrder - b.sortOrder) })).filter(cat => cat.items.length > 0);
            }, [categories, products, searchTerm]);

            const addCoupon = () => {
                const coupon = coupons.find(c => c.code === couponInput.trim().toUpperCase());
                if (coupon) {
                    if (myCoupons.some(c => c.code === coupon.code)) { showAlert("您已領取過此優惠券"); return; }
                    if (new Date(coupon.expiry) < new Date()) { showAlert("此優惠券已過期"); return; }
                    setMyCoupons([...myCoupons, coupon]);
                    setCouponInput('');
                    showAlert("優惠券領取成功！");
                } else { showAlert("無效的優惠代碼"); }
            };

            const handleOpenSelection = (type, id, categoryId, defaultPrice) => { setSelectionModal({ type, id, categoryId, defaultPrice }); };
            const handleProductSelectInModal = (prod) => {
                if ((!prod.variants || prod.variants.length === 0) && (!prod.allowAddons || prod.allowAddons.length === 0)) {
                    const choice = { id: prod.id, name: prod.name, price: prod.price, variantName: '', addons: [] };
                    if (selectionModal.type === 'side') { setSelectedSideGroups({ ...selectedSideGroups, [selectionModal.id]: choice }); }
                    else { setSelectedSetChoices({ ...selectedSetChoices, [selectionModal.id]: choice }); }
                    setSelectionModal(null);
                } else { 
                    const defaultVariant = (prod.variants && prod.variants.length > 0) ? prod.variants[0] : null;
                    setConfiguringProduct({ product: prod, variant: defaultVariant, addons: [] }); 
                }
            };
            const confirmConfiguration = () => {
                if (!configuringProduct) return;
                const { product, variant, addons: confAddons } = configuringProduct;
                if (product.variants && product.variants.length > 0 && !variant) { showAlert("請選擇規格"); return; }
                const finalPrice = (variant ? variant.price : product.price) + confAddons.reduce((sum, a) => sum + a.price, 0);
                const choice = { id: product.id, name: product.name, price: finalPrice, variantName: variant ? variant.name : '', addons: confAddons };
                if (selectionModal.type === 'side') { setSelectedSideGroups({ ...selectedSideGroups, [selectionModal.id]: choice }); }
                else { setSelectedSetChoices({ ...selectedSetChoices, [selectionModal.id]: choice }); }
                setConfiguringProduct(null);
                setSelectionModal(null);
            };

            const isSameItem = (item1, item2) => {
                if (item1.productId !== item2.productId) return false;
                if (item1.variantName !== item2.variantName) return false;
                if (item1.note?.trim() !== item2.note?.trim()) return false; // 備註不同視為不同商品
                
                // 深度比對 Set (套餐) ID
                if (item1.set?.id !== item2.set?.id) return false;

                // 輔助函式：將物件排序後轉字串比對
                const sortAndStringify = (obj) => {
                    if (!obj) return '';
                    if (Array.isArray(obj)) return JSON.stringify(obj.map(x => x.id).sort());
                    // 針對 SetChoices 或 SideGroups 這種 Key-Value 物件
                    const keys = Object.keys(obj).sort();
                    const simplified = keys.map(k => `${k}:${obj[k].id}:${JSON.stringify(obj[k].addons?.map(a=>a.id).sort())}`);
                    return JSON.stringify(simplified);
                };

                const addons1 = sortAndStringify(item1.addons);
                const addons2 = sortAndStringify(item2.addons);
                if (addons1 !== addons2) return false;

                const sides1 = sortAndStringify(item1.sideGroups);
                const sides2 = sortAndStringify(item2.sideGroups);
                if (sides1 !== sides2) return false;

                const setChoice1 = sortAndStringify(item1.setChoices);
                const setChoice2 = sortAndStringify(item2.setChoices);
                if (setChoice1 !== setChoice2) return false;

                return true;
            };

            const handleAddToCart = () => {
                if (!selectedItem) return;
                let unitPrice = selectedItem.price;
                let variantLabel = '';
                if (selectedItem.variants && selectedItem.variants.length > 0) {
                    if (!selectedVariant) { showAlert('請選擇規格'); return; }
                    unitPrice = selectedVariant.price;
                    variantLabel = selectedVariant.name;
                }
                let addonsTotal = selectedAddons.reduce((sum, ad) => sum + ad.price, 0);
                let sidesTotal = 0;
                selectedItem.sideGroups?.forEach(g => {
                    const choice = selectedSideGroups[g.id];
                    if (choice && g.allowChange && g.defaultProductId) {
                        const defProd = products.find(p => p.id === g.defaultProductId);
                        let defPrice = defProd ? defProd.price : 0;
                        if (defProd && g.defaultVariantName) { const dv = defProd.variants?.find(v => v.name === g.defaultVariantName); if (dv) defPrice = dv.price; }
                        sidesTotal += (choice.price - defPrice);
                    }
                });
                let setTotal = 0;
                if (selectedSet) {
                    setTotal += selectedSet.price;
                    selectedSet.contents?.forEach((c, idx) => {
                         const choice = selectedSetChoices[idx];
                         if (choice && c.type === 'category' && c.allowChange && c.defaultProductId) {
                             const defProd = products.find(p => p.id === c.defaultProductId);
                             let defPrice = defProd ? defProd.price : 0;
                             if (defProd && c.defaultVariantName) { const dv = defProd.variants?.find(v => v.name === c.defaultVariantName); if (dv) defPrice = dv.price; }
                             setTotal += (choice.price - defPrice);
                         }
                    });
                }
                const finalUnitPrice = unitPrice + addonsTotal + sidesTotal + setTotal;
                const newItem = { productId: selectedItem.id, name: selectedItem.name, image: selectedItem.image, variantName: variantLabel, variant: selectedVariant, unitPrice: finalUnitPrice, qty: itemCount, totalPrice: finalUnitPrice * itemCount, addons: selectedAddons, sideGroups: selectedSideGroups, set: selectedSet, setChoices: selectedSetChoices, note: itemNote };
                if (editingCartItem) {
                    const duplicateIndex = cart.findIndex(item => item.id !== editingCartItem.id && isSameItem(item, newItem));
                    if (duplicateIndex > -1) {
                         const newCart = [...cart]; newCart[duplicateIndex].qty += newItem.qty; newCart[duplicateIndex].totalPrice = newCart[duplicateIndex].unitPrice * newCart[duplicateIndex].qty;
                         setCart(newCart.filter(item => item.id !== editingCartItem.id));
                    } else { setCart(cart.map(item => item.id === editingCartItem.id ? { ...newItem, id: editingCartItem.id } : item)); }
                } else {
                    const existingItemIndex = cart.findIndex(item => isSameItem(item, newItem));
                    if (existingItemIndex > -1) { const newCart = [...cart]; newCart[existingItemIndex].qty += newItem.qty; newCart[existingItemIndex].totalPrice = newCart[existingItemIndex].unitPrice * newCart[existingItemIndex].qty; setCart(newCart); } else { setCart([...cart, { ...newItem, id: Date.now() }]); }
                }
                closeProductModal();
            };

            const openEditCartItem = (item) => {
                const prod = products.find(p => p.id === item.productId);
                if (!prod) return;
                setSelectedItem(prod); setItemCount(item.qty); setSelectedVariant(item.variant); setSelectedAddons(item.addons); setSelectedSideGroups(item.sideGroups || {}); setSelectedSet(item.set); setSelectedSetChoices(item.setChoices || {}); if (item.set) setExpandedSetId(item.set.id); setItemNote(item.note); setEditingCartItem(item); setShowCartModal(false); 
            };
            const closeProductModal = () => { setSelectedItem(null); setEditingCartItem(null); setItemCount(1); setSelectedVariant(null); setSelectedAddons([]); setSelectedSideGroups({}); setSelectedSet(null); setSelectedSetChoices({}); setItemNote(''); setExpandedSetId(null); if (editingCartItem) setShowCartModal(true); };
            const updateCartQty = (itemId, change) => { setCart(prevCart => prevCart.map(item => { if (item.id === itemId) { const newQty = Math.max(0, item.qty + change); return { ...item, qty: newQty, totalPrice: item.unitPrice * newQty }; } return item; }).filter(item => item.qty > 0)); };
            const removeFromCart = (itemId) => { setCart(prevCart => prevCart.filter(item => item.id !== itemId)); };
            const toggleFavorite = (e, prodId) => { e.stopPropagation(); if (favorites.includes(prodId)) setFavorites(favorites.filter(id => id !== prodId)); else setFavorites([...favorites, prodId]); };
            
            const reorder = (historyOrder) => {
                const newCartItems = historyOrder.items.map(oldItem => ({ ...oldItem, id: Date.now() + Math.random() }));
                setCart([...cart, ...newCartItems]);
                showAlert('已將訂單內容加入購物車');
                setCurrentView('menu');
            };

            const handlePreSubmit = () => {
                if (!userInfo.name || !userInfo.phone) { showAlert("請填寫姓名與電話"); return; }
                if (!pickupDate) { showAlert("請選擇取餐日期"); return; }
                if (!isASAP && (!pickupHour || !pickupMinute)) { showAlert("請選擇取餐時間"); return; }
                if (cart.length === 0) return;
                if (!currentUser) { showAlert("請先登入 LINE (請在 LINE 中開啟)"); return; }
                
                // 檢查購物車內是否有已售完商品
                const outOfStockItems = [];
                const outMaterialIds = materials.filter(m => m.isOut).map(m => m.id);
                
                cart.forEach(item => {
                    const prod = products.find(p => p.id === item.productId);
                    if (!prod) return;
                    
                    // 檢查主商品
                    if (prod.materials && prod.materials.some(id => outMaterialIds.includes(id))) {
                        outOfStockItems.push(item.name);
                    }
                    // 檢查規格
                    if (item.variant && item.variant.materials && item.variant.materials.some(id => outMaterialIds.includes(id))) {
                        outOfStockItems.push(`${item.name}-${item.variantName}`);
                    }
                    // 這裡可以繼續檢查 Set 或 Sides，但先檢查主體最重要
                });

                if (outOfStockItems.length > 0) {
                    showAlert(`以下商品已售完，請先移除：\n${outOfStockItems.join('、')}`);
                    return;
                }
                setShowSubmitConfirm(true);
            };

            // CREATE FLEX MESSAGE FUNCTION
            const createFlexMessage = (order) => {
                const BRAND_COLOR = "#5B2274";
                const RED_COLOR = "#EF4444";
                const GREEN_COLOR = "#10B981";
                const TEXT_COLOR = "#1E293B";
                const SUB_TEXT_COLOR = "#64748B";

                const safeStr = (val, defaultVal = "-") => {
                    if (val === undefined || val === null) return defaultVal;
                    const s = String(val).trim();
                    return s === "" ? defaultVal : s;
                };
                
                const formatDateTime = (isoString) => {
                    if (!isoString) return "-";
                    try {
                        const d = new Date(isoString);
                        const twDate = new Date(d.toLocaleString("en-US", { timeZone: "Asia/Taipei" }));
                        return `${twDate.getFullYear()}/${String(twDate.getMonth() + 1).padStart(2, '0')}/${String(twDate.getDate()).padStart(2, '0')} ${String(twDate.getHours()).padStart(2, '0')}:${String(twDate.getMinutes()).padStart(2, '0')}`;
                    } catch (e) { return "-"; }
                };
                
                const userInfo = order.userInfo || {};
                const pickupDateDisplay = (safeStr(userInfo.pickupDate, "未設定")).replace(/-/g, '/');
                const pickupTimeDisplay = safeStr(userInfo.pickupTime, "未設定");
                const contactMethodText = userInfo.contactMethod === 'line' ? '優先 LINE 聯絡' : '優先電話聯絡';

                const generateItemRows = () => {
                    if (!Array.isArray(order.items) || order.items.length === 0) {
                        return [{ type: "text", text: "無餐點資料", color: SUB_TEXT_COLOR, align: "center" }];
                    }
                    return order.items.flatMap((item, index) => {
                        const details = [];
                        if (item.variantName) details.push(`規格：${item.variantName}`);
                        if (Array.isArray(item.addons) && item.addons.length > 0) details.push(`客製：${item.addons.map(a => a.name).join('、')}`);
                        if (item.set && item.setChoices) {
                            const setContentStr = Object.values(item.setChoices).map(c => c.name + (c.variantName ? `(${c.variantName})` : "")).join('、');
                            if(setContentStr) details.push(`套餐：${setContentStr}`);
                        }
                        if (item.note) details.push(`備註：${item.note}`);

                        const rows = [
                            {
                                type: "box", layout: "horizontal", margin: index > 0 ? "md" : "none",
                                contents: [
                                    { type: "text", text: `${item.qty} x`, size: "md", color: TEXT_COLOR, flex: 1, weight: "bold" },
                                    { type: "text", text: safeStr(item.name), size: "md", color: TEXT_COLOR, flex: 4, wrap: true, weight: "bold" },
                                    { type: "text", text: `$${item.totalPrice}`, size: "md", color: TEXT_COLOR, flex: 2, align: "end", weight: "bold" }
                                ]
                            }
                        ];

                        if (details.length > 0) {
                            rows.push({
                                type: "box", layout: "vertical", paddingStart: "xxl",
                                contents: details.map((detail, i) => ({
                                    type: "text", text: safeStr(detail), size: "xs", color: SUB_TEXT_COLOR, wrap: true, margin: i > 0 ? "xs" : "none"
                                }))
                            });
                        }
                        if (index < order.items.length - 1) {
                            rows.push({ type: "separator", margin: "md" });
                        }
                        return rows;
                    });
                };

                return {
                    type: "flex",
                    altText: `新訂單通知：${safeStr(userInfo.name, "顧客")}`.replace(/\n/g, " ").trim(),
                    contents: {
                        type: "bubble",
                        body: {
                            type: "box", layout: "vertical",
                            contents: [
                                { type: "text", text: "城市漢堡 虎尾光復店", weight: "bold", color: BRAND_COLOR, size: "md", align: "center" },
                                {
                                    type: "box", layout: "horizontal", justifyContent: "center", alignItems: "center", margin: "md",
                                    contents: [
                                        { type: "text", text: "新訂單通知", size: "xl", color: RED_COLOR, weight: "bold", flex: 0 },
                                        {
                                            type: "box", layout: "vertical", backgroundColor: RED_COLOR, cornerRadius: "md", paddingStart: "lg", paddingEnd: "lg", paddingTop: "xs", paddingBottom: "xs", margin: "md", flex: 0,
                                            contents: [{ type: "text", text: "自取", color: "#ffffff", size: "lg", weight: "bold" }]
                                        }
                                    ]
                                },
                                {
                                    type: "box", layout: "horizontal", justifyContent: "center", margin: "xl",
                                    contents: [{
                                        type: "box", layout: "vertical", backgroundColor: BRAND_COLOR, cornerRadius: "md", paddingAll: "sm", width: "100px",
                                        contents: [{ type: "text", text: "取餐時間", color: "#ffffff", size: "sm", weight: "bold", align: "center" }]
                                    }]
                                },
                                { type: "text", text: safeStr(pickupDateDisplay), size: "xl", weight: "bold", align: "center", margin: "md", color: BRAND_COLOR },
                                { type: "text", text: safeStr(pickupTimeDisplay), size: "4xl", weight: "bold", align: "center", color: BRAND_COLOR },
                                { type: "separator", margin: "xl", color: TEXT_COLOR },
                                { type: "box", layout: "vertical", margin: "lg", spacing: "xs", contents: generateItemRows() },
                                { type: "separator", margin: "lg", color: TEXT_COLOR },
                                { type: "text", text: "訂單總金額", size: "md", weight: "bold", align: "center", color: TEXT_COLOR, margin: "lg" },
                                { type: "text", text: `$${order.totalPrice}`, size: "4xl", weight: "bold", align: "center", color: TEXT_COLOR, margin: "sm" },
                                ...(order.discountAmount > 0 ? [{
                                    type: "box", layout: "horizontal", justifyContent: "center", alignItems: "center", margin: "md",
                                    contents: [
                                        { type: "text", text: "折扣優惠：", size: "md", color: TEXT_COLOR, flex: 0 },
                                        {
                                            type: "box", layout: "vertical", backgroundColor: RED_COLOR, cornerRadius: "md", paddingStart: "sm", paddingEnd: "sm", flex: 0, margin: "sm",
                                            contents: [{ type: "text", text: order.discountApplied === 'loyalty' ? "集點卡" : "優惠券", color: "#ffffff", size: "xs", weight: "bold" }]
                                        },
                                        { type: "text", text: `-$${order.discountAmount}`, color: RED_COLOR, size: "md", weight: "bold", margin: "sm" }
                                    ]
                                }] : []),
                                { type: "separator", margin: "lg", color: TEXT_COLOR },
                                {
                                    type: "box", layout: "baseline", margin: "lg",
                                    contents: [
                                        { type: "text", text: "訂單編號：", size: "sm", color: SUB_TEXT_COLOR, flex: 0 },
                                        { type: "text", text: safeStr(order.orderId), size: "sm", color: TEXT_COLOR, weight: "bold", flex: 1 }
                                    ]
                                },
                                {
                                    type: "box", layout: "baseline", margin: "sm",
                                    contents: [
                                        { type: "text", text: "訂餐時間：", size: "sm", color: SUB_TEXT_COLOR, flex: 0 },
                                        { type: "text", text: formatDateTime(order.createdAt), size: "sm", color: TEXT_COLOR, flex: 1 }
                                    ]
                                },
                                { type: "separator", margin: "lg", color: TEXT_COLOR },
                                {
                                    type: "box", layout: "baseline", margin: "lg",
                                    contents: [
                                        { type: "text", text: "取餐人：", size: "md", color: SUB_TEXT_COLOR, flex: 0 },
                                        { type: "text", text: safeStr(userInfo.name), size: "md", color: TEXT_COLOR, weight: "bold", flex: 1, wrap: true }
                                    ]
                                },
                                {
                                    type: "box", layout: "baseline", margin: "md",
                                    contents: [
                                        { type: "text", text: "連絡電話：", size: "md", color: SUB_TEXT_COLOR, flex: 0 },
                                        { type: "text", text: safeStr(userInfo.phone), size: "md", color: TEXT_COLOR, weight: "bold", flex: 1 }
                                    ]
                                },
                                {
                                    type: "box", layout: "horizontal", margin: "md",
                                    contents: [{
                                        type: "box", layout: "vertical", backgroundColor: GREEN_COLOR, cornerRadius: "md", paddingTop: "xs", paddingBottom: "xs", flex: 1,
                                        contents: [{ type: "text", text: safeStr(contactMethodText), color: "#ffffff", size: "lg", weight: "bold", align: "center" }]
                                    }]
                                }
                            ].filter(Boolean)
                        },
                        footer: {
                            type: "box",
                            layout: "vertical",
                            spacing: "sm",
                            contents: [
                                {
                                    type: "button",
                                    style: "primary",
                                    color: "#5B2274",
                                    height: "sm",
                                    action: {
                                        type: "uri",
                                        label: "查看訂單進度",
                                        uri: `https://liff.line.me/${settings.liffId}?id=${order.id}`
                                    }
                                },
                                {
                                    type: "text",
                                    text: "點擊按鈕可隨時追蹤餐點狀態",
                                    size: "xs",
                                    color: "#BCBCBC",
                                    align: "center",
                                    margin: "sm"
                                }
                            ]
                        }
                    }
                };
            };

            const confirmSubmitOrder = async () => {
                let discountAmount = 0;
                if (useLoyaltyCard) discountAmount = 50;
                else if (selectedCoupon) { if (cartTotal >= selectedCoupon.minSpend) discountAmount = selectedCoupon.discount; }
                const total = Math.max(0, cartTotal - discountAmount);

                const finalTime = isASAP ? "ASAP" : `${pickupHour.toString().padStart(2, '0')}:${pickupMinute.toString().padStart(2, '0')}`;
                const randomId = `OD${Date.now().toString().slice(-6)}`;
                
                const newOrder = { 
                    orderId: randomId, 
                    items: cart, 
                    totalPrice: total, 
                    originalPrice: cartTotal,
                    discountApplied: useLoyaltyCard ? 'loyalty' : (selectedCoupon ? selectedCoupon.code : null), 
                    discountAmount, 
                    userInfo: { ...userInfo, pickupDate, pickupTime: finalTime },
                    customerUid: currentUser ? currentUser.uid : 'guest', 
                    createdAt: new Date().toISOString(), 
                    status: 'pending',
                    read: false
                };

                try {
                    const { db, appId, addDoc, setDoc, doc, collection } = window;

                    if (userInfo.remember && currentUser) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), {
                            savedName: userInfo.name,
                            savedPhone: userInfo.phone,
                            contactMethod: userInfo.contactMethod,
                            lineDisplayName: lineDisplayName,
                            updatedAt: new Date().toISOString()
                        });
                    }
                    localStorage.removeItem('cb_user_info');

                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), newOrder);
                    
                    const orderWithId = { ...newOrder, id: docRef.id };

                    if (appMode === 'order') {
                        if (window.liff && window.liff.isInClient()) {
                            const flexMessage = createFlexMessage(orderWithId);
                            await window.liff.sendMessages([flexMessage])
                                .catch((err) => console.error("LINE訊息傳送失敗", err));
                        }
                    }

                    setCart([]); 
                    setShowCartModal(false); 
                    setUseLoyaltyCard(false); 
                    setSelectedCoupon(null); 
                    setShowSubmitConfirm(false);
                    
                    // 強制切換到歷史紀錄頁面，並開啟該訂單
                    setCurrentView('history');
                    setTimeout(() => {
                        setSelectedOrderDetail({ id: docRef.id });
                    }, 100);

                } catch (e) {
                    console.error("提交訂單失敗:", e);
                    alert("系統錯誤，請洽詢店家: " + e.message);
                }
            };

            const openCancelConfirm = (order) => { setCancelConfirmModal({ show: true, order }); };

            const confirmCancelOrder = async () => {
                if (!cancelConfirmModal.order) return;
                
                const { db, appId, doc, updateDoc } = window;
                
                try {
                    const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', cancelConfirmModal.order.id);
                    
                    await updateDoc(orderRef, { 
                        status: 'cancelled',
                        updatedAt: new Date().toISOString()
                    });

                    setCancelConfirmModal({ show: false, order: null });
                    showAlert("訂單已成功取消");
                    
                } catch (e) {
                    console.error("取消訂單失敗:", e);
                    showAlert("取消失敗：請確認網路連線，或洽詢店家。");
                }
            };

            const cartTotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            const cartCount = cart.reduce((sum, item) => sum + item.qty, 0);
            const finalTotal = Math.max(0, cartTotal - (useLoyaltyCard ? 50 : (selectedCoupon ? selectedCoupon.discount : 0)));

            const getCartItemQty = (prodId) => cart.filter(item => item.productId === prodId).reduce((sum, item) => sum + item.qty, 0);
            
            useEffect(() => { if (currentView !== 'menu') return; const observer = new IntersectionObserver((entries) => { if (isClickScroll.current) return; const visibleSection = entries.find(entry => entry.isIntersecting); if (visibleSection) setActiveCategory(visibleSection.target.id); }, { root: menuRef.current, rootMargin: '-10% 0px -80% 0px', threshold: 0 }); categories.forEach(cat => { if (categoryRefs.current[cat.id]) observer.observe(categoryRefs.current[cat.id]); }); return () => observer.disconnect(); }, [categories, currentView]);

            const getGroupedAddons = (targetAddons) => { const groups = {}; targetAddons.forEach(a => { const cat = a.category || '其他'; if (!groups[cat]) groups[cat] = []; groups[cat].push(a); }); const definedGroups = settings.addonGroups || []; const result = definedGroups.map(dg => ({ name: dg.name, items: (groups[dg.name] || []).sort((a,b) => (a.sortOrder||0) - (b.sortOrder||0)) })).filter(g => g.items.length > 0); const definedNames = definedGroups.map(dg => dg.name); Object.keys(groups).forEach(catName => { if (!definedNames.includes(catName)) { result.push({ name: catName, items: groups[catName].sort((a,b) => (a.sortOrder||0) - (b.sortOrder||0)) }); } }); return result; };
            const groupedItemAddons = useMemo(() => { if (!selectedItem || !selectedItem.allowAddons) return []; const validAddons = addons.filter(a => selectedItem.allowAddons.includes(a.id)); return getGroupedAddons(validAddons); }, [selectedItem, addons, settings.addonGroups]);

            // [修正：白屏問題] 必須在 groupedItemAddons 之後才定義驗證邏輯
            const validateSelection = () => {
                if (!selectedItem) return { valid: false, msg: '' };
                
                // 1. 規格驗證
                if (selectedItem.variants?.length > 0 && !selectedVariant) {
                    return { valid: false, msg: '請選擇規格' };
                }

                // 2. 附餐驗證 (Side Groups) - 強制確認
                if (selectedItem.sideGroups?.length > 0) {
                    for (const group of selectedItem.sideGroups) {
                        if (!selectedSideGroups[group.id]) {
                            return { valid: false, msg: `請選擇 ${group.title || '附餐'}` };
                        }
                    }
                }

                // 3. 套餐驗證 (Set Choices) - 強制確認
                if (selectedSet && selectedSet.contents) {
                    for (let i = 0; i < selectedSet.contents.length; i++) {
                        const content = selectedSet.contents[i];
                        if (content.type === 'category' && !selectedSetChoices[i]) {
                            return { valid: false, msg: `請選擇套餐內的 ${content.label || '品項'}` };
                        }
                    }
                }

                // 4. 客製化驗證 (Addons)
                for (const group of groupedItemAddons) {
                    if (group.isRequired) {
                        const selectedInGroup = selectedAddons.filter(a => group.items.some(gi => gi.id === a.id));
                        if (selectedInGroup.length === 0) return { valid: false, msg: `請選擇 ${group.name}` };
                    }
                }

                return { valid: true, msg: '' };
            };
            
            const selectionStatus = validateSelection();

            const ProductCard = ({ item }) => {
                const availability = checkAvailability(item);
                const isSoldOut = availability === 'all_out';
                const isFav = favorites.includes(item.id);
                const qtyInCart = getCartItemQty(item.id);
                return (
                    <article onClick={() => setSelectedItem(item)} className={`flex items-start gap-4 transition-transform group cursor-pointer ${isSoldOut ? '' : 'active:scale-[0.98]'}`}>
                        <div className="w-24 h-24 rounded-2xl bg-slate-50 overflow-hidden shrink-0 shadow-sm relative aspect-square group-hover:shadow-md transition-all border border-slate-100">
                            <img src={getOptimizedImage(item.image, 300)} className={`w-full h-full object-cover transition-transform duration-500 ${isSoldOut ? 'grayscale opacity-70' : ''}`} loading="lazy" />
                            {isSoldOut && <div className="absolute inset-0 bg-black/10 flex items-center justify-center z-10"><span className="text-white font-black text-xs border-2 border-white px-1.5 py-0.5 rounded -rotate-12 bg-black/40">已售完</span></div>}
                            <div className={`absolute top-1 left-1 flex flex-col gap-0.5 z-20`}>{item.tags?.map(tId => { const tag = settings.productTags?.find(t => t.id === tId); return tag ? <span key={tId} className={`text-[8px] px-1.5 py-0.5 rounded-md font-bold shadow-sm ${TAG_COLORS[tag.color]}`}>{tag.label}</span> : null; })}</div>
                            <button onClick={(e) => toggleFavorite(e, item.id)} className="absolute top-1 right-1 p-1 rounded-full bg-white/80 shadow-sm z-30"><Icon name="heart" size={14} className={isFav ? "fill-red-500 text-red-500" : "text-slate-400"} /></button>
                        </div>
                        <div className={`flex-1 min-w-0 py-1 flex flex-col h-24 justify-between ${isSoldOut ? 'opacity-50' : ''}`}>
                            <div><h3 className="text-[16px] font-bold text-slate-900 truncate pr-2 leading-tight">{item.name}</h3><p className="text-[12px] text-slate-400 truncate mt-1 font-medium">{item.desc}</p></div>
                            <div className="flex justify-between items-end"><div className="flex flex-col"><span className="font-black text-[17px] text-[#5B2274]">{getDisplayPrice(item)}</span></div>{!isSoldOut && (qtyInCart > 0 ? <div className="w-7 h-7 rounded-full bg-[#5B2274] text-white flex items-center justify-center font-bold text-xs shadow-md">{qtyInCart}</div> : <button className="w-7 h-7 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center group-hover:bg-[#5B2274] group-hover:text-white transition-colors"><Icon name="plus" size={16} /></button>)}</div>
                        </div>
                    </article>
                );
            };

            if (isInitLoading) {
                return (
                    <div className="splash-screen">
                        <div className="w-20 h-20 bg-white rounded-2xl flex items-center justify-center mb-4 shadow-xl">
                            <Icon name="Utensils" size={40} className="text-[#5B2274]" />
                        </div>
                        <h1 className="text-2xl font-black tracking-widest animate-pulse">CITY BURGER</h1>
                    </div>
                );
            }
            
            return (
                <div className="h-screen flex flex-col overflow-hidden bg-[#F8F9FA]">
                    <header className="shrink-0 relative z-30 header-curve shadow-xl" style={{ backgroundColor: BRAND_COLOR }}>
                        <div className="px-6 pt-8 pb-10 space-y-5">
                            <div className="flex justify-between items-center">
                                <h1 className="text-2xl font-[900] text-white tracking-tight leading-none drop-shadow-md whitespace-nowrap">城市漢堡 虎尾光復店</h1>
                                <div className="flex items-center gap-2">
                                    <div className={`px-3 py-1.5 rounded-full shadow-lg transition-all flex items-center gap-1.5 ${isOpenStatus ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}`}>
                                        <span className="relative inline-flex rounded-full h-2 w-2 bg-white animate-pulse"></span>
                                        <span className="text-[11px] font-black tracking-wide leading-none pt-0.5">{isOpenStatus ? '營業中' : '休息中'}</span>
                                    </div>
                                    <button onClick={() => setShowInfoModal(true)} className="w-8 h-8 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center text-white active:scale-95 transition-all border border-white/10 hover:bg-white/30"><Icon name="info" size={18} /></button>
                                </div>
                            </div>
                            <div className="flex justify-between items-center text-white/90 text-[13px] font-bold px-1">
                                <a href={settings.mapsUrl || "#"} target="_blank" className="flex items-center gap-1.5 active:opacity-70 hover:text-white transition-opacity max-w-[60%]"><Icon name="map-pin" size={16} className="opacity-80" /><span className="truncate">{settings.address || '載入中...'}</span></a>
                                <a href={`tel:${settings.phone}`} className="flex items-center gap-1.5 active:opacity-70 hover:text-white transition-opacity"><Icon name="phone" size={16} className="opacity-80" />{settings.phone}</a>
                            </div>
                        </div>
                    </header>

                    {currentView === 'menu' && <SmartMarquee announcements={settings.announcements} />}

                    {currentView === 'menu' && (
                        <div className="px-6 mb-2 mt-4 relative z-30">
                             <div className="relative group">
                                <div className="absolute left-4 top-1/2 -translate-y-1/2 transition-colors z-10 pt-1"><SearchIcon active={isSearchActive} /></div>
                                <input type="text" placeholder="想吃點什麼？" className="w-full bg-white rounded-2xl py-3.5 pl-12 pr-4 text-slate-700 placeholder:text-slate-400 font-bold shadow-md border border-slate-100 outline-none focus:ring-0 focus:border-slate-400 transition-all" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} onFocus={() => setIsSearchActive(true)} onBlur={() => setIsSearchActive(false)} />
                            </div>
                        </div>
                    )}

                    {/* [修正：主區域 pb-32] 確保不被底部擋住 */}
                    <div className="flex flex-1 overflow-hidden bg-white mt-1 pb-32 relative">
                        {currentView === 'menu' && (
                            <>
                                <nav className="w-24 bg-slate-50 border-r border-slate-100 overflow-y-auto no-scrollbar shrink-0 pt-2 pb-24">
                                    {filteredMenu.map(cat => (
                                        <button key={cat.id} onClick={() => { isClickScroll.current = true; setActiveCategory(cat.id); categoryRefs.current[cat.id]?.scrollIntoView({ behavior: 'smooth', block: 'start' }); setTimeout(() => isClickScroll.current = false, 800); }} className={`w-full py-5 px-1 text-[13px] font-black text-center relative transition-all duration-300 flex flex-col items-center gap-1.5 ${activeCategory === cat.id ? 'text-[#5B2274] bg-white shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>
                                            {activeCategory === cat.id && <div className="absolute left-0 top-1/2 -translate-y-1/2 h-8 w-1.5 rounded-r-full" style={{ backgroundColor: BRAND_COLOR }}></div>}
                                            <span className="z-10 leading-tight px-1">{cat.name}</span>
                                        </button>
                                    ))}
                                </nav>
                                <main ref={menuRef} className="flex-1 overflow-y-auto p-5 no-scrollbar scroll-smooth bg-white pb-32">
                                    {filteredMenu.map(cat => (
                                        <section key={cat.id} id={cat.id} ref={el => categoryRefs.current[cat.id] = el} className="mb-10">
                                            <div className="flex items-center gap-3 mb-6"><span className="text-lg font-[900] tracking-tight text-slate-800">{cat.name}</span><div className="h-1 w-1 bg-slate-200 rounded-full"></div><div className="h-[1px] bg-slate-100 flex-1"></div></div>
                                            <div className="grid grid-cols-1 gap-6">
                                                {cat.items.map(item => <ProductCard key={item.id} item={item} />)}
                                            </div>
                                        </section>
                                    ))}
                                </main>
                            </>
                        )}
                        {currentView === 'favorites' && (
                            <div className="flex-1 overflow-y-auto p-5 pb-32 no-scrollbar">
                                <h2 className="text-xl font-black text-slate-800 mb-6 flex items-center gap-2"><Icon name="heart" className="text-red-500 fill-red-500" /> 我的收藏</h2>
                                {favorites.length === 0 ? <div className="text-center text-slate-400 mt-20">還沒有收藏任何餐點喔</div> : (
                                    <div className="space-y-8">
                                        {categories.map(cat => {
                                            const favItems = products.filter(p => p.categoryId === cat.id && favorites.includes(p.id));
                                            if (favItems.length === 0) return null;
                                            return (
                                                <section key={cat.id}>
                                                    <div className="flex items-center gap-3 mb-4"><span className="text-lg font-[900] tracking-tight text-slate-800">{cat.name}</span><div className="h-1 w-1 bg-slate-200 rounded-full"></div><div className="h-[1px] bg-slate-100 flex-1"></div></div>
                                                    <div className="grid grid-cols-1 gap-6">{favItems.map(item => <ProductCard key={item.id} item={item} />)}</div>
                                                </section>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}
                        {currentView === 'coupons' && (
                            <div className="flex-1 overflow-y-auto p-5 pb-32">
                                <h2 className="text-xl font-black text-slate-800 mb-6 flex items-center gap-2"><Icon name="ticket" className="text-slate-600" /> 優惠券</h2>
                                <div className="flex gap-2 mb-6">
                                    <input type="text" placeholder="輸入優惠代碼" className="flex-1 bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:border-[#5B2274]" value={couponInput} onChange={e => setCouponInput(e.target.value)} />
                                    <button onClick={addCoupon} className="bg-slate-800 text-white px-4 rounded-xl font-bold text-sm">新增</button>
                                </div>
                                {myCoupons.length === 0 ? <div className="text-center text-slate-400 mt-10">目前沒有優惠券</div> : (
                                    <div className="space-y-4">
                                        {myCoupons.map((coupon, idx) => (
                                            <div key={idx} className="coupon-ticket bg-white p-4 shadow-sm filter drop-shadow-sm flex items-center gap-4 relative overflow-hidden">
                                                <div className="w-16 h-16 bg-purple-50 rounded-lg flex items-center justify-center text-[#5B2274] font-black text-xl shrink-0">${coupon.discount}</div>
                                                <div className="flex-1 min-w-0"><h3 className="font-black text-slate-800">{coupon.title}</h3><p className="text-xs text-slate-500 mt-1">{coupon.desc}</p><p className="text-[10px] text-slate-400 mt-2">有效期至 {coupon.expiry}</p></div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                        {currentView === 'history' && (
                            <div className="flex-1 overflow-y-auto p-5 pb-32 no-scrollbar">
                                <h2 className="text-xl font-black text-slate-800 mb-6 flex items-center gap-2"><Icon name="history" className="text-slate-600" /> 訂單紀錄</h2>
                                
                                {orderHistory.length === 0 ? (
                                    <div className="text-center text-slate-400 mt-20">尚無訂單紀錄</div>
                                ) : (
                                    <div className="space-y-8">
                                        {/* 進行中區塊 */}
                                        {orderHistory.filter(o => !['completed', 'cancelled'].includes(o.status)).length > 0 && (
                                            <section>
                                                <div className="flex items-center gap-3 mb-4">
                                                    <span className="text-sm font-black text-[#5B2274] bg-purple-50 px-3 py-1 rounded-full text-nowrap">進行中訂單</span>
                                                    <div className="h-[1px] bg-purple-100 flex-1"></div>
                                                </div>
                                                {orderHistory
                                                    .filter(o => !['completed', 'cancelled'].includes(o.status))
                                                    .map((order, idx) => (
                                                        <OrderHistoryItem key={idx} order={order} onOpenDetail={setSelectedOrderDetail} />
                                                    ))
                                                }
                                            </section>
                                        )}

                                        {/* 歷史紀錄區塊 */}
                                        {orderHistory.filter(o => ['completed', 'cancelled'].includes(o.status)).length > 0 && (
                                            <section>
                                                <div className="flex items-center gap-3 mb-4">
                                                    <span className="text-sm font-black text-slate-400 bg-slate-50 px-3 py-1 rounded-full text-nowrap">歷史紀錄 (近30天)</span>
                                                    <div className="h-[1px] bg-slate-100 flex-1"></div>
                                                </div>
                                                {orderHistory
                                                    .filter(o => ['completed', 'cancelled'].includes(o.status))
                                                    .filter(o => {
                                                        const orderDate = new Date(o.createdAt);
                                                        const thirtyDaysAgo = new Date();
                                                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                                                        return orderDate >= thirtyDaysAgo;
                                                    })
                                                    .map((order, idx) => (
                                                        <OrderHistoryItem key={idx} order={order} onOpenDetail={setSelectedOrderDetail} />
                                                    ))
                                                }
                                            </section>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* [修正：底部高度與安全區域] 使用 h-75 並居中對齊 */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-[calc(75px+env(safe-area-inset-bottom))] z-50 shadow-[0_-5px_25px_rgba(0,0,0,0.08)] pb-[env(safe-area-inset-bottom)]">
                        <button onClick={() => setCurrentView('menu')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${currentView === 'menu' ? 'text-[#5B2274]' : 'text-slate-400'}`}><Icon name="utensils" size={20} /><span className="text-[10px] font-bold">菜單</span></button>
                        <button onClick={() => setCurrentView('favorites')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${currentView === 'favorites' ? 'text-[#5B2274]' : 'text-slate-400'}`}><Icon name="heart" size={20} className={currentView === 'favorites' ? 'fill-current' : ''} /><span className="text-[10px] font-bold">收藏</span></button>
                        <button onClick={() => setCurrentView('coupons')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${currentView === 'coupons' ? 'text-[#5B2274]' : 'text-slate-400'}`}><Icon name="ticket" size={20} /><span className="text-[10px] font-bold">優惠券</span></button>
                        <button onClick={() => setCurrentView('history')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${currentView === 'history' ? 'text-[#5B2274]' : 'text-slate-400'}`}><Icon name="history" size={20} /><span className="text-[10px] font-bold">紀錄</span></button>
                    </div>

                    {cart.length > 0 && currentView === 'menu' && (
                        <div className="fixed bottom-20 left-4 right-4 z-40 animate-bounce-subtle">
                            <button onClick={() => setShowCartModal(true)} className="w-full bg-[#5B2274] text-white p-4 rounded-2xl shadow-xl flex justify-between items-center hover:bg-[#4a1b5e] transition-colors"><div className="flex items-center gap-3"><div className="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">{cartCount}</div><span className="font-bold text-lg">查看購物車</span></div><span className="font-black text-xl">${cartTotal}</span></button>
                        </div>
                    )}

                    {/* Message Modal */}
                    {messageModal.show && (
                        <div className="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={() => setMessageModal({ show: false, content: '' })}>
                            <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-slide-up text-center relative" onClick={e => e.stopPropagation()}>
                                <div className="mb-4"><div className="w-12 h-12 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center mx-auto mb-2"><Icon name="info" size={24} /></div><p className="text-slate-700 font-bold leading-relaxed">{messageModal.content}</p></div>
                                <button onClick={() => setMessageModal({ show: false, content: '' })} className="w-full py-3 rounded-xl font-bold bg-[#5B2274] text-white shadow-lg active:scale-95 transition-transform">好</button>
                            </div>
                        </div>
                    )}

                    {/* Cancel Confirmation Modal */}
                    {cancelConfirmModal.show && (
                        <div className="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={() => setCancelConfirmModal({ show: false, order: null })}>
                            <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-slide-up text-center relative" onClick={e => e.stopPropagation()}>
                                <div className="mb-4"><div className="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-2"><Icon name="alert-triangle" size={24} /></div><h3 className="text-xl font-[900] text-slate-800 mb-2">確定要取消訂單？</h3><p className="text-sm text-slate-500 font-bold">取消後將無法復原</p></div>
                                <div className="flex gap-3"><button onClick={() => setCancelConfirmModal({ show: false, order: null })} className="flex-1 py-3 rounded-xl font-bold bg-slate-100 text-slate-600 active:scale-95 transition-transform">保留</button><button onClick={confirmCancelOrder} className="flex-1 py-3 rounded-xl font-bold bg-red-500 text-white shadow-lg active:scale-95 transition-transform">確認取消</button></div>
                            </div>
                        </div>
                    )}

                    {/* Selected Item Modal */}
                    {selectedItem && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-end sm:items-center justify-center p-0 sm:p-4 animate-fade-in backdrop-blur-sm" onClick={() => closeProductModal()}>
                            <div className="bg-white w-full max-w-md rounded-t-[40px] sm:rounded-[40px] overflow-hidden shadow-2xl flex flex-col animate-slide-up max-h-[90vh]" onClick={e => e.stopPropagation()}>
                                <div className="relative aspect-[16/9] w-full shrink-0 overflow-hidden bg-slate-100">
                                    <img src={getOptimizedImage(selectedItem.image, 800)} className={`w-full h-full object-cover ${checkAvailability(selectedItem) === 'all_out' ? 'grayscale opacity-50' : ''}`} />
                                    <button onClick={() => closeProductModal()} className="absolute top-4 right-4 bg-black/40 text-white p-2.5 rounded-full backdrop-blur-md active:scale-90 transition-transform z-10"><Icon name="x" size={24} /></button>
                                    {checkAvailability(selectedItem) === 'all_out' && <div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="bg-black/60 text-white text-3xl font-black px-6 py-2 border-4 border-white transform -rotate-6 tracking-widest uppercase">已售完</div></div>}
                                    <div className="absolute top-4 left-4 flex gap-1.5 flex-wrap z-20">{selectedItem.tags?.map(tId => { const tag = settings.productTags?.find(t => t.id === tId); return tag ? <span key={tId} className={`text-xs px-2 py-1 rounded-lg font-bold shadow-sm backdrop-blur-sm ${TAG_COLORS[tag.color]}`}>{tag.label}</span> : null; })}</div>
                                </div>
                                <div className="p-8 space-y-8 overflow-y-auto no-scrollbar bg-white pb-28">
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-start"><h2 className="text-2xl font-black text-slate-900 leading-tight pr-4">{selectedItem.name}</h2><span className="text-2xl font-black text-[#5B2274]">{getDisplayPrice(selectedItem)}</span></div>
                                        {selectedItem.desc && <div className="space-y-1"><p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest">商品內容</p><p className="text-[14px] font-bold leading-relaxed text-slate-600">{selectedItem.desc}</p></div>}
                                        <p className="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded inline-block">※ 圖片僅供參考，餐點以實物為主</p>
                                        {selectedItem.note && checkAvailability(selectedItem) !== 'all_out' && <div className="p-3 bg-orange-50 border border-orange-200 rounded-xl flex gap-2 shadow-sm"><Icon name="info" size={20} className="text-orange-500 shrink-0 mt-0.5" /><p className="text-xs font-bold text-orange-800 leading-tight flex items-center">{selectedItem.note}</p></div>}
                                    </div>
                                    {selectedItem.variants?.length > 0 && (
                                        <div className="space-y-3">
                                            <p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">規格選擇</p>
                                            <div className="grid grid-cols-3 gap-2">
                                                {selectedItem.variants.map((v, i) => {
                                                    const outMaterialIds = materials.filter(m => m.isOut).map(m => m.id);
                                                    const isVariantOut = (v.materials || []).some(id => outMaterialIds.includes(id));
                                                    const isSelected = selectedVariant?.name === v.name;
                                                    return (<button key={i} disabled={isVariantOut} onClick={() => setSelectedVariant(v)} className={`flex flex-col justify-between items-center p-3 rounded-xl border transition-all ${isSelected ? 'border-[#5B2274] bg-purple-50 ring-2 ring-[#5B2274]' : 'bg-white border-slate-200'} ${isVariantOut ? 'opacity-50 cursor-not-allowed bg-slate-100' : ''}`}><span className={`text-sm font-bold whitespace-nowrap overflow-hidden text-ellipsis w-full text-center ${isVariantOut ? 'text-slate-500' : 'text-slate-700'}`}>{v.name}</span><div className="flex items-center gap-1 mt-1"><span className={`text-sm font-black whitespace-nowrap ${isVariantOut ? 'text-slate-400' : 'text-[#5B2274]'}`}>${v.price}</span>{isVariantOut && <span className="text-xs font-bold text-red-400 whitespace-nowrap">(售完)</span>}</div></button>);
                                                })}
                                            </div>
                                        </div>
                                    )}
                                    {groupedItemAddons.length > 0 && (
                                        <div className="space-y-4">
                                            <p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">客製化選項</p>
                                            {groupedItemAddons.map(group => (
                                                <div key={group.name} className="space-y-2">
                                                    <p className="text-xs font-black text-slate-500">{group.name}</p>
                                                    <div className="grid grid-cols-3 gap-2">
                                                        {group.items.map(ad => {
                                                            const isSelected = selectedAddons.some(a => a.id === ad.id);
                                                            return (<button key={ad.id} onClick={() => { if (isSelected) setSelectedAddons(selectedAddons.filter(a => a.id !== ad.id)); else setSelectedAddons([...selectedAddons, ad]); }} className={`px-2 py-3 border rounded-xl text-sm font-bold shadow-sm flex flex-col items-center justify-center gap-1 transition-all ${isSelected ? 'bg-[#5B2274] text-white border-[#5B2274] ring-2 ring-[#5B2274]' : 'bg-white border-slate-200 text-slate-600'}`}><span className="whitespace-nowrap overflow-hidden text-ellipsis w-full text-center">{ad.name}</span> {ad.price > 0 && <span className={`whitespace-nowrap ${isSelected ? 'text-white/80' : 'text-[#5B2274]'}`}>+${ad.price}</span>}</button>);
                                                        })}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    {selectedItem.sideGroups?.length > 0 && (
                                        <div className="space-y-3">
                                            <p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">附餐內容</p>
                                            <div className="space-y-3">
                                                {selectedItem.sideGroups.map((group, i) => {
                                                    const targetCat = categories.find(c => c.id === group.categoryId);
                                                    const defProd = products.find(p => p.id === group.defaultProductId);
                                                    const choice = selectedSideGroups[group.id];
                                                    let img = 'https://placehold.co/100x100?text=Side', name = group.title, variant = '', priceDiff = 0, defPrice = defProd ? defProd.price : 0;
                                                    if (defProd && group.defaultVariantName) { const dv = defProd.variants?.find(v => v.name === group.defaultVariantName); if (dv) defPrice = dv.price; }
                                                    if (choice) { const p = products.find(p => p.id === choice.id); if (p && p.image) img = getOptimizedImage(p.image, 200); name = choice.name; variant = choice.variantName ? `(${choice.variantName})` : ''; priceDiff = choice.price - defPrice; }
                                                    else if (defProd) { img = getOptimizedImage(defProd.image, 200); name = defProd.name; if (group.defaultVariantName) variant = `(${group.defaultVariantName})`; }
                                                    return (
                                                        <div key={i} className={`flex gap-3 p-3 rounded-2xl border shadow-sm items-center transition-all ${group.allowChange ? 'cursor-pointer active:scale-98 border-purple-100 hover:border-purple-300' : 'border-slate-100 bg-white'}`} onClick={() => { if (group.allowChange && group.categoryId) handleOpenSelection('side', group.id, group.categoryId, defPrice); }}>
                                                            <div className="w-14 h-14 rounded-xl bg-slate-50 border border-slate-100 overflow-hidden shrink-0 aspect-square"><img src={img} className="w-full h-full object-cover" /></div>
                                                            <div className="flex-1 min-w-0 space-y-1"><p className="text-sm font-bold text-slate-800 truncate">{name} <span className="text-sm text-slate-500 font-bold">{variant}</span> {priceDiff !== 0 && <span className={`text-sm font-bold ml-1 ${priceDiff > 0 ? 'text-red-500' : 'text-green-500'}`}>{priceDiff > 0 ? `+$${priceDiff}` : `-$${Math.abs(priceDiff)}`}</span>}</p>{group.allowChange ? (<div className="flex items-center justify-between"><div className="flex items-center gap-1.5 text-[#5B2274]"><Icon name="check-circle-2" size={14} className="fill-[#5B2274] text-white" /><span className="text-[11px] font-bold">可更換同類別商品</span></div><button className="text-[10px] bg-purple-50 text-[#5B2274] px-2 py-0.5 rounded border border-purple-100 font-bold">更換</button></div>) : (<div className="flex items-center gap-1.5 text-slate-400"><Icon name="lock" size={14} /><span className="text-[11px] font-bold">固定附餐，不可更換</span></div>)}</div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                    {selectedItem.allowSets?.length > 0 && (
                                        <div className="space-y-3">
                                            <p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">升級套餐</p>
                                            <div className="space-y-3">
                                                {selectedItem.allowSets.map(setId => {
                                                    const s = sets.find(set => set.id === setId); if (!s) return null;
                                                    const isSelected = selectedSet?.id === setId, isExpanded = expandedSetId === setId || isSelected;
                                                    let setImg = getOptimizedImage(s.image, 200) || 'https://placehold.co/100x100?text=Set';
                                                    if (!s.image) { const fixedItem = s.contents?.find(c => c.type === 'fixed'); if (fixedItem) { const p = products.find(prod => prod.id === fixedItem.productId); if (p && p.image) setImg = getOptimizedImage(p.image, 200); } }
                                                    return (
                                                        <div key={setId} onClick={() => { if(isSelected) { setSelectedSet(null); setExpandedSetId(null); } else { setSelectedSet(s); setExpandedSetId(setId); } }} className={`rounded-2xl border shadow-sm overflow-hidden transition-all cursor-pointer ${isSelected ? 'border-[#5B2274] ring-2 ring-[#5B2274]' : 'border-slate-100 bg-white'}`}>
                                                            <div className={`flex gap-3 p-3 items-center ${isSelected ? 'bg-purple-50' : 'bg-white'}`}><div className="w-16 h-16 rounded-xl bg-slate-100 border border-slate-100 overflow-hidden shrink-0 aspect-square"><img src={setImg} className="w-full h-full object-cover" /></div><div className="flex-1 min-w-0"><div className="flex justify-between items-center"><p className="text-sm font-bold text-slate-800 truncate">{s.name}</p><span className="text-sm font-black text-[#5B2274]">+${s.price}</span></div><div className="flex justify-between items-center mt-1"><span className="text-[10px] text-slate-400 font-bold">查看內容</span><div className={`w-5 h-5 rounded-full border flex items-center justify-center ${isSelected ? 'bg-[#5B2274] border-[#5B2274]' : 'border-slate-300'}`}>{isSelected && <Icon name="check" size={12} className="text-white" />}</div></div></div></div>
                                                            {isExpanded && (
                                                                <div className="p-3 pt-0 border-t border-slate-100 animate-fade-in" onClick={e => e.stopPropagation()}>
                                                                    <div className="space-y-3 mt-2">{s.contents?.map((content, idx) => {
                                                                        let contentImg = 'https://placehold.co/100x100?text=Item', contentName = content.label, contentSub = "", isChangeable = content.allowChange !== false, targetCatName = '', priceDiff = 0, defPrice = 0;
                                                                        if (content.type === 'category' && content.defaultProductId) { const defProd = products.find(p => p.id === content.defaultProductId); defPrice = defProd ? defProd.price : 0; if (defProd && content.defaultVariantName) { const dv = defProd.variants?.find(v => v.name === content.defaultVariantName); if (dv) defPrice = dv.price; } }
                                                                        const choice = selectedSetChoices[idx];
                                                                        if (choice && isSelected) { const p = products.find(p => p.id === choice.id); if (p && p.image) contentImg = getOptimizedImage(p.image, 200); contentName = choice.name; contentSub = choice.variantName ? `(${choice.variantName})` : ''; priceDiff = choice.price - defPrice; }
                                                                        else { if (content.type === 'fixed') { const p = products.find(prod => prod.id === content.productId); if (p) { contentImg = getOptimizedImage(p.image, 200); contentName = p.name; if (content.variantName) contentSub = content.variantName; } isChangeable = false; } else if (content.type === 'category') { const cat = categories.find(c => c.id === content.categoryId), defP = products.find(p => p.id === content.defaultProductId); if (defP) { contentImg = getOptimizedImage(defP.image, 200); contentName = content.label; contentSub = defP.name; if (content.defaultVariantName) contentSub += ` (${content.defaultVariantName})`; } if (cat) targetCatName = cat.name; } }
                                                                        return (<div key={idx} className={`flex gap-3 p-3 rounded-2xl border shadow-sm items-center transition-all ${content.type === 'category' && content.allowChange ? 'cursor-pointer active:scale-98 border-purple-100 hover:border-purple-300' : 'bg-white border-slate-200'}`} onClick={() => { if (content.type === 'category' && content.allowChange && isSelected) handleOpenSelection('set', idx, content.categoryId, defPrice); }}><div className="w-14 h-14 rounded-xl bg-slate-50 border border-slate-100 overflow-hidden shrink-0 aspect-square"><img src={contentImg} className="w-full h-full object-cover" /></div><div className="flex-1 min-w-0 space-y-1"><p className="text-sm font-bold text-slate-800 truncate">{contentName} <span className="text-sm text-slate-500 font-bold">{contentSub}</span> {priceDiff !== 0 && <span className={`text-sm font-bold ml-1 ${priceDiff > 0 ? 'text-red-500' : 'text-green-500'}`}>{priceDiff > 0 ? `+$${priceDiff}` : `-$${Math.abs(priceDiff)}`}</span>}</p>{content.type === 'category' && isChangeable ? (<div className="flex items-center justify-between"><div className="flex items-center gap-1.5 text-[#5B2274]"><Icon name="check-circle-2" size={14} className="fill-[#5B2274] text-white" /><span className="text-[11px] font-bold">可更換同類別商品</span></div>{isSelected && <button className="text-[10px] bg-purple-50 text-[#5B2274] px-2 py-0.5 rounded border border-purple-100 font-bold">更換</button>}</div>) : !isChangeable && (<div className="flex items-center gap-1.5 text-slate-400"><Icon name="lock" size={14} /><span className="text-[11px] font-bold">固定品項，不可更換</span></div>)}</div></div>);
                                                                    })}</div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                    {checkAvailability(selectedItem) !== 'all_out' && (
                                        <div className="space-y-2"><label className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest">餐點備註</label><textarea className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold text-slate-700 outline-none focus:border-[#5B2274] resize-none h-24" placeholder="例如：去冰、不要洋蔥..." value={itemNote} onChange={e => setItemNote(e.target.value)}></textarea></div>
                                    )}
                                </div>
                                {checkAvailability(selectedItem) !== 'all_out' && (
                                    <div className="absolute bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-100 flex items-center gap-4 z-20">
                                        <div className="flex items-center gap-3 bg-slate-100 rounded-xl px-3 py-2"><button onClick={() => setItemCount(Math.max(1, itemCount-1))} className="w-8 h-8 flex items-center justify-center bg-white rounded-lg shadow-sm active:scale-95 text-slate-600"><Icon name="minus" size={16} /></button><span className="font-black text-lg w-6 text-center">{itemCount}</span><button onClick={() => setItemCount(itemCount+1)} className="w-8 h-8 flex items-center justify-center bg-[#5B2274] text-white rounded-lg shadow-sm active:scale-95"><Icon name="plus" size={16} /></button></div>
                                        <button 
                                            onClick={handleAddToCart}
                                            disabled={!selectionStatus.valid}
                                            className={`flex-1 py-4 rounded-xl font-black text-white shadow-lg flex justify-between px-6 items-center transition-all 
                                                ${!selectionStatus.valid ? 'bg-slate-300 cursor-not-allowed' : 'bg-[#5B2274] hover:bg-[#4a1b5e] active:scale-95'}`}
                                        >
                                            <span>
                                                {!selectionStatus.valid ? selectionStatus.msg : (editingCartItem ? '更新購物車' : '加入購物車')}
                                            </span>
                                            {selectionStatus.valid && (
                                                <span>${((selectedVariant ? selectedVariant.price : selectedItem.price) + selectedAddons.reduce((s,a)=>s+a.price,0) + (selectedSet ? (selectedSet.price + (function(){let d=0; selectedSet.contents?.forEach((c,i)=>{const ch=selectedSetChoices[i]; if(ch && c.type==='category' && c.allowChange && c.defaultProductId){const dp=products.find(p=>p.id===c.defaultProductId); let dpr=dp?dp.price:0; if(dp && c.defaultVariantName){const dv=dp.variants?.find(v=>v.name===c.defaultVariantName); if(dv)dpr=dv.price;} d+=(ch.price-dpr);}}); return d;})()) : 0) + (function(){let d=0; selectedItem.sideGroups?.forEach(g=>{const ch=selectedSideGroups[g.id]; if(ch && g.allowChange && g.defaultProductId){const dp=products.find(p=>p.id===g.defaultProductId); let dpr=dp?dp.price:0; if(dp && g.defaultVariantName){const dv=dp.variants?.find(v=>v.name===g.defaultVariantName); if(dv)dpr=dv.price;} d+=(ch.price-dpr);}}); return d;})()) * itemCount}</span>
                                            )}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* Selection Modal */}
                    {selectionModal && (
                        <div className="fixed inset-0 bg-black/80 z-[70] flex items-end sm:items-center justify-center p-0 sm:p-4 animate-fade-in backdrop-blur-sm" onClick={() => { if(!configuringProduct) setSelectionModal(null); }}>
                             <div className="bg-white w-full max-w-md rounded-t-[32px] sm:rounded-[32px] p-6 shadow-2xl animate-slide-up max-h-[85vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-4"><h3 className="text-lg font-[900] text-slate-800">{configuringProduct ? '商品內容' : '請選擇商品'}</h3><button onClick={() => { if(configuringProduct) setConfiguringProduct(null); else setSelectionModal(null); }} className="bg-slate-100 p-2 rounded-full text-slate-500"><Icon name={configuringProduct ? 'arrow-left' : 'x'} size={20} /></button></div>
                                <div className="flex-1 overflow-y-auto no-scrollbar space-y-3">
                                    {!configuringProduct ? (
                                        products.filter(p => p.categoryId === selectionModal.categoryId && !p.isHidden).map(p => {
                                            if (checkAvailability(p) === 'all_out') return null;
                                            let diffP = ''; const baseD = p.price - selectionModal.defaultPrice, hasV = p.variants && p.variants.length > 0;
                                            if (hasV) { const minP = Math.min(...p.variants.map(v => v.price)), minD = minP - selectionModal.defaultPrice; diffP = minD === 0 ? '不需補差價' : (minD > 0 ? `+$${minD}起` : `-$${Math.abs(minD)}起`); }
                                            else { diffP = baseD === 0 ? '不需補差價' : (baseD > 0 ? `+$${baseD}` : `-$${Math.abs(baseD)}`); }
                                            return (<div key={p.id} className="flex items-center justify-between p-4 bg-white border border-slate-200 rounded-xl active:bg-slate-50 cursor-pointer" onClick={() => handleProductSelectInModal(p)}><div className="flex items-center gap-3"><div className="w-12 h-12 rounded-lg bg-slate-100 overflow-hidden shrink-0"><img src={getOptimizedImage(p.image, 100)} className="w-full h-full object-cover" /></div><div><p className="font-bold text-slate-800">{p.name}</p><p className={`text-xs font-bold ${diffP.includes('+') ? 'text-red-500' : (diffP.includes('-') ? 'text-green-500' : 'text-slate-500')}`}>{diffP}</p></div></div><Icon name="chevron-right" size={16} className="text-slate-300" /></div>);
                                        })
                                    ) : (
                                        <div className="space-y-6">
                                            {configuringProduct.product.variants?.length > 0 && (<div className="space-y-2"><p className="text-xs font-black text-slate-400">規格</p><div className="grid grid-cols-2 gap-2">{configuringProduct.product.variants.map((v, i) => { const isS = configuringProduct.variant?.name === v.name, d = v.price - selectionModal.defaultPrice; return <button key={i} onClick={() => setConfiguringProduct({...configuringProduct, variant: isS ? null : v})} className={`p-3 rounded-xl border text-sm font-bold flex justify-between ${isS ? 'border-[#5B2274] bg-purple-50' : 'border-slate-200'}`}><span>{v.name}</span><span className="text-xs flex items-center gap-1"><s className="text-slate-400">${v.price}</s> <span className={d > 0 ? 'text-red-500' : (d < 0 ? 'text-green-500' : 'text-slate-500')}>{d === 0 ? '不需補差價' : (d > 0 ? `+$${d}` : `-$${Math.abs(d)}`)}</span></span></button>; })}</div></div>)}
                                            {configuringProduct.product.allowAddons?.length > 0 && (<div className="space-y-4"><p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">客製化選項</p>{getGroupedAddons(addons.filter(a => configuringProduct.product.allowAddons.includes(a.id))).map(g => (<div key={g.name} className="space-y-2"><p className="text-xs font-black text-slate-500">{g.name}</p><div className="grid grid-cols-2 gap-2">{g.items.map(ad => { const isS = configuringProduct.addons.some(a => a.id === ad.id); return <button key={ad.id} onClick={() => { const newA = isS ? configuringProduct.addons.filter(a => a.id !== ad.id) : [...configuringProduct.addons, ad]; setConfiguringProduct({...configuringProduct, addons: newA}); }} className={`p-3 rounded-xl text-sm font-bold flex justify-between ${isS ? 'bg-[#5B2274] text-white' : 'text-slate-500 border border-slate-200'}`}><span>{ad.name}</span> {ad.price>0 && <span className={isS ? 'text-white' : 'text-[#5B2274]'}>+${ad.price}</span>}</button>; })}</div></div>))}</div>)}
                                            <div className="border-t border-slate-100 pt-4 mt-2"><div className="flex justify-between items-center mb-4"><span className="font-bold text-slate-500">補差價金額</span><span className="font-black text-xl text-[#5B2274]">{(() => { if (configuringProduct.product.variants?.length > 0 && !configuringProduct.variant) return '請選擇規格'; const curr = (configuringProduct.variant ? configuringProduct.variant.price : configuringProduct.product.price) + configuringProduct.addons.reduce((s, a) => s + a.price, 0), diff = curr - selectionModal.defaultPrice; return diff === 0 ? '不需補差價' : (diff > 0 ? `+$${diff}` : `-$${Math.abs(diff)}`); })()}</span></div><button onClick={confirmConfiguration} className="w-full bg-[#5B2274] text-white py-3 rounded-xl font-bold shadow-lg">確認商品</button></div>
                                        </div>
                                    )}
                                </div>
                             </div>
                        </div>
                    )}

                    {showCartModal && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-end justify-center animate-fade-in backdrop-blur-sm" onClick={() => setShowCartModal(false)}>
                            <div className="bg-white w-full max-w-md rounded-t-[32px] p-6 shadow-2xl animate-slide-up max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h3 className="text-xl font-[900] text-slate-800">結帳確認</h3><button onClick={() => setShowCartModal(false)} className="bg-slate-100 p-2 rounded-full text-slate-500"><Icon name="x" size={20} /></button></div>
                                <div className="flex-1 overflow-y-auto no-scrollbar space-y-6 pb-4 px-1">
                                    <div className="space-y-4">
                                        <h4 className="text-sm font-black text-slate-400 uppercase tracking-widest">訂單內容</h4>
                                        {cart.length === 0 ? <div className="text-center py-6 text-slate-400 font-bold">購物車是空的</div> : cart.map(item => (
                                            <div key={item.id} className="flex gap-3 items-start border-b border-slate-50 pb-4 last:border-0 relative group">
                                                <button onClick={() => openEditCartItem(item)} className="absolute top-0 right-0 p-2 text-slate-300 hover:text-[#5B2274] z-10"><Icon name="pencil" size={16} /></button>
                                                <div className="w-16 h-16 rounded-xl bg-slate-50 border border-slate-100 shrink-0 overflow-hidden"><img src={getOptimizedImage(item.image, 200)} className="w-full h-full object-cover" /></div>
                                                <div className="flex-1 min-w-0 pr-8"><h4 className="font-black text-slate-800 text-sm truncate">{item.name}</h4><p className="text-xs text-slate-500 font-bold">{item.variantName}</p>{item.addons.length > 0 && <p className="text-xs text-slate-400 mt-1">{item.addons.map(a => a.name).join(' / ')}</p>}
                                                {item.sideGroups && Object.keys(item.sideGroups).length > 0 && (<div className="text-xs text-slate-600 bg-purple-50 p-2 rounded-lg mt-1 space-y-1"><p className="font-bold text-[#5B2274] mb-1">附餐：</p>{Object.values(item.sideGroups).map(c => (<div key={c.id}><span className="font-bold text-slate-700 mr-2">• {c.name} {c.variantName && `(${c.variantName})`}</span>{c.addons?.length > 0 && <span className="text-slate-400 block pl-2">{c.addons.map(a => a.name).join(' / ')}</span>}</div>))}</div>)}
                                                {item.set && (<div className="text-xs text-slate-600 bg-purple-50 p-2 rounded-lg mt-1 space-y-1"><p className="font-bold text-[#5B2274] mb-1">套餐：{item.set.name}</p>{item.set.contents?.map((c, i) => { const ch = item.setChoices?.[i]; let dn = 'Unknown', dv = ''; if (ch) { dn = ch.name; dv = ch.variantName; } else if (c.type === 'fixed') { const p = products.find(prod=>prod.id === c.productId); if(p) dn = p.name; } else if (c.type === 'category') { const p = products.find(prod=>prod.id === c.defaultProductId); if(p) dn = p.name; } return (<div key={i} className="flex flex-col"><span className="font-bold text-slate-700">• {dn} {dv && `(${dv})`}</span>{ch?.addons?.length > 0 && <span className="text-slate-400 pl-3">{ch.addons.map(a => a.name).join(' / ')}</span>}</div>); })}</div>)}
                                                {item.note && <p className="text-xs text-orange-500 bg-orange-50 px-2 py-1.5 rounded w-full block mt-2 font-medium break-words">備註：{item.note}</p>}<div className="flex items-center justify-between mt-2"><div className="flex items-center gap-2 bg-slate-50 rounded-lg px-2 py-1"><button onClick={() => item.qty > 1 ? updateCartQty(item.id, -1) : removeFromCart(item.id)} className="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm text-slate-600"><Icon name={item.qty > 1 ? "minus" : "trash-2"} size={12} /></button><span className="font-bold text-sm w-4 text-center">{item.qty}</span><button onClick={() => updateCartQty(item.id, 1)} className="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm text-slate-600"><Icon name="plus" size={12} /></button></div><span className="font-bold text-slate-700 text-sm">${item.totalPrice}</span></div></div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Pickup Time Section */}
                                    <div className="space-y-4 pt-2 border-t border-slate-100">
                                        <h4 className="text-sm font-black text-slate-400 uppercase tracking-widest">取餐時間</h4>
                                        <div className="grid grid-cols-1 gap-3">
                                            <select className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274] w-full" value={pickupDate} onChange={e => { setPickupDate(e.target.value); setIsASAP(false); }}>
                                                {getAvailableDates().length === 0 && <option disabled>無可選日期 (請來電)</option>}
                                                {getAvailableDates().map(d => <option key={d.value} value={d.value}>{d.label}</option>)}
                                            </select>
                                            
                                            {/* ASAP Toggle - Only show if selected date is today and currently open */}
                                            {pickupDate === new Date().toISOString().split('T')[0] && checkIsOpenNow() && (
                                                <label className={`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition-all ${isASAP ? 'bg-purple-50 border-[#5B2274]' : 'bg-white border-slate-200'}`}>
                                                    <div className={`w-5 h-5 rounded-full border flex items-center justify-center ${isASAP ? 'border-[#5B2274] bg-[#5B2274]' : 'border-slate-300'}`}>
                                                        {isASAP && <Icon name="check" size={14} className="text-white" />}
                                                    </div>
                                                    <input type="checkbox" className="hidden" checked={isASAP} onChange={e => setIsASAP(e.target.checked)} />
                                                    <span className={`text-sm font-bold ${isASAP ? 'text-[#5B2274]' : 'text-slate-600'}`}>盡快取餐</span>
                                                </label>
                                            )}

                                            {/* Split Hour and Minute Selectors - Hide if ASAP is checked */}
                                            {!isASAP && (
                                                <div className="grid grid-cols-2 gap-3">
                                                    <select className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274]" value={pickupHour} onChange={e => setPickupHour(e.target.value)}>
                                                        <option value="" disabled>選擇小時</option>
                                                        {getAvailableHours(pickupDate).map(h => <option key={h} value={h}>{h} 時</option>)}
                                                    </select>
                                                    <select className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274]" value={pickupMinute} onChange={e => setPickupMinute(e.target.value)} disabled={!pickupHour}>
                                                        <option value="" disabled>選擇分鐘</option>
                                                        {getAvailableMinutes(pickupDate, pickupHour).map(m => <option key={m} value={m}>{m.toString().padStart(2,'0')} 分</option>)}
                                                    </select>
                                                </div>
                                            )}
                                        </div>
                                        <p className="text-xs text-slate-400 font-bold text-center">如有其他時段需求，請直接來電</p>
                                    </div>

                                    <div className="border-t border-slate-100 border-dashed my-4"></div>

                                    <div className="space-y-4 pt-2">
                                        <h4 className="text-sm font-black text-slate-400 uppercase tracking-widest">訂購人資訊</h4>
                                        <div className="grid grid-cols-2 gap-3"><input type="text" placeholder="您的姓名" className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274]" value={userInfo.name} onChange={e => setUserInfo({...userInfo, name: e.target.value})} /><input type="tel" placeholder="聯絡電話" className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274]" value={userInfo.phone} onChange={e => setUserInfo({...userInfo, phone: e.target.value})} /></div>
                                        <div className="space-y-2"><p className="text-xs font-bold text-slate-500">優先聯絡方式</p><div className="flex bg-slate-50 rounded-xl p-1 w-full"><button onClick={() => setUserInfo({...userInfo, contactMethod: 'line'})} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${userInfo.contactMethod === 'line' ? 'bg-[#5B2274] text-white shadow-sm' : 'text-slate-400'}`}>LINE</button><button onClick={() => setUserInfo({...userInfo, contactMethod: 'phone'})} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${userInfo.contactMethod === 'phone' ? 'bg-[#5B2274] text-white shadow-sm' : 'text-slate-400'}`}>電話</button></div></div><label className="flex items-center justify-between cursor-pointer bg-slate-50 p-3 rounded-xl border border-slate-100"><span className="text-xs font-bold text-slate-500">記住我的資訊 (下次自動帶入)</span><div className="switch"><input type="checkbox" checked={userInfo.remember} onChange={e => setUserInfo({...userInfo, remember: e.target.checked})} /><span className="slider"></span></div></label>
                                    </div>
                                    <div className="border-t border-slate-100 border-dashed my-4"></div>
                                    <div className="space-y-3 pt-2"><h4 className="text-sm font-black text-slate-400 uppercase tracking-widest">優惠折扣</h4><div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">{myCoupons.map((c, i) => (<button key={i} onClick={() => setSelectedCoupon(selectedCoupon === c ? null : c)} className={`flex-shrink-0 px-3 py-2 rounded-xl border text-xs font-bold transition-all ${selectedCoupon === c ? 'bg-purple-100 border-[#5B2274] text-[#5B2274]' : 'bg-white border-slate-200 text-slate-600'}`}>{c.title} (-${c.discount})</button>))}{myCoupons.length === 0 && <span className="text-xs text-slate-400 py-2">無可用優惠券，請至菜單分頁領取</span>}</div><div className="flex items-start gap-3 p-3 bg-red-50 border border-red-100 rounded-xl cursor-pointer" onClick={() => setUseLoyaltyCard(!useLoyaltyCard)}><div className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 mt-0.5 ${useLoyaltyCard ? 'bg-red-500 border-red-500' : 'bg-white border-red-200'}`}>{useLoyaltyCard && <Icon name="check" size={14} className="text-white" />}</div><div><p className="text-sm font-bold text-red-800">使用集點卡折抵 $50</p><p className="text-[10px] text-red-500 mt-1 font-bold">※ 若現場核銷不符資格將收取原價</p></div></div></div>
                                </div>
                                <div className="mt-2 pt-4 border-t border-slate-100"><div className="flex justify-between items-center mb-4"><span className="font-bold text-slate-500">總計金額</span><div className="text-right">{(useLoyaltyCard || (selectedCoupon && cartTotal >= selectedCoupon.minSpend)) && <span className="text-xs text-slate-400 line-through mr-2">${cartTotal}</span>}<span className="font-black text-2xl text-[#5B2274]">${finalTotal}</span></div></div><button onClick={handlePreSubmit} className="w-full bg-[#5B2274] text-white py-4 rounded-2xl font-black text-lg shadow-xl hover:bg-[#4a1b5e] active:scale-95 transition-all">送出訂單</button></div>
                            </div>
                        </div>
                    )}

                    {showSubmitConfirm && (
                        <div className="fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={() => setShowSubmitConfirm(false)}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up flex flex-col items-center text-center space-y-4" onClick={e => e.stopPropagation()}>
                                <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-2"><Icon name="alert-triangle" size={32} /></div>
                                <h3 className="text-xl font-[900] text-slate-800">訂單確認</h3>
                                <div className="space-y-2 text-sm font-bold text-slate-600">
                                    <p>訂單送出無法線上變更</p>
                                    <p className="text-red-500">{pickupDate === new Date().toISOString().split('T')[0] ? "當日訂單無法透過線上取消" : "隔日訂單過凌晨後無法透過線上取消"}</p>
                                    <p>如有變更、取消需求請於營業時間內來電</p>
                                </div>
                                <div className="flex gap-3 w-full pt-2"><button onClick={() => setShowSubmitConfirm(false)} className="flex-1 py-3 rounded-xl font-bold bg-slate-100 text-slate-600 active:scale-95 transition-transform">取消</button><button onClick={confirmSubmitOrder} className="flex-1 py-3 rounded-xl font-bold bg-[#5B2274] text-white shadow-lg active:scale-95 transition-transform">確認送出</button></div>
                            </div>
                        </div>
                    )}

                    {showInfoModal && (
                        <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={() => setShowInfoModal(false)}>
                            <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-slide-up relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setShowInfoModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x" size={24} /></button>
                                <div className="text-center mb-6"><div className="w-12 h-12 bg-purple-100 text-[#5B2274] rounded-full flex items-center justify-center mx-auto mb-3"><Icon name="clock" size={24} /></div><h3 className="text-xl font-[900] text-slate-800">營業時間資訊</h3></div>
                                <div className="space-y-4">
                                    <div className="bg-slate-50 p-4 rounded-2xl flex justify-between items-center"><span className="text-sm font-bold text-slate-500">平日營業</span><span className="text-lg font-black text-slate-800">{settings.openTime} - {settings.closeTime}</span></div>
                                    <div className="bg-slate-50 p-4 rounded-2xl flex justify-between items-center"><span className="text-sm font-bold text-slate-500">每週公休</span><span className="text-lg font-black text-slate-800">{settings.closedDays.length > 0 ? `每週${settings.closedDays.sort().map(d => dayNames[d].replace('週','')).join('、')}公休` : '無'}</span></div>
                                    {settings.specialDates?.length > 0 && (
                                        <div className="space-y-2 pt-2 border-t border-slate-100">
                                            <p className="text-xs font-black text-slate-400 uppercase tracking-wider text-center">特殊排休/營業</p>
                                            <div className="max-h-32 overflow-y-auto no-scrollbar space-y-1.5">
                                                {settings.specialDates.map((sd, i) => (
                                                    <div key={i} className="flex flex-col border-b border-slate-100 last:border-0 pb-1">
                                                        <div className="flex justify-between text-xs font-bold px-2"><span className="text-slate-600">{sd.date}</span><span className={sd.type === 'open' ? 'text-emerald-500' : 'text-red-500'}>{sd.type === 'open' ? '加開營業' : '特殊店休'}</span></div>
                                                        {sd.note && <span className="text-[10px] text-slate-400 px-2">{sd.note}</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ★ 關鍵修正點：在這裡替換成條件渲染版本 ★ */}
                    {selectedOrderDetail && (
                        <OrderDetailModal 
                            order={orderHistory.find(o => o.id === selectedOrderDetail?.id)} 
                            onClose={() => setSelectedOrderDetail(null)} 
                            onReorder={reorder}
                            onCancel={openCancelConfirm}
                        />
                    )}
                    
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
