<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>線上點餐 | 城市漢堡 虎尾光復店</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        html, body { 
            height: 100%;          /* 強制高度為 100% */
            width: 100%;
            overflow: hidden;      /* 禁止外部捲動，這會阻止網址列收縮 */
            position: fixed;       /* 在 iOS 上這招最有效，完全鎖死背景 */
            
            font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif; 
            background-color: #F8F9FA; 
            color: #1E293B; 
            letter-spacing: 0px !important; 
            -webkit-tap-highlight-color: transparent;
        }
        
        #root {
            height: 100%;          /* 讓 React 根容器也填滿 */
            width: 100%;
        }

        
        section {
            scroll-margin-top: 20px; /* 點擊左側選單時，右側標題上方會預留 20px 空間 */
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        /* Marquee Animation */
        @keyframes marquee-scroll-wait { 
            0% { transform: translateX(0); } 
            15% { transform: translateX(0); } 
            100% { transform: translateX(-100%); }
        }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-slide-up { animation: slideInUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-bounce-subtle { animation: bounce-subtle 0.2s ease-in-out; }
        @keyframes bounce-subtle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .header-curve {
            border-bottom-left-radius: 2.5rem;
            border-bottom-right-radius: 2.5rem;
        }

        /* Checkbox custom style */
        .custom-checkbox:checked {
            background-color: #5B2274;
            border-color: #5B2274;
        }
        
        /* Ticket style for coupons */
        .coupon-ticket {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), radial-gradient(circle at 100% 50%, transparent 10px, white 11px);
            background-position: 0 0, 0 0;
            background-size: 100% 100%;
            background-repeat: no-repeat;
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #5B2274; }
        input:checked + .slider:before { transform: translateX(20px); }
        
        :root {
            --brand-color: #5B2274;
            --brand-light: #F5EEF8;
        }

        /* Icon 呼吸燈動畫 */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(91, 34, 116, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(91, 34, 116, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(91, 34, 116, 0); }
        }
        
        .status-icon-anim {
            animation: pulse-ring 2s infinite;
        }

        /* 進度條平滑過渡 */
        .progress-bar-fill {
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s;
        }

        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        .body-lock {
            overflow: hidden !important;
            height: 100vh !important;
            touch-action: none;
        }
        .full-width-note {
            width: 100% !important;
            max-width: 100% !important;
        }
        /* 載入畫面 */
        .splash-screen {
            position: fixed;
            inset: 0;
            background-color: #ffffff; /* 改成白色 */
            color: #5B2274;            /* 文字改成紫色，不然會看不見 */
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            /* 為了保險起見，可以加入這一行讓背景延伸到底部安全區 */
            padding-bottom: env(safe-area-inset-bottom);
        }

    </style>
</head>
<body class="select-none">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        // [修改] 加入 signInWithCustomToken
        import { getAuth, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, setDoc, updateDoc, enableIndexedDbPersistence, query, where, orderBy, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        // [新增] 引入 Functions SDK
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA9x0gk2zQBJr1vkNLAoBodbBQ3_D2aXag",
            authDomain: "cityburger-huwei.firebaseapp.com",
            projectId: "cityburger-huwei",
            storageBucket: "cityburger-huwei.firebasestorage.app",
            messagingSenderId: "546465207310",
            appId: "1:546465207310:web:4b742f2a3b883dee58585f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // [新增] 初始化 Functions (這就是連線到後端的關鍵)
        const functions = getFunctions(app);

        try {
            enableIndexedDbPersistence(db).catch((err) => {});
        } catch (e) { console.warn(e); }
        
        // 掛載到 window 供 React 使用
        window.db = db;
        window.auth = auth;
        window.functions = functions;          // [新增]
        window.httpsCallable = httpsCallable;  // [新增]
        window.signInWithCustomToken = signInWithCustomToken; // [新增]
        window.onAuthStateChanged = onAuthStateChanged;
        window.appId = "cityburger-huwei-v1";
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.collection = collection;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useLayoutEffect } = React;
        const BRAND_COLOR = "#5B2274";
        
        // ==========================================
        //  請填入您的 LIFF IDs
        // ==========================================
        // 點餐用 LIFF ID (主選單/訂單模式)
        const LIFF_ID_ORDER = "2008752799-3k2GdCkG";
        // 瀏覽用 LIFF ID (單純瀏覽菜單/非點餐模式)
        const LIFF_ID_BROWSE = "YOUR_BROWSE_LIFF_ID";

        const getOptimizedImage = (url, width = 600) => {
            if (!url) return 'https://placehold.co/400x300?text=No+Image';
            if (url.includes('cloudinary.com')) {
                const parts = url.split('/upload/');
                if (parts.length === 2) {
                    return `${parts[0]}/upload/w_${width},q_auto,f_auto/${parts[1]}`;
                }
            }
            return url;
        };

        const Icon = ({ name, size = 18, className = "", fill = "none" }) => {
            const [iconData, setIconData] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const icon = window.lucide.icons[name] || window.lucide.icons[pascalName] || window.lucide.icons[name.charAt(0).toUpperCase() + name.slice(1)];
                    setIconData(icon || null);
                }
            }, [name]);
            if (!iconData) return <span style={{ width: size, height: size }} className={`inline-block ${className}`}></span>;
            return React.createElement('svg', { 
                xmlns: "http://www.w3.org/2000/svg", 
                width: size, 
                height: size, 
                viewBox: "0 0 24 24", 
                fill: fill, 
                stroke: "currentColor", 
                strokeWidth: "2", 
                strokeLinecap: "round", 
                strokeLinejoin: "round", 
                className 
            }, iconData.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i })));
        };

        const SearchIcon = ({ active }) => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={active ? BRAND_COLOR : "#94A3B8"} strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="transition-colors duration-300">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.3-4.3"></path>
            </svg>
        );

        const TAG_COLORS = {
            red: 'bg-red-500 text-white',
            orange: 'bg-orange-400 text-white',
            green: 'bg-emerald-500 text-white',
            blue: 'bg-blue-500 text-white',
            purple: 'bg-purple-500 text-white',
            black: 'bg-slate-800 text-white'
        };

        const SmartMarquee = ({ announcements }) => {
            const [index, setIndex] = useState(0);
            const [shouldScroll, setShouldScroll] = useState(false);
            const containerRef = useRef(null);
            const textRef = useRef(null);
            const items = useMemo(() => announcements.filter(a => a && a.trim() !== ''), [announcements]);
            const currentText = items[index];

            useEffect(() => { setIndex(0); }, [items.length]);

            const handleNext = () => {
                setIndex((prev) => (prev + 1) % items.length);
                setShouldScroll(false);
            };

            useLayoutEffect(() => {
                if (containerRef.current && textRef.current && currentText) {
                    const containerWidth = containerRef.current.offsetWidth;
                    const textWidth = textRef.current.offsetWidth;
                    if (textWidth > containerWidth) {
                        setShouldScroll(true);
                    } else {
                        setShouldScroll(false);
                        const timer = setTimeout(handleNext, 4000);
                        return () => clearTimeout(timer);
                    }
                }
            }, [index, currentText]);

            useEffect(() => {
                if (items.length === 0 || !shouldScroll) return;
                const container = containerRef.current;
                const text = textRef.current;
                if (!container || !text) return;

                text.style.transform = 'translateX(0)';
                text.style.opacity = '0';
                const fadeIn = text.animate([{ opacity: 0 }, { opacity: 1 }], { duration: 500, fill: 'forwards' });

                fadeIn.onfinish = () => {
                    const containerWidth = container.offsetWidth;
                    const textWidth = text.offsetWidth;
                    const distance = textWidth - containerWidth;
                    if (distance > 0) {
                        const speed = 40;
                        const scrollDuration = (distance / speed) * 1000;
                        const waitStart = 2000;
                        const waitEnd = 2000;
                        const totalDuration = waitStart + scrollDuration + waitEnd;
                        const scrollAnim = text.animate([
                            { transform: 'translateX(0)', offset: 0 },
                            { transform: 'translateX(0)', offset: waitStart / totalDuration }, 
                            { transform: `translateX(-${distance}px)`, offset: (waitStart + scrollDuration) / totalDuration },
                            { transform: `translateX(-${distance}px)`, offset: 1 }
                        ], { duration: totalDuration, fill: 'forwards' });
                        scrollAnim.onfinish = () => {
                            const fadeOut = text.animate([{ opacity: 1 }, { opacity: 0 }], { duration: 500, fill: 'forwards' });
                            fadeOut.onfinish = () => { handleNext(); };
                        };
                    }
                };
                return () => { text.getAnimations().forEach(anim => anim.cancel()); };
            }, [index, items, shouldScroll]);

            if (items.length === 0) return null;

            return (
                <div className="bg-white rounded-xl shadow-lg p-3 flex items-center gap-3 border border-slate-100 mx-6 -mt-5 mb-2 relative z-40 overflow-hidden">
                    <div className="bg-amber-100 p-1.5 rounded-lg text-amber-600 shrink-0 relative z-10"><Icon name="megaphone" size={14} /></div>
                    <div className="flex-1 h-6 relative overflow-hidden flex items-center" ref={containerRef}>
                        <div ref={textRef} className={`whitespace-nowrap text-[15px] font-bold text-slate-700 ${!shouldScroll ? 'animate-fade-in' : ''}`} style={{ willChange: 'transform, opacity' }}>
                            {currentText}
                        </div>
                    </div>
                </div>
            );
        };

        const OrderHistoryItem = ({ order, onOpenDetail }) => {
            if (!order) return null;
            
            // 狀態文字對應邏輯
            const getStatusLabel = () => {
                const todayStr = new Date().toLocaleString("zh-TW", { timeZone: "Asia/Taipei", year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
                const isFuture = order.userInfo.pickupDate > todayStr;

                if (order.status === 'cancelled') return '訂單已取消';
                if (order.status === 'completed') return '訂單已完成';
                if (order.status === 'ready') return '餐點已完成';
                if (order.status === 'preparing') return '餐點製作中'; // ★ 新增狀態
                if (order.status === 'confirmed') return '店家已接單'; // ★ 修改狀態意義
                if (order.status === 'pending') return isFuture ? '預約訂單已成立' : '訂單待店家確認';
                return '處理中';
            };

            const formatTime = (iso) => {
                if(!iso) return "";
                const d = new Date(iso);
                return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            };

            const pickupTimeDisplay = `${order.userInfo.pickupDate.replace(/-/g, '/')} ${order.userInfo.pickupTime === 'ASAP' ? '盡快取餐' : order.userInfo.pickupTime}`;

            return (
                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between mb-3">
                    <div className="flex-1 space-y-1">
                        <div className="flex items-center gap-2">
                            <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${
                                ['cancelled'].includes(order.status) ? 'bg-red-50 text-red-500' : 
                                ['completed'].includes(order.status) ? 'bg-slate-100 text-slate-500' : 'bg-purple-50 text-[#5B2274]'
                            }`}>
                                {getStatusLabel()}
                            </span>
                        </div>
                        <p className="text-[11px] font-bold text-slate-400">訂購：{formatTime(order.createdAt)}</p>
                        <p className="text-[11px] font-bold text-slate-400">取餐：{pickupTimeDisplay}</p>
                        <p className="text-sm font-black text-slate-800">金額：${order.totalPrice}</p>
                    </div>
                    <button 
                        onClick={() => onOpenDetail(order)}
                        className="ml-4 px-4 py-2 bg-slate-50 text-[#5B2274] border border-purple-100 rounded-xl font-bold text-xs active:scale-95 transition-transform"
                    >
                        查看詳情
                    </button>
                </div>
            );
        };
        
        // 2. 訂單詳情彈窗元件 (保留此名稱，並確保包含 products 參數)
        const OrderDetailModal = ({ order, onClose, onReorder, onCancel, products }) => {
            if (!order) return null;

            const todayStr = new Date().toLocaleString("zh-TW", { timeZone: "Asia/Taipei", year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            const isFuture = order.userInfo.pickupDate > todayStr;
            const getStatusConfig = () => {
                switch (order.status) {
                    case 'cancelled':
                        return { title: '訂單已取消', desc: '很抱歉，此訂單已被取消。如有疑問請直接致電店家。', icon: 'CircleX', color: 'text-red-500', bg: 'bg-red-100', bar: '#9CA3AF', width: '100%', anim: false };
                    case 'completed':
                        return { title: '訂單已完成', desc: '感謝您的訂購，期待再次為您服務！', icon: 'CheckCircle', color: 'text-blue-600', bg: 'bg-blue-100', bar: '#2563EB', width: '100%', anim: false };
                    case 'ready':
                        return { title: '餐點已完成', desc: '您的餐點已準備好，請前往櫃台取餐。', icon: 'ShoppingBag', color: 'text-green-500', bg: 'bg-green-100', bar: '#10B981', width: '100%', anim: true };
                    
                    // ★ 新增：製作中 (Preparing)
                    case 'preparing':
                        return { title: '餐點製作中', desc: '廚房正在火熱製作您的餐點，請稍候！', icon: 'Flame', color: 'text-orange-500', bg: 'bg-orange-100', bar: '#F97316', width: '80%', anim: true };
                    
                    // ★ 修改：已接單 (Confirmed) - 代表「排隊中/準備中」，進度條設為 35%
                    case 'confirmed':
                        return { title: '店家已接單', desc: '店家已確認您的訂單內容，將依序或於指定時間開始製作。', icon: 'ClipboardCheck', color: 'text-blue-600', bg: 'bg-blue-100', bar: '#3B82F6', width: '35%', anim: false };
                    
                    case 'pending':
                    default:
                        return isFuture 
                            ? { title: '預約訂單已成立', desc: '店家已收到預約，將於指定時間開始製作餐點。', icon: 'Clock', color: 'text-teal-600', bg: 'bg-teal-100', bar: '#0D9488', width: '5%', anim: false }
                            : { title: '訂單待店家確認', desc: '店家正在確認您的訂單內容，請稍候。', icon: 'ClipboardList', color: 'text-[#5B2274]', bg: 'bg-purple-100', bar: '#5B2274', width: '15%', anim: false };
                }
            };
            const config = getStatusConfig();
            const formatTime = (iso) => { if(!iso) return "-"; const d = new Date(iso); return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };

            return (
                <div className="fixed inset-0 bg-[#F3F4F6] z-[100] flex flex-col animate-fade-in overflow-hidden">
                    <nav className="bg-[#F3F4F6] shrink-0 shadow-md relative z-10">
                        <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-between"><button onClick={onClose} className="text-gray-600 active:scale-90 transition-transform"><Icon name="ArrowLeft" size={24} /></button><h1 className="text-lg font-bold text-gray-800">訂單進度</h1><div className="w-6"></div></div>
                    </nav>

                    <div className="flex-1 overflow-y-auto no-scrollbar">
                        <div className="max-w-md mx-auto pb-10">
                            
                            {/* [區塊 1] 狀態 */}
                            <div className="bg-white p-6 mb-2 rounded-b-3xl shadow-sm relative overflow-hidden text-center">
                                <div className="absolute -top-10 -right-10 w-32 h-32 bg-purple-50 rounded-full opacity-50"></div>
                                <div className={`w-20 h-20 mx-auto ${config.bg} rounded-full flex items-center justify-center mb-4 transition-all duration-300 ${config.anim ? 'status-icon-anim' : ''}`}><Icon name={config.icon} size={32} className={config.color} /></div>
                                <h2 className={`text-2xl font-bold mb-1 ${order.status === 'cancelled' ? 'text-red-600' : 'text-gray-800'}`}>{config.title}</h2>
                                <p className="text-gray-500 text-sm mb-3 px-4">{config.desc}</p>
                                <div className="inline-flex items-center gap-1.5 bg-slate-50 border border-slate-100 px-3 py-1 rounded-full mb-6 shadow-sm"><Icon name="Clock" size={12} className="text-slate-400" /><span className="text-xs font-bold text-slate-600">預計取餐：{order.userInfo.pickupDate.replace(/-/g, '/')} {order.userInfo.pickupTime}</span></div>
                                <div className="w-full bg-gray-200 rounded-full h-2.5 mb-2 overflow-hidden"><div className="h-full rounded-full progress-bar-fill" style={{ width: config.width, backgroundColor: config.bar }}></div></div>
                                {order.status !== 'cancelled' && (<div className="flex justify-between text-xs text-gray-400 font-medium px-1"><span>確認中</span><span>準備中</span><span>可取餐</span></div>)}
                            </div>

                            {/* [區塊 2] 資訊 */}
                            <div className="mx-4 mt-4 bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex justify-between items-center">
                                <div className="flex items-center gap-3"><div className="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400"><Icon name="Store" size={20} /></div><div><h3 className="font-bold text-gray-800 text-sm">城市漢堡 虎尾光復店</h3><p className="text-xs text-gray-500">訂單編號 #{order.orderId}</p><p className="text-[10px] text-gray-400 mt-0.5 font-medium">下單時間：{formatTime(order.createdAt)}</p></div></div><a href={`tel:${window.settings?.phone || '056323111'}`} className="w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-[#5B2274]"><Icon name="Phone" size={16} /></a>
                            </div>

                            {/* [區塊 3] 訂單明細 */}
                            <div className="mx-4 mt-4 mb-4 bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 border-b border-gray-100 pb-2 flex items-center gap-2">
                                    <Icon name="Utensils" size={18} className="text-[#5B2274]" /> 餐點明細
                                </h3>
                                
                                {order.items.map((item, i) => (
                                    <div key={i} className="flex gap-3 items-start border-b border-slate-50 pb-4 mb-4 last:border-0 last:mb-0 last:pb-0 relative">
                                        <div className="bg-gray-100 px-2 py-1 rounded text-xs font-bold text-gray-600 h-fit shrink-0">{item.qty}x</div>
                                        
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between items-start">
                                                <h4 className="font-bold text-gray-800 text-sm truncate">{item.name}</h4>
                                                <span className="font-bold text-gray-800 text-sm shrink-0 ml-2">${item.totalPrice}</span>
                                            </div>
                                            
                                            <p className="text-xs text-slate-500 font-bold">{item.variantName}</p>
                                            
                                            {/* 客製化: 斜線 */}
                                            {item.addons?.length > 0 && (
                                                <p className="text-xs text-slate-400 mt-1">{item.addons.map(a => a.name).join(' / ')}</p>
                                            )}

                                            {/* 附餐 */}
                                            {item.sideGroups && Object.keys(item.sideGroups).length > 0 && (
                                                <div className="text-xs text-slate-600 bg-purple-50 p-2 rounded-lg mt-2 space-y-1">
                                                    <p className="font-bold text-[#5B2274] mb-1">附餐：</p>
                                                    {Object.values(item.sideGroups).map((c, idx) => (
                                                        <div key={idx}>
                                                            <span className="font-bold text-slate-700 mr-2">• {c.name} {c.variantName && `(${c.variantName})`}</span>
                                                            {/* 修改：移除開頭的符號，直接顯示項目 */}
                                                            {c.addons?.length > 0 && <span className="text-slate-400 block pl-2">{c.addons.map(a => a.name).join(' / ')}</span>}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}

                                            {/* 升級套餐 */}
                                            {item.set && (
                                                <div className="text-xs text-slate-600 bg-purple-50 p-2 rounded-lg mt-2 space-y-1">
                                                    <p className="font-bold text-[#5B2274] mb-1">升級套餐：{item.set.name}</p>
                                                    {item.set.contents?.map((c, idx) => { 
                                                        const ch = item.setChoices?.[idx]; 
                                                        let dn = 'Unknown', dv = ''; 
                                                        if (ch) { 
                                                            dn = ch.name; 
                                                            dv = ch.variantName; 
                                                        } else if (c.type === 'fixed') { 
                                                            // 查找固定餐點名稱
                                                            const fixedProd = products?.find(p => p.id === c.productId);
                                                            if (fixedProd) dn = fixedProd.name;
                                                            else dn = "(固定餐點)";
                                                        } 
                                                        
                                                        if (dn === 'Unknown') return null;

                                                        return (
                                                            <div key={idx} className="flex flex-col">
                                                                <span className="font-bold text-slate-700">• {dn} {dv && `(${dv})`}</span>
                                                                {/* 修改：移除開頭的符號，直接顯示項目 */}
                                                                {ch?.addons?.length > 0 && <span className="text-slate-400 pl-3">{ch.addons.map(a => a.name).join(' / ')}</span>}
                                                            </div>
                                                        ); 
                                                    })}
                                                </div>
                                            )}

                                            {item.note && (<p className="text-xs text-orange-500 bg-orange-50 px-2 py-1.5 rounded w-full block mt-2 font-medium break-words">備註：{item.note}</p>)}
                                        </div>
                                    </div>
                                ))}

                                <hr className="border-dashed border-gray-200 my-4" />
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between text-gray-600"><span>小計</span><span>${order.originalPrice || order.totalPrice}</span></div>
                                    {order.discountAmount > 0 && (<div className="flex justify-between text-red-500 font-medium"><div className="flex items-center gap-1"><Icon name="Ticket" size={14} /><span>折扣優惠 ({order.discountApplied === 'loyalty' ? '集點卡' : '優惠券'})</span></div><span>-${order.discountAmount}</span></div>)}
                                    <div className="flex justify-between text-gray-800 font-bold text-lg mt-2 pt-2 border-t border-gray-100"><span>總金額</span><span className="text-[#5B2274]">${order.totalPrice}</span></div>
                                </div>
                            </div>

                            {/* [區塊 4] 動作欄 */}
                            <div className="mx-4 mt-6">
                                {(['completed', 'cancelled'].includes(order.status)) ? (
                                    <button onClick={() => { onReorder(order); onClose(); }} className="w-full py-3.5 rounded-xl font-bold text-white shadow-lg bg-[#5B2274] active:scale-95 transition-all flex justify-center items-center gap-2"><Icon name="RotateCcw" size={20} /> 再次訂購</button>
                                ) : (
                                    (order.status === 'pending' && isFuture) && (<button onClick={() => { onCancel(order); onClose(); }} className="w-full py-3.5 rounded-xl font-bold text-white shadow-lg bg-red-500 active:bg-red-600 transition-colors flex justify-center items-center gap-2"><Icon name="Ban" size={20} /> 取消訂單</button>)
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        function App() {
			const [isCheckingProfile, setIsCheckingProfile] = useState(false);
            const [settings, setSettings] = useState({ phone: '', address: '', mapsUrl: '', openTime: '06:00', closeTime: '13:30', closedDays: [], statusMode: 'auto', announcements: [], specialDates: [], productTags: [], addonGroups: [] });
            const [categories, setCategories] = useState([]);
            const [lineDisplayName, setLineDisplayName] = useState('');
            const [products, setProducts] = useState([]);
            const [sets, setSets] = useState([]);
            const [addons, setAddons] = useState([]);
			const [organizations, setOrganizations] = useState([]); // [New] 特約機構列表
			const [showRegisterModal, setShowRegisterModal] = useState(false); // [New] 強制註冊視窗
            const [useDefaultInfo, setUseDefaultInfo] = useState(true);        // [New] 結帳時是否帶入會員資料
			// [New] 核心路由狀態
            // viewState: 'loading' | 'landing_guest' (內用入口) | 'landing_mode' (外帶入口) | 'menu' (主程式)
            const [viewState, setViewState] = useState('loading'); 
            
            // orderMode: 'initial' | 'dine_in' (內用) | 'pickup' (自取) | 'delivery' (外送)
            const [orderMode, setOrderMode] = useState('initial'); 
            
            const [tableNumber, setTableNumber] = useState(null); // 掃碼桌號
            const [isGuest, setIsGuest] = useState(false);        // 是否為訪客模式
			const [authLoading, setAuthLoading] = useState(true);
			const [isProfileComplete, setIsProfileComplete] = useState(false);
            const [userProfile, setUserProfile] = useState(null);   // [New] 使用者完整資料 (含特約身分/點數)
            const [materials, setMaterials] = useState([]);
            const [coupons, setCoupons] = useState([]); 
            const [currentView, setCurrentView] = useState('menu'); 
            const [activeCategory, setActiveCategory] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [isSearchActive, setIsSearchActive] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null); 
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [showCartModal, setShowCartModal] = useState(false);
            const [showSubmitConfirm, setShowSubmitConfirm] = useState(false); 
            const [selectionModal, setSelectionModal] = useState(null); 
            const [configuringProduct, setConfiguringProduct] = useState(null); 
            const [messageModal, setMessageModal] = useState({ show: false, content: '' });
            const [cancelConfirmModal, setCancelConfirmModal] = useState({ show: false, order: null });
            const [selectedOrderDetail, setSelectedOrderDetail] = useState(null);
            const [favorites, setFavorites] = useState([]);
            const [orderHistory, setOrderHistory] = useState([]);
            const [userInfo, setUserInfo] = useState({ name: '', phone: '', remember: false, contactMethod: 'line' });
            const [pickupDate, setPickupDate] = useState('');
            const [isASAP, setIsASAP] = useState(false);
            const [pickupHour, setPickupHour] = useState('');
            const [pickupMinute, setPickupMinute] = useState('');
            const [myCoupons, setMyCoupons] = useState([]); 
            const [cart, setCart] = useState([]);
            const [selectedCoupon, setSelectedCoupon] = useState(null);
            const [couponInput, setCouponInput] = useState('');
            const [useLoyaltyCard, setUseLoyaltyCard] = useState(false);
            const [editingCartItem, setEditingCartItem] = useState(null); 
            const [itemCount, setItemCount] = useState(1);
            const [selectedVariant, setSelectedVariant] = useState(null);
            const [selectedAddons, setSelectedAddons] = useState([]);
            const [selectedSideGroups, setSelectedSideGroups] = useState({}); 
            const [selectedSet, setSelectedSet] = useState(null);
            const [selectedSetChoices, setSelectedSetChoices] = useState({}); 
            const [itemNote, setItemNote] = useState('');
            const [expandedSetId, setExpandedSetId] = useState(null);
            const [isInitLoading, setIsInitLoading] = useState(true);
			const [showTableSelector, setShowTableSelector] = useState(false);
			const [showEditProfileModal, setShowEditProfileModal] = useState(false); // [New] 修改資料視窗開關

            const getTaiwanDate = () => {
                const d = new Date();
                return new Date(d.toLocaleString("en-US", { timeZone: "Asia/Taipei" }));
            };

            // New States for Auth & Mode
            const [currentUser, setCurrentUser] = useState(null);
            const [appMode, setAppMode] = useState('order'); // 'order' or 'browse'

            const categoryRefs = useRef({});
            const menuRef = useRef(null);
            const isClickScroll = useRef(false);

            useEffect(() => {
                const savedFavs = localStorage.getItem('cb_favorites');
                if (savedFavs) setFavorites(JSON.parse(savedFavs));
                const savedHistory = localStorage.getItem('cb_history');
                if (savedHistory) setOrderHistory(JSON.parse(savedHistory));
                const savedUser = localStorage.getItem('cb_user_info');
                if (savedUser) setUserInfo(JSON.parse(savedUser));
                const savedCoupons = localStorage.getItem('cb_my_coupons');
                if (savedCoupons) setMyCoupons(JSON.parse(savedCoupons));
            }, []);

            useEffect(() => { localStorage.setItem('cb_favorites', JSON.stringify(favorites)); }, [favorites]);
            useEffect(() => { localStorage.setItem('cb_my_coupons', JSON.stringify(myCoupons)); }, [myCoupons]);
            
			useEffect(() => {
				const unsub = window.onAuthStateChanged(window.auth, (user) => {
					setCurrentUser(user);
					// ... (略)
				});
				return () => unsub();
			}, [isGuest]);

            // ==========================================
            //  LIFF Initialization & Firebase Auth Bridge (修正版)
            // ==========================================          
			useEffect(() => {
                const initSystem = async () => {
                    // ★ 1. 設定安全計時器：如果 5 秒後還沒載入完，強制解除 Loading
                    const safetyTimer = setTimeout(() => {
                        console.warn("系統回應逾時，強制進入...");
                        setIsInitLoading(false);
                        // 如果還卡在 loading 狀態，強制切換到模式選擇頁
                        setViewState(prev => prev === 'loading' ? 'landing_mode' : prev);
                    }, 5000);

                    try {
                        const params = new URLSearchParams(window.location.search);
                        const tableParam = params.get('table'); 
                        
                        // 初始化 LIFF
                        if (window.liff) {
                            try {
                                await window.liff.init({ liffId: LIFF_ID_ORDER });
                            } catch (err) {
                                console.error("LIFF Init Failed", err);
                            }
                        }

                        const isInClient = window.liff ? window.liff.isInClient() : false;
                        const isLoggedIn = window.liff ? window.liff.isLoggedIn() : false;

                        // --- 場景 A: 外部瀏覽器掃碼 (顯示分流頁) ---
                        if (tableParam && !isInClient) {
                            console.log("Mode: External Browser Scan");
                            setTableNumber(tableParam);
                            setViewState('landing_guest'); 
                            return; // 這裡 return 會觸發 finally，關閉 Loading
                        }

                        // --- 場景 B: LINE App 內部 (一律顯示模式選擇) ---
                        if (isInClient || isLoggedIn) {
                            if (!isLoggedIn) {
                                window.liff.login({ redirectUri: window.location.href });
                                return;
                            }

                            // 嘗試登入 Firebase
                            if (!window.auth.currentUser) {
                                try {
                                    const idToken = window.liff.getIDToken();
                                    const lineLoginFn = window.httpsCallable(window.functions, 'lineLogin');
                                    // 這裡可能會因為 signBlob 報錯，但會被 catch 抓住
                                    const result = await lineLoginFn({ lineIdToken: idToken });
                                    if (result.data && result.data.token) {
                                        await window.signInWithCustomToken(window.auth, result.data.token);
                                    }
                                } catch (e) {
                                    console.error("自動登入失敗 (可能是權限問題):", e);
                                    // 失敗了沒關係，程式繼續往下跑，讓使用者至少能當訪客
                                }
                            }
                        }
                        
                        // 設定為模式選擇頁 (歡迎光臨)
                        setViewState('landing_mode');

                    } catch (err) {
                        console.error("System Init Error:", err);
                        setViewState('landing_mode');
                    } finally {
                        // ★ 2. 關鍵：無論成功或失敗，這行一定會執行，確保 Loading 消失
                        clearTimeout(safetyTimer);
                        setAuthLoading(false);
                        setIsInitLoading(false);
                    }
                };

                initSystem();
            }, []);

            useEffect(() => {
                const { db, appId, onSnapshot, doc, collection } = window;
                if (!db) return;
                const unsubs = [];
                const sub = (coll, setter) => unsubs.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', coll), snap => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if(coll === 'categories') {
                        list.sort((a,b) => a.sortOrder - b.sortOrder);
                        if(!activeCategory && list.length > 0) setActiveCategory(list[0].id);
                    }
                    if(coll === 'products' || coll === 'sets') list.sort((a,b) => a.sortOrder - b.sortOrder);
                    if(coll === 'materials' || coll === 'addons') list.sort((a,b) => (a.sortOrder||0) - (b.sortOrder||0));
                    setter(list);
                }));

                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), d => { 
                    if (d.exists()) setSettings(d.data()); 
                    else onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), gd => { if(gd.exists()) setSettings(gd.data()); });
                });

                sub('categories', setCategories);
                sub('products', setProducts);
                sub('sets', setSets);
                sub('addons', setAddons);
				sub('organizations', setOrganizations);
                sub('materials', setMaterials);
                sub('coupons', setCoupons);

                return () => unsubs.forEach(fn => fn());
            }, []);
            

            // [Updated] 使用者資料資料同步
            useEffect(() => {
                // 情境 1: 訪客模式 -> 不檢查資料庫，直接通行
                if (isGuest) {
                    setIsProfileComplete(true);
                    setIsCheckingProfile(false);
                    return;
                }

                // 情境 2: [關鍵] 還沒完成 Firebase 登入 -> 絕對不執行 onSnapshot
                // 這解決了 request.auth 為 null 導致的 Permission Denied 錯誤
                if (!currentUser) {
                    setIsProfileComplete(false);
                    return; 
                }

                setIsCheckingProfile(true); 

                const { db, appId, doc, onSnapshot } = window;
                if (!db) return;

                // 只有當 currentUser 存在時才監聽
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid);

                const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        setUserProfile(data);
                        setUserInfo(prev => ({
                            ...prev,
                            name: data.name || '',
                            phone: data.phone || '',
                            contactMethod: data.contactMethod || 'line'
                        }));
                        if (data.myCoupons) setMyCoupons(data.myCoupons);

                        // 檢查：是否有姓名與電話？
                        if (data.name && data.phone) {
                            setIsProfileComplete(true);
                            setShowRegisterModal(false); // 資料補齊後自動關閉註冊窗
                        } else {
                            setIsProfileComplete(false);
                        }
                    } else {
                        // 新用戶 (無資料)
                        setIsProfileComplete(false);
                        setUserProfile(null);
                    }
                    setIsCheckingProfile(false); // 檢查結束
                }, (error) => {
                    console.error("Firestore read error:", error);
                    setIsCheckingProfile(false);
                });

                return () => unsubscribe();
            }, [currentUser, isGuest]);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const orderIdFromUrl = params.get('id');
                
                // 只有當基礎資料 categories 載入後才執行判斷
                if (categories.length > 0) {
                    if (orderIdFromUrl) {
                        const targetOrder = orderHistory.find(o => o.id === orderIdFromUrl);
                        if (targetOrder) {
                            setSelectedOrderDetail(targetOrder);
                            
                            // ★ 關鍵修正：成功開啟訂單後，立刻清除網址上的 ID 參數
                            // 這樣下次 orderHistory 更新時，就不會因為讀到舊 ID 而再次跳轉
                            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                            window.history.replaceState({path: newUrl}, '', newUrl);

                            // 延遲關閉載入，確保詳情頁已準備好
                            setTimeout(() => setIsInitLoading(false), 500);
                            return; 
                        }
                        // 如果有 ID 但還沒在 history 找到，先不關閉 loading，等待 history 更新
                        if (orderHistory.length === 0) return; 
                    }
                    // 無參數或已處理完畢，關閉啟動頁
                    setTimeout(() => setIsInitLoading(false), 800);
                }
            }, [categories, orderHistory]);

            useEffect(() => {
                const isLocked = selectedItem || showCartModal || selectedOrderDetail || showInfoModal || selectionModal || showSubmitConfirm;
                if (isLocked) {
                    document.body.classList.add('body-lock');
                } else {
                    document.body.classList.remove('body-lock');
                }
                return () => document.body.classList.remove('body-lock');
            }, [selectedItem, showCartModal, selectedOrderDetail, showInfoModal, selectionModal, showSubmitConfirm]);

            const showAlert = (msg) => { setMessageModal({ show: true, content: msg }); };
            const dayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];

            const getAvailableDates = () => {
                const dates = [];
                const nowTw = getTaiwanDate(); // 使用剛剛新增的台灣時間工具
                let dayOffset = 0;
                let foundCount = 0;

                // 使用 while 迴圈，直到找到 3 個有營業的日子為止
                // 設定 dayOffset < 14 是為了避免設定錯誤導致無窮迴圈
                while (foundCount < 3 && dayOffset < 14) {
                    const d = new Date(nowTw);
                    d.setDate(nowTw.getDate() + dayOffset);
                    
                    // 格式化成 YYYY-MM-DD
                    const dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                    const dayOfWeek = d.getDay();
                    
                    let isAvailable = true;

                    // 1. 檢查每週固定公休
                    if (settings.closedDays?.includes(dayOfWeek)) isAvailable = false;
                    
                    // 2. 檢查特殊日期設定
                    const special = settings.specialDates?.find(sd => sd.date === dateStr);
                    if (special) {
                        if (special.type === 'closed') isAvailable = false;
                        else if (special.type === 'open') isAvailable = true;
                    }

                    // 3. 如果是「今天」，檢查是否已經超過最後點餐時間
                    if (dayOffset === 0 && isAvailable) {
                        const currentMinutes = nowTw.getHours() * 60 + nowTw.getMinutes();
                        const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                        // 最後點餐時間為打烊前 15 分鐘
                        const lastOrderTime = (eh * 60 + em) - 15;
                        if (currentMinutes > lastOrderTime) isAvailable = false; 
                    }

                    if (isAvailable) {
                        // 產生顯示文字 (今天、明天、日期+星期)
                        let label = "";
                        if (dayOffset === 0) label = `今天 (${d.getMonth()+1}/${d.getDate()})`;
                        else if (dayOffset === 1) label = `明天 (${d.getMonth()+1}/${d.getDate()})`;
                        else label = `${d.getMonth()+1}/${d.getDate()} (${dayNames[dayOfWeek]})`;

                        dates.push({ value: dateStr, label: label });
                        foundCount++;
                    }
                    
                    dayOffset++;
                }
                return dates;
            };

            const checkIsOpenNow = () => {
                const now = new Date();
                const [oh, om] = (settings.openTime || "06:00").split(':').map(Number);
                const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
                return currentTotalMinutes >= (oh * 60 + om) && currentTotalMinutes <= (eh * 60 + em);
            };

            const getAvailableHours = (dateStr) => {
                if (!dateStr) return [];
                const hours = [];
                const [oh, om] = (settings.openTime || "06:00").split(':').map(Number);
                const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                let startH = oh;
                const endH = eh;
                
                // ★ 改用台灣時間
                const now = getTaiwanDate();
                const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                
                const isToday = dateStr === todayStr;
                if (isToday) {
                    const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
                    let nextSlot = currentTotalMinutes + 15;
                    nextSlot = Math.ceil(nextSlot / 5) * 5;
                    startH = Math.floor(nextSlot / 60);
                }
                for (let h = startH; h <= endH; h++) { hours.push(h); }
                return hours;
            };

            const getAvailableMinutes = (dateStr, hour) => {
                if (!dateStr || hour === '') return [];
                const minutes = [];
                const h = parseInt(hour);
                const [oh, om] = (settings.openTime || "06:00").split(':').map(Number);
                const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                
                // ★ 改用台灣時間
                const now = getTaiwanDate();
                const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                
                const isToday = dateStr === todayStr;
                const minTotal = oh * 60 + om + 15;
                const maxTotal = eh * 60 + em - 15;
                for (let m = 0; m < 60; m += 5) {
                    const currentSlotTotal = h * 60 + m;
                    if (currentSlotTotal < minTotal || currentSlotTotal > maxTotal) continue;
                    if (isToday) {
                         const nowTotal = now.getHours() * 60 + now.getMinutes();
                         if (currentSlotTotal < nowTotal + 15) continue;
                    }
                    minutes.push(m);
                }
                return minutes;
            };

            useEffect(() => { if (showCartModal) { const dates = getAvailableDates(); if (dates.length > 0 && !pickupDate) { setPickupDate(dates[0].value); } } }, [showCartModal, settings]);
            useEffect(() => { if (pickupDate) { setPickupHour(''); setPickupMinute(''); } }, [pickupDate]);

            const getDisplayPrice = (p) => { if (p.variants && p.variants.length > 0) { const prices = p.variants.map(v => v.price); const min = Math.min(...prices); const max = Math.max(...prices); if (min === max) return `$${min}`; return `$${min} 起`; } return `$${p.price}`; };

            const checkAvailability = (product) => {
                const outMaterialIds = materials.filter(m => m.isOut).map(m => m.id);
                if (product.materials && product.materials.some(id => outMaterialIds.includes(id))) return 'all_out'; 
                if (product.variants && product.variants.length > 0) {
                    const availableVariants = product.variants.filter(v => { const vMats = v.materials || []; return !vMats.some(id => outMaterialIds.includes(id)); });
                    if (availableVariants.length === 0) return 'all_out'; 
                    if (availableVariants.length < product.variants.length) return 'partial'; 
                }
                return 'ok';
            };

            const checkSetAvailability = (set) => {
                if (!set || !set.contents) return true;
                
                // 檢查每一個內容
                for (const content of set.contents) {
                    // 只檢查「固定 (fixed)」的餐點，因為「類別 (category)」通常有替代品，不用強制隱藏
                    if (content.type === 'fixed') {
                        const prod = products.find(p => p.id === content.productId);
                        // 如果找不到商品，或該商品已售完，則此套餐不可用
                        if (!prod || checkAvailability(prod) === 'all_out') {
                            return false;
                        }
                    }
                }
                return true;
            };

            const isOpenStatus = useMemo(() => {
                if (settings.statusMode === 'open') return true;
                if (settings.statusMode === 'closed') return false;
                const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Taipei" }));
                const todayStr = now.toISOString().split('T')[0];
                const currentTime = now.getHours() * 60 + now.getMinutes();
                const currentDay = now.getDay(); 
                const special = settings.specialDates?.find(sd => sd.date === todayStr);
                if (special) {
                    if (special.type === 'closed') return false;
                    const [sh, sm] = (settings.openTime || "06:00").split(':').map(Number);
                    const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                    return currentTime >= (sh*60+sm) && currentTime <= (eh*60+em);
                }
                if (settings.closedDays?.includes(currentDay)) return false;
                const [sh, sm] = (settings.openTime || "06:00").split(':').map(Number);
                const [eh, em] = (settings.closeTime || "13:30").split(':').map(Number);
                return currentTime >= (sh*60+sm) && currentTime <= (eh*60+em);
            }, [settings]);

            const filteredMenu = useMemo(() => {
                const term = searchTerm.trim().toLowerCase();
                return categories.map(cat => ({ ...cat, items: products.filter(p => { const matchSearch = !term || p.name.toLowerCase().includes(term); return p.categoryId === cat.id && !p.isHidden && matchSearch; }).sort((a,b) => a.sortOrder - b.sortOrder) })).filter(cat => cat.items.length > 0);
            }, [categories, products, searchTerm]);

            const addCoupon = async () => {
                const coupon = coupons.find(c => c.code === couponInput.trim().toUpperCase());
                if (coupon) {
                    if (myCoupons.some(c => c.code === coupon.code)) { showAlert("您已領取過此優惠券"); return; }
                    if (new Date(coupon.expiry) < new Date()) { showAlert("此優惠券已過期"); return; }
                    
                    const newCoupons = [...myCoupons, coupon];
                    setMyCoupons(newCoupons);
                    setCouponInput('');
                    showAlert("優惠券領取成功！");

                    // [New] 同步寫入 Firestore，讓後台能看到
                    if (currentUser) {
                        try {
                            const { db, appId, doc, setDoc } = window;
                            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid);
                            // 使用 merge: true 避免覆蓋掉原本的 name/phone 或特約身分
                            await setDoc(userRef, { myCoupons: newCoupons }, { merge: true });
                        } catch (e) {
                            console.error("無法儲存優惠券至伺服器:", e);
                        }
                    }
                } else { showAlert("無效的優惠代碼"); }
            };

            const handleOpenSelection = (type, id, categoryId, defaultPrice) => { setSelectionModal({ type, id, categoryId, defaultPrice }); };
			// [New] 處理固定餐點的編輯 (直接開啟設定視窗)
            const handleConfigureFixedItem = (type, index, product, defaultPrice) => {
                const defaultVariant = (product.variants && product.variants.length > 0) ? product.variants[0] : null;
                // 設定 selectionModal 狀態，讓 confirmConfiguration 知道要存回哪裡 (categoryId 為 null 因為不需要選商品)
                setSelectionModal({ type, id: index, categoryId: null, defaultPrice });
                // 直接設定 configuringProduct 開啟編輯視窗
                setConfiguringProduct({ product, variant: defaultVariant, addons: [] });
            };
            const handleProductSelectInModal = (prod) => {
                if ((!prod.variants || prod.variants.length === 0) && (!prod.allowAddons || prod.allowAddons.length === 0)) {
                    const choice = { id: prod.id, name: prod.name, price: prod.price, variantName: '', addons: [] };
                    if (selectionModal.type === 'side') { setSelectedSideGroups({ ...selectedSideGroups, [selectionModal.id]: choice }); }
                    else { setSelectedSetChoices({ ...selectedSetChoices, [selectionModal.id]: choice }); }
                    setSelectionModal(null);
                } else { 
                    const defaultVariant = (prod.variants && prod.variants.length > 0) ? prod.variants[0] : null;
                    setConfiguringProduct({ product: prod, variant: defaultVariant, addons: [] }); 
                }
            };
            const confirmConfiguration = () => {
                if (!configuringProduct) return;
                const { product, variant, addons: confAddons } = configuringProduct;
                if (product.variants && product.variants.length > 0 && !variant) { showAlert("請選擇規格"); return; }
                // ★ 新增：檢查子項目的客製化選項是否符合 Min/Max
                // 1. 取得子項目的分組設定
                const subGroupedAddons = getGroupedAddons(addons.filter(a => product.allowAddons?.includes(a.id)));
                // 2. 驗證
                const val = validateAddons(subGroupedAddons, confAddons.map(a => a.id));
                if (!val.valid) {
                    showAlert(val.msg);
                    return;
                }
                const finalPrice = (variant ? variant.price : product.price) + confAddons.reduce((sum, a) => sum + a.price, 0);
                const choice = { id: product.id, name: product.name, price: finalPrice, variantName: variant ? variant.name : '', addons: confAddons };
                if (selectionModal.type === 'side') { setSelectedSideGroups({ ...selectedSideGroups, [selectionModal.id]: choice }); }
                else { setSelectedSetChoices({ ...selectedSetChoices, [selectionModal.id]: choice }); }
                setConfiguringProduct(null);
                setSelectionModal(null);
            };

            const isSameItem = (item1, item2) => {
                if (item1.productId !== item2.productId) return false;
                if (item1.variantName !== item2.variantName) return false;
                if (item1.note?.trim() !== item2.note?.trim()) return false; // 備註不同視為不同商品
                
                // 深度比對 Set (套餐) ID
                if (item1.set?.id !== item2.set?.id) return false;

                // 輔助函式：將物件排序後轉字串比對
                const sortAndStringify = (obj) => {
                    if (!obj) return '';
                    if (Array.isArray(obj)) return JSON.stringify(obj.map(x => x.id).sort());
                    // 針對 SetChoices 或 SideGroups 這種 Key-Value 物件
                    const keys = Object.keys(obj).sort();
                    const simplified = keys.map(k => `${k}:${obj[k].id}:${JSON.stringify(obj[k].addons?.map(a=>a.id).sort())}`);
                    return JSON.stringify(simplified);
                };

                const addons1 = sortAndStringify(item1.addons);
                const addons2 = sortAndStringify(item2.addons);
                if (addons1 !== addons2) return false;

                const sides1 = sortAndStringify(item1.sideGroups);
                const sides2 = sortAndStringify(item2.sideGroups);
                if (sides1 !== sides2) return false;

                const setChoice1 = sortAndStringify(item1.setChoices);
                const setChoice2 = sortAndStringify(item2.setChoices);
                if (setChoice1 !== setChoice2) return false;

                return true;
            };

            const handleAddToCart = () => {
                if (!selectedItem) return;
                let unitPrice = selectedItem.price;
                let variantLabel = '';
                if (selectedItem.variants && selectedItem.variants.length > 0) {
                    if (!selectedVariant) { showAlert('請選擇規格'); return; }
                    unitPrice = selectedVariant.price;
                    variantLabel = selectedVariant.name;
                }
                let addonsTotal = selectedAddons.reduce((sum, ad) => sum + ad.price, 0);
                let sidesTotal = 0;
                selectedItem.sideGroups?.forEach(g => {
                    const choice = selectedSideGroups[g.id];
                    if (choice && g.allowChange && g.defaultProductId) {
                        const defProd = products.find(p => p.id === g.defaultProductId);
                        let defPrice = defProd ? defProd.price : 0;
                        if (defProd && g.defaultVariantName) { const dv = defProd.variants?.find(v => v.name === g.defaultVariantName); if (dv) defPrice = dv.price; }
                        sidesTotal += (choice.price - defPrice);
                    }
                });
                let setTotal = 0;
                if (selectedSet) {
                    setTotal += selectedSet.price;
                    selectedSet.contents?.forEach((c, idx) => {
                         const choice = selectedSetChoices[idx];
                         if (choice && c.type === 'category' && c.allowChange && c.defaultProductId) {
                             const defProd = products.find(p => p.id === c.defaultProductId);
                             let defPrice = defProd ? defProd.price : 0;
                             if (defProd && c.defaultVariantName) { const dv = defProd.variants?.find(v => v.name === c.defaultVariantName); if (dv) defPrice = dv.price; }
                             setTotal += (choice.price - defPrice);
                         }
                    });
                }
                const finalUnitPrice = unitPrice + addonsTotal + sidesTotal + setTotal;
                const newItem = { productId: selectedItem.id, name: selectedItem.name, image: selectedItem.image, variantName: variantLabel, variant: selectedVariant, unitPrice: finalUnitPrice, qty: itemCount, totalPrice: finalUnitPrice * itemCount, addons: selectedAddons, sideGroups: selectedSideGroups, set: selectedSet, setChoices: selectedSetChoices, note: itemNote };
                if (editingCartItem) {
                    const duplicateIndex = cart.findIndex(item => item.id !== editingCartItem.id && isSameItem(item, newItem));
                    if (duplicateIndex > -1) {
                         const newCart = [...cart]; newCart[duplicateIndex].qty += newItem.qty; newCart[duplicateIndex].totalPrice = newCart[duplicateIndex].unitPrice * newCart[duplicateIndex].qty;
                         setCart(newCart.filter(item => item.id !== editingCartItem.id));
                    } else { setCart(cart.map(item => item.id === editingCartItem.id ? { ...newItem, id: editingCartItem.id } : item)); }
                } else {
                    const existingItemIndex = cart.findIndex(item => isSameItem(item, newItem));
                    if (existingItemIndex > -1) { const newCart = [...cart]; newCart[existingItemIndex].qty += newItem.qty; newCart[existingItemIndex].totalPrice = newCart[existingItemIndex].unitPrice * newCart[existingItemIndex].qty; setCart(newCart); } else { setCart([...cart, { ...newItem, id: Date.now() }]); }
                }
                closeProductModal();
            };

            const openEditCartItem = (item) => {
                const prod = products.find(p => p.id === item.productId);
                if (!prod) return;
                setSelectedItem(prod); setItemCount(item.qty); setSelectedVariant(item.variant); setSelectedAddons(item.addons); setSelectedSideGroups(item.sideGroups || {}); setSelectedSet(item.set); setSelectedSetChoices(item.setChoices || {}); if (item.set) setExpandedSetId(item.set.id); setItemNote(item.note); setEditingCartItem(item); setShowCartModal(false); 
            };
            const closeProductModal = () => { setSelectedItem(null); setEditingCartItem(null); setItemCount(1); setSelectedVariant(null); setSelectedAddons([]); setSelectedSideGroups({}); setSelectedSet(null); setSelectedSetChoices({}); setItemNote(''); setExpandedSetId(null); if (editingCartItem) setShowCartModal(true); };
            const updateCartQty = (itemId, change) => { setCart(prevCart => prevCart.map(item => { if (item.id === itemId) { const newQty = Math.max(0, item.qty + change); return { ...item, qty: newQty, totalPrice: item.unitPrice * newQty }; } return item; }).filter(item => item.qty > 0)); };
            const removeFromCart = (itemId) => { setCart(prevCart => prevCart.filter(item => item.id !== itemId)); };
            const toggleFavorite = (e, prodId) => { e.stopPropagation(); if (favorites.includes(prodId)) setFavorites(favorites.filter(id => id !== prodId)); else setFavorites([...favorites, prodId]); };
            
            const reorder = (historyOrder) => {
                const newCartItems = historyOrder.items.map(oldItem => ({ ...oldItem, id: Date.now() + Math.random() }));
                setCart([...cart, ...newCartItems]);
                showAlert('已將訂單內容加入購物車');
                setCurrentView('menu');
            };
			
			// [Updated] 處理初次註冊
            const handleRegister = async (e) => {
                e.preventDefault();
                if (!currentUser) return;

                const formData = new FormData(e.target);
                const name = formData.get('reg_name').trim();
                const phone = formData.get('reg_phone').trim();
                
                if (!name || !phone) { showAlert("請填寫完整"); return; }

                try {
                    const { db, appId, doc, setDoc } = window;
                    // 寫入資料庫，這會觸發 onSnapshot，進而更新 isProfileComplete = true
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), {
                        name: name,
                        phone: phone,
                        updatedAt: new Date().toISOString()
                    }, { merge: true }); // 使用 merge 避免蓋掉 LINE 圖片
                    
                    showAlert("註冊成功！");
                    // 這裡不需要手動 setViewState，因為 listener 會自動處理
                } catch (err) {
                    console.error(err);
                    showAlert("註冊失敗");
                }
            };
			
			// [New] 處理會員資料更新
            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                if (!currentUser) return;
                
                const formData = new FormData(e.target);
                const newName = formData.get('edit_name').trim();
                const newPhone = formData.get('edit_phone').trim();

                if (!newName || !newPhone) { showAlert("請填寫完整姓名與電話"); return; }

                try {
                    const { db, appId, doc, setDoc } = window;
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid);
                    
                    // 更新 Firestore
                    await setDoc(userRef, {
                        name: newName,
                        phone: newPhone,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });

                    // 這裡不需要手動 setUseInfo，因為您的 onSnapshot 監聽器會自動偵測到變更並更新畫面
                    
                    setShowEditProfileModal(false);
                    showAlert("個人資料更新成功！");
                } catch (err) {
                    console.error("更新失敗:", err);
                    showAlert("更新失敗，請稍後再試");
                }
            };
			
            // [Updated] 預先驗證 (加入訪客與外送邏輯)
            const handlePreSubmit = () => {
                // 1. 訪客模式 (內用) -> 免驗證個資，直接通過
                if (isGuest) {
                    setShowSubmitConfirm(true);
                    return;
                }

                // 2. 外送模式 -> 檢查地址
                if (orderMode === 'delivery' && (!userInfo.address || userInfo.address.length < 5)) {
                    showAlert("請填寫完整外送地址");
                    return;
                }

                // 3. 會員模式 (內用/自取) -> 檢查姓名電話
                // 判斷邏輯：如果選了「帶入會員」就檢查 userProfile，否則檢查 userInfo (手動輸入)
                const targetName = useDefaultInfo ? (userProfile?.name || userInfo.name) : userInfo.name;
                const targetPhone = useDefaultInfo ? (userProfile?.phone || userInfo.phone) : userInfo.phone;

                if (!targetName || !targetPhone) {
                    showAlert("請填寫訂購人姓名與電話");
                    return;
                }

                setShowSubmitConfirm(true);
            };

            // CREATE FLEX MESSAGE FUNCTION
            const createFlexMessage = (order) => {
                const BRAND_COLOR = "#5B2274";
                const RED_COLOR = "#EF4444";
                const GREEN_COLOR = "#10B981";
                const TEXT_COLOR = "#1E293B";
                const SUB_TEXT_COLOR = "#64748B";

                const safeStr = (val, defaultVal = "-") => {
                    if (val === undefined || val === null) return defaultVal;
                    const s = String(val).trim();
                    return s === "" ? defaultVal : s;
                };
                
                const formatDateTime = (isoString) => {
                    if (!isoString) return "-";
                    try {
                        const d = new Date(isoString);
                        const twDate = new Date(d.toLocaleString("en-US", { timeZone: "Asia/Taipei" }));
                        return `${twDate.getFullYear()}/${String(twDate.getMonth() + 1).padStart(2, '0')}/${String(twDate.getDate()).padStart(2, '0')} ${String(twDate.getHours()).padStart(2, '0')}:${String(twDate.getMinutes()).padStart(2, '0')}`;
                    } catch (e) { return "-"; }
                };
                
                const userInfo = order.userInfo || {};
                const pickupDateDisplay = (safeStr(userInfo.pickupDate, "未設定")).replace(/-/g, '/');
                const pickupTimeDisplay = safeStr(userInfo.pickupTime, "未設定");
                const contactMethodText = userInfo.contactMethod === 'line' ? '優先 LINE 聯絡' : '優先電話聯絡';

                const generateItemRows = () => {
                    if (!Array.isArray(order.items) || order.items.length === 0) {
                        return [{ type: "text", text: "無餐點資料", color: SUB_TEXT_COLOR, align: "center" }];
                    }
                    return order.items.flatMap((item, index) => {
                        const rowContents = [];

                        // 1. 主標題列
                        rowContents.push({
                            type: "box", layout: "horizontal", margin: index > 0 ? "md" : "none",
                            contents: [
                                { type: "text", text: `${item.qty} x`, size: "md", color: TEXT_COLOR, flex: 1, weight: "bold" },
                                { type: "text", text: safeStr(item.name), size: "md", color: TEXT_COLOR, flex: 4, wrap: true, weight: "bold" },
                                { type: "text", text: `$${item.totalPrice}`, size: "md", color: TEXT_COLOR, flex: 2, align: "end", weight: "bold" }
                            ]
                        });

                        // 2. 規格
                        if (item.variantName) {
                            rowContents.push({
                                type: "text", text: `規格：${item.variantName}`, size: "xs", color: SUB_TEXT_COLOR, wrap: true, margin: "xs", offsetStart: "xxl"
                            });
                        }

                        // 3. 客製化 (修改：移除前綴)
                        if (Array.isArray(item.addons) && item.addons.length > 0) {
                            rowContents.push({
                                type: "text", 
                                text: item.addons.map(a => a.name).join(' / '), // 直接顯示內容，無前綴
                                size: "xs", 
                                color: SUB_TEXT_COLOR, 
                                wrap: true, 
                                margin: "xs", 
                                offsetStart: "xxl"
                            });
                        }

                        // 4. 附餐 (前綴為 "附餐：")
                        if (item.sideGroups && Object.keys(item.sideGroups).length > 0) {
                            rowContents.push({
                                type: "text", text: "附餐：", size: "xs", color: BRAND_COLOR, weight: "bold", margin: "sm", offsetStart: "xxl"
                            });
                            Object.values(item.sideGroups).forEach(side => {
                                let sideText = `• ${side.name}`;
                                if (side.variantName) sideText += ` (${side.variantName})`;
                                if (side.addons && side.addons.length > 0) sideText += ` / ${side.addons.map(a => a.name).join('/')}`;
                                rowContents.push({
                                    type: "text", text: sideText, size: "xs", color: SUB_TEXT_COLOR, wrap: true, margin: "xs", offsetStart: "xxl"
                                });
                            });
                        }

                        // 5. 升級套餐 (前綴為 "升級套餐：")
                        if (item.set) {
                            rowContents.push({
                                type: "text", text: `升級套餐：${item.set.name}`, size: "xs", color: BRAND_COLOR, weight: "bold", margin: "sm", offsetStart: "xxl"
                            });
                            if (item.set.contents) {
                                item.set.contents.forEach((c, i) => {
                                    const choice = item.setChoices ? item.setChoices[i] : null;
                                    let contentText = "";
                                    
                                    if (choice) {
                                        contentText = `• ${choice.name}`;
                                        if (choice.variantName) contentText += ` (${choice.variantName})`;
                                        if (choice.addons && choice.addons.length > 0) contentText += ` / ${choice.addons.map(a => a.name).join('/')}`;
                                    } else if (c.type === 'fixed') {
                                        const fixedProd = products.find(p => p.id === c.productId);
                                        if (fixedProd) {
                                            contentText = `• ${fixedProd.name}`;
                                            if (c.variantName) contentText += ` (${c.variantName})`;
                                        } else {
                                            contentText = "• (固定餐點)";
                                        }
                                    }

                                    if (contentText) {
                                        rowContents.push({
                                            type: "text", text: contentText, size: "xs", color: SUB_TEXT_COLOR, wrap: true, margin: "xs", offsetStart: "xxl"
                                        });
                                    }
                                });
                            }
                        }

                        // 6. 備註
                        if (item.note) {
                            rowContents.push({
                                type: "text", text: `備註：${item.note}`, size: "xs", color: "#F97316", wrap: true, margin: "xs", offsetStart: "xxl"
                            });
                        }

                        if (index < order.items.length - 1) {
                            rowContents.push({ type: "separator", margin: "md" });
                        }
                        
                        return rowContents;
                    });
                };

                return {
                    type: "flex",
                    altText: `新訂單通知：${safeStr(userInfo.name, "顧客")}`.replace(/\n/g, " ").trim(),
                    contents: {
                        type: "bubble",
                        body: {
                            type: "box", layout: "vertical",
                            contents: [
                                { type: "text", text: "城市漢堡 虎尾光復店", weight: "bold", color: BRAND_COLOR, size: "md", align: "center" },
                                {
                                    type: "box", layout: "horizontal", justifyContent: "center", alignItems: "center", margin: "md",
                                    contents: [
                                        { type: "text", text: "新訂單通知", size: "xl", color: RED_COLOR, weight: "bold", flex: 0 },
                                        {
                                            type: "box", layout: "vertical", backgroundColor: RED_COLOR, cornerRadius: "md", paddingStart: "lg", paddingEnd: "lg", paddingTop: "xs", paddingBottom: "xs", margin: "md", flex: 0,
                                            contents: [{ type: "text", text: "自取", color: "#ffffff", size: "lg", weight: "bold" }]
                                        }
                                    ]
                                },
                                {
                                    type: "box", layout: "horizontal", justifyContent: "center", margin: "xl",
                                    contents: [{
                                        type: "box", layout: "vertical", backgroundColor: BRAND_COLOR, cornerRadius: "md", paddingAll: "sm", width: "100px",
                                        contents: [{ type: "text", text: "取餐時間", color: "#ffffff", size: "sm", weight: "bold", align: "center" }]
                                    }]
                                },
                                { type: "text", text: safeStr(pickupDateDisplay), size: "xl", weight: "bold", align: "center", margin: "md", color: BRAND_COLOR },
                                { type: "text", text: safeStr(pickupTimeDisplay), size: "4xl", weight: "bold", align: "center", color: BRAND_COLOR },
                                { type: "separator", margin: "xl", color: TEXT_COLOR },
                                { type: "box", layout: "vertical", margin: "lg", spacing: "xs", contents: generateItemRows() },
                                { type: "separator", margin: "lg", color: TEXT_COLOR },
                                { type: "text", text: "訂單總金額", size: "md", weight: "bold", align: "center", color: TEXT_COLOR, margin: "lg" },
                                { type: "text", text: `$${order.totalPrice}`, size: "4xl", weight: "bold", align: "center", color: TEXT_COLOR, margin: "sm" },
                                ...(order.discountAmount > 0 ? [{
                                    type: "box", layout: "horizontal", justifyContent: "center", alignItems: "center", margin: "md",
                                    contents: [
                                        { type: "text", text: "折扣優惠：", size: "md", color: TEXT_COLOR, flex: 0 },
                                        {
                                            type: "box", layout: "vertical", backgroundColor: RED_COLOR, cornerRadius: "md", paddingStart: "sm", paddingEnd: "sm", flex: 0, margin: "sm",
                                            contents: [{ type: "text", text: order.discountApplied === 'loyalty' ? "集點卡" : "優惠券", color: "#ffffff", size: "xs", weight: "bold" }]
                                        },
                                        { type: "text", text: `-$${order.discountAmount}`, color: RED_COLOR, size: "md", weight: "bold", margin: "sm" }
                                    ]
                                }] : []),
                                { type: "separator", margin: "lg", color: TEXT_COLOR },
                                {
                                    type: "box", layout: "baseline", margin: "lg",
                                    contents: [
                                        { type: "text", text: "訂單編號：", size: "sm", color: SUB_TEXT_COLOR, flex: 0 },
                                        { type: "text", text: safeStr(order.orderId), size: "sm", color: TEXT_COLOR, weight: "bold", flex: 1 }
                                    ]
                                },
                                {
                                    type: "box", layout: "baseline", margin: "sm",
                                    contents: [
                                        { type: "text", text: "訂餐時間：", size: "sm", color: SUB_TEXT_COLOR, flex: 0 },
                                        { type: "text", text: formatDateTime(order.createdAt), size: "sm", color: TEXT_COLOR, flex: 1 }
                                    ]
                                },
                                { type: "separator", margin: "lg", color: TEXT_COLOR },
                                {
                                    type: "box", layout: "baseline", margin: "lg",
                                    contents: [
                                        { type: "text", text: "取餐人：", size: "md", color: SUB_TEXT_COLOR, flex: 0 },
                                        { type: "text", text: safeStr(userInfo.name), size: "md", color: TEXT_COLOR, weight: "bold", flex: 1, wrap: true }
                                    ]
                                },
                                {
                                    type: "box", layout: "baseline", margin: "md",
                                    contents: [
                                        { type: "text", text: "連絡電話：", size: "md", color: SUB_TEXT_COLOR, flex: 0 },
                                        { type: "text", text: safeStr(userInfo.phone), size: "md", color: TEXT_COLOR, weight: "bold", flex: 1 }
                                    ]
                                },
                                {
                                    type: "box", layout: "horizontal", margin: "md",
                                    contents: [{
                                        type: "box", layout: "vertical", backgroundColor: GREEN_COLOR, cornerRadius: "md", paddingTop: "xs", paddingBottom: "xs", flex: 1,
                                        contents: [{ type: "text", text: safeStr(contactMethodText), color: "#ffffff", size: "lg", weight: "bold", align: "center" }]
                                    }]
                                }
                            ].filter(Boolean)
                        },
                        footer: {
                            type: "box",
                            layout: "vertical",
                            spacing: "sm",
                            contents: [
                                {
                                    type: "button",
                                    style: "primary",
                                    color: "#5B2274",
                                    height: "sm",
                                    action: {
                                        type: "uri",
                                        label: "查看訂單進度",
                                        uri: `https://liff.line.me/${settings.liffId}?id=${order.id}`
                                    }
                                },
                                {
                                    type: "text",
                                    text: "點擊按鈕可隨時追蹤餐點狀態",
                                    size: "xs",
                                    color: "#BCBCBC",
                                    align: "center",
                                    margin: "sm"
                                }
                            ]
                        }
                    }
                };
            };
            
            // [Updated] 送出訂單 (支援 訪客/內用/外送)
            const confirmSubmitOrder = async () => {
                // 1. 準備訂購人資料 (Final User Info)
                let finalUserInfo = {};

                if (isGuest) {
                    // --- 訪客 ---
                    // [Fix] 補上日期與時間，確保後台「今日訂單」能抓到資料
                    const todayStr = new Date().toLocaleDateString("en-CA", { timeZone: "Asia/Taipei" }).split(',')[0]; // 格式 YYYY-MM-DD
                    
                    finalUserInfo = {
                        name: 'Guest (訪客)',
                        phone: '現場結帳',
                        tableNumber: tableNumber || '',
                        contactMethod: 'none',
                        // 關鍵修正：必須寫入日期與時間
                        pickupDate: todayStr, 
                        pickupTime: '內用'
                    };
                } else {
                    // --- 會員 ---
                    // 根據「帶入會員」或「手動輸入」決定資料
                    finalUserInfo = {
                        ...userInfo,
                        name: useDefaultInfo ? (userProfile?.name || userInfo.name) : userInfo.name,
                        phone: useDefaultInfo ? (userProfile?.phone || userInfo.phone) : userInfo.phone,
                        // 若是外送，確保地址有寫入
                        address: orderMode === 'delivery' ? (userInfo.address || '') : '',
                        // 若是內用，寫入桌號
                        tableNumber: orderMode === 'dine_in' ? (tableNumber || '') : '',
                        
                        pickupDate, 
                        pickupTime: isASAP ? "ASAP" : `${pickupHour.toString().padStart(2, '0')}:${pickupMinute.toString().padStart(2, '0')}`
                    };
                }

                // 計算金額
                const total = orderCalc.final;
                const discountAmount = orderCalc.discount;
                const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);

                // 2. 判斷折扣來源標記
                let appliedArr = [];
                if (!isGuest && selectedCoupon) appliedArr.push(`coupon:${selectedCoupon.code}`); // 訪客無優惠券
                else if (!isGuest && userProfile?.role === 'affiliate' && userProfile?.orgId) appliedArr.push(`affiliate:${userProfile.orgId}`);
                
                if (useLoyaltyCard && settings.pointsEnabled) appliedArr.push('loyalty'); // 訪客也可以按集點(純備註)
                
                const discountTag = appliedArr.length > 0 ? appliedArr.join(',') : null;
                const randomId = `OD${Date.now().toString().slice(-6)}`;
                
                // 3. 建立訂單物件
                const newOrder = { 
                    orderId: randomId, 
                    items: cart, 
                    totalPrice: total, 
                    originalPrice: subtotal,
                    discountApplied: discountTag, 
                    discountAmount, 
                    
                    userInfo: finalUserInfo,
                    orderType: orderMode, // 'dine_in', 'pickup', 'delivery'

                    // 關鍵：訪客的 uid 設為 'guest'
                    customerUid: (currentUser && !isGuest) ? currentUser.uid : 'guest', 
                    
                    createdAt: new Date().toISOString(), 
                    status: 'pending',
                    read: false
                };

                try {
                    const { db, appId, addDoc, setDoc, doc, collection } = window;

                    // 4. 更新會員資料 (僅限 非訪客 且 已登入者)
                    // 訪客模式下，絕對不能執行這一段，否則會報錯或寫入錯誤資料
                    if (currentUser && !isGuest) {
                        const userUpdateData = {
                            contactMethod: finalUserInfo.contactMethod || 'line',
                            updatedAt: new Date().toISOString()
                        };
                        // 如果是強制註冊剛進來，順便補齊資料
                        if (!userProfile?.name) userUpdateData.name = finalUserInfo.name;
                        if (!userProfile?.phone) userUpdateData.phone = finalUserInfo.phone;

                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), userUpdateData, { merge: true });
                    }

                    // 清除本地暫存
                    localStorage.removeItem('cb_user_info');

                    // 5. 寫入訂單 (Everyone can do this)
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), newOrder);
                    
                    // 6. 傳送 LINE 訊息 (僅限 LIFF 環境)
                    const orderWithId = { ...newOrder, id: docRef.id };
                    if (window.liff && window.liff.isInClient() && !isGuest) {
                        // 訪客通常沒登入 LIFF，所以不送訊息，或者送不了
                        try {
                            const flexMessage = createFlexMessage(orderWithId);
                            await window.liff.sendMessages([flexMessage]);
                        } catch (err) {
                            console.error("LINE訊息傳送失敗 (可能是訪客或未授權)", err);
                        }
                    }

                    // 7. 重置與跳轉
                    setCart([]); 
                    setShowCartModal(false); 
                    setUseLoyaltyCard(false); 
                    setSelectedCoupon(null); 
                    setShowSubmitConfirm(false);
                    
                    // 訪客也可以看歷史紀錄嗎？
                    // 我們的架構是「訪客看不到 Tab」，但訂單送出後，
                    // 建議直接顯示「訂單成功頁」或是「跳轉到歷史紀錄(但只顯示剛下的那一單)」
                    // 簡單起見，我們先跳轉 history，因為 logic 會選中這筆單
                    setCurrentView('history');
                    setTimeout(() => {
                        setSelectedOrderDetail({ id: docRef.id });
                    }, 100);

                } catch (e) {
                    console.error("提交訂單失敗:", e);
                    // 如果是權限錯誤 (Permission Denied)，通常是因為 Firestore Rules 擋住了 guest
                    if (e.code === 'permission-denied') {
                        alert("系統權限錯誤：無法寫入訂單。請確認店家是否開放訪客點餐。");
                    } else {
                        alert("系統錯誤，請洽詢店家: " + e.message);
                    }
                }
            };

            const openCancelConfirm = (order) => { setCancelConfirmModal({ show: true, order }); };

            const confirmCancelOrder = async () => {
                if (!cancelConfirmModal.order) return;
                
                const { db, appId, doc, updateDoc } = window;
                
                try {
                    const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', cancelConfirmModal.order.id);
                    
                    await updateDoc(orderRef, { 
                        status: 'cancelled',
                        updatedAt: new Date().toISOString()
                    });

                    setCancelConfirmModal({ show: false, order: null });
                    showAlert("訂單已成功取消");
                    
                } catch (e) {
                    console.error("取消訂單失敗:", e);
                    showAlert("取消失敗：請確認網路連線，或洽詢店家。");
                }
            };

            const cartTotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            const cartCount = cart.reduce((sum, item) => sum + item.qty, 0);

            // [Updated] 訂單優惠計算核心 (集點/優惠券/特約)
            const orderCalc = useMemo(() => {
                const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
                let discount = 0;
                let discountName = '';

                // 1. 基礎優惠 (Coupon vs Affiliate 擇一)
                // 優先權：若有選優惠券則使用優惠券，否則檢查特約身分
                if (selectedCoupon) {
                    const { type, value, minSpend, maxDiscount, name } = selectedCoupon;
                    // 檢查低消
                    if (!minSpend || subtotal >= minSpend) {
                        let d = 0;
                        if (type === 'percent') { // 百分比折扣
                            d = Math.round(subtotal * (value / 100));
                            if (maxDiscount > 0) d = Math.min(d, maxDiscount); // 上限檢查
                        } else if (type === 'step') { // 階梯式折扣
                            if (minSpend > 0) {
                                const steps = Math.floor(subtotal / minSpend);
                                d = steps * value;
                                if (maxDiscount > 0) d = Math.min(d, maxDiscount);
                            }
                        } else {
                            // fixed: 固定金額 (相容舊版)
                            d = value;
                        }
                        discount += d;
                        discountName = name;
                    }
                } 
                else if (userProfile?.role === 'affiliate' && userProfile?.orgId) {
                    // 特約機構優惠檢查
                    const org = organizations.find(o => o.id === userProfile.orgId);
                    const now = new Date();
                    const validUser = !userProfile.affiliateExpiry || new Date(userProfile.affiliateExpiry) >= now;
                    const validOrg = org && (!org.expiryDate || new Date(org.expiryDate) >= now);

                    if (validUser && validOrg) {
                        let d = 0;
                        if (org.schemeType === 'percent') {
                            d = Math.round(subtotal * (org.schemeValue / 100));
                        } else {
                            d = org.schemeValue;
                        }
                        discount += d;
                        discountName = `${org.name}特約`;
                    }
                }

                // 2. 集點折抵 (可疊加)
                if (useLoyaltyCard && settings.pointsEnabled) {
                    // 讀取後台設定值，若無則預設 50
                    const reward = Number(settings.pointRewardValue) || 50;
                    discount += reward;
                    discountName = discountName ? `${discountName} + 集點` : '集點回饋';
                }

                // 防止負數
                if (discount > subtotal) discount = subtotal;

                return { final: subtotal - discount, discount, name: discountName };
            }, [cart, useLoyaltyCard, selectedCoupon, userProfile, organizations, settings]);

            // [Important] 綁定計算結果至舊變數，保持相容性
            const finalTotal = orderCalc.final;

            const getCartItemQty = (prodId) => cart.filter(item => item.productId === prodId).reduce((sum, item) => sum + item.qty, 0);
            
            useEffect(() => {
                if (currentView !== 'menu' || !menuRef.current) return;

                const observer = new IntersectionObserver(
                    (entries) => {
                        // 如果是用點擊的，就不要觸發偵測 (避免亂跳)
                        if (isClickScroll.current) return;

                        // 找出所有正在「掃描線」範圍內的區塊
                        const visibleEntries = entries.filter(entry => entry.isIntersecting);
                        
                        // 如果有區塊進入範圍
                        if (visibleEntries.length > 0) {
                            // 通常抓第一個進入的就會是正確的
                            // 或者你可以稍微比較一下誰的 intersectionRatio 比較大
                            // 但在這個設定下，直接取最後一個進入的通常最準確
                            const target = visibleEntries[visibleEntries.length - 1];
                            setActiveCategory(target.target.id);
                        }
                    }, 
                    { 
                        root: menuRef.current,
                        // ★ 關鍵修改：創造一個位於頂部的「掃描線」
                        // 上方扣掉 5% (給一點緩衝)，下方扣掉 80% (完全忽略下方內容)
                        // 這樣焦點會完全集中在螢幕最上方
                        rootMargin: '-5% 0px -80% 0px',
                        threshold: 0
                    }
                );

                categories.forEach(cat => {
                    const el = categoryRefs.current[cat.id];
                    if (el) observer.observe(el);
                });

                return () => observer.disconnect();
            }, [categories, currentView]);

            const getGroupedAddons = (targetAddons) => { 
                const groups = {}; 
                targetAddons.forEach(a => { 
                    const cat = a.category || '其他'; 
                    if (!groups[cat]) groups[cat] = []; 
                    groups[cat].push(a); 
                }); 
                const definedGroups = settings.addonGroups || []; 
                
                const result = definedGroups.map(dg => ({ 
                    name: dg.name, 
                    items: (groups[dg.name] || []).sort((a,b) => (a.sortOrder||0) - (b.sortOrder||0)),
                    // ★ 讀取 minSelect / maxSelect，若無則給預設值
                    // 相容舊版 isRequired: true 等同於 min: 1
                    min: typeof dg.minSelect === 'number' ? dg.minSelect : (dg.isRequired ? 1 : 0), 
                    max: typeof dg.maxSelect === 'number' ? dg.maxSelect : 99 
                })).filter(g => g.items.length > 0); 
                
                const definedNames = definedGroups.map(dg => dg.name); 
                
                Object.keys(groups).forEach(catName => { 
                    if (!definedNames.includes(catName)) { 
                        result.push({ 
                            name: catName, 
                            items: groups[catName].sort((a,b) => (a.sortOrder||0) - (b.sortOrder||0)),
                            min: 0,
                            max: 99
                        }); 
                    } 
                }); 
                return result; 
            };

            // 2. 共用驗證函式：檢查是否符合 Min/Max
            const validateAddons = (groupedAddons, currentSelectedIds) => {
                for (const group of groupedAddons) {
                    // 計算該群組已選的數量 (比對 ID)
                    const selectedCount = currentSelectedIds.filter(id => group.items.some(item => item.id === id)).length;
                    
                    if (selectedCount < group.min) {
                        return { valid: false, msg: `「${group.name}」至少需選擇 ${group.min} 項` };
                    }
                    if (selectedCount > group.max) {
                        return { valid: false, msg: `「${group.name}」最多只能選擇 ${group.max} 項` };
                    }
                }
                return { valid: true, msg: '' };
            };

            // 3. 共用點擊處理函式：處理單選替換與多選限制
            const handleAddonToggle = (addon, group, currentSelected, setter) => {
                const isSelected = currentSelected.some(a => a.id === addon.id);
                
                if (isSelected) {
                    // 取消選取 (先允許取消，最後送出前再擋 min，這樣操作體驗較好)
                    setter(currentSelected.filter(a => a.id !== addon.id));
                } else {
                    // 新增選取
                    if (group.max === 1) {
                        // ★ 單選模式 (Radio)：直接替換同群組的舊選項
                        const otherGroupItemIds = group.items.map(i => i.id);
                        const cleanSelection = currentSelected.filter(a => !otherGroupItemIds.includes(a.id));
                        setter([...cleanSelection, addon]);
                    } else {
                        // ★ 多選模式：檢查上限
                        const currentGroupCount = currentSelected.filter(a => group.items.some(gi => gi.id === a.id)).length;
                        if (currentGroupCount >= group.max) {
                            showAlert(`「${group.name}」最多只能選擇 ${group.max} 項`);
                            return;
                        }
                        setter([...currentSelected, addon]);
                    }
                }
            };
            
            const groupedItemAddons = useMemo(() => { if (!selectedItem || !selectedItem.allowAddons) return []; const validAddons = addons.filter(a => selectedItem.allowAddons.includes(a.id)); return getGroupedAddons(validAddons); }, [selectedItem, addons, settings.addonGroups]);

            // [修正：白屏問題] 必須在 groupedItemAddons 之後才定義驗證邏輯
            
            const ProductCard = ({ item }) => {
                const availability = checkAvailability(item);
                const isSoldOut = availability === 'all_out';
                const isFav = favorites.includes(item.id);
                const qtyInCart = getCartItemQty(item.id);
                return (
                    <article onClick={() => setSelectedItem(item)} className={`flex items-start gap-4 transition-transform group cursor-pointer ${isSoldOut ? '' : 'active:scale-[0.98]'}`}>
                        <div className="w-24 h-24 rounded-2xl bg-slate-50 overflow-hidden shrink-0 shadow-sm relative aspect-square group-hover:shadow-md transition-all border border-slate-100">
                            <img src={getOptimizedImage(item.image, 300)} className={`w-full h-full object-cover transition-transform duration-500 ${isSoldOut ? 'grayscale opacity-70' : ''}`} loading="lazy" />
                            {isSoldOut && <div className="absolute inset-0 bg-black/10 flex items-center justify-center z-10"><span className="text-white font-black text-xs border-2 border-white px-1.5 py-0.5 rounded -rotate-12 bg-black/40">已售完</span></div>}
                            <div className={`absolute top-1 left-1 flex flex-col gap-0.5 z-20`}>{item.tags?.map(tId => { const tag = settings.productTags?.find(t => t.id === tId); return tag ? <span key={tId} className={`text-[8px] px-1.5 py-0.5 rounded-md font-bold shadow-sm ${TAG_COLORS[tag.color]}`}>{tag.label}</span> : null; })}</div>
                            <button onClick={(e) => toggleFavorite(e, item.id)} className="absolute top-1 right-1 p-1 rounded-full bg-white/80 shadow-sm z-30"><Icon name="heart" size={14} className={isFav ? "fill-red-500 text-red-500" : "text-slate-400"} /></button>
                        </div>
                        <div className={`flex-1 min-w-0 py-1 flex flex-col h-24 justify-between ${isSoldOut ? 'opacity-50' : ''}`}>
                            <div><h3 className="text-[16px] font-bold text-slate-900 truncate pr-2 leading-tight">{item.name}</h3><p className="text-[12px] text-slate-400 truncate mt-1 font-medium">{item.desc}</p></div>
                            <div className="flex justify-between items-end"><div className="flex flex-col"><span className="font-black text-[17px] text-[#5B2274]">{getDisplayPrice(item)}</span></div>{!isSoldOut && (qtyInCart > 0 ? <div className="w-7 h-7 rounded-full bg-[#5B2274] text-white flex items-center justify-center font-bold text-xs shadow-md">{qtyInCart}</div> : <button className="w-7 h-7 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center group-hover:bg-[#5B2274] group-hover:text-white transition-colors"><Icon name="plus" size={16} /></button>)}</div>
                        </div>
                    </article>
                );
            };

            if (isInitLoading || viewState === 'loading') {
                return (
                    <div className="splash-screen">
                        <div className="w-20 h-20 bg-[#5B2274] rounded-2xl flex items-center justify-center mb-4 shadow-xl">
                            <Icon name="Utensils" size={40} className="text-white" />
                        </div>
                        <h1 className="text-2xl font-black tracking-widest animate-pulse">CITY BURGER</h1>
                    </div>
                );
            }
			// [New] 資料檢查中 (顯示全白或 Loading)
            // 修改重點：只有在「正在檢查」且「沒有要顯示註冊視窗」的時候，才顯示 Loading
            // 這樣一旦 showRegisterModal 變成 true，這個 Loading 就會消失，讓底下的註冊視窗露出來
            if (currentUser && !isGuest && isCheckingProfile && !showRegisterModal && viewState !== 'landing_mode') {
                return (
                    <div className="splash-screen">
                        <div className="w-20 h-20 bg-[#5B2274] rounded-2xl flex items-center justify-center mb-4 shadow-xl">
                            <div className="w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                        </div>
                        <h1 className="text-lg font-bold text-slate-500">讀取會員資料中...</h1>
                    </div>
                );
            }
			
                // [修正：放在這裡，確保變數已定義]
            const validateSelection = () => {
                if (!selectedItem) return { valid: false, msg: '' };
                
                if (selectedItem.variants?.length > 0 && !selectedVariant) return { valid: false, msg: '請選擇規格' };

                if (selectedItem.sideGroups?.length > 0) {
                    for (const group of selectedItem.sideGroups) {
                        if (!selectedSideGroups[group.id]) return { valid: false, msg: `請選擇附餐內的 ${group.title || '項目'}` };
                    }
                }

                if (selectedSet && selectedSet.contents) {
                    for (let i = 0; i < selectedSet.contents.length; i++) {
                        const content = selectedSet.contents[i];
                        if (content.type === 'category' && !selectedSetChoices[i]) return { valid: false, msg: `請選擇套餐內的 ${content.label || '品項'}` };
                    }
                }

                // ★ 使用新的驗證函式
                const addonVal = validateAddons(groupedItemAddons, selectedAddons.map(a => a.id));
                if (!addonVal.valid) return addonVal;

                return { valid: true, msg: '' };
            };
            const selectionStatus = validateSelection();
            
            // --- 視圖 1: 內用身分選擇 (掃碼後顯示) ---
            if (viewState === 'landing_guest') {
                return (
                    <div className="fixed inset-0 bg-slate-50 flex flex-col items-center justify-center p-6 animate-fade-in z-50">
                        <div className="w-24 h-24 bg-white rounded-full shadow-xl flex items-center justify-center mb-6">
                            <span className="text-4xl">🍽️</span>
                        </div>
                        <h2 className="text-2xl font-[900] text-slate-800 mb-2">歡迎光臨</h2>
                        <p className="text-sm text-slate-500 font-bold mb-8">目前桌號：{tableNumber}</p>

                        <div className="w-full max-w-xs space-y-4">
                            {/* 路徑 A-1: LINE 會員登入 (跳轉至 App) */}
                            <button 
                                onClick={() => {
                                    // ★ 修改重點：傳送「乾淨」的 LIFF 網址，不帶 table 參數
                                    // 這樣進入 LINE 後，系統就會把使用者當作全新進入，顯示歡迎頁並要求選桌號
                                    const liffUrl = `https://liff.line.me/${LIFF_ID_ORDER}`; // 拿掉 ?table=${tableNumber}
                                    window.location.href = liffUrl;
                                }}
                                className="w-full bg-[#06C755] text-white py-4 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"
                            >
                                <Icon name="message-circle" size={24} /> LINE 會員點餐
                            </button>
                            
                            <p className="text-xs text-slate-400 text-center">累積點數・領取優惠・專屬紀錄</p>
							
                            <div className="relative py-4">
                                <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-300"></div></div>
                                <div className="relative flex justify-center text-xs"><span className="px-2 bg-slate-50 text-slate-400 font-bold">或</span></div>
                            </div>

                            {/* 路徑 A-2: 直接點餐 (訪客) */}
                            <button 
                                onClick={() => {
                                    setIsGuest(true);       // 標記為訪客
                                    setOrderMode('dine_in');// 內用模式
                                    setViewState('menu');   // 進入菜單 (訪客不受註冊限制)
                                }}
                                className="w-full bg-white text-slate-600 border-2 border-slate-200 py-4 rounded-2xl font-black text-lg hover:border-slate-400 active:scale-95 transition-all"
                            >
                                直接點餐 (免登入)
                            </button>
                        </div>
                    </div>
                );
            }
			
			if (viewState === 'landing_mode') {
                
                // [修改] 檢查註冊狀態 (加入讀取狀態判斷)
                const checkRegistration = () => {
                    // 1. 如果還在讀取資料，先擋住並提示
                    if (isCheckingProfile) {
                        showAlert("會員資料讀取中，請稍候...");
                        return false;
                    }

                    // 2. 如果已登入且資料不全，開啟註冊視窗並阻擋
                    if (currentUser && (!userProfile?.name || !userProfile?.phone)) {
                        setShowRegisterModal(true);
                        return false; 
                    }
                    return true;
                };

                // 處理點擊邏輯
                const handleModeClick = (mode) => {
                    if (!window.liff.isLoggedIn()) {
                        window.liff.login({ redirectUri: window.location.href });
                        return;
                    }
                    
                    // ★ 關鍵：點擊按鈕時才檢查資料完整性
                    if (!checkRegistration()) return;

                    // 通過檢查 -> 設定模式
                    if (mode === 'dine_in') {
                        setOrderMode('dine_in');
                        if (tableNumber) {
                            setViewState('menu'); 
                        } else {
                            setShowTableSelector(true);
                        }
                    } else {
                        setOrderMode('pickup'); 
                        setViewState('menu');
                    }
                };

                return (
                    <div className="min-h-screen bg-slate-50 p-6 flex flex-col items-center justify-center relative">
                        <div className="text-center mb-10">
                            <h2 className="text-2xl font-[900] text-slate-800">
                                {currentUser ? `Hi, ${currentUser.displayName || '會員'}` : '歡迎光臨'}
                            </h2>
                            <p className="text-slate-500 font-medium mt-2">今天想怎麼吃？</p>
                        </div>

                        <div className="w-full max-w-sm grid grid-cols-2 gap-4">
                            {/* 內用按鈕 */}
                            <button 
                                onClick={() => handleModeClick('dine_in')}
                                className="aspect-square bg-white rounded-3xl shadow-lg border-2 border-transparent hover:border-[#5B2274] flex flex-col items-center justify-center gap-4 transition-all active:scale-95 group"
                            >
                                <div className="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center text-[#5B2274] group-hover:scale-110 transition-transform">
                                    <Icon name="utensils" size={32} />
                                </div>
                                <span className="text-lg font-black text-slate-700">內用點餐</span>
                            </button>

                            {/* 外帶按鈕 */}
                            <button 
                                onClick={() => handleModeClick('pickup')}
                                className="aspect-square bg-white rounded-3xl shadow-lg border-2 border-transparent hover:border-[#06C755] flex flex-col items-center justify-center gap-4 transition-all active:scale-95 group"
                            >
                                <div className="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center text-[#06C755] group-hover:scale-110 transition-transform">
                                    <Icon name="shopping-bag" size={32} />
                                </div>
                                <span className="text-lg font-black text-slate-700">外帶自取</span>
                            </button>
                        </div>

                        {/* 桌號選擇器 (內用時顯示) */}
                        {showTableSelector && (
                            <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 animate-fade-in">
                                <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-xl font-black text-slate-800">請選擇桌號</h3>
                                        <button onClick={() => setShowTableSelector(false)} className="p-2 bg-slate-100 rounded-full"><Icon name="x" size={20} /></button>
                                    </div>
                                    <div className="grid grid-cols-4 gap-3">
                                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(num => (
                                            <button
                                                key={num}
                                                onClick={() => {
                                                    setTableNumber(num.toString());
                                                    setShowTableSelector(false);
                                                    setViewState('menu'); // 選完桌號進菜單
                                                }}
                                                className="aspect-square rounded-2xl bg-slate-50 hover:bg-[#5B2274] hover:text-white border font-black text-xl transition-all shadow-sm"
                                            >
                                                {num}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* 這裡也需要補上註冊視窗，因為 landing_mode 也會觸發檢查 */}
                        {showRegisterModal && (
                            <div className="fixed inset-0 bg-black/60 z-[110] flex items-center justify-center p-4 animate-fade-in">
                                <div className="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl relative">
                                    <div className="bg-[#5B2274] p-6 text-center">
                                        <h3 className="text-xl font-black text-white">會員註冊</h3>
                                        <p className="text-white/80 text-sm font-bold mt-1">請先完善資料</p>
                                    </div>
                                    <div className="p-6">
                                        <form onSubmit={handleRegister}>
                                            <div className="mb-4"><label className="block text-xs font-bold text-gray-500 mb-1">姓名</label><input name="reg_name" className="w-full border rounded-xl p-3 bg-slate-50" placeholder="請輸入姓名" required /></div>
                                            <div className="mb-4"><label className="block text-xs font-bold text-gray-500 mb-1">電話</label><input name="reg_phone" className="w-full border rounded-xl p-3 bg-slate-50" placeholder="請輸入電話" required /></div>
                                            <button type="submit" className="w-full bg-[#5B2274] text-white py-3 rounded-xl font-bold">確認註冊</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // --- 視圖 2: 外帶模式選擇 (遠端會員顯示) ---
            // --- 視圖: 模式選擇 (修正版：補回被 return 截斷的註冊視窗) ---
            if (viewState === 'menu') {
                
                // 1. 強制註冊擋板 (Gatekeeper)
                // 條件：已登入會員 (currentUser) 且 不是訪客 (!isGuest) 且 資料不完整 (!isProfileComplete)
                // 結果：顯示全螢幕強制註冊表單，不渲染下方的菜單
                if (currentUser && !isGuest && !isProfileComplete) {
                    return (
                        <div className="fixed inset-0 bg-slate-50 z-[9999] flex flex-col items-center justify-center p-6 animate-fade-in">
                            <div className="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl relative overflow-hidden text-center">
                                <div className="w-16 h-16 bg-[#5B2274] text-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                                    <Icon name="user-plus" size={32} />
                                </div>
                                <h2 className="text-2xl font-[900] text-slate-800 mb-2">會員資料確認</h2>
                                <p className="text-sm text-slate-500 font-bold mb-8">為了提供完整的點餐服務，<br/>請先綁定您的真實姓名與電話。</p>
                                
                                <form onSubmit={handleRegister} className="space-y-4 text-left">
                                    <div>
                                        <label className="text-xs font-black text-slate-400 ml-1 mb-1 block">您的姓名</label>
                                        <input name="reg_name" type="text" placeholder="請輸入姓名" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:border-[#5B2274]" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-black text-slate-400 ml-1 mb-1 block">手機號碼</label>
                                        <input name="reg_phone" type="tel" placeholder="請輸入手機號碼" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:border-[#5B2274]" required />
                                    </div>
                                    <button type="submit" className="w-full bg-[#5B2274] text-white py-4 rounded-xl font-black text-lg shadow-xl active:scale-95 transition-all mt-4">
                                        確認綁定
                                    </button>
                                </form>
                            </div>
                            <p className="mt-8 text-xs text-slate-400 font-bold">資料同步中...</p>
                        </div>
                    );
                }

                // 2. 正常的菜單主畫面 (資料完整 或 訪客)
                // 這裡就是您原本那段 <div className="h-full..."> 的內容
                return (
                    <div className="h-full flex flex-col overflow-hidden bg-[#F8F9FA]">
                        {/* Header */}
                        <header className="shrink-0 relative z-30 header-curve shadow-xl" style={{ backgroundColor: BRAND_COLOR }}>
                            <div className="px-6 pt-8 pb-10 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h1 className="text-2xl font-[900] text-white tracking-tight leading-none drop-shadow-md whitespace-nowrap">城市漢堡 虎尾光復店</h1>
                                    <div className="flex items-center gap-2">
                                        <div className={`px-3 py-1.5 rounded-full shadow-lg transition-all flex items-center gap-1.5 ${isOpenStatus ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}`}>
                                            <span className="relative inline-flex rounded-full h-2 w-2 bg-white animate-pulse"></span>
                                            <span className="text-[11px] font-black tracking-wide leading-none pt-0.5">{isOpenStatus ? '營業中' : '休息中'}</span>
                                        </div>
                                        <button onClick={() => setShowInfoModal(true)} className="w-8 h-8 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center text-white active:scale-95 transition-all border border-white/10 hover:bg-white/30"><Icon name="info" size={18} /></button>
                                    </div>
                                </div>

                                {orderMode !== 'initial' && (
                                    <div className="animate-fade-in">
                                        <div className="bg-white/20 backdrop-blur-md border border-white/10 rounded-xl px-3 py-2.5 flex items-center gap-3 shadow-sm">
                                            <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center shrink-0 border border-white/10">
                                                <Icon name={orderMode === 'dine_in' ? 'utensils' : (orderMode === 'pickup' ? 'shopping-bag' : 'bike')} size={16} className="text-white" />
                                            </div>
                                            <div className="flex flex-col leading-none text-white">
                                                <span className="text-[10px] opacity-80 font-bold mb-0.5">目前用餐方式</span>
                                                <span className="text-sm font-black tracking-wide">
                                                    {orderMode === 'dine_in' ? `內用 (桌號 ${tableNumber})` : (orderMode === 'pickup' ? '外帶自取' : '外送服務')}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="flex justify-between items-center text-white/90 text-[13px] font-bold px-1">
                                    <a href={settings.mapsUrl || "#"} target="_blank" className="flex items-center gap-1.5 active:opacity-70 hover:text-white transition-opacity max-w-[60%]"><Icon name="map-pin" size={16} className="opacity-80" /><span className="truncate">{settings.address || '載入中...'}</span></a>
                                    <a href={`tel:${settings.phone}`} className="flex items-center gap-1.5 active:opacity-70 hover:text-white transition-opacity"><Icon name="phone" size={16} className="opacity-80" />{settings.phone}</a>
                                </div>
                            </div>
                        </header>

                        {currentView === 'menu' && <SmartMarquee announcements={settings.announcements} />}

                        {currentView === 'menu' && (
                            <div className="px-6 mb-2 mt-4 relative z-30">
                                <div className="relative group">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 transition-colors z-10 pt-1"><SearchIcon active={isSearchActive} /></div>
                                    <input type="text" placeholder="想吃點什麼？" className="w-full bg-white rounded-2xl py-3.5 pl-12 pr-4 text-slate-700 placeholder:text-slate-400 font-bold shadow-md border border-slate-100 outline-none focus:ring-0 focus:border-slate-400 transition-all" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} onFocus={() => setIsSearchActive(true)} onBlur={() => setIsSearchActive(false)} />
                                </div>
                            </div>
                        )}

                        <div className="flex flex-1 overflow-hidden bg-white mt-1 relative">
                            {currentView === 'menu' && (
                                <>
                                    <nav className="w-24 bg-slate-50 border-r border-slate-100 overflow-y-auto no-scrollbar shrink-0 pt-2 pb-36">
                                        {filteredMenu.map(cat => (
                                            <button key={cat.id} onClick={() => { isClickScroll.current = true; setActiveCategory(cat.id); categoryRefs.current[cat.id]?.scrollIntoView({ behavior: 'smooth', block: 'start' }); setTimeout(() => isClickScroll.current = false, 800); }} className={`w-full py-5 px-1 text-[13px] font-black text-center relative transition-all duration-300 flex flex-col items-center gap-1.5 ${activeCategory === cat.id ? 'text-[#5B2274] bg-white shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>
                                                {activeCategory === cat.id && <div className="absolute left-0 top-1/2 -translate-y-1/2 h-8 w-1.5 rounded-r-full" style={{ backgroundColor: BRAND_COLOR }}></div>}
                                                <span className="z-10 leading-tight px-1">{cat.name}</span>
                                            </button>
                                        ))}
                                    </nav>
                                    <main ref={menuRef} className="flex-1 overflow-y-auto p-5 no-scrollbar scroll-smooth bg-white pb-36">
                                        {filteredMenu.map(cat => (
                                            <section key={cat.id} id={cat.id} ref={el => categoryRefs.current[cat.id] = el} className="mb-10">
                                                <div className="flex items-center gap-3 mb-6"><span className="text-lg font-[900] tracking-tight text-slate-800">{cat.name}</span><div className="h-1 w-1 bg-slate-200 rounded-full"></div><div className="h-[1px] bg-slate-100 flex-1"></div></div>
                                                <div className="grid grid-cols-1 gap-6">
                                                    {cat.items.map(item => <ProductCard key={item.id} item={item} />)}
                                                </div>
                                            </section>
                                        ))}
                                    </main>
                                </>
                            )}
                            {currentView === 'favorites' && (
                                <div className="flex-1 overflow-y-auto p-5 pb-36 no-scrollbar">
                                    <h2 className="text-xl font-black text-slate-800 mb-6 flex items-center gap-2"><Icon name="heart" className="text-red-500 fill-red-500" /> 我的收藏</h2>
                                    {favorites.length === 0 ? <div className="text-center text-slate-400 mt-20">還沒有收藏任何餐點喔</div> : (
                                        <div className="space-y-8">
                                            {categories.map(cat => {
                                                const favItems = products.filter(p => p.categoryId === cat.id && favorites.includes(p.id));
                                                if (favItems.length === 0) return null;
                                                return (
                                                    <section key={cat.id}>
                                                        <div className="flex items-center gap-3 mb-4"><span className="text-lg font-[900] tracking-tight text-slate-800">{cat.name}</span><div className="h-1 w-1 bg-slate-200 rounded-full"></div><div className="h-[1px] bg-slate-100 flex-1"></div></div>
                                                        <div className="grid grid-cols-1 gap-6">{favItems.map(item => <ProductCard key={item.id} item={item} />)}</div>
                                                    </section>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            )}
                            {currentView === 'coupons' && (
                                <div className="flex-1 overflow-y-auto p-5 pb-36">
                                    <h2 className="text-xl font-black text-slate-800 mb-6 flex items-center gap-2"><Icon name="ticket" className="text-slate-600" /> 優惠券專區</h2>
                                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-6">
                                        <p className="text-sm font-bold text-slate-500 mb-2">手動領取</p>
                                        <div className="flex gap-2">
                                            <input type="text" placeholder="輸入優惠代碼" className="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:border-[#5B2274]" value={couponInput} onChange={e => setCouponInput(e.target.value)} />
                                            <button onClick={addCoupon} className="bg-slate-800 text-white px-4 rounded-xl font-bold text-sm">新增</button>
                                        </div>
                                    </div>
                                    <div className="mb-8">
                                        <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-3">限時領取</h3>
                                        {coupons.filter(c => !c.isHidden && (!c.expiry || new Date(c.expiry) > new Date())).length === 0 ? (
                                            <div className="text-center text-slate-400 text-xs py-4 bg-slate-50 rounded-xl border border-dashed border-slate-200">目前沒有可領取的活動優惠券</div>
                                        ) : (
                                            <div className="space-y-3">
                                                {coupons.filter(c => !c.isHidden && (!c.expiry || new Date(c.expiry) > new Date())).map(coupon => {
                                                    const isClaimed = myCoupons.some(mc => mc.code === coupon.code);
                                                    return (
                                                        <div key={coupon.id} className={`p-4 rounded-2xl border flex items-center gap-4 relative overflow-hidden transition-all ${isClaimed ? 'bg-slate-50 border-slate-200 opacity-60' : 'bg-white border-purple-100 shadow-sm'}`}>
                                                            <div className={`w-14 h-14 rounded-full flex items-center justify-center font-black text-lg shrink-0 ${isClaimed ? 'bg-slate-200 text-slate-400' : 'bg-purple-50 text-[#5B2274]'}`}>{coupon.type === 'percent' ? `${coupon.value}%` : `$${coupon.value}`}</div>
                                                            <div className="flex-1 min-w-0"><h4 className="font-bold text-slate-800">{coupon.title}</h4><p className="text-xs text-slate-500 mt-0.5">{coupon.desc || '全品項適用'}</p></div>
                                                            <button disabled={isClaimed} onClick={() => { if (isClaimed) return; setMyCoupons([...myCoupons, coupon]); showAlert("領取成功！"); }} className={`px-3 py-1.5 rounded-lg text-xs font-bold ${isClaimed ? 'text-slate-400 bg-slate-100' : 'bg-[#5B2274] text-white active:scale-95'}`}>{isClaimed ? '已領取' : '領取'}</button>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                    <div>
                                        <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-3">我的票夾</h3>
                                        {myCoupons.length === 0 ? <div className="text-center text-slate-400 mt-4 text-sm">尚無優惠券</div> : (
                                            <div className="space-y-4">
                                                {myCoupons.map((coupon, idx) => (
                                                    <div key={idx} className="coupon-ticket bg-white p-4 shadow-sm filter drop-shadow-sm flex items-center gap-4 relative overflow-hidden">
                                                        <div className="w-16 h-16 bg-purple-50 rounded-lg flex items-center justify-center text-[#5B2274] font-black text-xl shrink-0">{coupon.type === 'percent' ? `${coupon.value}%` : `$${coupon.value}`}</div>
                                                        <div className="flex-1 min-w-0"><h3 className="font-black text-slate-800">{coupon.title}</h3><p className="text-xs text-slate-500 mt-1">{coupon.desc}</p><p className="text-[10px] text-slate-400 mt-2">有效期至 {coupon.expiry}</p></div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            {currentView === 'history' && (
                                <div className="flex-1 overflow-y-auto p-5 pb-36 no-scrollbar">
                                    <h2 className="text-xl font-black text-slate-800 mb-6 flex items-center gap-2"><Icon name="history" className="text-slate-600" /> 訂單紀錄</h2>
                                    {orderHistory.length === 0 ? (
                                        <div className="text-center text-slate-400 mt-20">尚無訂單紀錄</div>
                                    ) : (
                                        <div className="space-y-8">
                                            {orderHistory.filter(o => !['completed', 'cancelled'].includes(o.status)).length > 0 && (
                                                <section>
                                                    <div className="flex items-center gap-3 mb-4"><span className="text-sm font-black text-[#5B2274] bg-purple-50 px-3 py-1 rounded-full text-nowrap">進行中訂單</span><div className="h-[1px] bg-purple-100 flex-1"></div></div>
                                                    {orderHistory.filter(o => !['completed', 'cancelled'].includes(o.status)).map((order, idx) => (<OrderHistoryItem key={idx} order={order} onOpenDetail={setSelectedOrderDetail} />))}
                                                </section>
                                            )}
                                            {orderHistory.filter(o => ['completed', 'cancelled'].includes(o.status)).length > 0 && (
                                                <section>
                                                    <div className="flex items-center gap-3 mb-4"><span className="text-sm font-black text-slate-400 bg-slate-50 px-3 py-1 rounded-full text-nowrap">歷史紀錄</span><div className="h-[1px] bg-slate-100 flex-1"></div></div>
                                                    {orderHistory.filter(o => ['completed', 'cancelled'].includes(o.status)).map((order, idx) => (<OrderHistoryItem key={idx} order={order} onOpenDetail={setSelectedOrderDetail} />))}
                                                </section>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}
                            {currentView === 'account' && (
                                <div className="flex-1 overflow-y-auto p-5 pb-36 no-scrollbar">
                                    <h2 className="text-xl font-black text-slate-800 mb-6 flex items-center gap-2"><Icon name="user" className="text-slate-600" /> 我的帳戶</h2>
                                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-6 text-center">
                                        <div className="w-20 h-20 bg-slate-100 rounded-full mx-auto mb-4 flex items-center justify-center text-slate-400"><Icon name="user" size={40} /></div>
                                        <h3 className="text-lg font-black text-slate-800 mb-1">{userInfo.name || '親愛的會員'}</h3>
                                        <p className="text-sm text-slate-500 font-bold mb-4">{userInfo.phone || '尚未綁定電話'}</p>
                                        
                                        {!currentUser ? (
                                            <button onClick={() => window.liff?.login()} className="text-xs bg-[#06C755] text-white px-4 py-2 rounded-full font-bold shadow-sm active:scale-95">登入 LINE 帳號</button>
                                        ) : (
                                            <button onClick={() => setShowEditProfileModal(true)} className="text-xs bg-slate-100 text-slate-600 px-4 py-2 rounded-full font-bold hover:bg-slate-200 transition-colors flex items-center gap-1 mx-auto"><Icon name="pencil" size={12} /> 修改資料</button>
                                        )}
                                    </div>

									{/* 2. 特約會員卡 (動態顯示) */}
									<div className="mb-6">
										<h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-3">特約會員卡</h3>
										{userProfile?.role === 'affiliate' && userProfile?.orgId ? (
											(() => {
												const org = organizations.find(o => o.id === userProfile.orgId);
												const isExpired = userProfile.affiliateExpiry && new Date(userProfile.affiliateExpiry) < new Date();
												return (
													<div className={`relative overflow-hidden rounded-2xl p-6 shadow-lg text-white ${isExpired ? 'bg-slate-500' : 'bg-gradient-to-br from-[#5B2274] to-[#8B3D9D]'}`}>
														<div className="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
														
														<div className="flex justify-between items-start mb-8 relative z-10">
															<div className="flex items-center gap-2">
																<div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-md">
																	<Icon name="crown" size={16} className="text-white" />
																</div>
																<span className="font-bold tracking-wider text-sm opacity-90">特約貴賓</span>
															</div>
															{isExpired && <span className="bg-red-500 text-white text-[10px] px-2 py-1 rounded font-bold">已過期</span>}
														</div>

														<div className="relative z-10">
															<h4 className="text-2xl font-black mb-1">{org ? org.name : '載入中...'}</h4>
															<p className="text-xs text-white/60 font-bold mb-6">Affiliate Member</p>
															
															<div className="flex items-center gap-1.5 opacity-80">
																<Icon name="clock" size={12} />
																<span className="text-xs font-bold tracking-wide">
																	有效期限：{userProfile.affiliateExpiry || '永久有效'}
																</span>
															</div>
														</div>
													</div>
												);
											})()
										) : (
											<div className="bg-white p-6 rounded-2xl border border-dashed border-slate-200 text-center">
												<div className="w-12 h-12 bg-slate-50 text-slate-300 rounded-full mx-auto mb-3 flex items-center justify-center"><Icon name="credit-card" size={24} /></div>
												<p className="text-sm font-bold text-slate-400">您目前尚未綁定特約機構</p>
												<p className="text-xs text-slate-300 mt-1">請洽詢櫃台或特定合作單位</p>
											</div>
										)}
									</div>
								</div>
							)}
						</div>

						{/* Bottom Navigation (依身分顯示) */}
						{!isGuest ? (
							// --- 會員模式：顯示完整選單 ---
							<div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-200 py-2 pb-safe z-50">
								<div className="flex justify-around items-center">
									<button onClick={() => setCurrentView('menu')} className={`flex flex-col items-center gap-0.5 w-16 transition-colors ${currentView === 'menu' ? 'text-[#5B2274]' : 'text-slate-400'}`}>
										<Icon name="utensils" size={20} className={currentView === 'menu' ? 'fill-current' : ''} />
										<span className="text-[10px] font-bold">點餐</span>
									</button>
									<button onClick={() => setCurrentView('favorites')} className={`flex flex-col items-center gap-0.5 w-16 transition-colors ${currentView === 'favorites' ? 'text-[#5B2274]' : 'text-slate-400'}`}>
										<Icon name="heart" size={20} className={currentView === 'favorites' ? 'fill-current' : ''} />
										<span className="text-[10px] font-bold">收藏</span>
									</button>
									<button onClick={() => setCurrentView('coupons')} className={`flex flex-col items-center gap-0.5 w-16 transition-colors ${currentView === 'coupons' ? 'text-[#5B2274]' : 'text-slate-400'}`}>
										<Icon name="ticket" size={20} />
										<span className="text-[10px] font-bold">優惠券</span>
									</button>
									<button onClick={() => setCurrentView('history')} className={`flex flex-col items-center gap-0.5 w-16 transition-colors ${currentView === 'history' ? 'text-[#5B2274]' : 'text-slate-400'}`}>
										<Icon name="history" size={20} />
										<span className="text-[10px] font-bold">紀錄</span>
									</button>
									<button onClick={() => setCurrentView('account')} className={`flex flex-col items-center gap-0.5 w-16 transition-colors ${currentView === 'account' ? 'text-[#5B2274]' : 'text-slate-400'}`}>
										<Icon name="user" size={20} />
										<span className="text-[10px] font-bold">帳戶</span>
									</button>
								</div>
							</div>
						) : (
							// --- 訪客模式：隱藏導覽列 (或是只顯示極簡版) ---
							// 由於訪客只能點餐，且不能切換 View，這裡我們選擇「隱藏整個導覽列」或「只顯示購物車提示」
							// 建議：訪客模式下，直接隱藏底部導覽列，讓畫面更乾淨，
							// 因為他們除了點餐(Menu)之外沒有其他頁面可去。
							null
						)}

						{cart.length > 0 && currentView === 'menu' && (
							<div className="fixed bottom-20 left-4 right-4 z-40 animate-bounce-subtle">
								<button onClick={() => setShowCartModal(true)} className="w-full bg-[#5B2274] text-white p-4 rounded-2xl shadow-xl flex justify-between items-center hover:bg-[#4a1b5e] transition-colors"><div className="flex items-center gap-3"><div className="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">{cartCount}</div><span className="font-bold text-lg">查看購物車</span></div><span className="font-black text-xl">${cartTotal}</span></button>
							</div>
						)}

						{/* Message Modal */}
						{messageModal.show && (
							<div className="fixed inset-0 bg-black/60 z-[110] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={() => setMessageModal({ show: false, content: '' })}>
								<div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-slide-up text-center relative" onClick={e => e.stopPropagation()}>
									<div className="mb-4"><div className="w-12 h-12 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center mx-auto mb-2"><Icon name="info" size={24} /></div><p className="text-slate-700 font-bold leading-relaxed">{messageModal.content}</p></div>
									<button onClick={() => setMessageModal({ show: false, content: '' })} className="w-full py-3 rounded-xl font-bold bg-[#5B2274] text-white shadow-lg active:scale-95 transition-transform">好</button>
								</div>
							</div>
						)}

						{/* Cancel Confirmation Modal */}
						{cancelConfirmModal.show && (
							<div className="fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={() => setCancelConfirmModal({ show: false, order: null })}>
								<div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-slide-up text-center relative" onClick={e => e.stopPropagation()}>
									<div className="mb-4"><div className="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-2"><Icon name="alert-triangle" size={24} /></div><h3 className="text-xl font-[900] text-slate-800 mb-2">確定要取消訂單？</h3><p className="text-sm text-slate-500 font-bold">取消後將無法復原</p></div>
									<div className="flex gap-3"><button onClick={() => setCancelConfirmModal({ show: false, order: null })} className="flex-1 py-3 rounded-xl font-bold bg-slate-100 text-slate-600 active:scale-95 transition-transform">保留</button><button onClick={confirmCancelOrder} className="flex-1 py-3 rounded-xl font-bold bg-red-500 text-white shadow-lg active:scale-95 transition-transform">確認取消</button></div>
								</div>
							</div>
						)}

						{/* Selected Item Modal */}
						{selectedItem && (
							<div className="fixed inset-0 bg-black/80 z-[60] flex items-end sm:items-center justify-center p-0 sm:p-4 animate-fade-in backdrop-blur-sm" onClick={() => closeProductModal()}>
								<div className="bg-white w-full max-w-md rounded-t-[40px] sm:rounded-[40px] overflow-hidden shadow-2xl flex flex-col animate-slide-up max-h-[90vh]" onClick={e => e.stopPropagation()}>
									<div className="relative aspect-[16/9] w-full shrink-0 overflow-hidden bg-slate-100">
										<img src={getOptimizedImage(selectedItem.image, 800)} className={`w-full h-full object-cover ${checkAvailability(selectedItem) === 'all_out' ? 'grayscale opacity-50' : ''}`} />
										<button onClick={() => closeProductModal()} className="absolute top-4 right-4 bg-black/40 text-white p-2.5 rounded-full backdrop-blur-md active:scale-90 transition-transform z-10"><Icon name="x" size={24} /></button>
										{checkAvailability(selectedItem) === 'all_out' && <div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="bg-black/60 text-white text-3xl font-black px-6 py-2 border-4 border-white transform -rotate-6 tracking-widest uppercase">已售完</div></div>}
										<div className="absolute top-4 left-4 flex gap-1.5 flex-wrap z-20">{selectedItem.tags?.map(tId => { const tag = settings.productTags?.find(t => t.id === tId); return tag ? <span key={tId} className={`text-xs px-2 py-1 rounded-lg font-bold shadow-sm backdrop-blur-sm ${TAG_COLORS[tag.color]}`}>{tag.label}</span> : null; })}</div>
									</div>
									<div className="p-8 space-y-8 overflow-y-auto no-scrollbar bg-white pb-28">
										<div className="space-y-4">
											<div className="flex justify-between items-start"><h2 className="text-2xl font-black text-slate-900 leading-tight pr-4">{selectedItem.name}</h2><span className="text-2xl font-black text-[#5B2274]">{getDisplayPrice(selectedItem)}</span></div>
											{selectedItem.desc && <div className="space-y-1"><p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest">商品內容</p><p className="text-[14px] font-bold leading-relaxed text-slate-600">{selectedItem.desc}</p></div>}
											<p className="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded inline-block">※ 圖片僅供參考，餐點以實物為主</p>
											{selectedItem.note && checkAvailability(selectedItem) !== 'all_out' && <div className="p-3 bg-orange-50 border border-orange-200 rounded-xl flex gap-2 shadow-sm"><Icon name="info" size={20} className="text-orange-500 shrink-0 mt-0.5" /><p className="text-xs font-bold text-orange-800 leading-tight flex items-center">{selectedItem.note}</p></div>}
										</div>
										{selectedItem.variants?.length > 0 && (
											<div className="space-y-3">
												<p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">規格選擇</p>
												<div className="grid grid-cols-3 gap-2">
													{selectedItem.variants.map((v, i) => {
														const outMaterialIds = materials.filter(m => m.isOut).map(m => m.id);
														const isVariantOut = (v.materials || []).some(id => outMaterialIds.includes(id));
														const isSelected = selectedVariant?.name === v.name;
														return (<button key={i} disabled={isVariantOut} onClick={() => setSelectedVariant(v)} className={`flex flex-col justify-between items-center p-3 rounded-xl border transition-all ${isSelected ? 'border-[#5B2274] bg-purple-50 ring-2 ring-[#5B2274]' : 'bg-white border-slate-200'} ${isVariantOut ? 'opacity-50 cursor-not-allowed bg-slate-100' : ''}`}><span className={`text-sm font-bold whitespace-nowrap overflow-hidden text-ellipsis w-full text-center ${isVariantOut ? 'text-slate-500' : 'text-slate-700'}`}>{v.name}</span><div className="flex items-center gap-1 mt-1"><span className={`text-sm font-black whitespace-nowrap ${isVariantOut ? 'text-slate-400' : 'text-[#5B2274]'}`}>${v.price}</span>{isVariantOut && <span className="text-xs font-bold text-red-400 whitespace-nowrap">(售完)</span>}</div></button>);
													})}
												</div>
											</div>
										)}
										{groupedItemAddons.length > 0 && (
											<div className="space-y-4">
												<p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">客製化選項</p>
												{groupedItemAddons.map(group => (
													<div key={group.name} className="space-y-2">
														{/* 標題列加入限制提示 */}
														<div className="flex justify-between items-end">
															<p className="text-xs font-black text-slate-500">{group.name}</p>
															<span className="text-[10px] text-slate-400 font-bold">
																{group.max === 1 ? '(單選)' : (group.min > 0 ? `(選 ${group.min}~${group.max} 項)` : `(至多 ${group.max} 項)`)}
															</span>
														</div>
														<div className="grid grid-cols-2 gap-2">
															{group.items.map(ad => {
																const isSelected = selectedAddons.some(a => a.id === ad.id);
																return (
																	<button 
																		key={ad.id} 
																		// ★ 改用 handleAddonToggle
																		onClick={() => handleAddonToggle(ad, group, selectedAddons, setSelectedAddons)} 
																		className={`p-3 rounded-xl text-sm font-bold flex justify-between transition-all ${isSelected ? 'bg-[#5B2274] text-white' : 'bg-white border border-slate-200 text-slate-600'}`}
																	>
																		<span>{ad.name}</span> 
																		{ad.price > 0 && <span className={isSelected ? 'text-white/80' : 'text-[#5B2274]'}>+${ad.price}</span>}
																	</button>
																);
															})}
														</div>
													</div>
												))}
											</div>
										)}
										{selectedItem.sideGroups?.length > 0 && (
											<div className="space-y-3">
												<p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">附餐內容</p>
												<div className="space-y-3">
													{selectedItem.sideGroups.map((group, i) => {
														const targetCat = categories.find(c => c.id === group.categoryId);
														const defProd = products.find(p => p.id === group.defaultProductId);
														const choice = selectedSideGroups[group.id];
														let img = 'https://placehold.co/100x100?text=Side', name = group.title, variant = '', priceDiff = 0, defPrice = defProd ? defProd.price : 0;
														if (defProd && group.defaultVariantName) { const dv = defProd.variants?.find(v => v.name === group.defaultVariantName); if (dv) defPrice = dv.price; }
														if (choice) { const p = products.find(p => p.id === choice.id); if (p && p.image) img = getOptimizedImage(p.image, 200); name = choice.name; variant = choice.variantName ? `(${choice.variantName})` : ''; priceDiff = choice.price - defPrice; }
														else if (defProd) { img = getOptimizedImage(defProd.image, 200); name = defProd.name; if (group.defaultVariantName) variant = `(${group.defaultVariantName})`; }
														return (
															<div key={i} className={`flex gap-3 p-3 rounded-2xl border shadow-sm items-center transition-all ${group.allowChange ? 'cursor-pointer active:scale-98 border-purple-100 hover:border-purple-300' : 'border-slate-100 bg-white'}`} onClick={() => { if (group.allowChange && group.categoryId) handleOpenSelection('side', group.id, group.categoryId, defPrice); }}>
																<div className="w-14 h-14 rounded-xl bg-slate-50 border border-slate-100 overflow-hidden shrink-0 aspect-square"><img src={img} className="w-full h-full object-cover" /></div>
																<div className="flex-1 min-w-0 space-y-1"><p className="text-sm font-bold text-slate-800 truncate">{name} <span className="text-sm text-slate-500 font-bold">{variant}</span> {priceDiff !== 0 && <span className={`text-sm font-bold ml-1 ${priceDiff > 0 ? 'text-red-500' : 'text-green-500'}`}>{priceDiff > 0 ? `+$${priceDiff}` : `-$${Math.abs(priceDiff)}`}</span>}</p>{group.allowChange ? (<div className="flex items-center justify-between"><div className="flex items-center gap-1.5 text-[#5B2274]"><Icon name="check-circle-2" size={14} className="fill-[#5B2274] text-white" /><span className="text-[11px] font-bold">可更換同類別商品</span></div><button className="text-[10px] bg-purple-50 text-[#5B2274] px-2 py-0.5 rounded border border-purple-100 font-bold">更換</button></div>) : (<div className="flex items-center gap-1.5 text-slate-400"><Icon name="lock" size={14} /><span className="text-[11px] font-bold">固定附餐，不可更換</span></div>)}</div>
															</div>
														);
													})}
												</div>
											</div>
										)}
										{selectedItem.allowSets?.length > 0 && (
											<div className="space-y-3">
												<p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">升級套餐</p>
												<div className="space-y-3">
													{selectedItem.allowSets.map(setId => {
														const s = sets.find(set => set.id === setId); if (!s) return null;
														if (!checkSetAvailability(s)) return null;
														const isSelected = selectedSet?.id === setId, isExpanded = expandedSetId === setId || isSelected;
														let setImg = getOptimizedImage(s.image, 200) || 'https://placehold.co/100x100?text=Set';
														if (!s.image) { const fixedItem = s.contents?.find(c => c.type === 'fixed'); if (fixedItem) { const p = products.find(prod => prod.id === fixedItem.productId); if (p && p.image) setImg = getOptimizedImage(p.image, 200); } }
														return (
															<div key={setId} onClick={() => { if(isSelected) { setSelectedSet(null); setExpandedSetId(null); setSelectedSetChoices({}); } else { setSelectedSet(s); setExpandedSetId(setId); setSelectedSetChoices({}); } }} className={`rounded-2xl border shadow-sm overflow-hidden transition-all cursor-pointer ${isSelected ? 'border-[#5B2274] ring-2 ring-[#5B2274]' : 'border-slate-100 bg-white'}`}>
																<div className={`flex gap-3 p-3 items-center ${isSelected ? 'bg-purple-50' : 'bg-white'}`}><div className="w-16 h-16 rounded-xl bg-slate-100 border border-slate-100 overflow-hidden shrink-0 aspect-square"><img src={setImg} className="w-full h-full object-cover" /></div><div className="flex-1 min-w-0"><div className="flex justify-between items-center"><p className="text-sm font-bold text-slate-800 truncate">{s.name}</p><span className="text-sm font-black text-[#5B2274]">+${s.price}</span></div><div className="flex justify-between items-center mt-1"><span className="text-[10px] text-slate-400 font-bold">查看內容</span><div className={`w-5 h-5 rounded-full border flex items-center justify-center ${isSelected ? 'bg-[#5B2274] border-[#5B2274]' : 'border-slate-300'}`}>{isSelected && <Icon name="check" size={12} className="text-white" />}</div></div></div></div>
																{isExpanded && (
																	<div className="p-3 pt-0 border-t border-slate-100 animate-fade-in" onClick={e => e.stopPropagation()}>
																		{s.contents?.map((content, idx) => {
																			let contentImg = 'https://placehold.co/100x100?text=Item', contentName = content.label, contentSub = "", isChangeable = content.allowChange !== false, targetCatName = '', priceDiff = 0, defPrice = 0;
																			
																			// 1. 計算預設價格與顯示名稱
																			if (content.type === 'category' && content.defaultProductId) { 
																				const defProd = products.find(p => p.id === content.defaultProductId); 
																				defPrice = defProd ? defProd.price : 0; 
																				if (defProd && content.defaultVariantName) { const dv = defProd.variants?.find(v => v.name === content.defaultVariantName); if (dv) defPrice = dv.price; } 
																			} else if (content.type === 'fixed') {
																				// 固定餐點：基準價即為該商品價格
																				const fixedProd = products.find(p => p.id === content.productId);
																				if (fixedProd) {
																					defPrice = fixedProd.variants?.[0]?.price || fixedProd.price;
																				}
																			}

																			// 2. 取得目前選擇 (Choice)
																			const choice = selectedSetChoices[idx];
																			
																			if (choice && isSelected) { 
																				// 有選擇：顯示選擇的商品
																				const p = products.find(p => p.id === choice.id); 
																				if (p && p.image) contentImg = getOptimizedImage(p.image, 200); 
																				contentName = choice.name; 
																				contentSub = choice.variantName ? `(${choice.variantName})` : ''; 
																				if (choice.addons && choice.addons.length > 0) contentSub += (contentSub ? ' ' : '') + `+${choice.addons.length}加料`;
																				priceDiff = choice.price - defPrice; 
																			} else { 
																				// 無選擇：顯示預設資訊
																				if (content.type === 'fixed') { 
																					const p = products.find(prod => prod.id === content.productId); 
																					if (p) { 
																						contentImg = getOptimizedImage(p.image, 200); 
																						contentName = p.name; 
																						if (content.variantName) contentSub = content.variantName; 
																					} 
																					isChangeable = false; // 雖然不可換商品，但下面會允許點擊編輯規格
																				} else if (content.type === 'category') { 
																					const cat = categories.find(c => c.id === content.categoryId), defP = products.find(p => p.id === content.defaultProductId); 
																					if (defP) { 
																						contentImg = getOptimizedImage(defP.image, 200); 
																						contentName = content.label; 
																						contentSub = defP.name; 
																						if (content.defaultVariantName) contentSub += ` (${content.defaultVariantName})`; 
																					} 
																					if (cat) targetCatName = cat.name; 
																				} 
																			}

																			// 3. 渲染卡片 (修正點擊邏輯)
																			return (
																				<div 
																					key={idx} 
																					className={`flex gap-3 p-3 rounded-2xl border shadow-sm items-center transition-all 
																						${(content.type === 'category' && content.allowChange) || (content.type === 'fixed') ? 'cursor-pointer active:scale-98 border-purple-100 hover:border-purple-300' : 'bg-white border-slate-200'}`} 
																					onClick={() => { 
																						if (!isSelected) return; // 套餐未選取時不能點
																						
																						if (content.type === 'category' && content.allowChange) {
																							// 類別選擇：開啟商品選單
																							handleOpenSelection('set', idx, content.categoryId, defPrice); 
																						} else if (content.type === 'fixed') {
																							// 固定餐點：直接開啟編輯 (修復點)
																							const fixedProd = products.find(p => p.id === content.productId);
																							if (fixedProd) handleConfigureFixedItem('set', idx, fixedProd, defPrice);
																						}
																					}}
																				>
																					<div className="w-14 h-14 rounded-xl bg-slate-50 border border-slate-100 overflow-hidden shrink-0 aspect-square">
																						<img src={contentImg} className="w-full h-full object-cover" />
																					</div>
																					<div className="flex-1 min-w-0 space-y-1">
																						<p className="text-sm font-bold text-slate-800 truncate">
																							{contentName} 
																							<span className="text-sm text-slate-500 font-bold ml-1">{contentSub}</span> 
																							{priceDiff !== 0 && <span className={`text-sm font-bold ml-1 ${priceDiff > 0 ? 'text-red-500' : 'text-green-500'}`}>{priceDiff > 0 ? `+$${priceDiff}` : `-$${Math.abs(priceDiff)}`}</span>}
																						</p>
																						
																						{/* 狀態標籤區 */}
																						{content.type === 'category' && content.allowChange ? (
																							<div className="flex items-center justify-between">
																								<div className="flex items-center gap-1.5 text-[#5B2274]">
																									<Icon name="check-circle-2" size={14} className="fill-[#5B2274] text-white" />
																									<span className="text-[11px] font-bold">可更換同類別商品</span>
																								</div>
																								{isSelected && <button className="text-[10px] bg-purple-50 text-[#5B2274] px-2 py-0.5 rounded border border-purple-100 font-bold">更換</button>}
																							</div>
																						) : content.type === 'fixed' ? (
																							// 固定餐點顯示 (修復)
																							<div className="flex items-center justify-between">
																								<div className="flex items-center gap-1.5 text-slate-500">
																									<Icon name="lock" size={14} />
																									<span className="text-[11px] font-bold">固定餐點</span>
																								</div>
																								{isSelected && <button className="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded border border-slate-200 font-bold">調整規格</button>}
																							</div>
																						) : (
																							<div className="flex items-center gap-1.5 text-slate-400">
																								<Icon name="lock" size={14} />
																								<span className="text-[11px] font-bold">不可更換</span>
																							</div>
																						)}
																					</div>
																				</div>
																			);
																		})}
																	</div>
																)}
															</div>
														);
													})}
												</div>
											</div>
										)}
										{checkAvailability(selectedItem) !== 'all_out' && (
											<div className="space-y-2"><label className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest">餐點備註</label><textarea className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold text-slate-700 outline-none focus:border-[#5B2274] resize-none h-24" placeholder="例如：去冰、不要洋蔥..." value={itemNote} onChange={e => setItemNote(e.target.value)}></textarea></div>
										)}
									</div>
									{checkAvailability(selectedItem) !== 'all_out' && (
										<div className="absolute bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-100 flex items-center gap-4 z-20">
											<div className="flex items-center gap-3 bg-slate-100 rounded-xl px-3 py-2"><button onClick={() => setItemCount(Math.max(1, itemCount-1))} className="w-8 h-8 flex items-center justify-center bg-white rounded-lg shadow-sm active:scale-95 text-slate-600"><Icon name="minus" size={16} /></button><span className="font-black text-lg w-6 text-center">{itemCount}</span><button onClick={() => setItemCount(itemCount+1)} className="w-8 h-8 flex items-center justify-center bg-[#5B2274] text-white rounded-lg shadow-sm active:scale-95"><Icon name="plus" size={16} /></button></div>
											<button 
												onClick={handleAddToCart}
												disabled={!selectionStatus.valid}
												className={`flex-1 py-4 rounded-xl font-black text-white shadow-lg flex justify-between px-6 items-center transition-all 
													${!selectionStatus.valid ? 'bg-slate-300 cursor-not-allowed' : 'bg-[#5B2274] hover:bg-[#4a1b5e] active:scale-95'}`}
											>
												<span>
													{!selectionStatus.valid ? selectionStatus.msg : (editingCartItem ? '更新購物車' : '加入購物車')}
												</span>
												{selectionStatus.valid && (
													<span>${((selectedVariant ? selectedVariant.price : selectedItem.price) + selectedAddons.reduce((s,a)=>s+a.price,0) + (selectedSet ? (selectedSet.price + (function(){let d=0; selectedSet.contents?.forEach((c,i)=>{const ch=selectedSetChoices[i]; if(ch && c.type==='category' && c.allowChange && c.defaultProductId){const dp=products.find(p=>p.id===c.defaultProductId); let dpr=dp?dp.price:0; if(dp && c.defaultVariantName){const dv=dp.variants?.find(v=>v.name===c.defaultVariantName); if(dv)dpr=dv.price;} d+=(ch.price-dpr);}}); return d;})()) : 0) + (function(){let d=0; selectedItem.sideGroups?.forEach(g=>{const ch=selectedSideGroups[g.id]; if(ch && g.allowChange && g.defaultProductId){const dp=products.find(p=>p.id===g.defaultProductId); let dpr=dp?dp.price:0; if(dp && g.defaultVariantName){const dv=dp.variants?.find(v=>v.name===g.defaultVariantName); if(dv)dpr=dv.price;} d+=(ch.price-dpr);}}); return d;})()) * itemCount}</span>
												)}
											</button>
										</div>
									)}
								</div>
							</div>
						)}
						
						{/* Selection Modal */}
						{selectionModal && (
							<div className="fixed inset-0 bg-black/80 z-[70] flex items-end sm:items-center justify-center p-0 sm:p-4 animate-fade-in backdrop-blur-sm" onClick={() => { if(!configuringProduct) setSelectionModal(null); }}>
								 <div className="bg-white w-full max-w-md rounded-t-[32px] sm:rounded-[32px] p-6 shadow-2xl animate-slide-up max-h-[85vh] flex flex-col" onClick={e => e.stopPropagation()}>
									<div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-4"><h3 className="text-lg font-[900] text-slate-800">{configuringProduct ? '商品內容' : '請選擇商品'}</h3><button onClick={() => { if(configuringProduct) setConfiguringProduct(null); else setSelectionModal(null); }} className="bg-slate-100 p-2 rounded-full text-slate-500"><Icon name={configuringProduct ? 'arrow-left' : 'x'} size={20} /></button></div>
									<div className="flex-1 overflow-y-auto no-scrollbar space-y-3">
										{!configuringProduct ? (
											products.filter(p => p.categoryId === selectionModal.categoryId && !p.isHidden).map(p => {
												if (checkAvailability(p) === 'all_out') return null;
												let diffP = ''; const baseD = p.price - selectionModal.defaultPrice, hasV = p.variants && p.variants.length > 0;
												if (hasV) { const minP = Math.min(...p.variants.map(v => v.price)), minD = minP - selectionModal.defaultPrice; diffP = minD === 0 ? '不需補差價' : (minD > 0 ? `+$${minD}起` : `-$${Math.abs(minD)}起`); }
												else { diffP = baseD === 0 ? '不需補差價' : (baseD > 0 ? `+$${baseD}` : `-$${Math.abs(baseD)}`); }
												return (<div key={p.id} className="flex items-center justify-between p-4 bg-white border border-slate-200 rounded-xl active:bg-slate-50 cursor-pointer" onClick={() => handleProductSelectInModal(p)}><div className="flex items-center gap-3"><div className="w-12 h-12 rounded-lg bg-slate-100 overflow-hidden shrink-0"><img src={getOptimizedImage(p.image, 100)} className="w-full h-full object-cover" /></div><div><p className="font-bold text-slate-800">{p.name}</p><p className={`text-xs font-bold ${diffP.includes('+') ? 'text-red-500' : (diffP.includes('-') ? 'text-green-500' : 'text-slate-500')}`}>{diffP}</p></div></div><Icon name="chevron-right" size={16} className="text-slate-300" /></div>);
											})
										) : (
											<div className="space-y-6">
												{configuringProduct.product.variants?.length > 0 && (<div className="space-y-2"><p className="text-xs font-black text-slate-400">規格</p><div className="grid grid-cols-2 gap-2">{configuringProduct.product.variants.map((v, i) => { const isS = configuringProduct.variant?.name === v.name, d = v.price - selectionModal.defaultPrice; return <button key={i} onClick={() => setConfiguringProduct({...configuringProduct, variant: isS ? null : v})} className={`p-3 rounded-xl border text-sm font-bold flex justify-between ${isS ? 'border-[#5B2274] bg-purple-50' : 'border-slate-200'}`}><span>{v.name}</span><span className="text-xs flex items-center gap-1"><s className="text-slate-400">${v.price}</s> <span className={d > 0 ? 'text-red-500' : (d < 0 ? 'text-green-500' : 'text-slate-500')}>{d === 0 ? '不需補差價' : (d > 0 ? `+$${d}` : `-$${Math.abs(d)}`)}</span></span></button>; })}</div></div>)}
												{configuringProduct.product.allowAddons?.length > 0 && (() => {
													// 這裡需要即時計算子項目的分組，因為它不像主商品有 state 存著
													const subGroupedAddons = getGroupedAddons(addons.filter(a => configuringProduct.product.allowAddons.includes(a.id)));
													
													return (
														<div className="space-y-4">
															<p className="text-[11px] font-[900] text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">客製化選項</p>
															{subGroupedAddons.map(group => (
																<div key={group.name} className="space-y-2">
																	<div className="flex justify-between items-end">
																		<p className="text-xs font-black text-slate-500">{group.name}</p>
																		<span className="text-[10px] text-slate-400 font-bold">
																			{group.max === 1 ? '(單選)' : (group.min > 0 ? `(選 ${group.min}~${group.max} 項)` : `(至多 ${group.max} 項)`)}
																		</span>
																	</div>
																	<div className="grid grid-cols-2 gap-2">
																		{group.items.map(ad => {
																			const isSelected = configuringProduct.addons.some(a => a.id === ad.id);
																			return (
																				<button 
																					key={ad.id} 
																					// ★ 使用 handleAddonToggle，但要傳入特殊的 setter 來更新 configuringProduct
																					onClick={() => handleAddonToggle(
																						ad, 
																						group, 
																						configuringProduct.addons, 
																						(newAddons) => setConfiguringProduct({...configuringProduct, addons: newAddons})
																					)} 
																					className={`p-3 rounded-xl text-sm font-bold flex justify-between transition-all ${isSelected ? 'bg-[#5B2274] text-white' : 'bg-white border border-slate-200 text-slate-500'}`}
																				>
																					<span>{ad.name}</span> 
																					{ad.price > 0 && <span className={isSelected ? 'text-white' : 'text-[#5B2274]'}>+${ad.price}</span>}
																				</button>
																			);
																		})}
																	</div>
																</div>
															))}
														</div>
													);
												})()}
												<div className="border-t border-slate-100 pt-4 mt-2"><div className="flex justify-between items-center mb-4"><span className="font-bold text-slate-500">補差價金額</span><span className="font-black text-xl text-[#5B2274]">{(() => { if (configuringProduct.product.variants?.length > 0 && !configuringProduct.variant) return '請選擇規格'; const curr = (configuringProduct.variant ? configuringProduct.variant.price : configuringProduct.product.price) + configuringProduct.addons.reduce((s, a) => s + a.price, 0), diff = curr - selectionModal.defaultPrice; return diff === 0 ? '不需補差價' : (diff > 0 ? `+$${diff}` : `-$${Math.abs(diff)}`); })()}</span></div><button onClick={confirmConfiguration} className="w-full bg-[#5B2274] text-white py-3 rounded-xl font-bold shadow-lg">確認商品</button></div>
											</div>
										)}
									</div>
								 </div>
							</div>
						)}

						{showCartModal && (
							<div className="fixed inset-0 bg-black/80 z-[60] flex items-end justify-center animate-fade-in backdrop-blur-sm" onClick={() => setShowCartModal(false)}>
								<div className="bg-white w-full max-w-md rounded-t-[32px] p-6 shadow-2xl animate-slide-up max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
									<div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h3 className="text-xl font-[900] text-slate-800">結帳確認</h3><button onClick={() => setShowCartModal(false)} className="bg-slate-100 p-2 rounded-full text-slate-500"><Icon name="x" size={20} /></button></div>
									<div className="flex-1 overflow-y-auto no-scrollbar space-y-6 pb-4 px-1">
										<div className="space-y-4">
											<h4 className="text-sm font-black text-slate-400 uppercase tracking-widest">訂單內容</h4>
											{cart.length === 0 ? <div className="text-center py-6 text-slate-400 font-bold">購物車是空的</div> : cart.map(item => (
												<div key={item.id} className="flex gap-3 items-start border-b border-slate-50 pb-4 last:border-0 relative group">
													<button onClick={() => openEditCartItem(item)} className="absolute top-0 right-0 p-2 text-slate-300 hover:text-[#5B2274] z-10"><Icon name="pencil" size={16} /></button>
													<div className="w-16 h-16 rounded-xl bg-slate-50 border border-slate-100 shrink-0 overflow-hidden"><img src={getOptimizedImage(item.image, 200)} className="w-full h-full object-cover" /></div>
													<div className="flex-1 min-w-0 pr-8"><h4 className="font-black text-slate-800 text-sm truncate">{item.name}</h4><p className="text-xs text-slate-500 font-bold">{item.variantName}</p>{item.addons.length > 0 && <p className="text-xs text-slate-400 mt-1">{item.addons.map(a => a.name).join(' / ')}</p>}
													{item.sideGroups && Object.keys(item.sideGroups).length > 0 && (<div className="text-xs text-slate-600 bg-purple-50 p-2 rounded-lg mt-1 space-y-1"><p className="font-bold text-[#5B2274] mb-1">附餐：</p>{Object.values(item.sideGroups).map(c => (<div key={c.id}><span className="font-bold text-slate-700 mr-2">• {c.name} {c.variantName && `(${c.variantName})`}</span>{c.addons?.length > 0 && <span className="text-slate-400 block pl-2">{c.addons.map(a => a.name).join(' / ')}</span>}</div>))}</div>)}
													{item.set && (<div className="text-xs text-slate-600 bg-purple-50 p-2 rounded-lg mt-1 space-y-1"><p className="font-bold text-[#5B2274] mb-1">套餐：{item.set.name}</p>{item.set.contents?.map((c, i) => { const ch = item.setChoices?.[i]; let dn = 'Unknown', dv = ''; if (ch) { dn = ch.name; dv = ch.variantName; } else if (c.type === 'fixed') { const p = products.find(prod=>prod.id === c.productId); if(p) dn = p.name; } else if (c.type === 'category') { const p = products.find(prod=>prod.id === c.defaultProductId); if(p) dn = p.name; } return (<div key={i} className="flex flex-col"><span className="font-bold text-slate-700">• {dn} {dv && `(${dv})`}</span>{ch?.addons?.length > 0 && <span className="text-slate-400 pl-3">{ch.addons.map(a => a.name).join(' / ')}</span>}</div>); })}</div>)}
													{item.note && <p className="text-xs text-orange-500 bg-orange-50 px-2 py-1.5 rounded w-full block mt-2 font-medium break-words">備註：{item.note}</p>}<div className="flex items-center justify-between mt-2"><div className="flex items-center gap-2 bg-slate-50 rounded-lg px-2 py-1"><button onClick={() => item.qty > 1 ? updateCartQty(item.id, -1) : removeFromCart(item.id)} className="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm text-slate-600"><Icon name={item.qty > 1 ? "minus" : "trash-2"} size={12} /></button><span className="font-bold text-sm w-4 text-center">{item.qty}</span><button onClick={() => updateCartQty(item.id, 1)} className="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm text-slate-600"><Icon name="plus" size={12} /></button></div><span className="font-bold text-slate-700 text-sm">${item.totalPrice}</span></div></div>
												</div>
											))}
										</div>

										{/* Pickup Time Section */}
										<div className="space-y-4 pt-2 border-t border-slate-100">
											<h4 className="text-sm font-black text-slate-400 uppercase tracking-widest">取餐時間</h4>
											<div className="grid grid-cols-1 gap-3">
												<select className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274] w-full" value={pickupDate} onChange={e => { setPickupDate(e.target.value); setIsASAP(false); }}>
													{getAvailableDates().length === 0 && <option disabled>無可選日期 (請來電)</option>}
													{getAvailableDates().map(d => <option key={d.value} value={d.value}>{d.label}</option>)}
												</select>
												
												{/* ASAP Toggle - Only show if selected date is today and currently open */}
												{pickupDate === new Date().toISOString().split('T')[0] && checkIsOpenNow() && (
													<label className={`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition-all ${isASAP ? 'bg-purple-50 border-[#5B2274]' : 'bg-white border-slate-200'}`}>
														<div className={`w-5 h-5 rounded-full border flex items-center justify-center ${isASAP ? 'border-[#5B2274] bg-[#5B2274]' : 'border-slate-300'}`}>
															{isASAP && <Icon name="check" size={14} className="text-white" />}
														</div>
														<input type="checkbox" className="hidden" checked={isASAP} onChange={e => setIsASAP(e.target.checked)} />
														<span className={`text-sm font-bold ${isASAP ? 'text-[#5B2274]' : 'text-slate-600'}`}>盡快取餐</span>
													</label>
												)}

												{/* Split Hour and Minute Selectors - Hide if ASAP is checked */}
												{!isASAP && (
													<div className="grid grid-cols-2 gap-3">
														<select className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274]" value={pickupHour} onChange={e => setPickupHour(e.target.value)}>
															<option value="" disabled>選擇小時</option>
															{getAvailableHours(pickupDate).map(h => <option key={h} value={h}>{h} 時</option>)}
														</select>
														<select className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274]" value={pickupMinute} onChange={e => setPickupMinute(e.target.value)} disabled={!pickupHour}>
															<option value="" disabled>選擇分鐘</option>
															{getAvailableMinutes(pickupDate, pickupHour).map(m => <option key={m} value={m}>{m.toString().padStart(2,'0')} 分</option>)}
														</select>
													</div>
												)}
											</div>
											<p className="text-xs text-slate-400 font-bold text-center">如有其他時段需求，請直接來電</p>
										</div>

										<div className="border-t border-slate-100 border-dashed my-4"></div>

										{/* [Updated] 訂購人資訊 (依模式變動) */}
										<div className="space-y-4 pt-2">
											<h4 className="text-sm font-black text-slate-400 uppercase tracking-widest">用餐資訊</h4>
											
											{/* 情境 A: 內用 (顯示桌號，隱藏個資輸入) */}
											{orderMode === 'dine_in' && (
												<div className="bg-purple-50 border border-purple-100 rounded-xl p-4 flex items-center justify-between">
													<div className="flex items-center gap-3">
														<div className="w-10 h-10 bg-[#5B2274] rounded-full flex items-center justify-center text-white shadow-sm">
															<span className="font-black text-lg">{tableNumber}</span>
														</div>
														<div>
															<p className="font-black text-slate-800">內用桌號</p>
															<p className="text-xs font-bold text-slate-500">{isGuest ? '匿名訪客' : (userProfile?.name || '會員')}</p>
														</div>
													</div>
													<div className="px-2 py-1 bg-white text-[#5B2274] text-xs font-bold rounded border border-purple-100">
														現場結帳
													</div>
												</div>
											)}

											{/* 情境 B: 外帶/外送 (需要填寫資料) */}
											{orderMode !== 'dine_in' && (
												<>
													{/* 資料來源切換 (僅會員可見) */}
													{!isGuest && (
														<div className="bg-slate-100 p-1 rounded-xl flex font-bold text-sm mb-2">
															<button 
																onClick={() => setUseDefaultInfo(true)} 
																className={`flex-1 py-2 rounded-lg flex items-center justify-center gap-2 transition-all ${useDefaultInfo ? 'bg-white text-[#5B2274] shadow-sm' : 'text-slate-400'}`}
															>
																<Icon name="user" size={14} /> 帶入會員
															</button>
															<button 
																onClick={() => setUseDefaultInfo(false)} 
																className={`flex-1 py-2 rounded-lg flex items-center justify-center gap-2 transition-all ${!useDefaultInfo ? 'bg-white text-[#5B2274] shadow-sm' : 'text-slate-400'}`}
															>
																<Icon name="pencil" size={14} /> 自行輸入
															</button>
														</div>
													)}

													{useDefaultInfo && !isGuest ? (
														// 會員預設資料
														<div className="bg-purple-50 border border-purple-100 rounded-xl p-4 flex flex-col gap-2 relative overflow-hidden">
															<div className="flex items-center gap-3">
																<div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-[#5B2274] shadow-sm">
																	<Icon name="smile" size={20} />
																</div>
																<div>
																	<p className="font-black text-slate-800">{userProfile?.name || '會員'}</p>
																	<p className="text-xs font-bold text-slate-500">{userProfile?.phone}</p>
																</div>
															</div>
															{orderMode === 'delivery' && (
																<div className="mt-2 pt-2 border-t border-purple-100">
																	<p className="text-xs font-bold text-slate-600 flex items-center gap-1"><Icon name="map-pin" size={12}/> {userInfo.address || '請輸入外送地址'}</p>
																</div>
															)}
														</div>
													) : (
														// 手動輸入 (外帶/外送必填)
														<div className="grid grid-cols-1 gap-3 animate-fade-in">
															<div className="grid grid-cols-2 gap-3">
																<input type="text" placeholder="您的姓名" className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274]" value={userInfo.name} onChange={e => setUserInfo({...userInfo, name: e.target.value})} />
																<input type="tel" placeholder="聯絡電話" className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274]" value={userInfo.phone} onChange={e => setUserInfo({...userInfo, phone: e.target.value})} />
															</div>
															{/* [New] 外送地址欄位 */}
															{orderMode === 'delivery' && (
																<input type="text" placeholder="外送地址 (必填)" className="bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274]" value={userInfo.address || ''} onChange={e => setUserInfo({...userInfo, address: e.target.value})} />
															)}
														</div>
													)}
													
													{/* 優先聯絡方式 (僅外帶外送顯示) */}
													<div className="space-y-2 mt-2">
														<p className="text-xs font-bold text-slate-500">優先聯絡方式</p>
														<div className="flex bg-slate-50 rounded-xl p-1 w-full">
															<button onClick={() => setUserInfo({...userInfo, contactMethod: 'line'})} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${userInfo.contactMethod === 'line' ? 'bg-[#5B2274] text-white shadow-sm' : 'text-slate-400'}`}>LINE</button>
															<button onClick={() => setUserInfo({...userInfo, contactMethod: 'phone'})} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${userInfo.contactMethod === 'phone' ? 'bg-[#5B2274] text-white shadow-sm' : 'text-slate-400'}`}>電話</button>
														</div>
													</div>
												</>
											)}
										</div>
										<div className="border-t border-slate-100 border-dashed my-4"></div>
										<div className="space-y-3 pt-2">
											<h4 className="text-sm font-black text-slate-400 uppercase tracking-widest">優惠折扣</h4>
											
											{/* [New] 優惠券列表：只有非訪客才顯示 */}
											{!isGuest && (
												<div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
													{myCoupons.map((c, i) => (
														<button key={i} onClick={() => setSelectedCoupon(selectedCoupon === c ? null : c)} className={`flex-shrink-0 px-3 py-2 rounded-xl border text-xs font-bold transition-all ${selectedCoupon === c ? 'bg-purple-100 border-[#5B2274] text-[#5B2274]' : 'bg-white border-slate-200 text-slate-600'}`}>
															{c.title} (-${c.discount})
														</button>
													))}
													{myCoupons.length === 0 && <span className="text-xs text-slate-400 py-2">無可用優惠券，請至菜單分頁領取</span>}
												</div>
											)}

											{/* 集點卡折抵：訪客與會員都保留 (因為是紙本核銷) */}
											<div className="flex items-start gap-3 p-3 bg-red-50 border border-red-100 rounded-xl cursor-pointer" onClick={() => setUseLoyaltyCard(!useLoyaltyCard)}>
												<div className={`w-5 h-5 rounded border flex items-center justify-center shrink-0 mt-0.5 ${useLoyaltyCard ? 'bg-red-500 border-red-500' : 'bg-white border-red-200'}`}>
													{useLoyaltyCard && <Icon name="check" size={14} className="text-white" />}
												</div>
												<div>
													<p className="text-sm font-bold text-red-800">使用集點卡折抵 ${settings.pointRewardValue || 50}</p>
													<p className="text-[10px] text-red-500 mt-1 font-bold">※ 若現場核銷不符資格將收取原價</p>
												</div>
											</div>
										</div>
									</div>
									<div className="mt-2 pt-4 border-t border-slate-100">
										<div className="space-y-2 mb-4">
											<div className="flex justify-between items-center text-slate-500">
												<span className="font-bold text-sm">小計</span>
												<span className="font-bold text-sm text-slate-700">${cart.reduce((sum, item) => sum + item.totalPrice, 0)}</span>
											</div>
											
											{/* [Updated] 動態優惠顯示 */}
											{orderCalc.discount > 0 && (
												<div className="flex justify-between items-center text-red-500">
													<span className="font-bold text-sm flex items-center gap-1">
														<Icon name="ticket" size={14} />
														{orderCalc.name}
													</span>
													<span className="font-bold text-sm">-${orderCalc.discount}</span>
												</div>
											)}

											<div className="flex justify-between items-center pt-2 border-t border-slate-100">
												<span className="font-black text-lg text-slate-800">總計金額</span>
												<span className="font-black text-2xl text-[#5B2274]">${orderCalc.final}</span>
											</div>
										</div>
										<button onClick={handlePreSubmit} className="w-full bg-[#5B2274] text-white py-4 rounded-2xl font-black text-lg shadow-xl hover:bg-[#4a1b5e] active:scale-95 transition-all">送出訂單</button>
									</div>
								</div>
							</div>
						)}

						{showSubmitConfirm && (
							<div className="fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={() => setShowSubmitConfirm(false)}>
								<div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up flex flex-col items-center text-center space-y-4" onClick={e => e.stopPropagation()}>
									<div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-2"><Icon name="alert-triangle" size={32} /></div>
									<h3 className="text-xl font-[900] text-slate-800">訂單確認</h3>
									<div className="space-y-2 text-sm font-bold text-slate-600">
										<p>訂單送出無法線上變更</p>
										<p className="text-red-500">{pickupDate === new Date().toISOString().split('T')[0] ? "當日訂單無法透過線上取消" : "隔日訂單過凌晨後無法透過線上取消"}</p>
										<p>如有變更、取消需求請於營業時間內來電</p>
									</div>
									<div className="flex gap-3 w-full pt-2"><button onClick={() => setShowSubmitConfirm(false)} className="flex-1 py-3 rounded-xl font-bold bg-slate-100 text-slate-600 active:scale-95 transition-transform">取消</button><button onClick={confirmSubmitOrder} className="flex-1 py-3 rounded-xl font-bold bg-[#5B2274] text-white shadow-lg active:scale-95 transition-transform">確認送出</button></div>
								</div>
							</div>
						)}

						{showInfoModal && (
							<div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={() => setShowInfoModal(false)}>
								<div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-slide-up relative" onClick={e => e.stopPropagation()}>
									<button onClick={() => setShowInfoModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x" size={24} /></button>
									<div className="text-center mb-6"><div className="w-12 h-12 bg-purple-100 text-[#5B2274] rounded-full flex items-center justify-center mx-auto mb-3"><Icon name="clock" size={24} /></div><h3 className="text-xl font-[900] text-slate-800">營業時間資訊</h3></div>
									<div className="space-y-4">
										<div className="bg-slate-50 p-4 rounded-2xl flex justify-between items-center"><span className="text-sm font-bold text-slate-500">平日營業</span><span className="text-lg font-black text-slate-800">{settings.openTime} - {settings.closeTime}</span></div>
										<div className="bg-slate-50 p-4 rounded-2xl flex justify-between items-center"><span className="text-sm font-bold text-slate-500">每週公休</span><span className="text-lg font-black text-slate-800">{settings.closedDays.length > 0 ? `每週${settings.closedDays.sort().map(d => dayNames[d].replace('週','')).join('、')}公休` : '無'}</span></div>
										{settings.specialDates?.length > 0 && (
											<div className="space-y-2 pt-2 border-t border-slate-100">
												<p className="text-xs font-black text-slate-400 uppercase tracking-wider text-center">特殊排休/營業</p>
												<div className="max-h-32 overflow-y-auto no-scrollbar space-y-1.5">
													{settings.specialDates.map((sd, i) => (
														<div key={i} className="flex flex-col border-b border-slate-100 last:border-0 pb-1">
															<div className="flex justify-between text-xs font-bold px-2"><span className="text-slate-600">{sd.date}</span><span className={sd.type === 'open' ? 'text-emerald-500' : 'text-red-500'}>{sd.type === 'open' ? '加開營業' : '特殊店休'}</span></div>
															{sd.note && <span className="text-[10px] text-slate-400 px-2">{sd.note}</span>}
														</div>
													))}
												</div>
											</div>
										)}
									</div>
								</div>
							</div>
						)}
					</div>
                );
            }
			
			
            
            // Fallback (如果都沒匹配到 viewState，顯示 Loading 或空白)
            return <div className="min-h-screen flex items-center justify-center bg-slate-50 font-bold text-slate-400">系統載入中...</div>;
       
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
