<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>City Burger Admin UI Preview (Incomplete Focus)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --primary: #5B2274;
            --bg-body: #F1F5F9;
        }

        body { 
            font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-body); 
            color: #1E293B; 
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-sidebar {
            background: linear-gradient(170deg, #5B2274 0%, #1a0b2e 100%);
            color: white;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-scale-in { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .backdrop-blur-sm { backdrop-filter: blur(4px); }

        /* Custom Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #5B2274;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #5B2274;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, size = 18, className = "" }) => {
            const [iconData, setIconData] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.charAt(0).toUpperCase() + name.slice(1);
                    setIconData(window.lucide.icons[name] || window.lucide.icons[pascalName] || null);
                }
            }, [name]);
            if (!iconData) return <span style={{ width: size, height: size }} className={`inline-block bg-slate-200 rounded-full ${className}`}></span>;
            return React.createElement('svg', { 
                xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className 
            }, iconData.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i })));
        };

        function App() {
            const [activeTab, setActiveTab] = useState('orders');
            const [orderFilter, setOrderFilter] = useState('today');
            const [subFilter, setSubFilter] = useState('all'); 
            const [searchQuery, setSearchQuery] = useState(''); 
            
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            const [historyDate, setHistoryDate] = useState(yesterday.toISOString().split('T')[0]);
            const [mobileOpen, setMobileOpen] = useState(false);
            const [modal, setModal] = useState(null); 
            const [dialog, setDialog] = useState(null); 

            // 模擬資料
            const [orders, setOrders] = useState([
                {
                    id: '1', orderId: 'ORD-20231226-0001', status: 'pending', totalPrice: 350, originalPrice: 350, discountAmount: 0, verified: false,
                    createdAt: new Date().toISOString(),
                    userInfo: { name: '王小明', phone: '0912-345-678', pickupDate: new Date().toISOString().split('T')[0], pickupTime: 'ASAP' },
                    items: [ { qty: 1, name: '經典牛肉堡', variantName: '雙層肉', totalPrice: 150 }, { qty: 2, name: '可樂', variantName: '大杯', totalPrice: 60 }, { qty: 1, name: '黃金薯條', variantName: '大份', totalPrice: 140 } ],
                    note: '不要洋蔥，可樂去冰，謝謝！', customerNote: '熟客，喜歡番茄醬多一點'
                },
                {
                    id: '2', orderId: 'ORD-20231226-0002', status: 'confirmed', totalPrice: 120, originalPrice: 120, discountAmount: 0, verified: true,
                    createdAt: new Date(Date.now() - 3600000).toISOString(),
                    userInfo: { name: '李美美', phone: '0988-888-888', pickupDate: new Date().toISOString().split('T')[0], pickupTime: '12:30' },
                    items: [{ qty: 1, name: '香雞堡套餐', variantName: '', totalPrice: 120 }]
                },
                {
                    id: '3', orderId: 'ORD-20231226-0003', status: 'preparing', totalPrice: 580, originalPrice: 580, discountAmount: 0, verified: false,
                    createdAt: new Date(Date.now() - 7200000).toISOString(),
                    userInfo: { name: '陳大文', phone: '0911-222-333', pickupDate: new Date().toISOString().split('T')[0], pickupTime: '12:45' },
                    items: [{ qty: 3, name: '花生培根堡', variantName: '', totalPrice: 580 }], note: '這是VIP客人'
                },
                {
                    id: '4', orderId: 'ORD-20231226-0004', status: 'ready', totalPrice: 90, originalPrice: 90, discountAmount: 0, verified: false,
                    createdAt: new Date(Date.now() - 10800000).toISOString(),
                    userInfo: { name: '外送員 #5566', phone: 'UBER', pickupDate: new Date().toISOString().split('T')[0], pickupTime: '11:00' },
                    items: [{ qty: 1, name: '紅茶', variantName: '半糖', totalPrice: 30 }, { qty: 1, name: '蛋餅', variantName: '起司', totalPrice: 60 }]
                },
                {
                    id: '5', orderId: 'ORD-20231227-0001', status: 'pending', totalPrice: 2500, originalPrice: 2500, discountAmount: 0, verified: false,
                    createdAt: new Date().toISOString(),
                    userInfo: { name: '虎尾科大 籃球隊', phone: '0900-111-222', pickupDate: new Date(Date.now() + 86400000).toISOString().split('T')[0], pickupTime: '12:00' },
                    items: [ { qty: 20, name: '卡拉雞腿堡', variantName: '', totalPrice: 2500 } ], note: '團體訂單'
                },
                {
                    id: '6', orderId: 'ORD-20231225-9999', status: 'completed', totalPrice: 200, originalPrice: 200, discountAmount: 0, verified: true,
                    createdAt: new Date(Date.now() - 86400000).toISOString(),
                    userInfo: { name: '昨天來的客人', phone: '0999-999-999', pickupDate: yesterday.toISOString().split('T')[0], pickupTime: '18:00' },
                    items: [{ qty: 1, name: '晚餐套餐', totalPrice: 200 }]
                },
                {
                    id: '7', orderId: 'ORD-20231226-0007', status: 'cancelled', totalPrice: 450, originalPrice: 450, discountAmount: 0, verified: false,
                    createdAt: new Date(Date.now() - 500000).toISOString(),
                    userInfo: { name: '取消的客人', phone: '0900-000-000', pickupDate: new Date().toISOString().split('T')[0], pickupTime: '12:00' },
                    items: [ { qty: 2, name: '牛肉堡', variantName: '', totalPrice: 450 } ], note: '臨時有事取消'
                }
            ]);

            const showAlert = (title, message) => setDialog({ title, message, type: 'alert', onConfirm: () => setDialog(null) });
            const showConfirm = (title, message, onConfirm, isDestructive = false) => setDialog({ title, message, type: 'confirm', onConfirm, isDestructive });

            const handleUpdateOrderStatus = (id, newStatus) => {
                const doUpdate = () => {
                    setOrders(prev => prev.map(o => o.id === id ? { ...o, status: newStatus } : o));
                    setDialog(null);
                    if(modal) setModal(null);
                    if (newStatus === 'completed') showAlert('完成', '訂單已結案！');
                };

                if (newStatus === 'cancelled') {
                    showConfirm('確定要拒絕此訂單？', '此操作將取消訂單並通知顧客，無法復原。', () => { doUpdate(); showAlert('已拒單', '訂單已成功取消。'); }, true);
                } else {
                    doUpdate();
                }
            };

            const toggleLoyaltyDiscount = () => {
                if(!modal) return;
                const newDiscount = modal.data.discountAmount > 0 ? 0 : 50; 
                const newTotal = Math.max(0, modal.data.originalPrice - newDiscount);
                const newData = { ...modal.data, discountAmount: newDiscount, totalPrice: newTotal, verified: true, discountApplied: newDiscount > 0 ? 'loyalty' : null };
                setModal({ ...modal, data: newData });
                setOrders(prev => prev.map(o => o.id === modal.data.id ? { ...o, ...newData } : o));
            };

            const toggleVerified = () => {
                if(!modal) return;
                const newData = { ...modal.data, verified: !modal.data.verified };
                setModal({ ...modal, data: newData });
                setOrders(prev => prev.map(o => o.id === modal.data.id ? { ...o, verified: newData.verified } : o));
            };

            const getTaiwanDateStr = () => new Date().toLocaleString("en-CA", { timeZone: "Asia/Taipei" }).split(',')[0];
            const STATUS_STYLE = {
                'pending':   { bg: 'bg-[#FFFBEB]', text: 'text-[#D97706]', label: '待確認', border: 'border-[#FCD34D]', icon: 'BellRing', chip: 'bg-[#FFFBEB] text-[#D97706] border-[#FCD34D]' },
                'confirmed': { bg: 'bg-[#EFF6FF]', text: 'text-[#2563EB]', label: '已接單', border: 'border-[#BFDBFE]', icon: 'ChefHat', chip: 'bg-[#EFF6FF] text-[#2563EB] border-[#BFDBFE]' },
                'preparing': { bg: 'bg-[#FFF7ED]', text: 'text-[#EA580C]', label: '製作中', border: 'border-[#FED7AA]', icon: 'Flame', chip: 'bg-[#FFF7ED] text-[#EA580C] border-[#FED7AA]' },
                'ready':     { bg: 'bg-[#F0FDF4]', text: 'text-[#16A34A]', label: '待取餐', border: 'border-[#BBF7D0]', icon: 'ShoppingBag', chip: 'bg-[#F0FDF4] text-[#16A34A] border-[#BBF7D0]' },
                'completed': { bg: 'bg-slate-700', text: 'text-white', label: '已完成', border: 'border-slate-800', icon: 'CheckCircle2', chip: 'bg-slate-100 text-slate-500 border-slate-200' },
                'cancelled': { bg: 'bg-[#FEF2F2]', text: 'text-[#DC2626]', label: '已取消', border: 'border-[#FECACA]', icon: 'XCircle', chip: 'bg-[#FEF2F2] text-[#DC2626] border-[#FECACA]' }
            };

            // 分頁切換處理：歷史紀錄預設顯示已完成，其他預設顯示未完成
            const handleTabChange = (newTab) => {
                setOrderFilter(newTab);
                if (newTab === 'history') {
                    setSubFilter('completed');
                } else {
                    setSubFilter('all');
                }
            };

            return (
                <div className="flex h-screen overflow-hidden bg-[#F1F5F9]">
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 glass-sidebar transform transition-transform duration-300 lg:translate-x-0 lg:static lg:block shadow-2xl flex flex-col ${mobileOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6">
                            <div className="flex items-center gap-3 mb-8">
                                <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm shadow-inner text-white"><Icon name="ChefHat" size={20} /></div>
                                <div><h1 className="font-black text-xl text-white leading-none tracking-tight">City Burger</h1><p className="text-[10px] font-bold text-purple-200 tracking-widest uppercase mt-1">Admin Preview</p></div>
                            </div>
                            <nav className="space-y-2">
                                <button onClick={() => setActiveTab('orders')} className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold text-sm transition-all ${activeTab === 'orders' ? 'bg-white text-[#5B2274] shadow-lg' : 'text-purple-100 hover:bg-white/10'}`}>
                                    <Icon name="ClipboardList" size={20} /> 訂單管理
                                </button>
                            </nav>
                        </div>
                    </aside>

                    <main className="flex-1 h-full overflow-y-auto no-scrollbar relative w-full">
                        <div className="lg:hidden sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 h-16 flex items-center justify-between">
                            <span className="font-black text-[#5B2274] text-lg">City Burger</span>
                            <button onClick={() => setMobileOpen(!mobileOpen)} className="p-2 bg-white shadow-sm border border-slate-200 rounded-lg text-slate-600"><Icon name="Menu" size={20} /></button>
                        </div>

                        {/* [Layout] Order Content */}
                        <div className="w-full px-4 lg:px-8 py-6 lg:py-6 pb-32">
                            {activeTab === 'orders' && (() => {
                                const todayStr = getTaiwanDateStr();
                                const currentTab = orderFilter; 
                                
                                let targetOrders = orders.filter(o => {
                                    const pDate = o.userInfo.pickupDate;
                                    const isDone = ['completed', 'cancelled'].includes(o.status);
                                    
                                    // 1. 基本 Tab 過濾
                                    let matchTab = false;
                                    if (currentTab === 'history') matchTab = (pDate === historyDate);
                                    else if (currentTab === 'today') matchTab = (pDate <= todayStr);
                                    else if (currentTab === 'future') matchTab = (pDate > todayStr);
                                    
                                    if (!matchTab) return false;

                                    // 2. 狀態過濾
                                    // 'all' 現在代表「未完成」：排除已完成與已取消
                                    if (subFilter === 'all') {
                                        if (isDone) return false;
                                    } else {
                                        // 其他按鈕：精準匹配狀態 (例如點「已取消」就只顯示取消的)
                                        if (o.status !== subFilter) return false;
                                    }

                                    return true;
                                });

                                // 3. Search Filter
                                if (searchQuery) {
                                    const q = searchQuery.toLowerCase();
                                    targetOrders = targetOrders.filter(o => 
                                        o.orderId.toLowerCase().includes(q) || 
                                        o.userInfo.name.toLowerCase().includes(q) || 
                                        o.userInfo.phone.includes(q)
                                    );
                                }

                                targetOrders.sort((a, b) => {
                                    if (currentTab === 'history') return new Date(b.createdAt) - new Date(a.createdAt);
                                    const timeA = a.userInfo.pickupTime === 'ASAP' ? '00:00' : a.userInfo.pickupTime;
                                    const timeB = b.userInfo.pickupTime === 'ASAP' ? '00:00' : b.userInfo.pickupTime;
                                    return timeA.localeCompare(timeB);
                                });

                                // Count helper
                                const getCount = (status) => {
                                    return orders.filter(o => {
                                        const pDate = o.userInfo.pickupDate;
                                        let matchTime = currentTab === 'today' ? (pDate <= todayStr) : (pDate > todayStr);
                                        if (currentTab === 'history') matchTime = (pDate === historyDate);
                                        return matchTime && o.status === status;
                                    }).length;
                                };

                                return (
                                    <div className="animate-fade-in space-y-4">
                                        
                                        {/* 1. Sticky Top Bar */}
                                        <div className="sticky top-0 z-20 bg-[#F1F5F9]/95 backdrop-blur pt-2 pb-4 space-y-3 -mx-4 px-4 lg:-mx-8 lg:px-8 border-b border-slate-200/50 shadow-sm">
                                            <div className="flex flex-col md:flex-row gap-3 justify-between items-center">
                                                {/* Tabs */}
                                                <div className="flex bg-slate-200/60 p-1 rounded-xl shadow-inner w-full md:w-auto md:min-w-[320px]">
                                                    {[{id:'today', t:'今日現場'}, {id:'future', t:'預約單'}, {id:'history', t:'歷史紀錄'}].map(t => (
                                                        <button key={t.id} onClick={() => handleTabChange(t.id)} className={`flex-1 py-2 text-xs lg:text-sm font-bold rounded-lg transition-all duration-200 ${currentTab === t.id ? 'bg-white text-slate-800 shadow-sm scale-[1.02]' : 'text-slate-400 hover:text-slate-600'}`}>
                                                            {t.t} {t.id === 'today' && orders.filter(o => o.status === 'pending').length > 0 && <span className="ml-1 w-2 h-2 bg-red-500 rounded-full inline-block align-top animate-pulse"></span>}
                                                        </button>
                                                    ))}
                                                </div>

                                                {/* Search Box */}
                                                <div className="relative w-full md:w-64 group">
                                                    <div className="absolute left-3 top-2.5 text-slate-400 group-focus-within:text-[#5B2274] transition-colors"><Icon name="Search" size={16}/></div>
                                                    <input 
                                                        type="text" 
                                                        placeholder="搜尋單號 / 姓名 / 電話..." 
                                                        className="w-full bg-white border border-slate-200 rounded-xl pl-9 pr-3 py-2 text-sm font-bold text-slate-700 outline-none focus:border-[#5B2274] focus:ring-2 focus:ring-purple-100 transition-all shadow-sm"
                                                        value={searchQuery}
                                                        onChange={(e) => setSearchQuery(e.target.value)}
                                                    />
                                                    {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-3 top-2.5 text-slate-300 hover:text-slate-500"><Icon name="X" size={14}/></button>}
                                                </div>
                                            </div>

                                            {/* History Date Picker */}
                                            {currentTab === 'history' && (
                                                <div className="bg-white p-2 rounded-xl border border-slate-200 flex items-center justify-between shadow-sm animate-scale-in max-w-md mx-auto">
                                                    <div className="flex items-center gap-2 text-slate-500 font-bold text-sm ml-2"><Icon name="Calendar" size={16}/> 日期</div>
                                                    <input type="date" className="bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5 text-sm font-bold text-slate-700 outline-none focus:border-[#5B2274]" value={historyDate} onChange={(e) => setHistoryDate(e.target.value)} />
                                                </div>
                                            )}
                                            
                                            {/* Centered Status Filters (1st is '未完成' = 'all') */}
                                            <div className="flex justify-center">
                                                <div className="flex gap-2 overflow-x-auto no-scrollbar py-1 px-1 max-w-full">
                                                    <button 
                                                        onClick={() => setSubFilter('all')} 
                                                        className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition-all ${subFilter === 'all' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200 shadow-sm'}`}
                                                    >
                                                        未完成
                                                    </button>
                                                    {[
                                                        {id: 'pending', label: '待確認', style: STATUS_STYLE.pending},
                                                        {id: 'confirmed', label: '已接單', style: STATUS_STYLE.confirmed},
                                                        {id: 'preparing', label: '製作中', style: STATUS_STYLE.preparing},
                                                        {id: 'ready', label: '待取餐', style: STATUS_STYLE.ready},
                                                        {id: 'completed', label: '已完成', style: STATUS_STYLE.completed},
                                                        {id: 'cancelled', label: '已取消', style: STATUS_STYLE.cancelled}
                                                    ].map(f => {
                                                        const count = getCount(f.id);
                                                        const isActive = subFilter === f.id;
                                                        // Active: Solid Color
                                                        const activeStyle = isActive 
                                                            ? { backgroundColor: f.id==='completed'?'#334155':(f.id==='cancelled'?'#DC2626':(f.id==='ready'?'#16A34A':(f.id==='preparing'?'#EA580C':(f.id==='confirmed'?'#2563EB':'#D97706')))), color:'white', borderColor:'transparent' }
                                                            : {};

                                                        return (
                                                            <button 
                                                                key={f.id} 
                                                                onClick={() => setSubFilter(f.id)}
                                                                className={`px-3 py-1.5 rounded-full text-xs font-black whitespace-nowrap border transition-all flex items-center gap-1 ${!isActive ? f.style.chip : ''}`}
                                                                style={activeStyle}
                                                            >
                                                                {f.label} 
                                                                <span className={`px-1.5 py-0.5 rounded-full text-[10px] bg-white/30 ${isActive?'text-white':'text-current opacity-70'}`}>{count}</span>
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Order List Grid */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4">
                                            {targetOrders.map(order => {
                                                const style = STATUS_STYLE[order.status];
                                                const isUrgent = order.userInfo.pickupTime === 'ASAP';

                                                return (
                                                    <div key={order.id} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden active:scale-[0.99] transition-transform duration-100 group hover:shadow-md cursor-pointer flex flex-col" onClick={() => setModal({ type: 'edit_order', data: order })}>
                                                        <div className="p-5 flex-1">
                                                            <div className="flex justify-between items-start mb-4">
                                                                <div className="flex flex-col">
                                                                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-0.5">預計取餐</span>
                                                                    <div className="flex items-baseline gap-2">
                                                                        <span className={`text-3xl font-[900] tracking-tighter leading-none ${isUrgent ? 'text-red-600' : 'text-slate-800'}`}>{order.userInfo.pickupTime}</span>
                                                                        {isUrgent && <span className="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-pulse">急件</span>}
                                                                    </div>
                                                                </div>
                                                                <div className={`px-3 py-1.5 rounded-lg text-xs font-black border flex items-center gap-1 ${style.bg} ${style.text} ${style.border}`}>
                                                                    <Icon name={style.icon} size={14} /> {style.label}
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center justify-between border-t border-dashed border-slate-100 pt-3">
                                                                <div className="flex items-center gap-3 overflow-hidden">
                                                                    <div className="min-w-0">
                                                                        <div className="text-base font-[900] text-slate-800 truncate mb-0.5">{order.userInfo.name}</div>
                                                                        <div className="text-xs text-slate-400 font-bold truncate flex items-center gap-1.5">
                                                                            <span className="bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">#{order.orderId.slice(-4)}</span><span>•</span>
                                                                            <span className={order.discountAmount > 0 ? "text-red-500 font-bold" : "text-slate-600"}>${order.totalPrice}</span>
                                                                            <span>•</span><span>{order.items.length} 項</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <Icon name="ChevronRight" size={18} className="text-slate-300" />
                                                            </div>
                                                        </div>
                                                        
                                                        {!['completed', 'cancelled'].includes(order.status) && (
                                                            <div className="grid grid-cols-2 divide-x divide-slate-100 border-t border-slate-100 bg-slate-50/50 mt-auto">
                                                                {order.status === 'pending' && (
                                                                    <>
                                                                        <button onClick={(e) => { e.stopPropagation(); handleUpdateOrderStatus(order.id, 'cancelled'); }} className="py-3.5 bg-slate-700 text-white font-bold text-sm hover:bg-slate-800 transition-colors">拒單</button>
                                                                        <button onClick={(e) => { e.stopPropagation(); handleUpdateOrderStatus(order.id, 'confirmed'); }} className="py-3.5 bg-blue-600 text-white font-black text-sm hover:bg-blue-700 transition-colors">確認接單</button>
                                                                    </>
                                                                )}
                                                                {order.status === 'confirmed' && (
                                                                    <button onClick={(e) => { e.stopPropagation(); handleUpdateOrderStatus(order.id, 'preparing'); }} className="col-span-2 py-3.5 text-[#E65100] font-black text-sm bg-orange-50/30 hover:bg-orange-100 transition-colors flex items-center justify-center gap-2"><Icon name="Flame" size={16}/> 開始製作</button>
                                                                )}
                                                                {order.status === 'preparing' && (
                                                                    <button onClick={(e) => { e.stopPropagation(); handleUpdateOrderStatus(order.id, 'ready'); }} className="col-span-2 py-3.5 text-emerald-600 font-black text-sm bg-emerald-50/30 hover:bg-emerald-100 transition-colors flex items-center justify-center gap-2"><Icon name="Check" size={16}/> 製作完成</button>
                                                                )}
                                                                {order.status === 'ready' && (
                                                                    <button onClick={(e) => { e.stopPropagation(); handleUpdateOrderStatus(order.id, 'completed'); }} className="col-span-2 py-3.5 text-white font-black text-sm bg-emerald-600 hover:bg-emerald-700 transition-colors flex items-center justify-center gap-2 shadow-sm"><Icon name="UserCheck" size={16}/> 客人已取餐 (結案)</button>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        {targetOrders.length === 0 && <div className="text-center py-20 text-slate-300 font-bold text-sm">暫無訂單</div>}
                                    </div>
                                );
                            })()}
                        </div>
                    </main>

                    {dialog && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 px-6 animate-fade-in">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => !dialog.isDestructive && setDialog(null)} />
                            <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative z-10 animate-scale-in">
                                <div className="p-6 text-center">
                                    <div className={`w-14 h-14 rounded-full mx-auto flex items-center justify-center mb-4 ${dialog.isDestructive ? 'bg-red-100 text-red-500' : 'bg-slate-100 text-slate-600'}`}><Icon name={dialog.isDestructive ? 'AlertTriangle' : 'Info'} size={28} /></div>
                                    <h3 className="text-lg font-[900] text-slate-800 mb-2">{dialog.title}</h3>
                                    <p className="text-sm text-slate-500 font-bold leading-relaxed">{dialog.message}</p>
                                </div>
                                <div className="flex border-t border-slate-100">
                                    {dialog.type === 'confirm' && <button onClick={() => setDialog(null)} className="flex-1 py-4 text-sm font-bold text-slate-500 hover:bg-slate-50 transition-colors">取消</button>}
                                    <div className="w-px bg-slate-100"></div>
                                    <button onClick={dialog.onConfirm} className={`flex-1 py-4 text-sm font-[900] transition-colors ${dialog.isDestructive ? 'text-red-500 hover:bg-red-50' : 'text-[#5B2274] hover:bg-purple-50'}`}>{dialog.isDestructive ? '確認刪除/拒絕' : '我知道了'}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modal && modal.type === 'edit_order' && (() => {
                        const style = STATUS_STYLE[modal.data.status];
                        return (
                            <div className="fixed inset-0 z-[60] flex items-end lg:items-center justify-center lg:p-4">
                                <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={() => setModal(null)} />
                                <div className="bg-white w-full max-w-lg lg:rounded-2xl rounded-t-3xl shadow-2xl relative z-10 flex flex-col max-h-[90vh] animate-fade-in overflow-hidden">
                                    <div className={`px-6 py-4 flex justify-between items-center border-b ${style.bg} ${style.border}`}>
                                        <div className="flex items-center gap-3">
                                            <div className={`p-2 rounded-lg bg-white/60 ${style.text}`}><Icon name={style.icon} size={20} /></div>
                                            <div><div className={`text-xs font-black uppercase tracking-wider ${style.text}`}>{style.label}</div><div className="text-sm font-bold text-slate-700">#{modal.data.orderId}</div></div>
                                        </div>
                                        <button onClick={() => setModal(null)} className="w-8 h-8 rounded-full bg-white/50 hover:bg-white flex items-center justify-center text-slate-500 transition-colors"><Icon name="X" size={18}/></button>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/50">
                                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 space-y-3">
                                            <div className="flex justify-between items-start">
                                                <div><h3 className="text-lg font-[900] text-slate-800">{modal.data.userInfo.name}</h3><a href="#" className="text-sm font-bold text-blue-500 flex items-center gap-1 mt-1"><Icon name="Phone" size={14}/> {modal.data.userInfo.phone}</a></div>
                                                <div className="text-right"><div className="text-xs text-slate-400 font-bold">預計取餐</div><div className={`text-2xl font-[900] ${modal.data.userInfo.pickupTime==='ASAP'?'text-red-500':'text-slate-800'}`}>{modal.data.userInfo.pickupTime}</div></div>
                                            </div>
                                            <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                                                <div className="flex items-center gap-2 text-xs font-bold text-yellow-700 mb-1"><Icon name="User" size={12}/> 顧客永久註記</div>
                                                <textarea className="w-full bg-transparent text-sm font-bold text-slate-700 resize-none focus:outline-none" rows="2" defaultValue={modal.data.customerNote || ''} placeholder="輸入註記..."></textarea>
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                                            <div className="bg-slate-800 px-5 py-3 flex items-center gap-2 text-white font-[900] text-sm">
                                                <Icon name="CreditCard" size={16} className="text-slate-300"/> 結帳與核銷控制台
                                            </div>
                                            <div className="p-5 space-y-5">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div className="space-y-1">
                                                        <label className="text-[10px] font-bold text-slate-400 uppercase">訂單總金額 (覆寫)</label>
                                                        <div className="relative">
                                                            <span className="absolute left-3 top-2.5 text-slate-400 font-bold">$</span>
                                                            <input type="number" className="w-full bg-slate-50 border border-slate-200 rounded-lg pl-6 pr-3 py-2 text-sm font-[900] text-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-200" defaultValue={modal.data.totalPrice} />
                                                        </div>
                                                    </div>
                                                    <div className="space-y-1">
                                                        <label className="text-[10px] font-bold text-slate-400 uppercase">折扣金額</label>
                                                        <div className="relative">
                                                            <span className="absolute left-3 top-2.5 text-red-400 font-bold">-</span>
                                                            <input type="number" className="w-full bg-red-50 border border-red-100 rounded-lg pl-6 pr-3 py-2 text-sm font-[900] text-red-500 focus:outline-none focus:ring-2 focus:ring-red-200" defaultValue={modal.data.discountAmount} />
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="h-px bg-slate-100 w-full"></div>

                                                <div className="space-y-3">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <div className="p-1.5 bg-red-50 text-red-500 rounded"><Icon name="Ticket" size={16}/></div>
                                                            <div>
                                                                <div className="text-sm font-bold text-slate-700">集點卡折抵</div>
                                                                <div className="text-[10px] font-bold text-slate-400">自動扣除 $50</div>
                                                            </div>
                                                        </div>
                                                        <label className="relative inline-flex items-center cursor-pointer">
                                                            <input type="checkbox" className="sr-only peer" checked={modal.data.discountApplied === 'loyalty'} onChange={toggleLoyaltyDiscount} />
                                                            <div className="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                                                        </label>
                                                    </div>

                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <div className={`p-1.5 rounded transition-colors ${modal.data.verified ? 'bg-emerald-50 text-emerald-500' : 'bg-slate-50 text-slate-400'}`}><Icon name="Verified" size={16}/></div>
                                                            <div>
                                                                <div className="text-sm font-bold text-slate-700">核銷狀態確認</div>
                                                                <div className="text-[10px] font-bold text-slate-400">標記為已核銷/已付款</div>
                                                            </div>
                                                        </div>
                                                        <label className="relative inline-flex items-center cursor-pointer">
                                                            <input type="checkbox" className="sr-only peer" checked={modal.data.verified} onChange={toggleVerified} />
                                                            <div className="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-1 pt-2">
                                                    <label className="text-[10px] font-bold text-slate-400 uppercase">店家內部備註 (Admin Note)</label>
                                                    <input type="text" className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-200" placeholder="例如：已退款處理..." defaultValue={modal.data.adminNote || ''} />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                                            <div className="bg-slate-50 px-4 py-2 text-xs font-black text-slate-400 uppercase tracking-wider">訂單內容</div>
                                            <div className="divide-y divide-slate-100">
                                                {modal.data.items.map((item, idx) => (
                                                    <div key={idx} className="p-4 flex justify-between items-start">
                                                        <div className="flex gap-3"><div className="font-[900] text-slate-400 w-6 pt-0.5">{item.qty}x</div><div><div className="font-bold text-slate-700 text-sm">{item.name}</div>{item.variantName && <div className="text-xs text-slate-400 font-bold">{item.variantName}</div>}</div></div>
                                                        <div className="font-bold text-slate-700">${item.totalPrice}</div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="bg-slate-50 p-4 border-t border-slate-100">
                                                <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-slate-400">小計</span><span className="text-sm font-bold text-slate-600">${modal.data.originalPrice}</span></div>
                                                {modal.data.discountAmount > 0 && <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-red-400">折扣</span><span className="text-sm font-bold text-red-500">-${modal.data.discountAmount}</span></div>}
                                                <div className="flex justify-between items-center pt-2 border-t border-slate-200 border-dashed"><span className="text-sm font-black text-slate-700">總金額</span><span className="text-xl font-[900] text-[#5B2274]">${modal.data.totalPrice}</span></div>
                                            </div>
                                        </div>

                                        {modal.data.note && <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><div className="text-xs font-black text-slate-400 uppercase mb-2">訂單備註</div><p className="text-sm font-bold text-slate-700">{modal.data.note}</p></div>}
                                        <div className="h-4"></div>
                                    </div>
                                    
                                    {!['completed', 'cancelled'].includes(modal.data.status) && (
                                        <div className="p-4 bg-white border-t border-slate-100 grid grid-cols-2 gap-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                                            {modal.data.status === 'pending' && (<><button onClick={() => handleUpdateOrderStatus(modal.data.id, 'cancelled')} className="py-3.5 bg-slate-700 text-white font-bold text-sm hover:bg-slate-800 transition-colors rounded-xl">拒絕接單</button><button onClick={() => handleUpdateOrderStatus(modal.data.id, 'confirmed')} className="py-3.5 bg-blue-600 text-white font-black text-sm hover:bg-blue-700 transition-colors rounded-xl">確認接單</button></>)}
                                            {modal.data.status === 'confirmed' && <button onClick={() => handleUpdateOrderStatus(modal.data.id, 'preparing')} className="col-span-2 py-3.5 rounded-xl bg-orange-500 text-white font-[900] text-sm hover:bg-orange-600 shadow-lg shadow-orange-200 transition-all flex items-center justify-center gap-2"><Icon name="Flame" size={18}/> 開始製作餐點</button>}
                                            {modal.data.status === 'preparing' && <button onClick={() => handleUpdateOrderStatus(modal.data.id, 'ready')} className="col-span-2 py-3.5 rounded-xl bg-emerald-500 text-white font-[900] text-sm hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition-all flex items-center justify-center gap-2"><Icon name="Check" size={18}/> 製作完成，通知取餐</button>}
                                            {modal.data.status === 'ready' && <button onClick={() => handleUpdateOrderStatus(modal.data.id, 'completed')} className="col-span-2 py-3.5 rounded-xl bg-slate-800 text-white font-[900] text-sm hover:bg-slate-900 shadow-lg transition-all flex items-center justify-center gap-2"><Icon name="ShoppingBag" size={18}/> 已完成取餐 (結案)</button>}
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })()}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
