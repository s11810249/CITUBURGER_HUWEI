<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>City Burger Admin V17.3 (Dual LIFF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Cloudinary Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --primary: #5B2274;
            --primary-dark: #3b1649;
            --bg-body: #F8FAFC;
        }

        body { 
            font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-body); 
            color: #1E293B; 
            font-size: 14px; 
            -webkit-tap-highlight-color: transparent;
        }

        @media (min-width: 1024px) {
            body { font-size: 16px; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .glass-sidebar {
            background: linear-gradient(165deg, #5B2274 0%, #2E103B 100%);
            color: white;
        }

        .input-compact { 
            transition: all 0.2s; 
            border: 1px solid #E2E8F0; 
            font-size: 0.875rem;
            padding: 0.6rem 0.75rem;
            width: 100%;
            border-radius: 0.5rem;
        }
        
        @media (min-width: 1024px) {
            .input-compact { 
                padding: 0.75rem 1rem; 
                font-size: 1rem; 
            }
        }

        .input-compact:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(91, 34, 116, 0.08); outline: none; background: white; }

        .time-input-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        input[type="time"] { min-width: 0; width: 100%; appearance: none; }

        .custom-select-container { position: relative; }
        .custom-select-trigger { cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: white; border: 1px solid #E2E8F0; border-radius: 0.5rem; padding: 0.6rem 0.75rem; font-size: 0.875rem; transition: all 0.2s; }
        @media (min-width: 1024px) { .custom-select-trigger { padding: 0.75rem 1rem; font-size: 1rem; } }
        .custom-select-trigger:hover { border-color: #cbd5e1; }
        .custom-select-options { position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background: white; border: 1px solid #E2E8F0; border-radius: 0.5rem; margin-top: 4px; max-height: 240px; overflow-y: auto; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); }
        .custom-option { padding: 8px 12px; cursor: pointer; font-size: 0.85rem; color: #475569; transition: all 0.1s; }
        .custom-option:hover { background-color: #F8FAFC; color: var(--primary); }
        .custom-option.selected { background-color: #F3E8FF; color: var(--primary); }
        .select-search { padding: 8px; border-bottom: 1px solid #E2E8F0; position: sticky; top: 0; background: white; z-index: 10; }
        .select-search input { width: 100%; padding: 6px 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.8rem; outline: none; }
        .select-search input:focus { border-color: var(--primary); }

        .switch { position: relative; display: inline-block; width: 36px; height: 20px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }
        .switch.danger input:checked + .slider { background-color: #ef4444; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; color: var(--primary); font-weight: 800; }
        
        /* Order Status Badges */
        .badge-pending { background: #f1f5f9; color: #64748b; }
        .badge-confirmed { background: #e0f2fe; color: #0284c7; }
        .badge-completed { background: #dcfce7; color: #16a34a; }
        .badge-cancelled { background: #fee2e2; color: #dc2626; }

        /* --- New UI Animations from try.html --- */
        .glass-sidebar { background: linear-gradient(170deg, #5B2274 0%, #1a0b2e 100%); color: white; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-slide-in { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-scale-in { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .toggle-checkbox:checked { right: 0; border-color: #5B2274; }
        .toggle-checkbox:checked + .toggle-label { background-color: #5B2274; }

        /* --- 優化樣式與動畫 --- */
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-slide-in { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-scale-in { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* 手機版 Header 優化 */
        @media (max-width: 640px) {
            .mobile-header-wrap { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .mobile-full-width { width: 100%; }
            .mobile-scroll-x { overflow-x: auto; padding-bottom: 5px; width: 100%; -webkit-overflow-scrolling: touch; }
        }
		
		/* 底部抽屜動畫 */
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .order-drawer {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            height: 92vh; /* 裝置底部上來的頁面高度 */
        }
        /* 全域縮小一點點字體 */
        .text-order-sm { font-size: 0.85rem; }
        .text-order-xs { font-size: 0.75rem; }
		
		/* 底部抽屜效果 */
        @keyframes drawerUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .order-drawer-content { animation: drawerUp 0.3s cubic-bezier(0, 0, 0.2, 1) forwards; height: 90vh; }
        
        /* 訂單內容清單層級線 */
        .item-child-line { border-left: 2px solid #E2E8F0; margin-left: 1.25rem; padding-left: 1rem; }
        
		/* 底部抽屜與字體優化 */
        @keyframes drawerSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .drawer-up { animation: drawerSlideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .order-detail-list-line { border-left: 2px solid #F1F5F9; margin-left: 0.75rem; padding-left: 1rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
		
		/* 優惠券票券風格 */
        .coupon-card {
            background-image: radial-gradient(circle at 0 50%, transparent 12px, white 13px), 
                              radial-gradient(circle at 100% 50%, transparent 12px, white 13px);
            background-size: 100% 100%;
        }
        .coupon-dash {
            border-left: 2px dashed #F1F5F9;
            height: 80%;
            position: absolute;
            left: 25%;
            top: 10%;
        }
		
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        // [Fix] 補上 getDoc
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA9x0gk2zQBJr1vkNLAoBodbBQ3_D2aXag",
            authDomain: "cityburger-huwei.firebaseapp.com",
            projectId: "cityburger-huwei",
            storageBucket: "cityburger-huwei.firebasestorage.app",
            messagingSenderId: "546465207310",
            appId: "1:546465207310:web:4b742f2a3b883dee58585f"
        };
        const appId = "cityburger-huwei-v1";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);

        window.firebase = { auth, db, appId, provider };
        // [Fix] 補上 getDoc 到全域物件
        window.firestore = { collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, writeBatch };
        window.authActions = { signInWithPopup, signOut, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const Icon = ({ name, size = 18, className = "" }) => {
            const [iconData, setIconData] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const pascalName = name.charAt(0).toUpperCase() + name.slice(1);
                    setIconData(window.lucide.icons[name] || window.lucide.icons[pascalName] || null);
                }
            }, [name]);
            if (!iconData) return <span style={{ width: size, height: size }} className={`inline-block ${className}`}></span>;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconData.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i }))}
                </svg>
            );
        };

        const BlurInput = ({ value, onSave, className, type="text", placeholder, list, ...props }) => {
            const [localValue, setLocalValue] = useState(value);
            useEffect(() => { setLocalValue(value); }, [value]);
            const handleBlur = () => { if (localValue !== value) onSave(localValue); };
            const handleKeyDown = (e) => { if (e.key === 'Enter') e.target.blur(); };
            return <input type={type} className={className} value={localValue || ''} onChange={(e) => setLocalValue(e.target.value)} onBlur={handleBlur} onKeyDown={handleKeyDown} placeholder={placeholder} list={list} {...props} />;
        };

        const Button = ({ children, onClick, variant = 'primary', className = "", icon, size="normal" }) => {
            const variants = {
                primary: "bg-[#5B2274] text-white hover:bg-[#4a1b5e] shadow-md shadow-purple-900/10",
                secondary: "bg-white text-slate-600 hover:bg-slate-50 border border-slate-200",
                danger: "bg-red-50 text-red-500 hover:bg-red-100 border border-red-100",
                ghost: "bg-transparent text-slate-400 hover:bg-slate-100",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-md shadow-emerald-200"
            };
            const sizes = { small: "px-2 py-1.5 text-[10px]", normal: "px-4 py-2.5 text-xs lg:text-sm lg:px-6 lg:py-3" };
            return (
                <button onClick={onClick} className={`flex items-center justify-center gap-2 rounded-lg font-bold transition-all active:scale-95 tracking-wide ${variants[variant]} ${sizes[size]} ${className}`}>
                    {icon && <Icon name={icon} size={size==='small'?14:18} />}
                    {children}
                </button>
            );
        };

        const SortButton = ({ direction, onClick, disabled }) => (
            <button onClick={(e) => { e.stopPropagation(); onClick(); }} disabled={disabled} className="w-7 h-7 lg:w-9 lg:h-9 flex items-center justify-center rounded-md bg-slate-100 text-slate-400 hover:bg-slate-200 hover:text-[#5B2274] disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                <Icon name={direction === 'up' ? 'ChevronUp' : 'ChevronDown'} size={14} />
            </button>
        );

        const ToggleSwitch = ({ checked, onChange, variant = "primary" }) => (
            <label className={`switch ${variant}`}>
                <input type="checkbox" checked={checked} onChange={(e) => onChange(e.target.checked)} />
                <span className="slider"></span>
            </label>
        );

        const MultiSelect = ({ value = [], onChange, options, placeholder = "選擇..." }) => {
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => { if (ref.current && !ref.current.contains(event.target)) setIsOpen(false); };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);
            const selectedLabels = options.filter(o => value.includes(o.value)).map(o => o.label).join(", ");
            return (
                <div className="custom-select-container w-full" ref={ref} style={{ zIndex: isOpen ? 50 : 'auto' }}>
                    <div className={`custom-select-trigger ${isOpen ? 'border-[#5B2274]' : ''}`} onClick={() => setIsOpen(!isOpen)}>
                        <span className={`font-medium truncate ${value.length > 0 ? 'text-slate-700' : 'text-slate-400'}`}>
                            {value.length > 0 ? selectedLabels : placeholder}
                        </span>
                        <Icon name="ChevronDown" size={14} className={`text-slate-400 shrink-0 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                    </div>
                    {isOpen && (
                        <div className="custom-select-options no-scrollbar p-1">
                            {options.length > 0 ? options.map(opt => {
                                const isSelected = value.includes(opt.value);
                                return (
                                    <div key={opt.value} className={`custom-option rounded flex items-center justify-between ${isSelected ? 'bg-purple-50 text-[#5B2274]' : ''}`} onClick={(e) => {
                                            e.stopPropagation();
                                            const newValue = isSelected ? value.filter(v => v !== opt.value) : [...value, opt.value];
                                            onChange(newValue);
                                        }}>
                                        <span>{opt.label}</span>
                                        {isSelected && <Icon name="Check" size={14} />}
                                    </div>
                                );
                            }) : <div className="p-3 text-xs text-slate-400 text-center">無選項</div>}
                        </div>
                    )}
                </div>
            );
        };

        const CustomSelect = ({ value, onChange, options, placeholder = "請選擇...", searchable = false, className="", allowCustom = false }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState("");
            const ref = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => { if (ref.current && !ref.current.contains(event.target)) setIsOpen(false); };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);
            const filteredOptions = searchable ? options.filter(opt => opt.label.toLowerCase().includes(search.toLowerCase())) : options;
            const selectedOption = options.find(o => o.value === value);
            return (
                <div className={`custom-select-container w-full ${className}`} ref={ref} style={{ zIndex: isOpen ? 50 : 'auto' }}>
                    <div className={`custom-select-trigger ${isOpen ? 'border-[#5B2274]' : ''}`} onClick={() => { setIsOpen(!isOpen); setSearch(""); }}>
                        <span className={`font-medium truncate ${selectedOption ? 'text-slate-700' : 'text-slate-400'}`}>{selectedOption ? selectedOption.label : (value || placeholder)}</span>
                        <Icon name="ChevronDown" size={14} className={`text-slate-400 shrink-0 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                    </div>
                    {isOpen && (
                        <div className="custom-select-options no-scrollbar">
                            {searchable && (<div className="select-search" onClick={(e) => e.stopPropagation()}><input type="text" placeholder="搜尋或輸入..." value={search} onChange={(e) => setSearch(e.target.value)} autoFocus /></div>)}
                            {allowCustom && search && !filteredOptions.find(o => o.label === search) && (<div className="custom-option text-[#5B2274] font-bold border-b border-purple-50" onClick={() => { onChange(search); setIsOpen(false); }}>+ 使用 "{search}"</div>)}
                            {filteredOptions.length > 0 ? (filteredOptions.map(opt => (<div key={opt.value} className={`custom-option ${value === opt.value ? 'selected' : ''}`} onClick={() => { onChange(opt.value); setIsOpen(false); }}>{opt.label}</div>))) : (!allowCustom && <div className="p-3 text-xs text-slate-400 text-center">無符合項目</div>)}
                        </div>
                    )}
                </div>
            );
        };

        const TAG_COLORS = { red: 'bg-red-500 text-white', orange: 'bg-orange-400 text-white', green: 'bg-emerald-500 text-white', blue: 'bg-blue-500 text-white', purple: 'bg-purple-500 text-white', black: 'bg-slate-800 text-white' };

        const STATUS_MAP = {
            'pending':   { label: '待處理', class: 'bg-slate-100 text-slate-500 border border-slate-200' },
            'confirmed': { label: '已接單', class: 'bg-blue-50 text-blue-600 border border-blue-100' }, // 改為已接單
            'preparing': { label: '製作中', class: 'bg-orange-50 text-orange-600 border border-orange-100' }, // 新增製作中
            'ready':     { label: '已完成', class: 'bg-emerald-50 text-emerald-600 border border-emerald-100' },
            'completed': { label: '已取餐', class: 'bg-green-100 text-green-700 border border-green-200' },
            'cancelled': { label: '已取消', class: 'bg-red-50 text-red-500 border border-red-100' }
        };

        // [修改 2] 取得台灣時間的 YYYY-MM-DD 字串 (用於判斷今日/未來)
        const getTaiwanDateStr = () => {
            return new Date().toLocaleString("en-CA", { timeZone: "Asia/Taipei" }).split(',')[0]; // 格式: YYYY-MM-DD
        };

        const formatTaiwanDate = (dateInput) => {
            const d = new Date(dateInput);
            return d.toLocaleDateString("zh-TW", {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
        };
		
		// [新增] 滑動確認按鈕元件
        const SlideButton = ({ onConfirm, label = "滑動接單", className="" }) => {
            const [val, setVal] = useState(0);
            const [confirmed, setConfirmed] = useState(false);
            return (
                <div className={`relative h-full w-full bg-slate-100 rounded-lg overflow-hidden select-none flex items-center ${className}`}>
                    {/* 進度條底色 */}
                    <div className="absolute inset-y-0 left-0 bg-blue-600 transition-all duration-75" style={{width: val+'%'}}></div>
                    {/* 文字提示 */}
                    <div className="absolute inset-0 flex items-center justify-center text-xs font-black text-slate-400 z-10 pointer-events-none transition-opacity" style={{opacity: val > 50 ? 0 : 1}}>
                        {label} <Icon name="ChevronsRight" size={14} className="ml-0.5 animate-pulse text-slate-300"/>
                    </div>
                    {/* 隱形拉桿 (Range Input) */}
                    <input type="range" min="0" max="100" value={val} 
                        onChange={(e)=>{
                            const v = parseInt(e.target.value);
                            setVal(v);
                            if(v > 90 && !confirmed) { setConfirmed(true); onConfirm(); }
                        }}
                        onTouchEnd={()=>{ if(!confirmed) setVal(0); }}
                        onMouseUp={()=>{ if(!confirmed) setVal(0); }}
                        className="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-20"
                    />
                    {/* 視覺滑塊 */}
                    <div className="absolute top-1 bottom-1 aspect-square bg-white shadow-sm rounded-md pointer-events-none z-10 flex items-center justify-center transition-all duration-75 border border-slate-100" style={{left: `calc(${val}% - ${val*0.4}px + 4px)`}}>
                        <Icon name="ChevronRight" size={16} className={val > 50 ? "text-blue-600" : "text-slate-300"}/>
                    </div>
                </div>
            );
        };
		
// --- [外部定義] 庫存檢查 ---
        // --- [外部定義] 庫存檢查 ---
        const checkStock = (prod, variant = null, materials = []) => {
            if (!prod) return { isOut: true, label: '未知' };
            if (prod.outOfStock || prod.isOut) return { isOut: true, label: '已售完' };
            const outMaterials = materials ? materials.filter(m => m.isOut).map(m => m.id) : [];
            if (variant) {
                if (variant.isOut) return { isOut: true, label: '缺貨' };
                if (variant.materials?.some(mId => outMaterials.includes(mId))) return { isOut: true, label: '缺貨' };
            } 
            if (prod.materials?.some(mId => outMaterials.includes(mId))) return { isOut: true, label: '缺貨' };
            return { isOut: false, label: '' };
        };

        // --- [外部定義] 資料深度還原 ---
        const rehydrateItem = (savedItem, allProducts) => {
            if (!savedItem) return null;
            const pid = savedItem.productId || savedItem.id;
            const originalProduct = allProducts.find(p => p.id === pid);
            
            const product = originalProduct || {
                id: pid,
                name: savedItem.name || '未知商品',
                price: savedItem.price || 0,
                variants: [],
                allowAddons: []
            };

            let variant = savedItem.variant;
            if (!variant && savedItem.variantName && product.variants) {
                variant = product.variants.find(v => v.name === savedItem.variantName);
            }
            if (!variant) variant = { name: savedItem.variantName || '單一規格', price: 0 };

            return {
                ...savedItem,
                product,
                variant,
                addons: savedItem.addons || [],
                name: product.name, 
                variantName: variant.name 
            };
        };

        // --- [外部定義] 訂單資料正規化 ---
        const normalizeOrderItems = (items, allProducts) => {
            return items.map(item => {
                const hydratedMain = rehydrateItem(item, allProducts);
                const newItem = { ...item, ...hydratedMain };

                if (newItem.sideGroups) {
                    const newSides = {};
                    Object.keys(newItem.sideGroups).forEach(key => {
                        const s = newItem.sideGroups[key];
                        const rawData = s.product ? s : { ...s, productId: s.id }; 
                        const hydratedSide = rehydrateItem(rawData, allProducts);
                        if (hydratedSide) newSides[key] = hydratedSide;
                    });
                    newItem.sideGroups = newSides;
                }

                if (newItem.setChoices) {
                    const newChoices = {};
                    const processChoice = (ch) => {
                        if (!ch) return null;
                        const rawData = ch.product ? ch : { ...ch, productId: ch.id };
                        return rehydrateItem(rawData, allProducts);
                    };

                    if (Array.isArray(newItem.setChoices)) {
                        newItem.setChoices.forEach((ch, idx) => { if(ch) newChoices[idx] = processChoice(ch); });
                    } else {
                        Object.keys(newItem.setChoices).forEach(k => { newChoices[k] = processChoice(newItem.setChoices[k]); });
                    }
                    newItem.setChoices = newChoices;
                }
                return newItem;
            });
        };

        // --- [外部定義] 子項目選擇器 ---
        const SubItemSelector = ({ label, options, selected, defaultId, onChange, isRequired, addons, settings, materials, products }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const defaultProd = options.find(p => p.id === defaultId);
            const basePrice = defaultProd ? defaultProd.variants?.[0]?.price || defaultProd.price : 0;
            
            const hasSelected = !!selected?.product;
            const currentName = selected?.product ? selected.product.name : '請選擇';
            const vName = selected?.variant?.name || selected?.variantName;
            const currentVariant = (vName && vName !== '單一規格') ? `(${vName})` : '';
            
            const priceDiff = selected?.product ? ((selected.variant?.price || selected.product.price) - basePrice) : 0;
            const displayPrice = priceDiff > 0 ? `+$${priceDiff}` : '';

            const subProduct = selected?.product;
            const subAvailableAddons = subProduct ? (addons || []).filter(a => (subProduct.allowAddons || []).includes(a.id)) : [];
            const subAddonGroups = {};
            subAvailableAddons.forEach(a => { const c = a.category || '其他'; if (!subAddonGroups[c]) subAddonGroups[c] = []; subAddonGroups[c].push(a); });
            
            let missingAddonGroups = [];
            if (subProduct) {
                Object.keys(subAddonGroups).forEach(cat => {
                    const groupConfig = (settings?.addonGroups || []).find(g => g.name === cat);
                    const min = groupConfig?.minSelect || 0;
                    const selectedCount = selected.addons?.filter(a => a.category === cat).length || 0;
                    if (min > 0 && selectedCount < min) missingAddonGroups.push(cat);
                });
            }
            const isSubValid = missingAddonGroups.length === 0;

            return (
                <div className={`border-b border-slate-100 last:border-0 py-3 ${(!hasSelected && isRequired) || !isSubValid ? 'bg-red-50/50 -mx-2 px-2 rounded-lg' : ''}`}>
                    <div className="flex justify-between items-center cursor-pointer py-1" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                                <span className={`font-bold text-[15px] ${((!hasSelected && isRequired) || !isSubValid) ? 'text-red-600' : 'text-slate-800'}`}>{label}</span>
                                {isRequired && !hasSelected && <span className="text-[10px] bg-red-100 text-red-500 px-1.5 py-0.5 rounded font-bold">必選</span>}
                                {hasSelected && !isSubValid && <span className="text-[10px] bg-red-100 text-red-500 px-1.5 py-0.5 rounded font-bold">客製化未完成</span>}
                            </div>
                            <div className={`text-sm ${hasSelected ? 'text-slate-600 font-bold' : 'text-slate-400'}`}>
                                {currentName} {currentVariant} {displayPrice && <span className="text-[#5B2274]">{displayPrice}</span>}
                            </div>
                            {selected?.addons?.length > 0 && (
                                <div className="text-xs text-slate-400 mt-0.5 font-bold">
                                    {selected.addons.map(a => a.name).join(' / ')}
                                </div>
                            )}
                        </div>
                        <Icon name="ChevronDown" size={20} className={`text-slate-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`}/>
                    </div>

                    {isExpanded && (
                        <div className="bg-slate-50 rounded-xl p-3 space-y-2 mt-2 animate-fade-in border border-slate-100">
                            {options.map(opt => {
                                const stock = checkStock(opt, null, materials);
                                const isSelected = selected?.product?.id === opt.id;
                                const myBase = opt.variants?.[0]?.price || opt.price;
                                const diff = myBase - basePrice;

                                return (
                                    <div key={opt.id} className={`rounded-lg border transition-all bg-white ${isSelected ? 'border-[#5B2274] shadow-sm' : 'border-slate-200'}`}>
                                        <button disabled={stock.isOut} onClick={() => {
                                                const v = opt.variants?.find(vr => !checkStock(opt, vr, materials).isOut) || opt.variants?.[0];
                                                onChange({ product: opt, variant: v, addons: [] });
                                            }}
                                            className="w-full p-3 flex justify-between items-center text-left"
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`w-4 h-4 rounded-full border flex items-center justify-center shrink-0 ${isSelected ? 'border-[#5B2274] bg-[#5B2274]' : 'border-slate-300'}`}>
                                                    {isSelected && <Icon name="Check" size={10} className="text-white"/>}
                                                </div>
                                                <div className={stock.isOut ? "opacity-50" : ""}>
                                                    <span className="font-bold text-slate-800 text-sm">{opt.name}</span>
                                                    {stock.isOut && <span className="text-[10px] text-red-500 ml-2">售完</span>}
                                                </div>
                                            </div>
                                            {diff > 0 && <span className="text-xs font-black text-[#5B2274]">+{diff}</span>}
                                        </button>

                                        {isSelected && ((opt.variants?.length > 1) || (opt.allowAddons?.length > 0)) && (
                                            <div className="px-3 pb-3 pl-10 space-y-3 pt-1 border-t border-dashed border-slate-100">
                                                {opt.variants?.length > 1 && (
                                                    <div className="flex flex-wrap gap-2">
                                                        {opt.variants.map((v, i) => {
                                                            const vStock = checkStock(opt, v, materials);
                                                            const isVSel = selected.variant?.name === v.name;
                                                            const vDiff = v.price - myBase;
                                                            return (
                                                                <button key={i} disabled={vStock.isOut} onClick={(e) => { e.stopPropagation(); onChange({ ...selected, variant: v }); }}
                                                                    className={`px-3 py-1.5 text-xs rounded border font-bold transition-all ${isVSel ? 'bg-[#5B2274] text-white border-[#5B2274]' : 'bg-white text-slate-600 border-slate-200'} ${vStock.isOut ? 'opacity-40 line-through' : ''}`}>
                                                                    {v.name} {vDiff > 0 && `+$${vDiff}`}
                                                                </button>
                                                            );
                                                        })}
                                                    </div>
                                                )}
                                                {Object.entries(subAddonGroups).map(([cat, groupAddons]) => {
                                                    const groupConfig = (settings?.addonGroups || []).find(g => g.name === cat);
                                                    const min = groupConfig?.minSelect || (groupConfig?.required ? 1 : 0);
                                                    const currentSelectedCount = selected.addons?.filter(a => a.category === cat).length || 0;
                                                    const isMissing = min > 0 && currentSelectedCount < min;

                                                    return (
                                                        <div key={cat} className={isMissing ? 'bg-red-50 p-2 rounded-lg -mx-2' : ''}>
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className={`text-[10px] font-bold ${isMissing ? 'text-red-500' : 'text-slate-400'}`}>{cat}</span>
                                                                {isMissing && <span className="text-[9px] bg-red-100 text-red-500 px-1 rounded">必填</span>}
                                                            </div>
                                                            <div className="flex flex-wrap gap-2">
                                                                {groupAddons.map(addon => {
                                                                    const isChecked = selected.addons?.some(ad => ad.id === addon.id);
                                                                    return (
                                                                        <button key={addon.id} onClick={(e) => { 
                                                                            e.stopPropagation(); 
                                                                            const current = selected.addons || []; 
                                                                            const isSingle = groupConfig?.maxSelect === 1;
                                                                            let next = isSingle ? (isChecked?[]:[addon]) : (isChecked?current.filter(ad=>ad.id!==addon.id):[...current, addon]); 
                                                                            onChange({ ...selected, addons: next }); 
                                                                        }}
                                                                        className={`px-3 py-1.5 text-xs rounded border font-bold transition-all flex items-center gap-1 ${isChecked ? 'bg-orange-50 text-orange-600 border-orange-200' : 'bg-white text-slate-500 border-slate-200'}`}>
                                                                            {addon.name} {addon.price > 0 && `+$${addon.price}`}
                                                                        </button>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // --- [外部定義] 商品建構器 ---
        const ProductBuilder = ({ product, initialData, onConfirm, onCancel, sets, addons, settings, materials, products }) => {
            const [variant, setVariant] = useState(() => {
                if (initialData?.variant) return initialData.variant;
                if (initialData?.variantName) return product.variants?.find(v => v.name === initialData.variantName) || { name: initialData.variantName, price: 0 };
                return product.variants?.[0] || {name: '單一規格', price: product.price};
            });

            const [selectedAddons, setSelectedAddons] = useState(() => {
                const initAddons = {};
                (initialData?.addons || []).forEach(a => { 
                    const c = a.category || '其他'; 
                    if(!initAddons[c]) initAddons[c] = []; 
                    initAddons[c].push(a); 
                });
                return initAddons;
            });

            const [note, setNote] = useState(initialData?.note || '');
            const [qty, setQty] = useState(initialData?.qty || 1);
            
            const [sideSelections, setSideSelections] = useState(initialData?.sideGroups || {});
            const [selectedSetId, setSelectedSetId] = useState(initialData?.set?.id || null);
            
            // [Fix] 套餐內容回填：補完固定餐點 (Fixed Items)
            const [setChoices, setSetChoices] = useState(() => {
                const choices = { ...initialData?.setChoices };
                // 若有選套餐，檢查是否有 fixed item 沒被存入
                const currentSet = sets.find(s => s.id === (selectedSetId || initialData?.set?.id));
                if (currentSet && currentSet.contents) {
                    currentSet.contents.forEach((c, idx) => {
                        // 若該位置是空的，且是固定餐點，則自動填入
                        if (!choices[idx] && !choices[c.id] && c.type === 'fixed') {
                            const p = products.find(prod => prod.id === c.productId);
                            if (p) {
                                // 建立一個虛擬選擇
                                const v = p.variants?.[0] || { name: '單一規格', price: p.price };
                                choices[idx] = { product: p, variant: v, addons: [] };
                            }
                        }
                    });
                }
                return choices;
            });

            const validate = () => {
                let missing = [];
                const availableAddons = (addons || []).filter(a => (product.allowAddons || []).includes(a.id));
                const addonGroups = {};
                availableAddons.forEach(a => { const c = a.category || '其他'; if (!addonGroups[c]) addonGroups[c] = []; addonGroups[c].push(a); });
                Object.keys(addonGroups).forEach(cat => {
                        const groupConfig = (settings?.addonGroups || []).find(g => g.name === cat);
                        const min = groupConfig?.minSelect || 0;
                        const current = selectedAddons[cat]?.length || 0;
                        if (min > 0 && current < min) missing.push(cat);
                });
                if (product.sideGroups) { 
                    product.sideGroups.forEach((g, idx) => { 
                        const sel = sideSelections[idx] || sideSelections[g.id];
                        if (!sel?.product) missing.push(`附餐: ${g.title}`); 
                    }); 
                }
                if (selectedSetId) { 
                    const setObj = sets.find(s => s.id === selectedSetId); 
                    if (setObj) { 
                        setObj.contents?.forEach((c, idx) => { 
                            const sel = setChoices[idx] || setChoices[c.id];
                            if (!sel?.product) missing.push(`套餐: ${c.label}`); 
                        }); 
                    } 
                }
                return missing;
            };
            const missingFields = validate();
            const isReadyToAdd = missingFields.length === 0;

            const calculateTotal = () => {
                let total = variant.price;
                Object.values(selectedAddons).flat().forEach(a => total += (a.price || 0));
                if (product.sideGroups) {
                    product.sideGroups.forEach((g, idx) => {
                        const sel = sideSelections[idx] || sideSelections[g.id];
                        if (sel?.product) {
                            const baseP = products.find(p=>p.id === g.defaultProductId);
                            const basePrice = baseP ? (baseP.variants?.[0]?.price || baseP.price) : 0;
                            const currentPrice = (sel.variant?.price || sel.product.price);
                            const addonPrice = (sel.addons || []).reduce((sum, a) => sum + a.price, 0);
                            total += Math.max(0, currentPrice - basePrice) + addonPrice;
                        }
                    });
                }
                if (selectedSetId) {
                    const setObj = sets.find(s => s.id === selectedSetId);
                    if (setObj) {
                        total += setObj.price;
                        setObj.contents?.forEach((content, idx) => {
                            const sel = setChoices[idx] || setChoices[content.id];
                            if (sel?.product) {
                                let basePrice = 0;
                                if (content.type === 'fixed') {
                                    const bp = products.find(p=>p.id===content.productId);
                                    basePrice = bp ? (bp.variants?.[0]?.price || bp.price) : 0;
                                } else {
                                    const bp = products.find(p=>p.id===content.defaultProductId);
                                    basePrice = bp ? (bp.variants?.[0]?.price || bp.price) : 0;
                                }
                                const currentPrice = (sel.variant?.price || sel.product.price);
                                const addonPrice = (sel.addons || []).reduce((sum, a) => sum + a.price, 0);
                                total += Math.max(0, currentPrice - basePrice) + addonPrice;
                            }
                        });
                    }
                }
                return total * qty;
            };

            const handleAddonClick = (addon) => {
                const cat = addon.category || '其他';
                const current = selectedAddons[cat] || [];
                const exists = current.find(a => a.id === addon.id);
                const groupConfig = (settings?.addonGroups || []).find(g => g.name === cat);
                const isSingle = groupConfig?.maxSelect === 1;
                let next = isSingle ? (exists ? [] : [addon]) : (exists ? current.filter(a => a.id !== addon.id) : [...current, addon]);
                setSelectedAddons({ ...selectedAddons, [cat]: next });
            };

            const availableAddons = (addons || []).filter(a => (product.allowAddons || []).includes(a.id));
            const addonGroups = {};
            availableAddons.forEach(a => { const c = a.category || '其他'; if (!addonGroups[c]) addonGroups[c] = []; addonGroups[c].push(a); });

            return (
                <div className="flex-1 flex flex-col h-full bg-white relative">
                    <div className="px-5 py-4 border-b border-slate-100 flex items-center justify-between shrink-0 bg-white z-10 sticky top-0">
                        <button onClick={onCancel} className="w-9 h-9 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 hover:bg-slate-100"><Icon name="ArrowLeft" size={20}/></button>
                        <span className="font-[1000] text-slate-800 text-lg line-clamp-1">{product.name}</span>
                        <div className="w-9"></div>
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scrollbar px-6 py-6 pb-32 space-y-8">
                        {/* 規格 */}
                        {product.variants?.length > 1 && (
                            <div>
                                <div className="flex items-center justify-between mb-3">
                                    <h4 className="font-[1000] text-slate-800 text-base">選擇規格</h4>
                                    <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded">必選</span>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {product.variants.map((v, i) => {
                                        const stock = checkStock(product, v, materials);
                                        const isSel = variant.name === v.name;
                                        return (
                                            <button key={i} disabled={stock.isOut} onClick={() => setVariant(v)} 
                                                className={`px-4 py-2.5 rounded-lg border font-bold transition-all text-sm ${isSel ? 'border-[#5B2274] bg-[#5B2274] text-white' : 'border-slate-200 bg-white text-slate-600'} ${stock.isOut ? 'opacity-40 cursor-not-allowed' : 'active:scale-95'}`}>
                                                {v.name} <span className="opacity-80">${v.price}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* 客製化 */}
                        {Object.entries(addonGroups).map(([catName, groupAddons]) => {
                            const groupConfig = (settings?.addonGroups || []).find(g => g.name === catName);
                            const min = groupConfig?.minSelect || 0;
                            const isRequired = min > 0;
                            const currentCount = selectedAddons[catName]?.length || 0;
                            const isMissing = isRequired && currentCount < min;

                            return (
                                <div key={catName} className={isMissing ? 'bg-red-50 p-3 rounded-xl -mx-3' : ''}>
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="flex items-center gap-2">
                                            <h4 className={`font-[1000] text-base ${isMissing ? 'text-red-600' : 'text-slate-800'}`}>{catName}</h4>
                                            {isMissing && <span className="text-[10px] bg-red-100 text-red-500 px-2 py-0.5 rounded font-bold">必選</span>}
                                        </div>
                                        <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded">{(groupConfig?.maxSelect === 1) ? '單選' : '多選'}</span>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {groupAddons.map(addon => {
                                            const isSelected = selectedAddons[catName]?.some(a => a.id === addon.id);
                                            return (
                                                <button key={addon.id} onClick={() => handleAddonClick(addon)}
                                                    className={`px-4 py-2.5 rounded-lg border font-bold transition-all text-sm flex items-center gap-1 ${isSelected ? 'border-[#5B2274] bg-purple-50 text-[#5B2274]' : 'border-slate-200 bg-white text-slate-600'} hover:border-purple-200 active:scale-95`}>
                                                    {addon.name} {addon.price > 0 && <span className="text-xs opacity-80">+${addon.price}</span>}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}

                        {/* 附餐與套餐 */}
                        {((product.sideGroups?.length > 0) || (product.allowSets?.length > 0)) && (
                            <div className="space-y-6 pt-6 border-t border-slate-100">
                                {(product.sideGroups || []).map((group, idx) => {
                                    const groupProducts = products.filter(p => String(p.categoryId) === String(group.categoryId) && !p.isHidden);
                                    // Fix: 同時嘗試用 ID 和 Index 讀取
                                    const selected = sideSelections[group.id] || sideSelections[idx];
                                    return <SubItemSelector key={`side-${idx}`} label={`附餐：${group.title}`} options={groupProducts} defaultId={group.defaultProductId} 
                                        selected={selected} 
                                        onChange={(val) => setSideSelections({ ...sideSelections, [group.id]: val })} 
                                        isRequired={true} addons={addons} settings={settings} materials={materials} products={products} />;
                                })}

                                {(product.allowSets || []).length > 0 && (
                                    <div>
                                        <h4 className="font-[1000] text-slate-800 text-base mb-4">升級套餐</h4>
                                        <div className="space-y-4">
                                            <div onClick={() => { setSelectedSetId(null); setSetChoices({}); }} className={`flex justify-between items-center p-4 rounded-xl border-2 cursor-pointer transition-all ${!selectedSetId ? 'border-slate-800 bg-slate-800 text-white shadow-lg' : 'border-slate-100 bg-white text-slate-500'}`}><span className="font-bold text-base">單點 (不加套餐)</span>{selectedSetId === null && <Icon name="CheckCircle" size={20}/>}</div>
                                            {product.allowSets.map(setId => {
                                                const setObj = sets.find(s => s.id === setId);
                                                if (!setObj) return null;
                                                const isSel = selectedSetId === setObj.id;
                                                return (
                                                    <div key={setObj.id} className={`rounded-xl border-2 transition-all overflow-hidden ${isSel ? 'border-[#5B2274] bg-white' : 'border-slate-100 bg-white'}`}>
                                                        <div onClick={() => setSelectedSetId(setObj.id)} className="p-4 cursor-pointer"><div className="flex justify-between items-center mb-1"><span className={`font-[900] text-lg ${isSel ? 'text-[#5B2274]' : 'text-slate-800'}`}>{setObj.name}</span><span className="font-[1000] text-[#5B2274] text-lg">+${setObj.price}</span></div><div className="text-sm text-slate-400 font-medium">{setObj.contents?.map(c => c.label).join(' + ')}</div></div>
                                                        {isSel && (<div className="px-4 pb-4 space-y-2 border-t border-slate-100 pt-3">{setObj.contents?.map((content, cIdx) => { 
                                                            let options = []; let defaultId = ''; 
                                                            if (content.type === 'fixed') { const p = products.find(p => p.id === content.productId); if (p) options = [p]; defaultId = content.productId; } 
                                                            else { options = products.filter(p => String(p.categoryId) === String(content.categoryId) && !p.isHidden); defaultId = content.defaultProductId; } 
                                                            
                                                            // Fix: 同時嘗試用 ID 和 Index 讀取
                                                            const selected = setChoices[content.id] || setChoices[cIdx];
                                                            
                                                            return <SubItemSelector key={`set-content-${cIdx}`} label={content.label} options={options} defaultId={defaultId} 
                                                                selected={selected} 
                                                                onChange={(val) => setSetChoices({ ...setChoices, [cIdx]: val })} // 寫入時用 index 確保順序
                                                                isRequired={true} addons={addons} settings={settings} materials={materials} products={products} />; 
                                                        })}</div>)}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        <div className="space-y-4 pt-6 pb-2 border-t border-slate-100">
                            <div><h4 className="font-[900] text-slate-800 text-base mb-2">備註</h4><textarea className="w-full p-3 bg-slate-100 border-none rounded-xl font-bold text-slate-600 outline-none focus:ring-2 focus:ring-[#5B2274]/20 resize-none text-base" rows="2" placeholder="備註..." value={note} onChange={e => setNote(e.target.value)}></textarea></div>
                            <div className="flex items-center justify-between"><span className="font-[900] text-slate-800 text-lg">數量</span><div className="flex items-center gap-4 bg-slate-100 p-1.5 rounded-xl border border-slate-200"><button onClick={() => setQty(Math.max(1, qty - 1))} className="w-10 h-10 bg-white border border-slate-200 rounded-lg flex items-center justify-center shadow-sm active:scale-90 transition-transform"><Icon name="Minus" size={18} className="text-slate-600"/></button><span className="font-[1000] text-xl w-8 text-center text-slate-800">{qty}</span><button onClick={() => setQty(qty + 1)} className="w-10 h-10 bg-[#5B2274] text-white rounded-lg flex items-center justify-center shadow-lg shadow-purple-200 active:scale-90 transition-transform"><Icon name="Plus" size={18}/></button></div></div>
                        </div>
                    </div>

                    <div className="p-4 bg-white border-t border-slate-100 sticky bottom-0 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                        <button disabled={!isReadyToAdd} onClick={() => { const setObj = selectedSetId ? sets.find(s => s.id === selectedSetId) : null; const newItem = { productId: product.id, name: product.name, variantName: variant.name, variant: variant, unitPrice: calculateTotal() / qty, qty: qty, totalPrice: calculateTotal(), addons: Object.values(selectedAddons).flat(), sideGroups: sideSelections, set: setObj, setChoices: setChoices, note: note, image: product.image }; onConfirm(newItem); }} className={`w-full py-4 rounded-2xl font-[1000] text-lg shadow-none flex justify-between px-6 transition-all ${isReadyToAdd ? 'bg-[#5B2274] text-white hover:bg-[#4a1b5e] active:scale-[0.98]' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}><span>{isReadyToAdd ? (initialData ? '確認修改' : '加入訂單') : `未完成 (${missingFields.length})`}</span><span>${calculateTotal()}</span></button>
                    </div>
                </div>
            );
        };

        // [New] 訂單變更抽屜主元件 (V32.0: 資料讀取萬能版 / 樣式完全復刻)
        const EditCartDrawer = ({ order, products, categories, sets, addons, settings, materials, onClose, onSave }) => {
            const [items, setItems] = useState(() => {
                const rawItems = JSON.parse(JSON.stringify(order.items || []));
                return normalizeOrderItems(rawItems, products);
            });
            const [pickupDate, setPickupDate] = useState(order.userInfo?.pickupDate || '');
            const [pickupTime, setPickupTime] = useState(order.userInfo?.pickupTime || '');
            
            const [viewStack, setViewStack] = useState(['cart']); 
            const currentView = viewStack[viewStack.length - 1];
            const [activeCategory, setActiveCategory] = useState(categories[0]?.id || '');
            const [searchTerm, setSearchTerm] = useState('');
            const [editingIndex, setEditingIndex] = useState(null); 
            const [selectedProduct, setSelectedProduct] = useState(null);

            const pushView = (view) => setViewStack([...viewStack, view]);
            const popView = () => { if (viewStack.length > 1) setViewStack(viewStack.slice(0, -1)); else onClose(); };
            const resetToCart = () => setViewStack(['cart']);

            const total = items.reduce((sum, item) => item.skip ? sum : sum + (item.totalPrice || 0), 0);
            const updateQty = (idx, delta) => { const newItems = [...items]; const item = newItems[idx]; const newQty = Math.max(1, item.qty + delta); const unitPrice = item.totalPrice / item.qty; item.qty = newQty; item.totalPrice = unitPrice * newQty; setItems(newItems); };
            const toggleSkip = (idx) => { const newItems = [...items]; newItems[idx].skip = !newItems[idx].skip; setItems(newItems); };
            const removeItem = (idx) => { if(confirm('確定移除？')) setItems(items.filter((_, i) => i !== idx)); };
            const handleEditItem = (index) => { const item = items[index]; const product = item.product || products.find(p => p.id === (item.productId || item.id)); if (!product) return alert('找不到商品資料'); setEditingIndex(index); setSelectedProduct(product); pushView('product'); };
            const handleSave = () => { onSave({ ...order, items: items, totalPrice: total, userInfo: { ...order.userInfo, pickupDate, pickupTime } }); };

            // [萬能資料讀取] 
            const getItemDisplayData = (item) => {
                const pName = item.product ? item.product.name : item.name;
                const vName = item.variant?.name || item.variantName;
                const adList = item.addons || [];
                return { 
                    name: pName, 
                    variant: (vName && vName !== '單一規格') ? vName : '', 
                    addons: adList.map(a => a.name) 
                };
            };

            const renderContent = () => {
                if (currentView === 'product' && selectedProduct) { return <ProductBuilder product={selectedProduct} initialData={editingIndex !== null ? items[editingIndex] : null} onCancel={() => { setSelectedProduct(null); setEditingIndex(null); popView(); }} onConfirm={(newItem) => { if (editingIndex !== null) { const newItems = [...items]; newItems[editingIndex] = newItem; setItems(newItems); } else { setItems([...items, newItem]); } setSelectedProduct(null); setEditingIndex(null); resetToCart(); }} sets={sets} addons={addons} settings={settings} materials={materials} products={products} />; }
                return (
                    <div className="flex flex-col h-full">
                        <div className="px-6 py-4 bg-white border-b border-slate-100 flex justify-between items-center shrink-0 z-20 shadow-[0_2px_10px_rgba(0,0,0,0.03)]"><div className="flex items-center gap-3">{currentView === 'menu' ? (<button onClick={popView} className="w-10 h-10 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-600 transition-colors"><Icon name="ArrowLeft" size={20}/></button>) : (<div className="bg-[#5B2274] w-10 h-10 flex items-center justify-center rounded-xl text-white shadow-lg shadow-purple-100"><Icon name="Edit3" size={20}/></div>)}<div><h3 className="text-xl font-[1000] text-slate-800">{currentView === 'menu' ? '新增商品' : '變更訂單'}</h3></div></div><button onClick={onClose} className="w-10 h-10 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-400 transition-colors"><Icon name="X" size={22}/></button></div>
                        <div className="flex-1 overflow-hidden relative bg-[#F8FAFC]">
                            {currentView === 'cart' && (
                                <div className="h-full overflow-y-auto custom-scrollbar p-4 pb-32 space-y-4">
                                    <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex gap-4"><div className="space-y-1 flex-1"><div className="flex items-center gap-1 text-[10px] font-black text-slate-400 uppercase tracking-wider"><Icon name="Calendar" size={10}/> 取餐日期</div><input type="date" className="w-full bg-slate-50 border-none rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none" value={pickupDate} onChange={e => setPickupDate(e.target.value)} /></div><div className="space-y-1 flex-1"><div className="flex items-center gap-1 text-[10px] font-black text-slate-400 uppercase tracking-wider"><Icon name="Clock" size={10}/> 取餐時間</div><input type="time" className="w-full bg-slate-50 border-none rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none" value={pickupTime === 'ASAP' ? '' : pickupTime} onChange={e => setPickupTime(e.target.value)} /></div></div>
                                    {items.map((item, idx) => {
                                        const main = getItemDisplayData(item);
                                        return (
                                            <div key={idx} className="space-y-8 p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                                <div className="flex gap-4 items-start">
                                                    {/* Left: Qty */}
                                                    <div className="w-9 h-9 bg-slate-100 rounded-lg flex items-center justify-center text-slate-600 font-[900] text-sm shrink-0 mt-0.5">{item.qty}x</div>
                                                    
                                                    <div className="flex-1 min-w-0">
                                                        {/* Header */}
                                                        <div className="flex justify-between items-start mb-1">
                                                            <div className="font-[900] text-slate-800 text-lg leading-tight">{main.name}</div>
                                                            <div className="font-[900] text-slate-800 text-lg ml-3">${item.totalPrice}</div>
                                                        </div>

                                                        {/* Main Specs */}
                                                        {(main.variant || main.addons.length > 0) && (
                                                            <div className="text-sm font-bold text-slate-400 mb-3">
                                                                {[main.variant, ...main.addons].filter(Boolean).join(' / ')}
                                                            </div>
                                                        )}

                                                        {/* Side Groups (附餐) - 樣式 1:1 復刻 */}
                                                        {item.sideGroups && Object.values(item.sideGroups).some(s => s.product || s.name) && (
                                                            <div className="bg-[#FAF5FF] rounded-xl p-4 mb-3 space-y-3">
                                                                <div className="text-sm font-[900] text-[#5B2274]">附餐：</div>
                                                                <div className="space-y-2">
                                                                    {Object.values(item.sideGroups).map((s, i) => {
                                                                        const info = getItemDisplayData(s);
                                                                        if (!info.name) return null;
                                                                        return (
                                                                            <div key={i}>
                                                                                <div className="flex items-start text-sm font-bold text-slate-700">
                                                                                    <span className="mr-1.5 text-slate-400">•</span>
                                                                                    <span>{info.name}</span>
                                                                                </div>
                                                                                {(info.variant || info.addons.length > 0) && (
                                                                                    <div className="text-xs font-bold text-slate-400 pl-4 mt-0.5">
                                                                                        {[info.variant, ...info.addons].filter(Boolean).join(' / ')}
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* Set Groups (套餐) - 樣式 1:1 復刻 */}
                                                        {item.set && (
                                                            <div className="bg-[#FAF5FF] rounded-xl p-4 mb-3 space-y-3">
                                                                <div className="text-sm font-[900] text-[#5B2274]">升級套餐：{item.set.name}</div>
                                                                <div className="space-y-2">
                                                                    {item.set.contents?.map((c, ci) => {
                                                                        const choice = item.setChoices ? (item.setChoices[ci] || item.setChoices[c.id]) : null;
                                                                        
                                                                        let info = { name: '', variant: '', addons: [] };
                                                                        if (choice) {
                                                                            info = getItemDisplayData(choice);
                                                                        } else if (c.type === 'fixed') {
                                                                            const fp = products.find(p => p.id === c.productId);
                                                                            info.name = fp ? fp.name : '固定餐點';
                                                                        }

                                                                        if (!info.name) return null;

                                                                        return (
                                                                            <div key={ci}>
                                                                                <div className="flex items-start text-sm font-bold text-slate-700">
                                                                                    <span className="mr-1.5 text-slate-400">•</span>
                                                                                    <span>{info.name}</span>
                                                                                </div>
                                                                                {(info.variant || info.addons.length > 0) && (
                                                                                    <div className="text-xs font-bold text-slate-400 pl-4 mt-0.5">
                                                                                        {[info.variant, ...info.addons].filter(Boolean).join(' / ')}
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* Note */}
                                                        {item.note && (
                                                            <div className="bg-orange-50 rounded-xl p-4 mb-3 text-sm font-bold text-orange-600">
                                                                備註：{item.note}
                                                            </div>
                                                        )}

                                                        {/* Buttons */}
                                                        <div className="flex items-center justify-between mt-2 pt-3 border-t border-dashed border-slate-100">
                                                            <div className="flex gap-2">
                                                                <button onClick={() => updateQty(idx, -1)} className="w-9 h-9 flex items-center justify-center bg-slate-100 text-slate-500 rounded-lg hover:bg-slate-200"><Icon name="Minus" size={16}/></button>
                                                                <button onClick={() => updateQty(idx, 1)} className="w-9 h-9 flex items-center justify-center bg-purple-50 text-[#5B2274] rounded-lg hover:bg-purple-100"><Icon name="Plus" size={16}/></button>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button onClick={() => handleEditItem(idx)} className="w-9 h-9 flex items-center justify-center bg-blue-50 text-blue-500 rounded-lg hover:bg-blue-100" title="編輯"><Icon name="Edit3" size={16}/></button>
                                                                <button onClick={() => toggleSkip(idx)} className={`w-9 h-9 flex items-center justify-center rounded-lg ${item.skip ? 'bg-slate-600 text-white' : 'bg-slate-50 text-slate-400'}`} title="劃掉"><Icon name={item.skip ? "EyeOff" : "Eye"} size={16}/></button>
                                                                <button onClick={() => removeItem(idx)} className="w-9 h-9 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100" title="移除"><Icon name="Trash2" size={16}/></button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    <button onClick={() => { setEditingIndex(null); setSelectedProduct(null); pushView('menu'); }} className="w-full py-5 border-2 border-dashed border-slate-300 rounded-3xl text-slate-400 font-[1000] text-lg flex items-center justify-center gap-2 hover:bg-slate-50 hover:border-slate-400 hover:text-slate-500 transition-all active:scale-[0.99]"><Icon name="PlusCircle" size={24}/> 新增商品</button>
                                </div>
                            )}
                            {currentView === 'menu' && (
                                <div className="flex h-full"><div className="w-[28%] bg-slate-50 h-full overflow-y-auto custom-scrollbar border-r border-slate-200">{categories.map(c => (<button key={c.id} onClick={() => setActiveCategory(c.id)} className={`w-full py-5 px-3 text-xs font-[900] text-left transition-all relative ${activeCategory === c.id ? 'bg-white text-[#5B2274]' : 'text-slate-400 hover:bg-slate-100'}`}>{activeCategory === c.id && <div className="absolute left-0 top-0 bottom-0 w-1 bg-[#5B2274] rounded-r-full"></div>}{c.name}</button>))}</div><div className="w-[72%] h-full overflow-y-auto custom-scrollbar p-4 bg-white pb-20"><div className="sticky top-0 bg-white z-10 pb-4"><div className="relative"><Icon name="Search" size={16} className="absolute left-3 top-3 text-slate-400"/><input type="text" placeholder="搜尋..." className="w-full bg-slate-50 border border-slate-100 rounded-2xl pl-10 pr-4 py-2.5 text-sm font-bold outline-none focus:ring-2 focus:ring-[#5B2274]/10 transition-all" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div></div><div className="space-y-4">{products.filter(p => (String(p.categoryId) === String(activeCategory)) && !p.isHidden && p.name.includes(searchTerm)).map(p => { const stock = checkStock(p, null, materials); return (<button key={p.id} disabled={stock.isOut} onClick={() => { setSelectedProduct(p); setEditingIndex(null); pushView('product'); }} className={`w-full p-3 rounded-2xl border flex items-center gap-3 transition-all text-left ${stock.isOut ? 'opacity-50 grayscale border-slate-100 cursor-not-allowed' : 'border-slate-100 hover:border-[#5B2274] hover:shadow-lg bg-white group'}`}><div className="flex-1 min-w-0"><div className="font-bold text-slate-700 text-sm mb-1 line-clamp-1">{p.name}</div><div className="text-base font-[1000] text-slate-900">${p.price}</div></div>{!stock.isOut && <div className="w-8 h-8 rounded-full bg-[#5B2274] text-white flex items-center justify-center shadow-md shadow-purple-200"><Icon name="Plus" size={16}/></div>}</button>); })}</div></div></div>
                            )}
                        </div>

                        {currentView === 'cart' && (
                            <div className="p-5 bg-white border-t border-slate-100 shadow-[0_-5px_40px_rgba(0,0,0,0.08)] z-30 pb-10">
                                <div className="flex justify-between items-end mb-5 px-2"><span className="text-xs font-black text-slate-400 uppercase tracking-widest">修改後總金額</span><span className="text-4xl font-[1000] text-[#5B2274] tracking-tight">${total}</span></div>
                                <div className="flex gap-3"><button onClick={onClose} className="w-24 rounded-2xl bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200 transition-all font-bold">放棄變更</button><button onClick={handleSave} className="flex-1 h-16 bg-[#5B2274] text-white font-[1000] text-xl rounded-2xl hover:bg-[#4a1b5e] flex items-center justify-center gap-3">儲存變更</button></div>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 z-[110] flex items-center justify-center">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity" onClick={onClose} />
                    <div className="bg-[#F8FAFC] w-full max-w-2xl h-[90vh] md:rounded-[2rem] rounded-t-[2rem] shadow-2xl relative z-10 flex flex-col overflow-hidden animate-slide-up transform">
                        {renderContent()}
                    </div>
                </div>
            );
        };
		
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('orders'); // Default to orders
            const [activeCategory, setActiveCategory] = useState('');
            const [mobileOpen, setMobileOpen] = useState(false);
            const [modal, setModal] = useState(null);
            const [categories, setCategories] = useState([]);
            const [products, setProducts] = useState([]);
            const [addons, setAddons] = useState([]);
            const [sets, setSets] = useState([]);
            const [materials, setMaterials] = useState([]);
            const [orders, setOrders] = useState([]);
			const [members, setMembers] = useState([]); // 儲存會員清單
            const [coupons, setCoupons] = useState([]);
            const [settings, setSettings] = useState({ statusMode: 'auto', openTime: '06:00', closeTime: '13:30', phone: '', address: '', mapsUrl: '', closedDays: [], announcements: ['', '', ''], specialDates: [], productTags: [], cloudinaryCloudName: '', cloudinaryUploadPreset: '', materialGroups: [], addonGroups: [], liffId: '', liffIdBrowse: '' });

            // --- [訂單管理核心邏輯：狀態與過濾] ---
            const [orderFilter, setOrderFilter] = useState('today'); 
            const [subFilter, setSubFilter] = useState('all');       
            const [searchQuery, setSearchQuery] = useState(''); 

            const todayStr = getTaiwanDateStr();
            const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
			const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const [historyDate, setHistoryDate] = useState(todayStr); 
            const [futureDate, setFutureDate] = useState(tomorrowStr);
            const [currentTime, setCurrentTime] = useState(new Date());

            const [customerNote, setCustomerNote] = useState(''); 
            
            // [Fix] 會員詳情 Modal 的完整狀態 (確保只宣告一次)
            const [memberHistorySearch, setMemberHistorySearch] = useState('');
            const [memberHistoryFilter, setMemberHistoryFilter] = useState('all');
            const [memberInternalTab, setMemberInternalTab] = useState('overview');
            const [memberNote, setMemberNote] = useState('');
            const [isMemberSaving, setIsMemberSaving] = useState(false);
			
			// [Req] 會員消費紀錄分頁狀態
            const [memberHistoryPage, setMemberHistoryPage] = useState(1);
            const [memberHistoryRows, setMemberHistoryRows] = useState(5); // 預設每頁 5 筆
			
			// [Req] 視窗導航堆疊 (實現多層彈窗返回)
            const [modalHistory, setModalHistory] = useState([]);
			
			// [New] 特約機構狀態
            const [organizations, setOrganizations] = useState([]);

            // 在現有的 useEffect (Fetch Data) 中新增對 organizations 的監聽
            useEffect(() => {
                if (!user) return;
                const { db, appId } = window.firebase;
                const { collection, onSnapshot } = window.firestore;

                const unsubOrgs = onSnapshot(
                    collection(db, 'artifacts', appId, 'public', 'data', 'organizations'),
                    (snap) => {
                        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        setOrganizations(data);
                    },
                    (err) => console.error("Fetch organizations error:", err)
                );

                return () => unsubOrgs();
            }, [user]);

            // [New] 推入新視窗 (保留當前視窗到歷史紀錄)
            const handlePushModal = (newModal) => {
                if (modal) {
                    setModalHistory(prev => [...prev, modal]);
                }
                setModal(newModal);
            };

            // [New] 返回上一頁 (如果沒有上一頁則關閉)
            const handlePopModal = () => {
                if (modalHistory.length > 0) {
                    const prev = modalHistory[modalHistory.length - 1];
                    setModalHistory(prevHistory => prevHistory.slice(0, -1));
                    setModal(prev);
                } else {
                    setModal(null);
                }
            };

            // [New] 開啟新主視窗 (清空歷史紀錄) - 用於列表點擊
            const handleOpenMainModal = (newModal) => {
                setModalHistory([]);
                setModal(newModal);
            };

            // [Fix] 當開啟會員詳情時，初始化這些狀態
            useEffect(() => {
                if (modal && modal.type === 'member_detail') {
                    setMemberHistorySearch('');
                    setMemberHistoryFilter('all');
                    setMemberInternalTab('overview');
                    setMemberNote(modal.data.internalNote || '');
                    setMemberHistoryPage(1); // 重置頁碼
                }
            }, [modal]);

            // [Fix] 儲存會員備註的獨立函式
            const handleSaveMemberNote = async () => {
                if (!modal || modal.type !== 'member_detail') return;
                setIsMemberSaving(true);
                try {
                    const { db, appId } = window.firebase;
                    const { doc, setDoc } = window.firestore;
                    // 更新資料庫
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', modal.data.id), { internalNote: memberNote }, { merge: true });
                    // 同步更新本地 modal 資料，讓畫面不需重整
                    setModal({ ...modal, data: { ...modal.data, internalNote: memberNote } });
                    setIsMemberSaving(false);
                } catch(e) {
                    console.error(e);
                    alert('儲存失敗');
                    setIsMemberSaving(false);
                }
            };
			
			// [Req] 會員管理 - 列表狀態 (排序、分頁)
            const [memberSortConfig, setMemberSortConfig] = useState({ key: 'lastOrderDate', direction: 'desc' });
            const [memberPage, setMemberPage] = useState(1);
            const [memberRowsPerPage, setMemberRowsPerPage] = useState(10);
            
            // [Req] 會員詳情 Modal - 內部 Tab 狀態
            const [memberModalTab, setMemberModalTab] = useState('overview'); // 'overview' | 'history' | 'coupons'

            const deleteNotification = (id) => setNotifications(prev => prev.filter(n => n.id !== id));

            const STATUS_STYLE = {
                'pending':   { bg: 'bg-amber-50', text: 'text-amber-600', label: '待確認', border: 'border-amber-200', icon: 'BellRing' },
                'confirmed': { bg: 'bg-blue-50', text: 'text-blue-600', label: '已接單', border: 'border-blue-200', icon: 'ChefHat' },
                'preparing': { bg: 'bg-orange-50', text: 'text-orange-600', label: '製作中', border: 'border-orange-200', icon: 'Flame' },
                'ready':     { bg: 'bg-emerald-50', text: 'text-emerald-600', label: '待取餐', border: 'border-emerald-200', icon: 'ShoppingBag' },
                'completed': { bg: 'bg-slate-100', text: 'text-slate-600', label: '已完成', border: 'border-slate-200', icon: 'CheckCircle2' },
                'cancelled': { bg: 'bg-red-50', text: 'text-red-500', label: '已取消', border: 'border-red-200', icon: 'XCircle' }
            };
			
			const ORDER_TYPES = {
                'takeout':  { label: '自取', icon: 'ShoppingBag', bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-200', dot: 'bg-blue-500' },
                'delivery': { label: '外送', icon: 'Bike',        bg: 'bg-yellow-50', text: 'text-yellow-700', border: 'border-yellow-200', dot: 'bg-yellow-500' },
                'dinein':   { label: '內用', icon: 'Utensils',    bg: 'bg-rose-50', text: 'text-rose-700', border: 'border-rose-200', dot: 'bg-rose-500' }
            };

            const getTabCount = (tab) => orders.filter(o => {
                const pDate = o.userInfo?.pickupDate || '1970-01-01';
                const isDone = ['completed', 'cancelled'].includes(o.status);
                return (tab === 'today' ? pDate === todayStr : pDate > todayStr) && !isDone;
            }).length;

            const getStatusCount = (status) => orders.filter(o => {
                const pDate = o.userInfo?.pickupDate || '1970-01-01';
                if (orderFilter === 'history' ? pDate !== historyDate : (orderFilter === 'future' ? pDate !== futureDate : pDate !== todayStr)) return false;
                return status === 'all' ? !['completed', 'cancelled'].includes(o.status) : o.status === status;
            }).length;

            const filteredOrders = useMemo(() => {
                return orders.filter(o => {
                    const pDate = o.userInfo?.pickupDate || '1970-01-01';
                    const isDone = ['completed', 'cancelled'].includes(o.status);
                    if (orderFilter === 'history' ? pDate !== historyDate : (orderFilter === 'future' ? pDate !== futureDate : pDate !== todayStr)) return false;
                    if (subFilter === 'all' ? isDone : o.status !== subFilter) return false;
                    if (searchQuery) {
                        const q = searchQuery.toLowerCase();
                        return o.orderId?.toLowerCase().includes(q) || o.userInfo?.name?.toLowerCase().includes(q) || o.userInfo?.phone?.includes(q);
                    }
                    return true;
                }).sort((a, b) => (orderFilter === 'history' ? new Date(b.createdAt) - new Date(a.createdAt) : a.userInfo?.pickupTime.localeCompare(b.userInfo?.pickupTime)));
            }, [orders, orderFilter, subFilter, historyDate, futureDate, searchQuery, todayStr]);
            
			const optimizedCoupons = useMemo(() => {
                const now = new Date();
                return coupons.map(c => {
                    // 從訂單中計算這張券被用了幾次
                    const usageCount = orders.filter(o => o.couponCode === c.code && o.status === 'completed').length;
                    
                    // 判斷狀態
                    let status = 'active'; // 進行中
                    if (c.startDate && new Date(c.startDate) > now) status = 'scheduled'; // 尚未開始
                    if (c.expiry && new Date(c.expiry) < now) status = 'expired'; // 已過期
                    
                    return { ...c, usageCount, status };
                });
            }, [coupons, orders]);
			
            // 定義統一的資料庫路徑產生器 (避免手寫錯誤)
            const getUserDocRef = (uid) => {
                const { db, appId } = window.firebase;
                const { doc } = window.firestore;
                // 確保這裡的路徑與您的 Firestore Rules 完全一致
                return doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
            };

            // 1. 讀取顧客資料
            useEffect(() => {
                if (modal && modal.type === 'edit_order' && modal.data?.customerUid) {
                    try {
                        const { onSnapshot } = window.firestore;
                        const userRef = getUserDocRef(modal.data.customerUid);

                        const unsubscribe = onSnapshot(userRef, (docSnap) => {
                            if (docSnap.exists()) {
                                setCustomerNote(docSnap.data().internalNote || '');
                            } else {
                                setCustomerNote('');
                            }
                        }, (error) => {
                            console.error("讀取監聽失敗:", error);
                        });

                        return () => unsubscribe();
                    } catch (e) {
                        console.error("讀取初始化錯誤:", e);
                    }
                } else {
                    setCustomerNote('');
                }
            }, [modal]);

            // 2. 儲存顧客註記
            const saveCustomerNote = async () => {
                if (!modal.data?.customerUid) {
                    alert("錯誤：此訂單沒有綁定 customerUid，無法儲存。");
                    return;
                }
                
                try {
                    const { setDoc } = window.firestore;
                    const userRef = getUserDocRef(modal.data.customerUid);

                    await setDoc(userRef, {
                        internalNote: customerNote
                    }, { merge: true });
                    
                    alert('✅ 成功！顧客永久註記已寫入資料庫。');
                } catch (error) {
                    console.error("儲存失敗詳細原因:", error);
                    alert(`儲存失敗！\n請檢查 Console 錯誤訊息。\n常見原因：規則權限不足或路徑錯誤。`);
                }
            };
			
			// 在 useEffect 中新增對 users 集合的監聽
            useEffect(() => {
                if (!user) return;
                const { db, appId } = window.firebase;
                const { collection, onSnapshot } = window.firestore;

                const unsubscribeMembers = onSnapshot(
                    collection(db, 'artifacts', appId, 'public', 'data', 'users'),
                    (snap) => {
                        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        setMembers(data);
                    },
                    (err) => console.error("Fetch members error:", err)
                );

                return () => unsubscribeMembers();
            }, [user]);

            // 計算會員統計數據的邏輯 (Memoized)
            const memberStats = useMemo(() => {
                return members.map(m => {
                    const mOrders = orders.filter(o => o.customerUid === m.id);
                    const completedOrders = mOrders.filter(o => o.status === 'completed');
                    const totalSpend = completedOrders.reduce((sum, o) => sum + (o.totalPrice || 0), 0);
                    return {
                        ...m,
                        orderCount: mOrders.length,
                        avgSpend: mOrders.length > 0 ? Math.round(totalSpend / completedOrders.length || 0) : 0,
                        totalSpend: totalSpend,
                        lastOrder: mOrders[0] // orders 已按時間排序，第 0 筆即為最新
                    };
                }).sort((a, b) => b.orderCount - a.orderCount); // 預設按訂單數排序
            }, [members, orders]);
			
			useEffect(() => {
                if (orders.length === 0 || members.length === 0) return;

                const syncUserData = async () => {
                    const { db, appId } = window.firebase;
                    const { doc, updateDoc } = window.firestore;
                    const updates = [];

                    members.forEach(member => {
                        // 找出該會員的所有訂單，並按時間倒序排列 (最新的在前)
                        const memberOrders = orders
                            .filter(o => o.customerUid === member.id)
                            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                        if (memberOrders.length > 0) {
                            const lastOrder = memberOrders[0]; // 最新一筆訂單
                            const orderName = lastOrder.userInfo?.name;
                            const orderPhone = lastOrder.userInfo?.phone;

                            // 檢查條件：
                            // 1. 會員資料庫缺電話或姓名 (或是想強制更新最新資訊)
                            // 2. 訂單裡有這些資訊
                            // 這裡設定為：如果會員資料庫是空的，就自動補上
                            let needsUpdate = false;
                            const updateData = {};

                            if ((!member.phone || member.phone === '') && orderPhone) {
                                updateData.phone = orderPhone;
                                needsUpdate = true;
                            }
                            if ((!member.realName || member.realName === '') && orderName) {
                                updateData.realName = orderName; // 區分：displayName 是 LINE 暱稱，realName 是真實姓名
                                needsUpdate = true;
                            }

                            if (needsUpdate) {
                                console.log(`[Auto-Sync] 更新會員 ${member.displayName || member.id} 資料:`, updateData);
                                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', member.id);
                                updates.push(updateDoc(userRef, updateData));
                            }
                        }
                    });

                    if (updates.length > 0) {
                        await Promise.all(updates);
                        console.log(`✅ 已自動補全 ${updates.length} 位會員的資料`);
                    }
                };

                // 延遲執行，避免頻繁觸發
                const timer = setTimeout(syncUserData, 3000);
                return () => clearTimeout(timer);
            }, [orders, members]);
			
                    
            // 每分鐘更新一次時間，讓倒數計時器跳動
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 60000);
                return () => clearInterval(timer);
            }, []);

            // --- [新增] 輔助函式：取得訂單的取餐時間物件 ---
            const getOrderPickupTime = (order) => {
                if (!order.userInfo?.pickupDate || !order.userInfo?.pickupTime) return null;
                const d = new Date(`${order.userInfo.pickupDate}T${order.userInfo.pickupTime === 'ASAP' ? '00:00' : order.userInfo.pickupTime}`);
                // 如果是 ASAP，簡單處理為下單時間+20分，或視為極為緊急
                if (order.userInfo.pickupTime === 'ASAP') {
                    const created = new Date(order.createdAt);
                    return new Date(created.getTime() + 20 * 60000);
                }
                return d;
            };

            // --- [新增] 輔助函式：計算尖峰負荷 (每15分鐘區間) ---
            const calculatePeakLoad = (ordersList) => {
                const slots = {};
                ordersList.forEach(o => {
                    if (['completed', 'cancelled'].includes(o.status)) return;
                    const time = o.userInfo?.pickupTime;
                    if (time && time !== 'ASAP') {
                        // 將時間簡化為小時 (例如 11:30 -> 11)，簡單做每小時或半小時統計
                        const hour = time.split(':')[0]; 
                        slots[hour] = (slots[hour] || 0) + 1;
                    }
                });
                // 找出大於設定閥值 (例如每小時 > 10 單) 的時段
                const peakThreshold = 10; 
                const peakHours = Object.keys(slots).filter(h => slots[h] > peakThreshold);
                return peakHours.length > 0 ? peakHours : null;
            };

            useEffect(() => {
                const { auth } = window.firebase;
                const { onAuthStateChanged } = window.authActions;
                const unsubscribe = onAuthStateChanged(auth, u => { setUser(u); setLoading(false); });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const { db, appId } = window.firebase;
                const { collection, doc, onSnapshot } = window.firestore;
                const unsubs = [];
                const sub = (collName, setter) => {
                    return onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', collName), (snap) => {
                        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        // Sort logic
                        if (collName === 'categories' || collName === 'products' || collName === 'sets') data.sort((a,b) => a.sortOrder - b.sortOrder);
                        if (collName === 'materials' || collName === 'addons') data.sort((a,b) => (a.sortOrder||0) - (b.sortOrder||0));
                        if (collName === 'orders') data.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                        if (collName === 'coupons') data.sort((a,b) => new Date(a.expiry) - new Date(b.expiry));
                        
                        setter(data);
                    }, (err) => console.error(`Fetch error ${collName}:`, err));
                };
                
                unsubs.push(sub('categories', (data) => { setCategories(data); if (data.length > 0 && !activeCategory) setActiveCategory(data[0].id); }));
                unsubs.push(sub('products', setProducts));
                unsubs.push(sub('sets', setSets));
                unsubs.push(sub('addons', setAddons));
                unsubs.push(sub('materials', setMaterials));
                unsubs.push(sub('orders', setOrders));
                unsubs.push(sub('coupons', setCoupons));
                
                unsubs.push(onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), (d) => {
                    if (d.exists()) setSettings(prev => ({ ...prev, ...d.data() }));
                    else { onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), (gd) => { if (gd.exists()) setSettings(prev => ({ ...prev, ...gd.data() })); }); }
                }));
                return () => unsubs.forEach(u => u && u());
            }, [user, activeCategory]); 

            // ... (dbOp, openCloudinaryWidget, etc. remain the same)
            const dbOp = async (action, coll, id, data) => {
                const { db, appId } = window.firebase;
                const { doc, addDoc, updateDoc, deleteDoc, collection, setDoc } = window.firestore;
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', coll);
                try {
                    if (action === 'add') await addDoc(colRef, data);
                    if (action === 'update') await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id), data);
                    if (action === 'delete') await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id));
                    if (action === 'set') await setDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id), data);
                } catch(e) { console.error("DB Error:", e); alert("操作失敗：可能權限不足"); }
            };

            const openCloudinaryWidget = (callback) => {
                if (!settings.cloudinaryCloudName || !settings.cloudinaryUploadPreset) {
                    alert("請先至「營運設定」中設定 Cloudinary 圖片主機資訊");
                    return;
                }
                const widget = window.cloudinary.createUploadWidget({
                    cloudName: settings.cloudinaryCloudName,
                    uploadPreset: settings.cloudinaryUploadPreset,
                    sources: ['local', 'url', 'camera'],
                    multiple: false,
                    clientAllowedFormats: ['image'],
                    maxImageFileSize: 2000000, 
                    theme: 'purple',
                    language: 'zh-TW',
                    text: { "zh-TW": { "menu": { "files": "我的檔案" }, "local": { "browse": "瀏覽檔案", "dd_title_single": "拖曳圖片至此" } } }
                }, (error, result) => {
                    if (!error && result && result.event === "success") {
                        callback(result.info.secure_url);
                    }
                });
                widget.open();
            };

            const getDisplayPrice = (p) => { if (p.variants && p.variants.length > 0) { const min = Math.min(...p.variants.map(v => v.price)); return `$${min}起`; } return `$${p.price}`; };
            
            const checkMaterialAvailability = (product) => {
                const outMaterials = materials.filter(m => m.isOut).map(m => m.id);
                if (product.variants && product.variants.length > 0) {
                    const availableVariants = product.variants.filter(v => {
                        const variantMaterials = v.materials || [];
                        return !variantMaterials.some(mId => outMaterials.includes(mId));
                    });
                    if (availableVariants.length === 0) return { status: 'all_out', label: '原料缺貨' };
                    if (availableVariants.length < product.variants.length) return { status: 'partial', label: '部分缺貨' };
                } else {
                    const prodMaterials = product.materials || [];
                    if (prodMaterials.some(mId => outMaterials.includes(mId))) return { status: 'all_out', label: '原料缺貨' };
                }
                return { status: 'ok', label: '' };
            };

            // ... (handleCloneProduct, handleCloneSet, handleBulkClose, handleSort, handleDelete, etc.)
            const handleCloneProduct = async (product) => {
                if(!confirm(`確定要複製「${product.name}」嗎？`)) return;
                const { id, ...rest } = product;
                const newProduct = { ...rest, name: `${product.name} (複製)` };
                const currentList = products.filter(p => p.categoryId === product.categoryId);
                const nextSortOrder = currentList.length > 0 ? Math.max(...currentList.map(p => p.sortOrder || 0)) + 1 : 0;
                await dbOp('add', 'products', null, { ...newProduct, sortOrder: nextSortOrder });
            };

            const handleCloneSet = async (set) => {
                if(!confirm(`確定要複製「${set.name}」嗎？`)) return;
                const { id, ...rest } = set;
                const newSet = { ...rest, name: `${set.name} (複製)` };
                const nextSortOrder = sets.length > 0 ? Math.max(...sets.map(s => s.sortOrder || 0)) + 1 : 0;
                await dbOp('add', 'sets', null, { ...newSet, sortOrder: nextSortOrder });
            }

            const handleBulkClose = async (catId) => {
                const catName = categories.find(c => c.id === catId)?.name;
                if(!confirm(`確定要將「${catName}」分類下的所有商品設為隱藏嗎？\n(此操作不可一鍵復原，需手動開啟)`)) return;
                const targetProducts = products.filter(p => p.categoryId === catId && !p.isHidden);
                const updates = targetProducts.map(p => dbOp('update', 'products', p.id, { isHidden: true }));
                await Promise.all(updates);
                alert(`已隱藏 ${updates.length} 項商品`);
            };

            const handleSort = async (type, id, direction) => {
                let list = [];
                let coll = '';
                if(type === 'cat') { list = [...categories]; coll = 'categories'; }
                else if(type === 'prod') { list = products.filter(p => p.categoryId === activeCategory).sort((a,b)=>a.sortOrder-b.sortOrder); coll = 'products'; }
                else if(type === 'set') { list = [...sets]; coll = 'sets'; }

                const index = list.findIndex(item => item.id === id);
                if (index === -1) return;
                const targetIndex = direction === 'up' ? index - 1 : index + 1;
                if (targetIndex < 0 || targetIndex >= list.length) return;
                const itemA = list[index];
                const itemB = list[targetIndex];
                if (itemA.sortOrder === itemB.sortOrder) {
                    const updates = list.map((item, idx) => {
                        let newSort = idx;
                        if (idx === index) newSort = targetIndex;
                        if (idx === targetIndex) newSort = index;
                        return dbOp('update', coll, item.id, { sortOrder: newSort });
                    });
                    await Promise.all(updates);
                } else {
                    const tempOrder = itemA.sortOrder;
                    await dbOp('update', coll, itemA.id, { sortOrder: itemB.sortOrder });
                    await dbOp('update', coll, itemB.id, { sortOrder: tempOrder });
                }
            };

            const handleDelete = (type, id) => {
                if(!confirm('確定刪除？')) return;
                // [Fix] 補上 'org' 對應 'organizations'
                const coll = type === 'cat' ? 'categories' : 
                             (type === 'prod' ? 'products' : 
                             (type === 'set' ? 'sets' : 
                             (type === 'mat' ? 'materials' : 
                             (type === 'addon' ? 'addons' : 
                             (type === 'coupon' ? 'coupons' : 
                             (type === 'org' ? 'organizations' : '')))))); // 新增這一行
                
                if (!coll) return;
                dbOp('delete', coll, id);
                if(type === 'cat' && activeCategory === id && categories.length > 1) setActiveCategory(categories.find(c => c.id !== id)?.id);
            };

            // Group Management
            const getGroups = (type) => type === 'materials' ? (settings.materialGroups || []) : (settings.addonGroups || []);
            const saveGroups = (type, groups) => dbOp('update', 'settings', 'config', { [type === 'materials' ? 'materialGroups' : 'addonGroups']: groups });
            
            const handleRenameGroup = async (type, oldName, newName) => {
                const { db, appId } = window.firebase;
                const { collection, getDocs, writeBatch, query, where, doc } = window.firestore;
                const collName = type === 'materials' ? 'materials' : 'addons';
                const groups = getGroups(type);
                const newGroups = groups.map(g => g.name === oldName ? { ...g, name: newName } : g);
                await saveGroups(type, newGroups);
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', collName), where('category', '==', oldName));
                const snap = await getDocs(q);
                const batch = writeBatch(db);
                snap.forEach(d => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', collName, d.id), { category: newName }); });
                await batch.commit();
            };
            const handleCloneGroup = async (type, groupName) => {
                const { db, appId } = window.firebase;
                const { collection, getDocs, addDoc, query, where } = window.firestore;
                const collName = type === 'materials' ? 'materials' : 'addons';
                const newGroupName = `${groupName} (複製)`;
                const groups = getGroups(type);
                await saveGroups(type, [...groups, { id: Date.now(), name: newGroupName, sortOrder: groups.length }]);
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', collName), where('category', '==', groupName));
                const snap = await getDocs(q);
                const promises = snap.docs.map(d => { const data = d.data(); return addDoc(collection(db, 'artifacts', appId, 'public', 'data', collName), { ...data, category: newGroupName }); });
                await Promise.all(promises);
            };
            const handleDeleteGroup = async (type, groupName) => {
                if(!confirm(`確定刪除群組「${groupName}」？\n注意：該群組下的項目將變為「未分類」`)) return;
                const { db, appId } = window.firebase;
                const { collection, getDocs, writeBatch, query, where, doc } = window.firestore;
                const collName = type === 'materials' ? 'materials' : 'addons';
                const groups = getGroups(type);
                await saveGroups(type, groups.filter(g => g.name !== groupName));
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', collName), where('category', '==', groupName));
                const snap = await getDocs(q);
                const batch = writeBatch(db);
                snap.forEach(d => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', collName, d.id), { category: '未分類' }); });
                await batch.commit();
            };
            const handleSortGroup = async (type, index, direction) => {
                const groups = [...getGroups(type)];
                if (direction === 'up' && index > 0) { [groups[index], groups[index-1]] = [groups[index-1], groups[index]]; } 
                else if (direction === 'down' && index < groups.length - 1) { [groups[index], groups[index+1]] = [groups[index+1], groups[index]]; }
                await saveGroups(type, groups);
            };
            const handleSortItem = async (coll, item, direction, itemList) => {
                const index = itemList.findIndex(i => i.id === item.id);
                if (index === -1) return;
                const targetIndex = direction === 'up' ? index - 1 : index + 1;
                if (targetIndex < 0 || targetIndex >= itemList.length) return;
                const itemA = itemList[index];
                const itemB = itemList[targetIndex];
                if ((itemA.sortOrder || 0) === (itemB.sortOrder || 0)) {
                     const batchUpdates = itemList.map((it, idx) => {
                         let newSort = idx; if(idx === index) newSort = targetIndex; if(idx === targetIndex) newSort = index;
                         return dbOp('update', coll, it.id, { sortOrder: newSort });
                     });
                     await Promise.all(batchUpdates);
                } else {
                    const tempOrder = itemA.sortOrder || 0;
                    await dbOp('update', coll, itemA.id, { sortOrder: itemB.sortOrder || 0 });
                    await dbOp('update', coll, itemB.id, { sortOrder: tempOrder });
                }
            };

            const processGroups = (type) => {
                const definedGroups = getGroups(type);
                const items = type === 'materials' ? materials : addons;
                const result = definedGroups.map(g => ({
                    name: g.name,
                    items: items.filter(i => i.category === g.name).sort((a,b) => (a.sortOrder||0) - (b.sortOrder||0))
                }));
                const definedNames = definedGroups.map(g => g.name);
                const others = items.filter(i => !i.category || !definedNames.includes(i.category));
                if (others.length > 0) {
                    const otherGroups = {};
                    others.forEach(i => { const c = i.category || '未分類'; if (!otherGroups[c]) otherGroups[c] = []; otherGroups[c].push(i); });
                    Object.entries(otherGroups).forEach(([cName, cItems]) => {
                        result.push({ name: cName, items: cItems.sort((a,b) => (a.sortOrder||0) - (b.sortOrder||0)), isUnregistered: true });
                    });
                }
                return result;
            };

            // Publish Function
            const handlePublish = async () => {
                if(!confirm("確定要發布目前的設定到前台嗎？\n這將會更新客人的數位菜單內容。")) return;
                try {
                    const { setDoc, doc } = window.firestore;
                    const { db, appId } = window.firebase;
                    // Sanitize data to remove undefined values which Firestore rejects
                    const cleanData = JSON.parse(JSON.stringify({ 
                        settings, categories, products, sets, addons, materials, coupons, 
                        updatedAt: new Date().toISOString() 
                    }));
                    
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'menu_display'), cleanData);
                    await dbOp('set', 'settings', 'config', settings); 
                    alert('✅ 發布成功！前台已更新。');
                } catch(e) { 
                    console.error("Publish Error:", e); 
                    alert('發布失敗: ' + e.message); 
                }
            };

            // Order Status Update
            const handleUpdateOrderStatus = async (orderId, newStatus) => {
                try {
                    // 1. 更新資料庫
                    await dbOp('update', 'orders', orderId, { status: newStatus });
                    
                    // 2. [Fix] 如果當前 Modal 正好開著這筆訂單，同步更新 Modal 的狀態，讓按鈕即時變化
                    if (modal && modal.type === 'edit_order' && modal.data.id === orderId) {
                        setModal(prev => ({
                            ...prev,
                            data: { ...prev.data, status: newStatus }
                        }));
                    }
                } catch (e) {
                    console.error("Status update failed:", e);
                    alert("更新失敗，請檢查網路");
                }
            };
			
			// [Req] 批量派發優惠券核心邏輯
            const handleCustomDistribute = async (coupon, targets) => {
                const { db, appId } = window.firebase;
                const { writeBatch, doc } = window.firestore;
                
                try {
                    const chunkSize = 400;
                    for (let i = 0; i < targets.length; i += chunkSize) {
                        const batch = writeBatch(db);
                        const chunk = targets.slice(i, i + chunkSize);
                        chunk.forEach(m => {
                            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', m.id);
                            const currentCoupons = m.coupons || [];
                            const newCouponEntry = {
                                ...coupon,
                                issuedAt: new Date().toISOString(),
                                used: false,
                                uniqueId: Date.now() + Math.random().toString(36).substr(2, 9)
                            };
                            batch.set(userRef, { coupons: [...currentCoupons, newCouponEntry] }, { merge: true });
                        });
                        await batch.commit();
                    }
                    alert(`✅ 成功派發給 ${targets.length} 位機構用戶！`);
                    setModal(null);
                } catch(e) {
                    console.error("Custom Distribute Error:", e);
                    alert("派發失敗：" + e.message);
                }
            };

            // Format Date
            const formatDate = (dateStr) => {
                if(!dateStr) return '-';
                return new Date(dateStr).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            };

            if (loading) return <div className="loading-overlay"><Icon name="Loader2" className="animate-spin" size={48} /><span>系統連線中...</span></div>;

            if (!user) return ( /* ... Login UI ... */ 
                <div className="h-screen flex items-center justify-center p-6 bg-[#F8FAFC]">
                    <div className="max-w-sm w-full text-center space-y-8 animate-fade-in">
                        <div className="w-20 h-20 bg-[#5B2274] rounded-[32px] flex items-center justify-center mx-auto shadow-2xl transition-transform hover:rotate-3">
                            <Icon name="ShieldCheck" className="text-white" size={40} />
                        </div>
                        <div className="space-y-2">
                            <h1 className="text-3xl font-[900] text-slate-900 tracking-tighter">城市漢堡 虎尾光復店</h1>
                            <p className="text-slate-400 font-bold text-xs uppercase tracking-widest">Store Management v17.2</p>
                        </div>
                        <button onClick={() => window.authActions.signInWithPopup(window.firebase.auth, window.firebase.provider)} className="w-full py-5 bg-slate-900 text-white rounded-3xl font-[900] shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3">
                            <Icon name="LogIn" size={18} />
                            使用 Google 帳號安全登入
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen overflow-hidden bg-[#F8FAFC]">
                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 z-50 w-60 lg:w-72 glass-sidebar transform transition-transform duration-300 lg:translate-x-0 lg:static lg:block shadow-xl flex flex-col ${mobileOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 pb-4">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-sm shadow-inner text-white"><Icon name="ChefHat" size={18} /></div>
                                <div><h1 className="font-black text-lg text-white leading-none">City Burger</h1><p className="text-[10px] font-bold text-purple-200 tracking-widest uppercase mt-1">CLOUD V17.2</p></div>
                            </div>
                        </div>
                        <nav className="flex-1 px-3 space-y-1.5 mt-2 overflow-y-auto no-scrollbar">
                            {[
                                {id:'orders', label:'訂單管理', icon:'ClipboardList'},
                                {id:'products',label:'餐點管理',icon:'UtensilsCrossed'},
                                {id:'categories',label:'分類排序',icon:'ListOrdered'},
                                {id:'sets',label:'套餐管理',icon:'Utensils'},
                                {id:'customization',label:'客製化選項',icon:'Settings2'},
                                {id:'materials',label:'原物料庫',icon:'PackageSearch'},
								{id:'members', label:'會員管理', icon:'Users'},
                                {id:'coupons', label:'優惠管理', icon:'Ticket'},
								{id:'organizations', label:'特約機構', icon:'Building2'},
                                {id:'settings',label:'營運設定',icon:'Sliders'}
                            ].map(item => (
                                <button key={item.id} onClick={() => { setActiveTab(item.id); setMobileOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-xs lg:text-sm lg:py-4 transition-all ${activeTab === item.id ? 'bg-white text-[#5B2274] shadow-md' : 'text-purple-200 hover:text-white hover:bg-white/10'}`}>
                                    <Icon name={item.icon} size={20} /> {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 mt-auto border-t border-white/10 shrink-0">
                            <button onClick={() => window.authActions.signOut(window.firebase.auth)} className="w-full py-2.5 bg-white/10 hover:bg-red-500/20 text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-all">
                                <Icon name="LogOut" size={14} /> 登出系統
                            </button>
                        </div>
                    </aside>

                    {mobileOpen && <div className="fixed inset-0 bg-black/40 z-40 lg:hidden backdrop-blur-sm" onClick={() => setMobileOpen(false)} />}

                    <main className="flex-1 h-full overflow-y-auto no-scrollbar relative">
                        {/* Mobile Header */}
                        <div className="lg:hidden sticky top-0 z-30 bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 h-14 flex items-center justify-between">
                            <span className="font-black text-[#5B2274] text-base">City Burger</span>
                            <button onClick={() => setMobileOpen(true)} className="p-2 bg-slate-100 rounded-lg text-slate-600"><Icon name="Menu" size={20} /></button>
                        </div>

                        <div className="max-w-6xl lg:max-w-7xl mx-auto px-6 lg:px-10 py-8 space-y-6 pb-24">
                            
                            {/* Order Management Tab (Optimized V2) */}
                            {activeTab === 'orders' && (
                                <div className="animate-fade-in pb-24 h-full flex flex-col">
                                    <header className="bg-white border-b border-slate-100 sticky top-0 z-30 -mx-6 lg:-mx-10 mt-[-2rem] mb-6 shadow-sm">
                                        <div className="px-6 py-4 max-w-7xl mx-auto flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
                                            {/* 1. 分頁切換 */}
                                            <div className="bg-slate-100/80 p-1.5 rounded-2xl flex overflow-x-auto no-scrollbar shrink-0 w-full lg:w-auto">
                                                {[
                                                    {id:'today', t:'今日現場', c:getTabCount('today')}, 
                                                    {id:'future', t:'預約單', c:getTabCount('future')}, 
                                                    {id:'history', t:'歷史紀錄', c:0}
                                                ].map(t => (
                                                    <button key={t.id} onClick={() => { setOrderFilter(t.id); setSubFilter(t.id==='history'?'completed':'all'); }} 
                                                        className={`flex-1 min-w-[90px] px-3 py-2.5 rounded-xl text-xs font-[900] transition-all flex items-center justify-center gap-2 relative whitespace-nowrap ${orderFilter===t.id?'bg-white text-[#5B2274] shadow-sm ring-1 ring-black/5':'text-slate-400 hover:text-slate-600'}`}>
                                                        {t.t} {t.c > 0 && <span className="bg-red-500 text-white min-w-[1.25rem] h-5 px-1.5 flex items-center justify-center rounded-full text-[10px] shadow-sm">{t.c}</span>}
                                                    </button>
                                                ))}
                                            </div>

                                            {/* 2. 工具列 (手機版 flex-col 強制換行，解決破圖) */}
                                            <div className="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                                                {/* 日期選擇器 */}
                                                <div className={`relative group w-full sm:w-44 ${orderFilter === 'today' ? 'opacity-40 cursor-not-allowed' : ''}`}>
                                                    <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none text-slate-500 z-10"><Icon name="Calendar" size={16}/></div>
                                                    <input type="date" 
                                                        className={`w-full h-11 bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-3 text-xs font-[900] text-[#5B2274] outline-none transition-all shadow-sm appearance-none min-w-0 ${orderFilter === 'today' ? 'pointer-events-none' : 'hover:bg-white focus:bg-white focus:ring-2 focus:ring-purple-100 cursor-pointer'}`}
                                                        value={orderFilter === 'today' ? todayStr : (orderFilter==='history'?historyDate:futureDate)} 
                                                        onChange={e => orderFilter==='history' ? setHistoryDate(e.target.value) : setFutureDate(e.target.value)}
                                                        disabled={orderFilter === 'today'}
                                                        max={orderFilter === 'history' ? yesterdayStr : undefined}
                                                        min={orderFilter === 'future' ? tomorrowStr : undefined}
                                                    />
                                                </div>
                                                
                                                {/* 搜尋框 */}
                                                <div className="relative flex-1 sm:w-64">
                                                    <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none text-slate-400"><Icon name="Search" size={16}/></div>
                                                    <input type="text" placeholder="搜尋..." 
                                                        className="w-full h-11 bg-slate-50 hover:bg-white focus:bg-white border border-slate-200 rounded-xl pl-10 pr-8 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-purple-100 transition-all shadow-sm placeholder:text-slate-400 appearance-none" 
                                                        value={searchQuery} onChange={(e)=>setSearchQuery(e.target.value)} />
                                                    {searchQuery && <button onClick={()=>setSearchQuery('')} className="absolute inset-y-0 right-3 flex items-center text-slate-400 hover:text-slate-600"><Icon name="X" size={14}/></button>}
                                                </div>
                                            </div>
                                        </div>
                                    </header>

                                    {/* 狀態切換條 - 縮小版 */}
                                    <div className="flex items-center gap-2 mb-6 overflow-x-auto no-scrollbar py-2 relative pl-1">
                                        {/* 凍結首個按鈕 */}
                                        <div className="sticky left-0 z-10 pr-2 bg-[#F8FAFC]">
                                            <button onClick={()=>setSubFilter('all')} 
                                                className={`px-5 py-2.5 rounded-2xl font-black text-xs whitespace-nowrap transition-all border-2 shadow-sm ${subFilter==='all' ? 'bg-slate-800 border-slate-800 text-white' : 'bg-white border-slate-200 text-slate-500'}`}>
                                                未完成 ({getStatusCount('all')})
                                            </button>
                                        </div>
                                        
                                        {/* [Req 4] 分隔線 */}
                                        <div className="h-6 w-px bg-slate-300/50 mx-1 shrink-0 rounded-full"></div>
                                        
                                        {['pending','confirmed','preparing','ready','completed','cancelled'].map(st => {
                                            const isActive = subFilter === st;
                                            const style = STATUS_STYLE[st];
                                            return (
                                                <button key={st} onClick={()=>setSubFilter(st)} 
                                                    className={`px-4 py-2.5 rounded-2xl font-[900] text-xs whitespace-nowrap transition-all border-2 flex items-center gap-2 shadow-sm
                                                    ${isActive ? style.bg + ' ' + style.text + ' border-current' : 'bg-white border-slate-100 ' + style.text + ' opacity-60'}`}>
                                                    <div className={`w-2 h-2 rounded-full ${style.text.replace('text-', 'bg-')}`}></div>
                                                    {style.label} ({getStatusCount(st)})
                                                </button>
                                            );
                                        })}
                                    </div>

                                    {/* 訂單卡片網格 (已修正層級錯誤) */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                        {filteredOrders.map(order => {
                                            const st = STATUS_STYLE[order.status] || STATUS_STYLE.pending;
                                            const orderType = order.orderType || 'takeout'; 
                                            const typeConfig = ORDER_TYPES[orderType] || ORDER_TYPES['takeout'];

                                            return (
                                                <div key={order.id} className="bg-white rounded-[2rem] border border-slate-200 overflow-hidden shadow-sm hover:shadow-xl transition-all cursor-pointer flex flex-col group animate-fade-in" onClick={()=>handleOpenMainModal({type:'edit_order', data:order})}>
                                                    <div className={`h-1.5 w-full ${st.bg.replace('50', '500')}`}></div>
                                                    <div className="p-6 flex-1 space-y-3">
                                                        <div className="flex justify-between items-start">
                                                            <div className="space-y-2">
                                                                <div className="flex items-center gap-2">
                                                                    {/* 狀態標籤 */}
                                                                    <span className={`text-[9px] font-black px-2 py-0.5 rounded-full border ${st.bg} ${st.text} ${st.border}`}>{st.label}</span>
                                                                    
                                                                    {/* [Req 2] 訂單類型 (大型呼吸燈) */}
                                                                    <div className={`px-2 py-1 rounded-lg border flex items-center gap-2 ${typeConfig.bg} ${typeConfig.border} ${typeConfig.text}`}>
                                                                        <div className="relative flex h-2.5 w-2.5">
                                                                            <span className={`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${typeConfig.dot}`}></span>
                                                                            <span className={`relative inline-flex rounded-full h-2.5 w-2.5 ${typeConfig.dot}`}></span>
                                                                        </div>
                                                                        <div className="flex items-center gap-1 font-black text-[10px]">
                                                                            <Icon name={typeConfig.icon} size={12}/>
                                                                            <span>{typeConfig.label}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div className="text-3xl font-[1000] text-slate-800 tracking-tighter">{order.userInfo?.pickupTime}</div>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-[10px] font-bold text-slate-500 uppercase">#{order.orderId?.slice(-4)}</span>
                                                                    <span className="text-slate-300">|</span>
                                                                    <div className="text-[11px] font-bold text-slate-500 flex items-center gap-1"><Icon name="Calendar" size={12}/> {order.userInfo?.pickupDate}</div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="text-2xl font-[1000] text-[#5B2274] tracking-tighter">${order.totalPrice}</div>
                                                                <div className="text-[10px] font-black text-slate-500 uppercase tracking-widest mt-0.5">{order.items?.length} 品項</div>
                                                            </div>
                                                        </div>
                                                        <div className="pt-3 border-t border-dashed border-slate-100 flex items-center justify-between">
                                                            <div className="text-xs font-black text-slate-700">{order.userInfo?.name} <span className="text-[11px] text-slate-500 font-bold ml-1">{order.userInfo?.phone}</span></div>
                                                            <Icon name="ChevronRight" size={14} className="text-slate-300 group-hover:text-[#5B2274]"/>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* 列表卡片按鈕 (保持不變) */}
                                                    {!['completed', 'cancelled'].includes(order.status) && (
                                                        <div className="grid grid-cols-2 divide-x divide-slate-100 border-t border-slate-100 bg-slate-50/50">
                                                            {order.status === 'pending' && (
                                                                <>
                                                                    <button onClick={(e)=>{e.stopPropagation(); if(confirm('確定拒絕此單？')) handleUpdateOrderStatus(order.id, 'cancelled');}} className="py-4 text-slate-400 font-bold text-sm hover:bg-red-50 hover:text-red-500 transition-colors flex items-center justify-center gap-2">拒絕</button>
                                                                    <button onClick={(e)=>{e.stopPropagation(); handleUpdateOrderStatus(order.id, 'confirmed');}} className="py-4 bg-blue-600 text-white font-[1000] text-sm tracking-widest hover:bg-blue-700 transition-colors shadow-inner flex items-center justify-center gap-2">確認接單</button>
                                                                </>
                                                            )}
                                                            {order.status === 'confirmed' && <button onClick={(e)=>{e.stopPropagation(); handleUpdateOrderStatus(order.id, 'preparing');}} className="col-span-2 py-4 bg-orange-500 text-white font-[1000] text-sm tracking-widest hover:bg-orange-600 transition-colors shadow-inner">開始製作</button>}
                                                            {order.status === 'preparing' && <button onClick={(e)=>{e.stopPropagation(); handleUpdateOrderStatus(order.id, 'ready');}} className="col-span-2 py-4 bg-emerald-500 text-white font-[1000] text-sm tracking-widest hover:bg-emerald-600 transition-colors shadow-inner">製作完成</button>}
                                                            {order.status === 'ready' && (() => {
                                                                // [Fix] 列表卡片增加核銷檢查邏輯
                                                                const hasPointReward = !!order.usePointReward || order.discountApplied === 'loyalty';
                                                                const isPointVerified = order.verified === true;
                                                                const canComplete = !hasPointReward || isPointVerified;
                                                                
                                                                return (
                                                                    <button 
                                                                        onClick={(e)=>{
                                                                            e.stopPropagation(); 
                                                                            if (!canComplete) {
                                                                                // 如果未核銷，點擊時彈出提示或僅阻止完成
                                                                                alert('此訂單包含集點優惠，請點擊卡片進入詳情進行核銷！');
                                                                                return;
                                                                            }
                                                                            handleUpdateOrderStatus(order.id, 'completed');
                                                                        }} 
                                                                        className={`col-span-2 py-4 font-[1000] text-sm tracking-widest transition-colors shadow-inner flex items-center justify-center gap-2 ${canComplete ? 'bg-[#5B2274] text-white hover:bg-[#4a1b5e]' : 'bg-slate-300 text-white cursor-not-allowed'}`}
                                                                    >
                                                                        {canComplete ? '完成取餐' : '待核銷 (請點入)'}
                                                                    </button>
                                                                );
                                                            })()}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
							
							{/* Member Management Tab */}
                            {activeTab === 'members' && (
                                <div className="animate-fade-in space-y-4 pb-24">
                                    {/* Toolbar: 標題、搜尋、每頁筆數 */}
                                    <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                        <div>
                                            <h2 className="text-xl font-[900] text-slate-800 tracking-tight">會員列表</h2>
                                            <p className="text-xs font-bold text-slate-400 mt-0.5">管理 {members.length} 位會員資料</p>
                                        </div>
                                        <div className="flex gap-3 w-full lg:w-auto">
                                            <div className="relative group flex-1 lg:w-64">
                                                <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none text-slate-400"><Icon name="Search" size={16}/></div>
                                                <input 
                                                    type="text" 
                                                    placeholder="搜尋姓名、電話..." 
                                                    className="w-full bg-slate-50 border border-slate-200 rounded-lg pl-10 pr-4 py-2.5 text-sm font-bold focus:ring-2 focus:ring-purple-100 outline-none transition-all" 
                                                    value={searchQuery} 
                                                    onChange={(e)=>{setSearchQuery(e.target.value); setMemberPage(1);}} 
                                                />
                                            </div>
                                            <select 
                                                className="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-sm font-bold text-slate-600 outline-none focus:border-purple-500 cursor-pointer"
                                                value={memberRowsPerPage}
                                                onChange={(e) => { setMemberRowsPerPage(Number(e.target.value)); setMemberPage(1); }}
                                            >
                                                <option value={10}>10 筆/頁</option>
                                                <option value={25}>25 筆/頁</option>
                                                <option value={50}>50 筆/頁</option>
                                                <option value={100}>100 筆/頁</option>
                                            </select>
                                        </div>
                                    </div>

                                    {/* Data Table */}
                                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left border-collapse">
                                                <thead>
                                                    <tr className="bg-slate-50 border-b border-slate-200 text-xs font-black text-slate-500 uppercase tracking-wider">
                                                        <th className="px-6 py-4 cursor-pointer hover:bg-slate-100 transition-colors" onClick={() => setMemberSortConfig({ key: 'displayName', direction: memberSortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                            會員名稱 {memberSortConfig.key === 'displayName' && (memberSortConfig.direction === 'asc' ? '↑' : '↓')}
                                                        </th>
                                                        <th className="px-6 py-4 cursor-pointer hover:bg-slate-100 transition-colors" onClick={() => setMemberSortConfig({ key: 'phone', direction: memberSortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                            電話
                                                        </th>
                                                        <th className="px-6 py-4 text-right cursor-pointer hover:bg-slate-100 transition-colors" onClick={() => setMemberSortConfig({ key: 'orderCount', direction: memberSortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                            訂單數 {memberSortConfig.key === 'orderCount' && (memberSortConfig.direction === 'asc' ? '↑' : '↓')}
                                                        </th>
                                                        <th className="px-6 py-4 text-right cursor-pointer hover:bg-slate-100 transition-colors" onClick={() => setMemberSortConfig({ key: 'totalSpend', direction: memberSortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                            總消費 {memberSortConfig.key === 'totalSpend' && (memberSortConfig.direction === 'asc' ? '↑' : '↓')}
                                                        </th>
                                                        <th className="px-6 py-4 text-right cursor-pointer hover:bg-slate-100 transition-colors" onClick={() => setMemberSortConfig({ key: 'avgSpend', direction: memberSortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                            客單價 {memberSortConfig.key === 'avgSpend' && (memberSortConfig.direction === 'asc' ? '↑' : '↓')}
                                                        </th>
                                                        <th className="px-6 py-4 text-right cursor-pointer hover:bg-slate-100 transition-colors" onClick={() => setMemberSortConfig({ key: 'lastOrderDate', direction: memberSortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                            最近消費 {memberSortConfig.key === 'lastOrderDate' && (memberSortConfig.direction === 'asc' ? '↑' : '↓')}
                                                        </th>
                                                        <th className="px-6 py-4 text-center">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {(() => {
                                                        // 1. Filter
                                                        let processed = memberStats.filter(m => !searchQuery || 
                                                            (m.displayName || '').toLowerCase().includes(searchQuery.toLowerCase()) || 
                                                            (m.realName || '').toLowerCase().includes(searchQuery.toLowerCase()) || 
                                                            (m.phone || '').includes(searchQuery)
                                                        );
                                                        
                                                        // 2. Sort
                                                        processed.sort((a, b) => {
                                                            let valA = a[memberSortConfig.key];
                                                            let valB = b[memberSortConfig.key];
                                                            
                                                            // Handle special sort keys
                                                            if (memberSortConfig.key === 'lastOrderDate') {
                                                                valA = a.lastOrder ? new Date(a.lastOrder.createdAt).getTime() : 0;
                                                                valB = b.lastOrder ? new Date(b.lastOrder.createdAt).getTime() : 0;
                                                            }

                                                            if (valA < valB) return memberSortConfig.direction === 'asc' ? -1 : 1;
                                                            if (valA > valB) return memberSortConfig.direction === 'asc' ? 1 : -1;
                                                            return 0;
                                                        });

                                                        // 3. Pagination
                                                        const totalPages = Math.ceil(processed.length / memberRowsPerPage);
                                                        const startIndex = (memberPage - 1) * memberRowsPerPage;
                                                        const paginatedMembers = processed.slice(startIndex, startIndex + memberRowsPerPage);

                                                        if (paginatedMembers.length === 0) {
                                                            return <tr><td colSpan="7" className="px-6 py-12 text-center text-slate-400 font-bold">查無會員資料</td></tr>;
                                                        }

                                                        return paginatedMembers.map((m) => (
                                                            <tr key={m.id} className="group hover:bg-slate-50 transition-colors cursor-pointer" onClick={() => { setMemberModalTab('overview'); handleOpenMainModal({type: 'member_detail', data: m}); }}>
                                                                <td className="px-6 py-4">
                                                                    <div className="flex items-center gap-3">
                                                                        <div className="w-8 h-8 rounded-lg bg-slate-100 text-slate-500 font-black flex items-center justify-center text-xs uppercase border border-slate-200">
                                                                            {m.displayName?.[0] || 'U'}
                                                                        </div>
                                                                        <div>
                                                                            <div className="font-bold text-slate-800 text-sm">{m.displayName}</div>
                                                                            <div className="text-[10px] font-bold text-slate-400">{m.realName || '-'}</div>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td className="px-6 py-4 text-sm font-bold text-slate-600 font-mono">{m.phone || '-'}</td>
                                                                <td className="px-6 py-4 text-right text-sm font-bold text-slate-700">{m.orderCount}</td>
                                                                <td className="px-6 py-4 text-right text-sm font-[1000] text-[#5B2274]">${m.totalSpend.toLocaleString()}</td>
                                                                <td className="px-6 py-4 text-right text-sm font-bold text-slate-600">${m.avgSpend}</td>
                                                                <td className="px-6 py-4 text-right text-xs font-bold text-slate-500">
                                                                    {m.lastOrder ? formatDate(m.lastOrder.createdAt).split(' ')[0] : '-'}
                                                                </td>
                                                                <td className="px-6 py-4 text-center">
                                                                    <button className="p-2 rounded-lg text-slate-400 hover:text-[#5B2274] hover:bg-purple-50 transition-all">
                                                                        <Icon name="ChevronRight" size={16}/>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ));
                                                    })()}
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        {/* Pagination Footer */}
                                        <div className="px-6 py-4 border-t border-slate-200 flex items-center justify-between bg-slate-50">
                                            <span className="text-xs font-bold text-slate-400">
                                                顯示 {(memberPage - 1) * memberRowsPerPage + 1} - {Math.min(memberPage * memberRowsPerPage, memberStats.length)} 筆，共 {memberStats.length} 筆
                                            </span>
                                            <div className="flex gap-2">
                                                <button 
                                                    disabled={memberPage === 1}
                                                    onClick={() => setMemberPage(p => Math.max(1, p - 1))}
                                                    className="px-3 py-1.5 rounded-lg border border-slate-200 bg-white text-xs font-bold text-slate-600 disabled:opacity-50 hover:bg-slate-50"
                                                >上一頁</button>
                                                <button 
                                                    disabled={memberPage * memberRowsPerPage >= memberStats.length}
                                                    onClick={() => setMemberPage(p => p + 1)}
                                                    className="px-3 py-1.5 rounded-lg border border-slate-200 bg-white text-xs font-bold text-slate-600 disabled:opacity-50 hover:bg-slate-50"
                                                >下一頁</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Promotion Management Tab (優惠管理) */}
                            {activeTab === 'coupons' && (
                                <div className="animate-fade-in space-y-12 pb-24">
                                    
                                    {/* A. 集點卡獎勵設定區 (已補回) */}
                                    <section className="space-y-2">
                                        {/* Header Bar: 標題與開關 */}
                                        <div className={`bg-white p-5 rounded-2xl border transition-all flex justify-between items-center ${settings.pointsEnabled ? 'border-purple-200 shadow-sm' : 'border-slate-200'}`}>
                                            <div className="flex items-center gap-4">
                                                <div className={`p-3 rounded-xl transition-colors ${settings.pointsEnabled ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-400'}`}>
                                                    <Icon name="Crown" size={24}/>
                                                </div>
                                                <div>
                                                    <h3 className={`font-[900] text-base ${settings.pointsEnabled ? 'text-slate-800' : 'text-slate-400'}`}>集點獎勵計畫</h3>
                                                    <p className="text-[11px] font-bold text-slate-400 mt-0.5">顧客忠誠度回饋系統</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="text-[10px] font-bold text-slate-400 hidden sm:block">{settings.pointsEnabled ? '已啟用' : '已關閉'}</span>
                                                <ToggleSwitch 
                                                    checked={settings.pointsEnabled} 
                                                    onChange={(val) => setSettings({...settings, pointsEnabled: val})} 
                                                />
                                            </div>
                                        </div>

                                        {/* Collapsible Content: 只有開啟時才顯示詳細設定 */}
                                        {settings.pointsEnabled && (
                                            <div className="bg-slate-50/50 p-6 rounded-2xl border border-slate-200/60 animate-fade-in space-y-6 relative">
                                                {/* 連接線裝飾 (Optional) */}
                                                <div className="absolute top-[-10px] left-8 w-0.5 h-3 bg-purple-200"></div>

                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                    {/* 1. 累積規則 */}
                                                    <div className="space-y-2">
                                                        <label className="text-xs font-black text-slate-500 flex items-center gap-1.5"><Icon name="Coins" size={14} className="text-amber-500"/> 累積規則</label>
                                                        <div className="flex items-center bg-white border border-slate-200 rounded-xl px-3 py-3 focus-within:border-purple-300 focus-within:ring-2 focus-within:ring-purple-50 transition-all shadow-sm">
                                                            <span className="text-xs font-bold text-slate-400 mr-2 shrink-0">每消費滿</span>
                                                            <input type="number" className="flex-1 min-w-0 bg-transparent text-sm font-[1000] text-slate-800 outline-none text-center" 
                                                                value={settings.spendPerPoint || 100} 
                                                                onChange={e => setSettings({...settings, spendPerPoint: parseInt(e.target.value)||0})} 
                                                            />
                                                            <span className="text-xs font-bold text-slate-400 ml-2 shrink-0">元 = 1 點</span>
                                                        </div>
                                                    </div>

                                                    {/* 2. 兌換門檻 */}
                                                    <div className="space-y-2">
                                                        <label className="text-xs font-black text-slate-500 flex items-center gap-1.5"><Icon name="Trophy" size={14} className="text-purple-500"/> 兌換門檻</label>
                                                        <div className="flex items-center bg-white border border-slate-200 rounded-xl px-3 py-3 focus-within:border-purple-300 focus-within:ring-2 focus-within:ring-purple-50 transition-all shadow-sm">
                                                            <span className="text-xs font-bold text-slate-400 mr-2 shrink-0">累積滿</span>
                                                            <input type="number" className="flex-1 min-w-0 bg-transparent text-sm font-[1000] text-slate-800 outline-none text-center" 
                                                                value={settings.pointsToReward || 10} 
                                                                onChange={e => setSettings({...settings, pointsToReward: parseInt(e.target.value)||0})} 
                                                            />
                                                            <span className="text-xs font-bold text-slate-400 ml-2 shrink-0">點</span>
                                                        </div>
                                                    </div>

                                                    {/* 3. 獎勵內容 */}
                                                    <div className="space-y-2">
                                                        <label className="text-xs font-black text-slate-500 flex items-center gap-1.5"><Icon name="Gift" size={14} className="text-rose-500"/> 自動回饋</label>
                                                        <div className="flex items-center bg-white border border-slate-200 rounded-xl px-3 py-3 focus-within:border-purple-300 focus-within:ring-2 focus-within:ring-purple-50 transition-all shadow-sm">
                                                            <span className="text-xs font-bold text-slate-400 mr-2 shrink-0">折抵現金</span>
                                                            <input type="number" className="flex-1 min-w-0 bg-transparent text-sm font-[1000] text-rose-500 outline-none text-center" 
                                                                value={settings.pointRewardValue || 50} 
                                                                onChange={e => setSettings({...settings, pointRewardValue: parseInt(e.target.value)||0})} 
                                                            />
                                                            <span className="text-xs font-bold text-slate-400 ml-2 shrink-0">元</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex justify-end border-t border-slate-200 pt-4">
                                                    <Button size="small" icon="Save" onClick={() => { dbOp('set', 'settings', 'config', settings); alert('✅ 設定已儲存'); }}>儲存設定</Button>
                                                </div>
                                            </div>
                                        )}
                                    </section>

                                    {/* B. 優惠券管理 (Ticket Style) */}
                                    <section className="space-y-6">
                                        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4 px-2">
                                            <div>
                                                <h2 className="text-lg font-[1000] text-slate-800 tracking-tight">優惠券管理</h2>
                                                <p className="text-slate-400 text-[11px] font-bold mt-0.5">設定促銷活動與折扣代碼</p>
                                            </div>
                                            <button onClick={() => setModal({ type: 'coupon', data: { active: true, type: 'fixed', minSpend: 0, usageLimit: 0, targetAudience: 'all' } })} 
                                                className="bg-rose-500 hover:bg-rose-600 text-white px-5 py-3 rounded-xl font-[1000] shadow-lg shadow-rose-200 flex items-center gap-2 transition-all active:scale-95">
                                                <Icon name="Plus" size={18} /> 新增優惠券
                                            </button>
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                            {coupons.map(coupon => {
                                                const isExpired = coupon.endDate && new Date(coupon.endDate) < new Date();
                                                const isActive = coupon.active !== false && !isExpired;
                                                const statusColor = isActive ? 'bg-rose-500' : 'bg-slate-400';
                                                const bgColor = isActive ? 'bg-white' : 'bg-slate-50';
                                                const textColor = isActive ? 'text-slate-800' : 'text-slate-400';

                                                return (
                                                    <div key={coupon.id} className={`relative group flex ${bgColor} rounded-2xl shadow-sm border border-slate-200 overflow-hidden min-h-[140px] transition-all hover:shadow-xl hover:-translate-y-1`}>
                                                        {/* 左側：折扣力度 */}
                                                        <div className={`${statusColor} w-32 p-4 flex flex-col items-center justify-center text-white shrink-0 relative overflow-hidden`}>
                                                            <div className={`absolute -right-3 top-0 bottom-0 my-auto w-6 h-6 rounded-full ${isActive?'bg-[#F1F5F9]':'bg-[#F8FAFC]'}`}></div>
                                                            <div className="text-[10px] font-black uppercase tracking-widest opacity-80 mb-1">{coupon.type === 'percent' ? 'DISCOUNT' : 'CASH OFF'}</div>
                                                            <div className="flex items-baseline justify-center">
                                                                {coupon.type === 'fixed' && <span className="text-sm font-bold">$</span>}
                                                                <span className="text-4xl font-[1000] leading-none tracking-tighter">{coupon.value}</span>
                                                                {coupon.type === 'percent' && <span className="text-xl font-black">%</span>}
                                                            </div>
                                                            <div className="text-[10px] font-bold mt-2 opacity-90 text-center">
                                                                {coupon.minSpend > 0 ? `滿 $${coupon.minSpend} 可用` : '無低消限制'}
                                                            </div>
                                                        </div>

                                                        {/* 中間虛線 */}
                                                        <div className="w-4 flex flex-col items-center justify-center relative">
                                                            <div className="absolute top-0 bottom-0 left-0 border-l-2 border-dashed border-slate-200 h-full"></div>
                                                            <div className="absolute -top-3 left-[-10px] w-5 h-5 rounded-full bg-[#F1F5F9] border-b border-slate-200"></div>
                                                            <div className="absolute -bottom-3 left-[-10px] w-5 h-5 rounded-full bg-[#F1F5F9] border-t border-slate-200"></div>
                                                        </div>

                                                        {/* 右側：詳細資訊 */}
                                                        <div className="flex-1 p-5 flex flex-col justify-between relative">
                                                            <div>
                                                                <div className="flex justify-between items-start mb-1">
                                                                    <div className={`text-xs font-[1000] uppercase tracking-wider px-2 py-0.5 rounded-md w-fit mb-1 ${isActive ? 'bg-rose-50 text-rose-600' : 'bg-slate-200 text-slate-500'}`}>
                                                                        {isExpired ? '已過期' : (isActive ? '進行中' : '已停用')}
                                                                    </div>
                                                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                        {/* 1. 編輯 */}
                                                                        <button onClick={() => setModal({ type: 'coupon', data: coupon })} className="w-7 h-7 rounded-full bg-slate-100 text-slate-500 hover:bg-blue-100 hover:text-blue-600 flex items-center justify-center transition-colors"><Icon name="Edit3" size={14}/></button>
                                                                        
                                                                        {/* 2. [New] 一鍵派發按鈕 */}
                                                                        <button onClick={() => setModal({ type: 'distribute_coupon', data: coupon })} className="w-7 h-7 rounded-full bg-slate-100 text-slate-500 hover:bg-emerald-100 hover:text-emerald-600 flex items-center justify-center transition-colors" title="一鍵派發"><Icon name="Send" size={14}/></button>
                                                                        
                                                                        {/* 3. 刪除 */}
                                                                        <button onClick={() => { if(confirm('確定刪除？')) dbOp('delete', 'coupons', coupon.id); }} className="w-7 h-7 rounded-full bg-slate-100 text-slate-500 hover:bg-red-100 hover:text-red-600 flex items-center justify-center transition-colors"><Icon name="Trash2" size={14}/></button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="pt-3 mt-3 border-t border-slate-100 flex justify-between items-end">
                                                                <div className="space-y-0.5">
                                                                    <div className="text-[10px] font-bold text-slate-400 flex items-center gap-1">
                                                                        <Icon name="Clock" size={10}/> {coupon.startDate || '即日起'} ~ {coupon.endDate || '無限期'}
                                                                    </div>
                                                                    <div className="text-[10px] font-bold text-slate-400 flex items-center gap-1">
                                                                        <Icon name="Users" size={10}/> {coupon.targetAudience === 'member_only' ? '限會員' : (coupon.targetAudience === 'first_purchase' ? '首購限定' : '所有顧客')}
                                                                    </div>
                                                                </div>
                                                                {coupon.usageLimit > 0 && (
                                                                    <div className="text-[10px] font-black text-rose-400 bg-rose-50 px-2 py-0.5 rounded-full">
                                                                        限量 {coupon.usageLimit}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            
                                            {/* Empty State */}
                                            {coupons.length === 0 && (
                                                <div className="col-span-full py-20 text-center text-slate-400">
                                                    <div className="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300"><Icon name="Ticket" size={40}/></div>
                                                    <p className="font-bold">目前沒有任何優惠券</p>
                                                    <button onClick={() => setModal({ type: 'coupon', data: { active: true, type: 'fixed' } })} className="mt-2 text-rose-500 font-bold hover:underline">立即新增一張</button>
                                                </div>
                                            )}
                                        </div>
                                    </section>
                                </div>
                            )}
							
							{/* [New] 特約機構管理 Tab */}
                            {activeTab === 'organizations' && (
                                <div className="animate-fade-in space-y-6 pb-24">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h2 className="text-2xl font-[1000] text-slate-800 tracking-tight">特約機構管理</h2>
                                            <p className="text-xs font-bold text-slate-400 mt-1">設定企業合作方案與驗證期限</p>
                                        </div>
                                        <Button onClick={() => setModal({type: 'org_editor', data: { name: '', schemeType: 'fixed', schemeValue: 0, expiryDate: '', verificationMonths: 12 }})} icon="Plus">新增機構</Button>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {organizations.map(org => (
                                            <div key={org.id} className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-md transition-all group">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div className="bg-blue-50 p-3 rounded-2xl text-blue-600"><Icon name="Building2" size={24}/></div>
                                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                                        <button onClick={() => setModal({type: 'org_editor', data: org})} className="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-blue-600"><Icon name="Edit3" size={16}/></button>
                                                        <button onClick={() => handleDelete('org', org.id)} className="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-red-600"><Icon name="Trash2" size={16}/></button>
                                                    </div>
                                                </div>
                                                <h3 className="text-xl font-[1000] text-slate-800 mb-1">{org.name}</h3>
                                                <div className="space-y-2 mt-4 pt-4 border-t border-slate-50">
                                                    <div className="flex justify-between text-xs font-bold">
                                                        <span className="text-slate-400">合作方案</span>
                                                        <span className="text-[#5B2274]">{org.schemeType === 'percent' ? `${org.schemeValue}% 折扣` : `現折 $${org.schemeValue}`}</span>
                                                    </div>
                                                    <div className="flex justify-between text-xs font-bold">
                                                        <span className="text-slate-400">特約到期日</span>
                                                        <span className="text-slate-600">{org.expiryDate || '永久'}</span>
                                                    </div>
                                                    <div className="flex justify-between text-xs font-bold">
                                                        <span className="text-slate-400">驗證有效期</span>
                                                        <span className="text-blue-500">{org.verificationMonths} 個月 (月底迄)</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Products Tab */}
                            {activeTab === 'products' && (
                                <div className="animate-fade-in space-y-5">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-2xl font-[900] text-slate-800 tracking-tight">餐點管理</h2>
                                        <div className="flex gap-2">
                                            <Button variant="secondary" onClick={() => setModal({type: 'tags'})} icon="Tag">標籤設定</Button>
                                            <Button onClick={() => setModal({type: 'prod', data: { name: '', price: 0, categoryId: activeCategory, isHidden: false, variants: [], materials: [], sideGroups: [], allowSets: [], desc: '', note: '', allowAddons: [], tags: [] }})} icon="Plus">新增</Button>
                                        </div>
                                    </div>
                                    {/* ... Category filter buttons ... */}
                                    <div className="flex items-center gap-2 py-1">
                                        <div className="flex-1 overflow-x-auto no-scrollbar flex gap-2">
                                            {categories.map(c => (<button key={c.id} onClick={() => setActiveCategory(c.id)} className={`px-5 py-2.5 rounded-xl font-bold text-xs lg:text-sm whitespace-nowrap transition-all shadow-sm ${activeCategory === c.id ? 'bg-[#5B2274] text-white shadow-purple-200' : 'bg-white text-slate-500 hover:text-[#5B2274] hover:bg-purple-50'}`}>{c.name}</button>))}
                                        </div>
                                        {activeCategory && <button onClick={() => handleBulkClose(activeCategory)} className="flex-shrink-0 w-10 h-10 rounded-xl bg-red-100 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all shadow-sm" title="本類別一鍵全關"><Icon name="Power" size={18} /></button>}
                                    </div>
                                    
                                    {/* Products Grid */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                                        {products.filter(p => p.categoryId === activeCategory).sort((a,b) => a.sortOrder - b.sortOrder).map((p, index) => {
                                            const matCheck = checkMaterialAvailability(p);
                                            const isMaterialOut = matCheck.status === 'all_out';
                                            const isPartialOut = matCheck.status === 'partial';
                                            
                                            return (
                                                <div key={p.id} className={`glass-panel p-4 lg:p-6 rounded-2xl relative group hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 ${p.isHidden || isMaterialOut ? 'opacity-60 grayscale' : ''}`}>
                                                    {/* Card Content ... */}
                                                    <div className="flex gap-4 mb-4">
                                                        <div className="w-16 h-16 lg:w-20 lg:h-20 rounded-xl bg-slate-100 object-cover overflow-hidden border border-slate-100 shrink-0 relative">{p.image ? <img src={p.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-slate-300"><Icon name="Image" size={24} /></div>}</div>
                                                        <div className="flex-1 min-w-0 flex flex-col justify-center">
                                                            <h4 className="font-[800] text-base lg:text-lg text-slate-800 truncate mb-0.5">{p.name}</h4>
                                                            <div className="flex items-center gap-2 flex-wrap">
                                                                <span className="font-[900] text-lg lg:text-xl text-[#5B2274]">{getDisplayPrice(p)}</span>
                                                                {p.variants?.length > 0 && <span className="text-[10px] bg-purple-50 text-purple-600 px-1 rounded">多規格</span>}
                                                                {isMaterialOut && <span className="text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold">原料缺貨</span>}
                                                                {isPartialOut && <span className="text-[10px] bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded font-bold">部分缺貨</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between pt-3 border-t border-slate-100">
                                                        <div className="flex gap-1"><SortButton direction="up" disabled={index === 0} onClick={() => handleSort('prod', p.id, 'up')} /><SortButton direction="down" disabled={index === products.filter(x=>x.categoryId===activeCategory).length - 1} onClick={() => handleSort('prod', p.id, 'down')} /></div>
                                                        <div className="flex gap-2 items-center">
                                                            <button onClick={() => handleCloneProduct(p)} className="p-2 lg:p-3 rounded-lg bg-blue-50 text-blue-500 hover:bg-blue-500 hover:text-white transition-all" title="複製商品"><Icon name="Copy" size={16} /></button>
                                                            <button onClick={() => setModal({type: 'prod', data: p})} className="p-2 lg:p-3 rounded-lg bg-purple-50 text-[#5B2274] hover:bg-[#5B2274] hover:text-white transition-all"><Icon name="Edit3" size={16} /></button>
                                                            <button onClick={() => handleDelete('prod', p.id)} className="p-2 lg:p-3 rounded-lg bg-red-50 text-red-400 hover:bg-red-500 hover:text-white transition-all"><Icon name="Trash2" size={16} /></button>
                                                            <div className="w-px h-6 bg-slate-200 mx-1"></div>
                                                            <ToggleSwitch checked={!p.isHidden} onChange={(checked) => dbOp('update', 'products', p.id, { isHidden: !checked })} />
                                                        </div>
                                                    </div>
                                                    {p.sideGroups?.length > 0 && <div className="absolute top-3 right-3 text-amber-400 bg-amber-50 rounded-full p-0.5"><Icon name="Sparkles" size={12}/></div>}
                                                    <div className="absolute top-2 left-2 flex gap-1 flex-wrap">
                                                        {p.tags?.map(tId => {
                                                            const tag = settings.productTags?.find(t => t.id === tId);
                                                            return tag ? <span key={tId} className={`text-[9px] px-1.5 py-0.5 rounded font-bold shadow-sm ${TAG_COLORS[tag.color]}`}>{tag.label}</span> : null;
                                                        })}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    {products.filter(p => p.categoryId === activeCategory).length === 0 && <div className="p-12 border-2 border-dashed border-slate-200 rounded-[24px] text-center text-slate-400 font-bold bg-white/50">此分類暫無餐點</div>}
                                </div>
                            )}

                            {/* Materials & Customization Tabs (Using Group Logic) */}
                            {['materials', 'customization'].includes(activeTab) && (
                                <div className="animate-fade-in space-y-6">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-2xl font-[900] text-slate-800 tracking-tight">{activeTab === 'materials' ? '原物料庫存' : '客製化選項'}</h2>
                                        <div className="flex gap-2">
                                            <Button variant="secondary" icon="Settings" onClick={() => setModal({ type: 'group_mgmt', dataType: activeTab === 'materials' ? 'materials' : 'addons' })}>管理組別</Button>
                                            <Button onClick={() => setModal({ type: 'item_editor', dataType: activeTab === 'materials' ? 'materials' : 'addons', data: { name: '新項目', category: '未分類' } })} icon="Plus">新增項目</Button>
                                        </div>
                                    </div>
                                    
                                    {/* [Fix] 恢復正確的原物料與客製化項目顯示邏輯 */}
                                    <div className="space-y-8">
                                        {processGroups(activeTab === 'materials' ? 'materials' : 'customization').map((group, gIdx) => (
                                            <div key={gIdx} className="space-y-3">
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xs font-black text-slate-500 uppercase tracking-widest bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200">{group.name}</span>
                                                    <div className="h-px bg-slate-100 flex-1"></div>
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                                    {group.items.map(item => (
                                                        <div key={item.id} className={`bg-white p-4 rounded-xl border shadow-sm flex items-center justify-between group hover:border-[#5B2274] hover:shadow-md transition-all ${item.isOut ? 'border-red-200 bg-red-50/10' : 'border-slate-100'}`}>
                                                            <div className="min-w-0">
                                                                <div className="font-bold text-slate-700 truncate">{item.name}</div>
                                                                {activeTab === 'customization' && <div className="text-xs font-bold text-[#5B2274] mt-0.5">+${item.price}</div>}
                                                                {activeTab === 'materials' && (
                                                                    <div className={`text-[10px] font-black px-2 py-0.5 rounded-md w-fit mt-1 flex items-center gap-1 ${item.isOut ? 'bg-red-100 text-red-600' : 'bg-emerald-50 text-emerald-600'}`}>
                                                                        <div className={`w-1.5 h-1.5 rounded-full ${item.isOut ? 'bg-red-500' : 'bg-emerald-500'}`}></div>
                                                                        {item.isOut ? '缺貨中' : '供應中'}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button onClick={() => setModal({ type: 'item_editor', dataType: activeTab === 'materials' ? 'materials' : 'addons', data: item })} className="p-2 rounded-lg bg-slate-50 text-slate-400 hover:bg-[#5B2274] hover:text-white transition-all"><Icon name="Edit3" size={16}/></button>
                                                                <button onClick={() => handleDelete(activeTab === 'materials' ? 'mat' : 'addon', item.id)} className="p-2 rounded-lg bg-slate-50 text-slate-400 hover:bg-red-500 hover:text-white transition-all"><Icon name="Trash2" size={16}/></button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    {(materials.length === 0 && activeTab === 'materials') && <div className="text-center py-20 text-slate-300 font-bold border-2 border-dashed border-slate-100 rounded-3xl">尚未建立原物料</div>}
                                    {(addons.length === 0 && activeTab === 'customization') && <div className="text-center py-20 text-slate-300 font-bold border-2 border-dashed border-slate-100 rounded-3xl">尚未建立選項</div>}
                                </div>
                            )}

                            {/* Categories & Sets Tabs (Similar structure) */}
                            {activeTab === 'categories' && (
                                <div className="animate-fade-in space-y-5">
                                    <div className="flex justify-between items-center"><h2 className="text-2xl font-[900] text-slate-800 tracking-tight">分類排序</h2><Button onClick={() => setModal({type: 'cat', data: { name: '', sortOrder: categories.length + 1 }})} icon="Plus">新增</Button></div>
                                    <div className="grid grid-cols-1 gap-3">
                                        {categories.map((c, i) => (
                                            <div key={c.id} className="glass-panel p-4 lg:p-5 rounded-2xl flex items-center gap-5 group hover:border-[#5B2274]/30 transition-all">
                                                <div className="w-10 h-10 lg:w-12 lg:h-12 shrink-0 bg-white rounded-xl flex items-center justify-center font-[900] text-base text-[#5B2274] shadow-sm border border-slate-100">{i + 1}</div>
                                                <div className="flex-1"><h3 className="font-[800] text-lg lg:text-xl text-slate-800">{c.name}</h3></div>
                                                <div className="flex items-center gap-2">
                                                    <div className="flex gap-1 mr-2"><SortButton direction="up" disabled={i === 0} onClick={() => handleSort('cat', c.id, 'up')} /><SortButton direction="down" disabled={i === categories.length - 1} onClick={() => handleSort('cat', c.id, 'down')} /></div>
                                                    <button onClick={() => setModal({type: 'cat', data: c})} className="p-2 lg:p-3 rounded-lg bg-slate-50 text-slate-500 hover:bg-[#5B2274] hover:text-white transition-all"><Icon name="Edit3" size={18}/></button>
                                                    <button onClick={() => handleDelete('cat', c.id)} className="p-2 lg:p-3 rounded-lg bg-red-50 text-red-400 hover:bg-red-500 hover:text-white transition-all"><Icon name="Trash2" size={18}/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'sets' && (
                                <div className="animate-fade-in space-y-5">
                                    <div className="flex justify-between items-center"><h2 className="text-2xl font-[900] text-slate-800 tracking-tight">套餐管理</h2><Button onClick={() => setModal({type: 'set', data: { name: '', price: 0, contents: [], image: '' }})} icon="Plus">建立套餐</Button></div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                                        {sets.map((s, index) => (
                                            <div key={s.id} className={`glass-panel p-4 lg:p-6 rounded-2xl relative group hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 ${s.isHidden ? 'opacity-60 grayscale' : ''}`}>
                                                <div className="flex gap-4 mb-4">
                                                    <div className="w-16 h-16 lg:w-20 lg:h-20 rounded-xl bg-slate-100 object-cover overflow-hidden border border-slate-100 shrink-0 relative">
                                                        {s.image ? <img src={s.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-slate-300"><Icon name="Image" size={24} /></div>}
                                                    </div>
                                                    <div className="flex-1 min-w-0 flex flex-col justify-center">
                                                        <h4 className="font-[800] text-base lg:text-lg text-slate-800 truncate mb-0.5">{s.name}</h4>
                                                        <div className="flex items-center gap-2"><span className="font-[900] text-lg lg:text-xl text-[#5B2274]">+${s.price}</span></div>
                                                    </div>
                                                </div>
                                                <div className="bg-slate-50 p-2 rounded-lg mb-3">
                                                    <p className="text-[10px] text-slate-400 font-bold uppercase mb-1">內容物</p>
                                                    <div className="space-y-1">
                                                        {s.contents?.slice(0, 3).map((c, i) => {
                                                            let contentText = c.label;
                                                            if (c.type === 'fixed') {
                                                                const p = products.find(prod => prod.id === c.productId);
                                                                if (p) contentText = `${p.name}${c.variantName ? ` (${c.variantName})` : ''}`;
                                                            } else if (c.type === 'category') {
                                                                const cat = categories.find(cat => cat.id === c.categoryId);
                                                                const def = products.find(prod => prod.id === c.defaultProductId);
                                                                contentText = `選: ${cat?.name || '未知分類'}${def ? ` (預設: ${def.name})` : ''}`;
                                                            }
                                                            return <div key={i} className="text-xs text-slate-600 font-bold truncate">• {contentText}</div>;
                                                        })}
                                                        {(s.contents?.length || 0) > 3 && <div className="text-[10px] text-slate-400 pl-2">...還有 {s.contents.length - 3} 項</div>}
                                                        {(s.contents?.length || 0) === 0 && <span className="text-xs text-slate-300">無內容</span>}
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between pt-3 border-t border-slate-100">
                                                    <div className="flex gap-1"><SortButton direction="up" disabled={index === 0} onClick={() => handleSort('set', s.id, 'up')} /><SortButton direction="down" disabled={index === sets.length - 1} onClick={() => handleSort('set', s.id, 'down')} /></div>
                                                    <div className="flex gap-2 items-center">
                                                        <button onClick={() => handleCloneSet(s)} className="p-2 lg:p-3 rounded-lg bg-blue-50 text-blue-500 hover:bg-blue-500 hover:text-white transition-all"><Icon name="Copy" size={16} /></button>
                                                        <button onClick={() => setModal({type: 'set', data: s})} className="p-2 lg:p-3 rounded-lg bg-purple-50 text-[#5B2274] hover:bg-[#5B2274] hover:text-white transition-all"><Icon name="Edit3" size={16} /></button>
                                                        <button onClick={() => handleDelete('set', s.id)} className="p-2 lg:p-3 rounded-lg bg-red-50 text-red-400 hover:bg-red-500 hover:text-white transition-all"><Icon name="Trash2" size={16} /></button>
                                                        <div className="w-px h-6 bg-slate-200 mx-1"></div>
                                                        <ToggleSwitch checked={!s.isHidden} onChange={(checked) => dbOp('update', 'sets', s.id, { isHidden: !checked })} />
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Settings Tab (Updated with Publish Button) */}
                            {activeTab === 'settings' && (
                                <div className="animate-fade-in space-y-5">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-2xl font-[900] text-slate-800 tracking-tight">營運設定</h2>
                                        
                                        {/* Publish Button */}
                                        <Button 
                                            icon="Send" 
                                            className="bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200"
                                            onClick={handlePublish}
                                        >
                                            儲存並發布到前台
                                        </Button>
                                    </div>
                                    
                                    {/* LINE Settings Section */}
                                    <div className="glass-panel p-6 lg:p-8 rounded-2xl space-y-4">
                                        <div className="flex items-center gap-2 text-[#06C755] mb-1">
                                            <Icon name="MessageCircle" size={18}/>
                                            <h3 className="font-[800] text-base lg:text-lg">LINE 設定</h3>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-[10px] lg:text-xs font-bold text-slate-400">LIFF ID (點餐用)</label>
                                                <input 
                                                    className="w-full input-compact rounded-lg font-bold" 
                                                    value={settings.liffId || ''} 
                                                    onChange={e=>setSettings({...settings, liffId: e.target.value})} 
                                                    placeholder="例如: 1657xxxxxx-xxxxxx" 
                                                />
                                                <p className="text-[10px] text-slate-400 mt-1">
                                                    需具備 chat_message.write 權限，用於傳送訂單。
                                                </p>
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] lg:text-xs font-bold text-slate-400">LIFF ID (純瀏覽/菜單用)</label>
                                                <input 
                                                    className="w-full input-compact rounded-lg font-bold" 
                                                    value={settings.liffIdBrowse || ''} 
                                                    onChange={e=>setSettings({...settings, liffIdBrowse: e.target.value})} 
                                                    placeholder="例如: 1657xxxxxx-yyyyyy" 
                                                />
                                                <p className="text-[10px] text-slate-400 mt-1">
                                                    用於隱藏網址純瀏覽，不需傳送訊息權限。
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="glass-panel p-6 lg:p-8 rounded-2xl space-y-4">
                                        <div className="flex items-center gap-2 text-[#5B2274] mb-1"><Icon name="Cloud" size={18}/><h3 className="font-[800] text-base lg:text-lg">圖片主機設定 (Cloudinary)</h3></div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="space-y-1"><label className="text-[10px] lg:text-xs font-bold text-slate-400">Cloud Name</label><input className="w-full input-compact rounded-lg font-bold" value={settings.cloudinaryCloudName || ''} onChange={e=>setSettings({...settings, cloudinaryCloudName: e.target.value})} placeholder="例如: demo" /></div>
                                            <div className="space-y-1"><label className="text-[10px] lg:text-xs font-bold text-slate-400">Upload Preset (Unsigned)</label><input className="w-full input-compact rounded-lg font-bold" value={settings.cloudinaryUploadPreset || ''} onChange={e=>setSettings({...settings, cloudinaryUploadPreset: e.target.value})} placeholder="例如: my_preset" /></div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className="glass-panel p-6 lg:p-8 rounded-2xl space-y-5">
                                            <div className="flex items-center gap-2 text-[#5B2274] mb-1"><Icon name="Store" size={18}/><h3 className="font-[800] text-base lg:text-lg">基本資料 & 營運模式</h3></div>
                                            <div className="bg-slate-100 p-1 rounded-xl flex gap-1">{['auto', 'open', 'closed'].map(mode => (<button key={mode} onClick={()=>setSettings({...settings, statusMode: mode})} className={`flex-1 py-2.5 rounded-lg text-xs lg:text-sm font-bold transition-all ${settings.statusMode === mode ? 'bg-white text-[#5B2274] shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>{mode === 'auto' ? '自動' : (mode === 'open' ? '營業' : '休息')}</button>))}</div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="space-y-1"><label className="text-[10px] lg:text-xs font-bold text-slate-400">開店</label><div className="time-input-wrapper"><input type="time" className="input-compact rounded-lg bg-white font-bold text-slate-700" value={settings.openTime} onChange={e=>setSettings({...settings, openTime: e.target.value})} /></div></div>
                                                <div className="space-y-1"><label className="text-[10px] lg:text-xs font-bold text-slate-400">打烊</label><div className="time-input-wrapper"><input type="time" className="input-compact rounded-lg bg-white font-bold text-slate-700" value={settings.closeTime} onChange={e=>setSettings({...settings, closeTime: e.target.value})} /></div></div>
                                            </div>
                                            <div className="space-y-3"><div className="space-y-1"><label className="text-[10px] lg:text-xs font-bold text-slate-400">門市電話</label><input className="w-full input-compact rounded-lg font-bold" value={settings.phone} onChange={e=>setSettings({...settings, phone: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] lg:text-xs font-bold text-slate-400">門市地址</label><input className="w-full input-compact rounded-lg font-bold" value={settings.address} onChange={e=>setSettings({...settings, address: e.target.value})} /></div><div className="space-y-1"><label className="text-[10px] lg:text-xs font-bold text-slate-400">Google 地圖連結</label><input className="w-full input-compact rounded-lg font-bold" value={settings.mapsUrl} onChange={e=>setSettings({...settings, mapsUrl: e.target.value})} placeholder="https://maps..." /></div></div>
                                        </div>
                                        <div className="glass-panel p-6 lg:p-8 rounded-2xl space-y-5">
                                            <div className="flex items-center gap-2 text-[#5B2274] mb-1"><Icon name="CalendarOff" size={18}/><h3 className="font-[800] text-base lg:text-lg">公休與特殊日程</h3></div>
                                            <div className="flex justify-between gap-2">{['日','一','二','三','四','五','六'].map((d, i) => (<button key={i} onClick={() => { const newDays = settings.closedDays.includes(i) ? settings.closedDays.filter(d => d !== i) : [...settings.closedDays, i]; setSettings({...settings, closedDays: newDays}); }} className={`w-9 h-9 lg:w-12 lg:h-12 rounded-full text-xs lg:text-sm font-bold flex items-center justify-center transition-all border ${settings.closedDays.includes(i) ? 'bg-slate-800 border-slate-800 text-white' : 'bg-white border-slate-200 text-slate-400 hover:border-[#5B2274]'}`}>{d}</button>))}</div>
                                            <div className="space-y-2 max-h-32 overflow-y-auto no-scrollbar pt-2">{settings.specialDates.length===0 && <div className="text-center text-xs text-slate-400 border border-dashed rounded-lg py-3 cursor-pointer hover:bg-slate-50" onClick={()=>setSettings({...settings, specialDates: [...settings.specialDates, { id: Date.now(), date: '', type: 'closed' }]})}>+ 新增特殊排程</div>}{settings.specialDates.map((sd, idx) => (<div key={sd.id} className="flex flex-col gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200"><div className="flex items-center gap-2"><input type="date" className="input-compact py-1 px-2 rounded bg-white text-xs lg:text-sm font-bold flex-1" value={sd.date} onChange={e => { const n = [...settings.specialDates]; n[idx].date = e.target.value; setSettings({...settings, specialDates: n}); }} /><select className="input-compact py-1 px-2 rounded bg-white text-xs lg:text-sm font-bold w-24 shrink-0" value={sd.type} onChange={e => { const n = [...settings.specialDates]; n[idx].type = e.target.value; setSettings({...settings, specialDates: n}); }}><option value="closed">店休</option><option value="open">營業</option></select><button onClick={() => setSettings({...settings, specialDates: settings.specialDates.filter((_, i) => i !== idx)})} className="ml-auto text-slate-400 hover:text-red-500 shrink-0"><Icon name="X" size={16}/></button></div><input type="text" placeholder="備註說明 (選填)" value={sd.note || ''} onChange={e => { const n = [...settings.specialDates]; n[idx].note = e.target.value; setSettings({...settings, specialDates: n}); }} className="input-compact py-1 px-2 bg-white text-xs font-bold rounded" /></div>))}</div>
                                        </div>
                                    </div>
                                    <div className="glass-panel p-6 lg:p-8 rounded-2xl space-y-4">
                                        <div className="flex items-center gap-2 text-[#5B2274] mb-1"><Icon name="Megaphone" size={18}/><h3 className="font-[800] text-base lg:text-lg">公告系統</h3></div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{settings.announcements.map((ann, i) => (<div key={i} className="space-y-1"><label className="text-[10px] lg:text-xs font-bold text-slate-400 uppercase">公告 {i+1}</label><input className="w-full input-compact rounded-lg font-bold" value={ann} onChange={e => { const n = [...settings.announcements]; n[i] = e.target.value; setSettings({...settings, announcements: n}); }} placeholder="輸入..." /></div>))}</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    
					
					
					{/* Modals & Drawers */}
                    {modal && (
                        <div className={`fixed inset-0 z-[100] flex justify-center ${['edit_order', 'member_detail', 'edit_cart'].includes(modal.type) ? 'items-end p-0' : 'items-center p-4'}`}>
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={() => setModal(null)} />
                            
                            {/* 1. 訂單詳情 (Order Detail) */}
                            {modal.type === 'edit_order' ? (
                                <div className="bg-slate-50 w-full max-w-2xl mt-auto rounded-t-[2rem] shadow-[0_-20px_60px_-15px_rgba(0,0,0,0.3)] relative z-10 flex flex-col overflow-hidden animate-slide-up" style={{height: '92vh'}}>
                                    {(() => {
                                        const st = STATUS_STYLE[modal.data.status] || STATUS_STYLE.pending;
                                        const pickupDateRaw = modal.data.userInfo?.pickupDate;
                                        const displayDate = pickupDateRaw?.replace(/-/g, '/') || '';
                                        const isToday = pickupDateRaw === todayStr;
                                        const orderType = modal.data.orderType || 'takeout';
                                        const typeConfig = ORDER_TYPES[orderType] || ORDER_TYPES['takeout'];
                                        
                                        // 集點卡狀態
                                        const hasPointReward = !!modal.data.usePointReward || modal.data.discountApplied === 'loyalty';
                                        const isPointVerified = modal.pointVerified === true || modal.data.verified === true; // 包含已核銷狀態

                                        // [核心] 切換集點優惠狀態 (資料庫連動修正)
                                        const togglePointReward = async (enable) => {
                                            const actionName = enable ? "手動套用" : "移除";
                                            if(!confirm(`確定要【${actionName}】集點卡優惠嗎？\n\n${enable ? '將扣除 $50 並標記為 loyalty' : '將恢復原價並清除標記'}。`)) return;

                                            // 1. 計算金額
                                            const currentTotal = modal.data.totalPrice;
                                            const currentDiscount = modal.data.discountAmount || 0;
                                            // 嘗試還原原價
                                            const basePrice = modal.data.originalPrice ? modal.data.originalPrice : (currentTotal + currentDiscount);
                                            
                                            // 設定折扣 (假設 $50)
                                            const discountValue = 50; 
                                            const newDiscount = enable ? discountValue : 0;
                                            const newTotal = Math.max(0, basePrice - newDiscount);

                                            // 2. 準備寫入資料庫的物件 (關鍵修正)
                                            const updateData = {
                                                usePointReward: enable,                // 標記開關
                                                discountAmount: newDiscount,           // 折扣金額
                                                discountApplied: enable ? 'loyalty' : null, // 優惠類型標記
                                                totalPrice: newTotal,                  // 更新後總價
                                                originalPrice: basePrice               // 確保原價被記錄
                                            };

                                            try {
                                                // 3. 寫入 Firestore
                                                await dbOp('update', 'orders', modal.data.id, updateData);
                                                
                                                // 4. 更新 UI
                                                setModal({ 
                                                    ...modal, 
                                                    data: { ...modal.data, ...updateData },
                                                    // 若開啟優惠，需重置檢核狀態；若移除，則視為已處理
                                                    pointVerified: enable ? false : true 
                                                });
                                                alert(`已${actionName}集點優惠。`);
                                            } catch(e) {
                                                console.error(e);
                                                alert("更新失敗，請檢查網路連線。");
                                            }
                                        };

                                        return (
                                            <div className="flex flex-col h-full bg-[#F8FAFC] relative">
                                                {/* Header */}
                                                <div className={`px-6 py-5 flex justify-between items-center border-b shrink-0 bg-white shadow-sm z-20`}>
                                                    <div className="flex items-center gap-4">
                                                        <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shadow-inner ${st.bg}`}><Icon name={st.icon} size={24} className={st.text}/></div>
                                                        <div>
                                                            <div className={`text-[10px] font-black uppercase tracking-widest mb-0.5 ${st.text}`}>{st.label}</div>
                                                            <div className="text-xl font-[1000] text-slate-800 tracking-tighter flex items-center gap-2"><span>#{modal.data.orderId?.slice(-6)}</span></div>
                                                        </div>
                                                    </div>
                                                    <button onClick={handlePopModal} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-slate-200 hover:text-slate-600 transition-all"><Icon name="X" size={20}/></button>
                                                </div>

                                                <div className="flex-1 overflow-y-auto p-4 space-y-6 no-scrollbar pb-32">
                                                    {/* 顧客資訊 */}
                                                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex justify-between items-center relative overflow-hidden">
                                                        <div className="space-y-3 z-10">
                                                            <div className="flex items-center gap-3">
                                                                <div className="text-3xl font-[1000] text-slate-800 tracking-tight leading-none">{modal.data.userInfo?.name}</div>
                                                                {modal.data.customerUid && modal.data.customerUid !== 'guest' && (
                                                                    <button onClick={(e) => { e.stopPropagation(); const memberData = members.find(m => m.id === modal.data.customerUid); if(memberData) handlePushModal({ type: 'member_detail', data: memberData }); else alert('查無此會員資料'); }} className="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-[#5B2274] hover:text-white transition-all shadow-sm flex items-center justify-center active:scale-90"><Icon name="User" size={16} /></button>
                                                                )}
                                                            </div>
                                                            <div className="flex items-center gap-3">
                                                                <span className={`text-[10px] font-black px-2 py-1 rounded-lg border flex items-center gap-1 ${typeConfig.bg} ${typeConfig.text} ${typeConfig.border}`}><Icon name={typeConfig.icon} size={12}/> {typeConfig.label}</span>
                                                                <a href={`tel:${modal.data.userInfo?.phone}`} className="inline-flex items-center gap-1 text-sm font-bold text-slate-400 hover:text-blue-600 transition-colors"><Icon name="Phone" size={14} /> {modal.data.userInfo?.phone}</a>
                                                            </div>
                                                            {orderType === 'delivery' && modal.data.userInfo?.address && (<div className="text-xs font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded border border-slate-100 mt-1 flex items-start gap-1"><Icon name="MapPin" size={12} className="mt-0.5 shrink-0"/> {modal.data.userInfo.address}</div>)}
                                                        </div>
                                                        <div className="flex flex-col items-start pl-8 border-l-2 border-slate-100 border-dashed">
                                                            <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">預計時間</div>
                                                            <div className={`text-5xl font-[1000] tracking-tighter leading-none ${modal.data.userInfo?.pickupTime==='ASAP'?'text-red-500 animate-pulse':'text-slate-900'}`}>{modal.data.userInfo?.pickupTime}</div>
                                                            <div className={`text-xs font-black mt-2 px-2 py-0.5 rounded ${isToday ? 'text-slate-400 bg-slate-100' : 'text-red-500 bg-red-50'}`}>{isToday ? '今日' : displayDate}</div>
                                                        </div>
                                                    </div>

                                                    {/* 變更訂單按鈕 */}
                                                    {!['completed', 'cancelled'].includes(modal.data.status) && (
                                                        <div className="mb-4">
                                                            <button onClick={() => setModal({ type: 'edit_cart', data: JSON.parse(JSON.stringify(modal.data)) })} className="w-full py-4 bg-white border-2 border-dashed border-purple-200 text-[#5B2274] font-[900] rounded-2xl hover:bg-purple-50 hover:border-[#5B2274] transition-all flex items-center justify-center gap-2 shadow-sm animate-pulse"><Icon name="Edit3" size={20}/> 變更訂單內容 (補單/改量)</button>
                                                        </div>
                                                    )}

                                                    {/* 餐點明細 */}
                                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                                                        <div className="flex items-center gap-2 mb-6 border-b border-slate-100 pb-3"><Icon name="Utensils" size={20} className="text-[#5B2274]" /><h3 className="text-lg font-[900] text-slate-800">餐點明細</h3></div>
                                                        
                                                        {/* 列表渲染 (保持不變) */}
                                                        <div className="space-y-8"> 
                                                            {modal.data.items?.map((item, idx) => (
                                                                <div key={idx} className="flex gap-4 items-start">
                                                                    <div className="w-9 h-9 bg-slate-100 rounded-lg flex items-center justify-center text-slate-600 font-[900] text-sm shrink-0 mt-0.5">{item.qty}x</div>
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className="flex justify-between items-start mb-1"><div className="font-[900] text-slate-800 text-lg leading-tight">{item.name}</div><div className="font-[900] text-slate-800 text-lg ml-3">${item.totalPrice}</div></div>
                                                                        {(item.variantName || (item.addons && item.addons.length > 0)) && (<div className="text-sm font-bold text-slate-400 mb-3">{[item.variantName, ...(item.addons?.map(a => a.name) || [])].filter(Boolean).join(' / ')}</div>)}
                                                                        
                                                                        {item.sideGroups && Object.values(item.sideGroups).some(s=>s.product || s.name) && (
                                                                            <div className="bg-[#FAF5FF] rounded-xl p-4 mb-3 space-y-3">
                                                                                <div className="text-sm font-[900] text-[#5B2274]">附餐：</div>
                                                                                <div className="space-y-2">{Object.values(item.sideGroups).map((side, si) => (side.product || side.name) && (<div key={si}><div className="flex items-start text-sm font-bold text-slate-700"><span className="mr-1.5 text-slate-400">•</span><span>{side.product?.name || side.name}</span></div>{(side.variantName || (side.addons && side.addons.length > 0)) && (<div className="text-xs font-bold text-slate-400 pl-4 mt-0.5">{[side.variantName, ...(side.addons?.map(a => a.name) || [])].filter(Boolean).join(' / ')}</div>)}</div>))}</div>
                                                                            </div>
                                                                        )}
                                                                        
                                                                        {item.set && (
                                                                            <div className="bg-[#FAF5FF] rounded-xl p-4 mb-3 space-y-3">
                                                                                <div className="text-sm font-[900] text-[#5B2274]">升級套餐：{item.set.name}</div>
                                                                                <div className="space-y-2">{item.set.contents?.map((c, ci) => { const choice = item.setChoices?.[ci] || item.setChoices?.[c.id]; let cName = choice?.product?.name || choice?.name || (c.type==='fixed' ? '固定餐點' : null); if(!cName) return null; return (<div key={ci}><div className="flex items-start text-sm font-bold text-slate-700"><span className="mr-1.5 text-slate-400">•</span><span>{cName}</span></div>{((choice?.variantName) || (choice?.addons?.length > 0)) && (<div className="text-xs font-bold text-slate-400 pl-4 mt-0.5">{[choice?.variantName, ...(choice?.addons?.map(a => a.name) || [])].filter(Boolean).join(' / ')}</div>)}</div>); })}</div>
                                                                            </div>
                                                                        )}
                                                                        
                                                                        {item.note && (<div className="bg-[#FFF7ED] rounded-xl p-3 text-[#EA580C] text-sm font-bold flex items-baseline gap-2 leading-relaxed"><span className="shrink-0 opacity-70 text-xs">備註：</span><span>{item.note}</span></div>)}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>

                                                        {/* [Modified] 集點卡管理專區 */}
                                                        <div className="mt-8 border-t border-slate-100 pt-6">
                                                            {hasPointReward ? (
                                                                // 情境 A: 顧客已勾選
                                                                <div className="bg-rose-50 border-2 border-rose-100 rounded-2xl p-4 animate-pulse-slow">
                                                                    <div className="flex justify-between items-start mb-3">
                                                                        <div className="flex items-center gap-2">
                                                                            <div className="bg-rose-500 text-white p-1.5 rounded-lg"><Icon name="Ticket" size={16}/></div>
                                                                            <h4 className="font-[1000] text-rose-600 text-base">顧客使用集點卡優惠</h4>
                                                                        </div>
                                                                        {/* 移除按鈕 */}
                                                                        <button onClick={() => togglePointReward(false)} className="text-[10px] font-bold text-rose-400 bg-white border border-rose-200 px-3 py-1.5 rounded-lg hover:bg-rose-100 hover:text-rose-600 transition-colors flex items-center gap-1">
                                                                            <Icon name="X" size={12}/> 資格不符？移除
                                                                        </button>
                                                                    </div>
                                                                    {/* 核銷勾選 */}
                                                                    <label className={`flex items-center gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all ${isPointVerified ? 'bg-rose-500 border-rose-500 text-white shadow-lg shadow-rose-200 transform scale-[1.02]' : 'bg-white border-rose-200 text-slate-500 hover:border-rose-300'}`}>
                                                                        <div className={`w-6 h-6 rounded border-2 flex items-center justify-center transition-colors ${isPointVerified ? 'border-white bg-white/20' : 'border-slate-300 bg-slate-50'}`}>
                                                                            {isPointVerified && <Icon name="Check" size={16} className="text-white"/>}
                                                                        </div>
                                                                        <input type="checkbox" className="hidden" checked={isPointVerified} onChange={(e) => setModal({...modal, pointVerified: e.target.checked})} />
                                                                        <div>
                                                                            <div className={`font-[900] ${isPointVerified?'text-white':'text-slate-700'}`}>確認核銷</div>
                                                                            <div className={`text-xs font-bold ${isPointVerified?'text-white/80':'text-slate-400'}`}>我已回收紙本卡 / 蓋章</div>
                                                                        </div>
                                                                    </label>
                                                                </div>
                                                            ) : (
                                                                // 情境 B: 顧客未勾選 (顯示手動補登按鈕)
                                                                <div className="bg-slate-50 border border-slate-200 rounded-2xl p-4 flex justify-between items-center">
                                                                    <div className="flex items-center gap-2 text-slate-400">
                                                                        <Icon name="Ticket" size={18}/>
                                                                        <span className="font-bold text-sm">未套用集點優惠</span>
                                                                    </div>
                                                                    <button onClick={() => togglePointReward(true)} className="text-xs font-[900] text-[#5B2274] bg-white border border-purple-200 px-4 py-2 rounded-xl hover:bg-purple-50 transition-all flex items-center gap-1 shadow-sm">
                                                                        <Icon name="Plus" size={14}/> 手動套用優惠
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </div>

                                                        {/* 金額統計區 */}
                                                        <div className="mt-6 space-y-2">
                                                            <div className="flex justify-between items-center text-slate-400 font-bold text-xs"><span>小計</span><span>${modal.data.originalPrice || modal.data.totalPrice}</span></div>
                                                            {modal.data.discountAmount > 0 && (<div className="flex justify-between items-center text-red-500 font-bold text-xs"><div className="flex items-center gap-1.5">{modal.data.organizationId ? (<><Icon name="Building2" size={14} className="text-blue-500"/><span className="text-blue-600">特約：{modal.data.organizationName || '合作機構'}{modal.data.discountContent ? ` (${modal.data.discountContent})` : ''}</span></>) : modal.data.discountApplied === 'loyalty' ? (<><Icon name="Crown" size={14} className="text-amber-500"/><span className="text-amber-600">集點卡回饋</span></>) : (<><Icon name="Ticket" size={14}/><span>優惠券 ({modal.data.discountApplied || '未知'})</span></>)}</div><span>-${modal.data.discountAmount}</span></div>)}
                                                            <div className="flex justify-between items-center pt-3 mt-2 border-t border-slate-200 border-dashed"><span className="text-sm font-black text-slate-700 uppercase tracking-widest">總計金額</span><span className="text-2xl font-[1000] text-[#5B2274] tracking-tighter">${modal.data.totalPrice}</span></div>
                                                        </div>
                                                    </div>

                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div className="bg-amber-50/80 rounded-2xl p-4 border border-amber-100/50 shadow-sm flex flex-col gap-2 relative group focus-within:bg-amber-50 focus-within:ring-2 focus-within:ring-amber-200 transition-all">
                                                            <div className="flex justify-between items-center"><div className="flex items-center gap-2 text-[10px] font-black text-amber-700 uppercase tracking-widest"><Icon name="Star" size={12}/> 顧客永久註記 (跨單連動)</div><button onClick={saveCustomerNote} className="bg-amber-400 text-white p-1.5 rounded-lg shadow-sm hover:scale-110 active:scale-90 transition-all opacity-0 group-focus-within:opacity-100"><Icon name="Save" size={14}/></button></div>
                                                            <textarea className="w-full bg-transparent text-sm font-bold text-slate-700 resize-none outline-none placeholder:text-amber-700/30" rows="3" value={customerNote} onChange={(e) => setCustomerNote(e.target.value)} placeholder="輸入關於此客人的習慣 (例如: 不吃香菜)..."></textarea>
                                                        </div>
                                                        {/* [Fix] 移除訂單核銷按鈕，僅保留內部備註 */}
                                                        <div className="bg-white rounded-2xl p-4 border border-slate-200 shadow-sm flex flex-col gap-3">
                                                            <div className="flex justify-between items-center border-b border-slate-100 pb-2"><div className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1"><Icon name="FileText" size={12}/> 內部備註</div></div>
                                                            <div className="flex items-center gap-2 bg-slate-50 rounded-xl px-3 py-2 border border-slate-200 focus-within:border-slate-400 transition-colors"><Icon name="Tag" size={14} className="text-slate-400"/><input className="flex-1 bg-transparent border-none text-xs font-bold text-slate-700 outline-none placeholder:text-slate-400" value={modal.data.adminNote || ''} onChange={e => setModal({...modal, data: {...modal.data, adminNote: e.target.value}})} placeholder="填寫內部備註..." /></div>
                                                        </div>
                                                    </div>
                                                    <div className="text-center pt-8 pb-12"><button onClick={() => { if(confirm("確定永久刪除？")) { dbOp('delete', 'orders', modal.data.id); setModal(null); }}} className="text-[10px] font-bold text-slate-300 hover:text-red-500 underline tracking-widest">永久刪除此訂單</button></div>
                                                </div>

                                                {!['completed', 'cancelled'].includes(modal.data.status) && (
                                                    <div className="grid grid-cols-2 divide-x divide-slate-100 border-t border-slate-100 bg-slate-50 absolute bottom-0 w-full z-30 shadow-[0_-10px_30px_-10px_rgba(0,0,0,0.1)] pb-[env(safe-area-inset-bottom)]">
                                                        {modal.data.status === 'pending' && (<><button onClick={() => { if(confirm('拒絕？')) handleUpdateOrderStatus(modal.data.id, 'cancelled'); }} className="py-4 text-slate-400 font-bold text-sm hover:bg-red-50 hover:text-red-500 transition-colors flex items-center justify-center gap-2">拒絕</button><button onClick={() => handleUpdateOrderStatus(modal.data.id, 'confirmed')} className="py-4 bg-blue-600 text-white font-[1000] text-sm tracking-widest hover:bg-blue-700 transition-colors shadow-inner flex items-center justify-center gap-2">確認接單</button></>)}
                                                        {modal.data.status === 'confirmed' && <button onClick={() => handleUpdateOrderStatus(modal.data.id, 'preparing')} className="col-span-2 py-4 bg-orange-500 text-white font-[1000] text-sm tracking-widest hover:bg-orange-600 transition-colors shadow-inner">開始製作餐點</button>}
                                                        {modal.data.status === 'preparing' && <button onClick={() => handleUpdateOrderStatus(modal.data.id, 'ready')} className="col-span-2 py-4 bg-emerald-500 text-white font-[1000] text-sm tracking-widest hover:bg-emerald-600 transition-colors shadow-inner">製作完成</button>}
                                                        {/* 底部按鈕鎖定邏輯 */}
                                                        {modal.data.status === 'ready' && (
                                                            <button 
                                                                disabled={hasPointReward && !isPointVerified} 
                                                                onClick={() => handleUpdateOrderStatus(modal.data.id, 'completed')} 
                                                                className={`col-span-2 py-4 font-[1000] text-sm tracking-widest transition-colors shadow-inner ${hasPointReward && !isPointVerified ? 'bg-slate-300 text-white cursor-not-allowed' : 'bg-[#5B2274] text-white hover:bg-[#4a1b5e]'}`}
                                                            >
                                                                {hasPointReward && !isPointVerified ? '請先核銷集點卡' : '完成取餐'}
                                                            </button>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </div>
                            ) : modal.type === 'edit_cart' ? (
                                <EditCartDrawer 
                                    order={modal.data} 
                                    products={products} 
                                    categories={categories}
                                    sets={sets}
                                    addons={addons}
                                    settings={settings}
                                    materials={materials}
                                    onClose={() => handlePopModal()}
                                    onSave={async (updatedOrder) => {
                                        try {
                                            const { db, appId } = window.firebase;
                                            const { doc, updateDoc } = window.firestore;
                                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', updatedOrder.id), updatedOrder);
                                            setModal({ type: 'edit_order', data: updatedOrder });
                                            alert('✅ 訂單變更已儲存！');
                                        } catch(e) { console.error(e); alert('儲存失敗：' + e.message); }
                                    }}
                                />
                            ) : modal.type === 'org_editor' ? (
                                <div className="bg-slate-50 w-full max-w-4xl rounded-[2.5rem] shadow-2xl relative z-10 flex flex-col overflow-hidden animate-scale-in">
                                    {/* Header */}
                                    <div className="px-8 py-5 bg-white border-b border-slate-100 flex justify-between items-center shrink-0">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-blue-100 p-2.5 rounded-xl text-blue-600 shadow-sm"><Icon name="Building2" size={24}/></div>
                                            <div>
                                                <h3 className="text-xl font-[1000] text-slate-800 tracking-tight">特約機構設定</h3>
                                                <p className="text-[11px] font-bold text-slate-400 uppercase tracking-wider mt-0.5">Organization & Discount</p>
                                            </div>
                                        </div>
                                        <button onClick={() => setModal(null)} className="w-9 h-9 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-400 transition-colors"><Icon name="X" size={20}/></button>
                                    </div>

                                    <div className="p-8 overflow-y-auto custom-scrollbar bg-[#F8FAFC]">
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            
                                            {/* 左欄：機構基本資料 */}
                                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/60 space-y-5 h-fit">
                                                <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 mb-2 pb-2 border-b border-slate-50">
                                                    <Icon name="FileText" size={14}/> 1. 機構基本資料
                                                </h4>
                                                
                                                <div className="space-y-1.5">
                                                    <label className="text-xs font-bold text-slate-700">機構名稱</label>
                                                    <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-200 transition-all group">
                                                        <div className="pl-3 pr-2 text-slate-400 group-focus-within:text-blue-600 transition-colors"><Icon name="Building" size={16}/></div>
                                                        <input className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 placeholder:text-slate-400 outline-none ring-0" 
                                                            value={modal.data.name || ''} 
                                                            onChange={e => setModal({...modal, data: {...modal.data, name: e.target.value}})} 
                                                            placeholder="例如: 台積電 TSMC" 
                                                        />
                                                    </div>
                                                </div>

                                                <div className="space-y-1.5">
                                                    <label className="text-xs font-bold text-slate-700">合約到期日</label>
                                                    <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-200 transition-all group">
                                                        <div className="pl-3 pr-2 text-slate-400 group-focus-within:text-blue-600 transition-colors"><Icon name="Calendar" size={16}/></div>
                                                        <input type="date" className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 outline-none ring-0 text-slate-500" 
                                                            value={modal.data.expiryDate || ''} 
                                                            onChange={e => setModal({...modal, data: {...modal.data, expiryDate: e.target.value}})} 
                                                        />
                                                    </div>
                                                    <p className="text-[10px] font-bold text-slate-400 pl-1">* 留空則代表永久有效</p>
                                                </div>

                                                <div className="space-y-1.5">
                                                    <label className="text-xs font-bold text-slate-700">員工身分驗證效期</label>
                                                    <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-200 transition-all group">
                                                        <div className="pl-3 pr-2 text-slate-400 group-focus-within:text-blue-600 transition-colors"><Icon name="UserCheck" size={16}/></div>
                                                        <input type="number" className="flex-1 bg-transparent border-none p-3 text-sm font-bold text-slate-700 outline-none ring-0" 
                                                            value={modal.data.verificationMonths || 12} 
                                                            onChange={e => setModal({...modal, data: {...modal.data, verificationMonths: parseInt(e.target.value)||0}})} 
                                                        />
                                                        <div className="pr-4 text-xs font-black text-slate-400">個月</div>
                                                    </div>
                                                    <p className="text-[10px] font-bold text-blue-400 pl-1 flex items-center gap-1">
                                                        <Icon name="Info" size={10}/> 驗證通過後，有效期至 N 個月後的月底
                                                    </p>
                                                </div>
                                            </div>

                                            {/* 右欄：折扣方案 */}
                                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/60 space-y-5 h-fit">
                                                <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 mb-2 pb-2 border-b border-slate-50">
                                                    <Icon name="BadgePercent" size={14}/> 2. 折扣方案設定
                                                </h4>

                                                {/* 方案類型選擇 */}
                                                <div className="space-y-1.5">
                                                    <label className="text-xs font-bold text-slate-700">選擇折扣模式</label>
                                                    <div className="grid grid-cols-3 gap-2">
                                                        {[
                                                            {id: 'fixed', label: '固定折抵', icon: 'DollarSign'},
                                                            {id: 'percent', label: '百分比折扣', icon: 'Percent'},
                                                            {id: 'step', label: '滿額累折', icon: 'Layers'}
                                                        ].map(opt => (
                                                            <button key={opt.id} onClick={()=>setModal({...modal, data: {...modal.data, schemeType: opt.id}})}
                                                                className={`flex flex-col items-center justify-center gap-1.5 py-3 rounded-xl border-2 transition-all ${modal.data.schemeType === opt.id ? 'border-[#5B2274] bg-purple-50 text-[#5B2274]' : 'border-slate-100 bg-white text-slate-400 hover:border-slate-200'}`}>
                                                                <Icon name={opt.icon} size={18}/>
                                                                <span className="text-[10px] font-black">{opt.label}</span>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* 動態欄位顯示區 */}
                                                <div className="p-4 bg-slate-50 rounded-xl border border-slate-100 space-y-4">
                                                    {/* 固定金額折抵 */}
                                                    {modal.data.schemeType === 'fixed' && (
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">每單折抵 ($)</label><input type="number" className="w-full input-compact font-black text-lg" value={modal.data.schemeValue || ''} onChange={e => setModal({...modal, data: {...modal.data, schemeValue: parseInt(e.target.value)}})} placeholder="10" /></div>
                                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">最低消費門檻</label><input type="number" className="w-full input-compact font-bold text-lg" value={modal.data.minSpend || 0} onChange={e => setModal({...modal, data: {...modal.data, minSpend: parseInt(e.target.value)}})} placeholder="0" /></div>
                                                        </div>
                                                    )}

                                                    {/* 百分比折扣 */}
                                                    {modal.data.schemeType === 'percent' && (
                                                        <>
                                                            <div className="grid grid-cols-2 gap-4">
                                                                <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">折扣比例 (%)</label><input type="number" className="w-full input-compact font-black text-lg" value={modal.data.schemeValue || ''} onChange={e => setModal({...modal, data: {...modal.data, schemeValue: parseInt(e.target.value)}})} placeholder="90 (九折)" /></div>
                                                                <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">最高折抵上限 ($)</label><input type="number" className="w-full input-compact font-bold text-lg" value={modal.data.maxDiscount || ''} onChange={e => setModal({...modal, data: {...modal.data, maxDiscount: parseInt(e.target.value)}})} placeholder="無上限" /></div>
                                                            </div>
                                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">最低消費門檻</label><input type="number" className="w-full input-compact font-bold" value={modal.data.minSpend || 0} onChange={e => setModal({...modal, data: {...modal.data, minSpend: parseInt(e.target.value)}})} placeholder="0" /></div>
                                                        </>
                                                    )}

                                                    {/* 滿額累折 */}
                                                    {modal.data.schemeType === 'step' && (
                                                        <>
                                                            <div className="grid grid-cols-2 gap-4">
                                                                <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">每滿額度 (門檻)</label><input type="number" className="w-full input-compact font-black text-lg" value={modal.data.minSpend || ''} onChange={e => setModal({...modal, data: {...modal.data, minSpend: parseInt(e.target.value)}})} placeholder="100" /></div>
                                                                <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">折抵金額 ($)</label><input type="number" className="w-full input-compact font-black text-lg text-rose-500" value={modal.data.schemeValue || ''} onChange={e => setModal({...modal, data: {...modal.data, schemeValue: parseInt(e.target.value)}})} placeholder="10" /></div>
                                                            </div>
                                                            <div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">單筆最高折抵上限 ($)</label><input type="number" className="w-full input-compact font-bold" value={modal.data.maxDiscount || ''} onChange={e => setModal({...modal, data: {...modal.data, maxDiscount: parseInt(e.target.value)}})} placeholder="無上限" /></div>
                                                            <div className="bg-blue-50 p-2 rounded-lg flex gap-2 items-start">
                                                                <Icon name="Info" size={14} className="text-blue-500 mt-0.5 shrink-0"/>
                                                                <p className="text-[10px] text-blue-600 font-bold leading-relaxed">
                                                                    範例：若設定「每滿 100 折 10 元」，則消費 250 元時，滿足 2 個 100 單位，系統將自動折抵 20 元。
                                                                </p>
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Footer */}
                                    <div className="p-5 bg-white border-t border-slate-100 flex justify-end gap-3 shrink-0">
                                        <button onClick={()=>setModal(null)} className="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition-colors text-sm">取消</button>
                                        <button onClick={async () => {
                                            if(!modal.data.name) return alert('請填寫機構名稱');
                                            try {
                                                const { db, appId } = window.firebase;
                                                const { doc, updateDoc, addDoc, collection } = window.firestore;
                                                const dataToSave = {
                                                    ...modal.data,
                                                    schemeValue: parseInt(modal.data.schemeValue) || 0,
                                                    minSpend: parseInt(modal.data.minSpend) || 0,
                                                    maxDiscount: parseInt(modal.data.maxDiscount) || 0,
                                                    verificationMonths: parseInt(modal.data.verificationMonths) || 12
                                                };
                                                if(modal.data.id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'organizations', modal.data.id), dataToSave);
                                                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'organizations'), dataToSave);
                                                setModal(null);
                                            } catch(e) { console.error(e); alert('儲存失敗'); }
                                        }} className="bg-[#5B2274] hover:bg-[#4a1b5e] text-white px-8 py-3 rounded-xl font-[1000] text-sm shadow-xl shadow-purple-200 transition-all active:scale-95 flex items-center gap-2">
                                            <Icon name="Save" size={18}/> 儲存設定
                                        </button>
                                    </div>
                                </div>
							) : modal.type === 'coupon' ? (
                                <div className="bg-slate-50 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl relative z-10 flex flex-col overflow-hidden animate-fade-in">
                                    {/* Header */}
                                    <div className="px-6 py-4 bg-white border-b border-slate-100 flex justify-between items-center shrink-0">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-rose-100 p-2 rounded-lg text-rose-600"><Icon name="Ticket" size={20}/></div>
                                            <div>
                                                <h3 className="text-lg font-[900] text-slate-800">優惠券設定</h3>
                                                <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Coupon Management</div>
                                            </div>
                                        </div>
                                        <button onClick={() => setModal(null)} className="w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-500 transition-colors"><Icon name="X" size={18}/></button>
                                    </div>

                                    {/* Scrollable Content */}
                                    <div className="p-6 overflow-y-auto custom-scrollbar bg-[#F8FAFC]">
                                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                                            
                                            {/* 左欄：核心資訊 (Col-5) */}
                                            <div className="lg:col-span-5 space-y-6">
                                                {/* 1. 基本券面設定 */}
                                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60 space-y-4">
                                                    <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-1"><Icon name="Tag" size={12}/> 券面資訊</h4>
                                                    
                                                    {/* 名稱 */}
                                                    <div className="space-y-1">
                                                        <label className="text-xs font-bold text-slate-700">優惠券名稱</label>
                                                        <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-rose-100 focus-within:border-rose-200 transition-all group">
                                                            <div className="pl-3 pr-2 text-slate-400 group-focus-within:text-rose-500 transition-colors flex items-center justify-center"><Icon name="Tag" size={16}/></div>
                                                            <input className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 placeholder:text-slate-400 outline-none ring-0" value={modal.data.name || ''} onChange={e => setModal({...modal, data: {...modal.data, name: e.target.value}})} placeholder="例如: 開幕慶88折" />
                                                        </div>
                                                    </div>

                                                    {/* 代碼 */}
                                                    <div className="space-y-1">
                                                        <label className="text-xs font-bold text-slate-700">優惠代碼 (Code)</label>
                                                        <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-rose-100 focus-within:border-rose-200 transition-all group">
                                                            <div className="pl-3 pr-2 text-rose-300 group-focus-within:text-rose-500 transition-colors flex items-center justify-center"><Icon name="Hash" size={16}/></div>
                                                            <input type="text" className="w-full bg-transparent border-none p-3 text-sm font-[1000] text-rose-600 placeholder:text-rose-200 uppercase tracking-widest outline-none ring-0" value={modal.data.code || ''} onChange={e => setModal({...modal, data: {...modal.data, code: e.target.value.toUpperCase()}})} placeholder="OPEN88" />
                                                        </div>
                                                    </div>

                                                    <div className="grid grid-cols-2 gap-3">
                                                        {/* 類型 (修正：補上 Step Discount 選項) */}
                                                        <div className="space-y-1">
                                                            <label className="text-xs font-bold text-slate-700">折扣類型</label>
                                                            <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-slate-100 focus-within:border-slate-300 transition-all">
                                                                <select className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 outline-none ring-0 appearance-none" value={modal.data.type || 'fixed'} onChange={e => setModal({...modal, data: {...modal.data, type: e.target.value}})}>
                                                                    <option value="fixed">金額折抵 ($)</option>
                                                                    <option value="percent">百分比 (%)</option>
                                                                    <option value="step">滿額累折 (Step)</option>
                                                                </select>
                                                                <div className="pr-3 text-slate-400 pointer-events-none"><Icon name="ChevronDown" size={14}/></div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* 數值 (動態標題) */}
                                                        <div className="space-y-1">
                                                            <label className="text-xs font-bold text-slate-700">
                                                                {modal.data.type === 'percent' ? '折扣比例 (%)' : '折抵金額 ($)'}
                                                            </label>
                                                            <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-rose-100 focus-within:border-rose-200 transition-all group">
                                                                <div className="pl-3 pr-1 text-slate-400 group-focus-within:text-rose-500 transition-colors"><Icon name="Zap" size={14}/></div>
                                                                <input type="number" className="w-full bg-transparent border-none p-3 text-sm font-[1000] text-slate-800 placeholder:text-slate-300 outline-none ring-0" value={modal.data.value || ''} onChange={e => setModal({...modal, data: {...modal.data, value: parseInt(e.target.value)}})} placeholder={modal.data.type==='percent'?'90 (九折)':'20 (折20元)'} />
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div className="pt-2 border-t border-slate-100 flex items-center justify-between">
                                                        <span className="text-xs font-bold text-slate-600">啟用狀態</span>
                                                        <ToggleSwitch checked={modal.data.active !== false} onChange={c => setModal({...modal, data: {...modal.data, active: c}})} />
                                                    </div>
                                                </div>

                                                {/* 2. 財務條件 (修正：單一低消欄位 + 條件式上限) */}
                                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60 space-y-4">
                                                    <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-1"><Icon name="BadgeDollarSign" size={12}/> 訂單條件</h4>
                                                    
                                                    {/* [Fix] 統一的最低消費/累折門檻欄位 (只顯示一次) */}
                                                    <div className="space-y-1">
                                                        <label className="text-xs font-bold text-slate-700">
                                                            {modal.data.type === 'step' ? '每滿額度 (累折門檻)' : '最低消費門檻 (低消)'}
                                                        </label>
                                                        <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-200 transition-all group">
                                                            <div className="pl-4 pr-1 py-3 bg-slate-100/50 border-r border-slate-100 text-slate-400 font-black text-xs group-focus-within:text-blue-500 group-focus-within:bg-blue-50/30 transition-colors">$</div>
                                                            <input type="number" className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 placeholder:text-slate-300 outline-none ring-0" value={modal.data.minSpend || 0} onChange={e => setModal({...modal, data: {...modal.data, minSpend: parseInt(e.target.value)||0}})} placeholder="0 = 無限制" />
                                                        </div>
                                                        {modal.data.type === 'step' && <p className="text-[10px] text-rose-500 font-bold mt-1 flex items-center gap-1"><Icon name="Info" size={10}/> 設定 100 則代表每滿 100 元折抵一次</p>}
                                                    </div>

                                                    {/* [Fix] 最高折抵上限 (僅在百分比或累折時出現) */}
                                                    {(modal.data.type === 'percent' || modal.data.type === 'step') && (
                                                        <div className="space-y-1 animate-fade-in">
                                                            <label className="text-xs font-bold text-slate-700">最高折抵上限</label>
                                                            <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-200 transition-all group">
                                                                <div className="pl-4 pr-1 py-3 bg-slate-100/50 border-r border-slate-100 text-slate-400 font-black text-xs group-focus-within:text-blue-500 group-focus-within:bg-blue-50/30 transition-colors">$</div>
                                                                <input type="number" className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 placeholder:text-slate-300 outline-none ring-0" value={modal.data.maxDiscount || ''} onChange={e => setModal({...modal, data: {...modal.data, maxDiscount: parseInt(e.target.value)}})} placeholder="無上限" />
                                                            </div>
                                                        </div>
                                                    )}

                                                    <div className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                                                        <div className="text-xs font-bold text-slate-600">允許與其他優惠併用</div>
                                                        <ToggleSwitch checked={modal.data.stackable || false} onChange={c => setModal({...modal, data: {...modal.data, stackable: c}})} />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* 右欄：進階設定 (保持不變) */}
                                            <div className="lg:col-span-7 space-y-6">
                                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/60">
                                                    <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-1"><Icon name="Users" size={12}/> 對象與場景設定</h4>
                                                    
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                        {/* 會員身分限制 */}
                                                        <div className="space-y-3">
                                                            <label className="text-xs font-bold text-slate-700 block">會員身分限定</label>
                                                            <div className="space-y-2">
                                                                {[
                                                                    {val: 'all', label: '所有顧客 (無限制)'},
                                                                    {val: 'member_only', label: '僅限註冊會員'},
                                                                    {val: 'first_purchase', label: '首購限定 (需登入會員)'},
                                                                    {val: 'staff', label: '特約/員工限定'}
                                                                ].map(opt => (
                                                                    <label key={opt.val} className={`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition-all ${modal.data.targetAudience === opt.val ? 'bg-rose-50 border-rose-200 ring-1 ring-rose-200' : 'bg-slate-50 border-slate-100 hover:bg-white'}`}>
                                                                        <input type="radio" name="targetAudience" className="accent-rose-500 w-4 h-4" checked={(modal.data.targetAudience || 'all') === opt.val} onChange={()=>setModal({...modal, data:{...modal.data, targetAudience: opt.val}})} />
                                                                        <span className="text-xs font-bold text-slate-700">{opt.label}</span>
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        </div>

                                                        {/* 訂單類型限制 */}
                                                        <div className="space-y-3">
                                                            <label className="text-xs font-bold text-slate-700 block">適用訂單類型</label>
                                                            <div className="space-y-2">
                                                                {['dinein:內用', 'takeout:外帶自取', 'delivery:外送'].map(type => {
                                                                    const [val, label] = type.split(':');
                                                                    const currentTypes = modal.data.limitOrderTypes || ['dinein', 'takeout', 'delivery'];
                                                                    const isChecked = currentTypes.includes(val);
                                                                    return (
                                                                        <label key={val} className={`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition-all ${isChecked ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100'}`}>
                                                                            <input type="checkbox" className="accent-blue-500 w-4 h-4" checked={isChecked} onChange={(e)=>{
                                                                                const newTypes = e.target.checked ? [...currentTypes, val] : currentTypes.filter(t=>t!==val);
                                                                                setModal({...modal, data:{...modal.data, limitOrderTypes: newTypes}});
                                                                            }} />
                                                                            <span className="text-xs font-bold text-slate-700">{label}</span>
                                                                        </label>
                                                                    );
                                                                })}
                                                                <div className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                                                                    <div className="text-xs font-bold text-slate-600">允許用於預約單</div>
                                                                    <ToggleSwitch checked={modal.data.allowPreorder !== false} onChange={c => setModal({...modal, data: {...modal.data, allowPreorder: c}})} />
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* 品項分類限制 */}
                                                    <div className="mt-6 pt-6 border-t border-slate-100">
                                                        <label className="text-xs font-bold text-slate-700 block mb-3">限定品項分類 (未勾選則代表全品項適用)</label>
                                                        <div className="flex flex-wrap gap-2">
                                                            {categories.map(cat => {
                                                                const limitCats = modal.data.limitCategories || [];
                                                                const active = limitCats.includes(cat.id);
                                                                return (
                                                                    <button key={cat.id} 
                                                                        onClick={() => {
                                                                            const newCats = active ? limitCats.filter(c=>c!==cat.id) : [...limitCats, cat.id];
                                                                            setModal({...modal, data:{...modal.data, limitCategories: newCats}});
                                                                        }}
                                                                        className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${active ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200 hover:border-slate-300'}`}>
                                                                        {cat.name}
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* 4. 時間與效期 */}
                                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/60">
                                                    <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-1"><Icon name="Clock" size={12}/> 效期與限制</h4>
                                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                                        <div className="space-y-1">
                                                            <label className="text-xs font-bold text-slate-700">生效日期</label>
                                                            <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-slate-100 focus-within:border-slate-300 transition-all group">
                                                                <div className="pl-3 pr-2 text-slate-400 group-focus-within:text-slate-600 transition-colors"><Icon name="Calendar" size={14}/></div>
                                                                <input type="date" className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 outline-none ring-0" value={modal.data.startDate || ''} onChange={e => setModal({...modal, data: {...modal.data, startDate: e.target.value}})} />
                                                            </div>
                                                        </div>
                                                        <div className="space-y-1">
                                                            <label className="text-xs font-bold text-slate-700">截止日期</label>
                                                            <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-slate-100 focus-within:border-slate-300 transition-all group">
                                                                <div className="pl-3 pr-2 text-slate-400 group-focus-within:text-slate-600 transition-colors"><Icon name="Calendar" size={14}/></div>
                                                                <input type="date" className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 outline-none ring-0" value={modal.data.endDate || ''} onChange={e => setModal({...modal, data: {...modal.data, endDate: e.target.value}})} />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="space-y-3 pt-4 border-t border-slate-100">
                                                        <div className="flex justify-between items-center">
                                                            <label className="text-xs font-bold text-slate-700">特殊時段限定 (Happy Hour)</label>
                                                            <span className="text-[10px] text-slate-400">留空則全時段適用</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-slate-100 focus-within:border-slate-300 transition-all group flex-1">
                                                                <div className="pl-3 pr-2 text-slate-400 group-focus-within:text-slate-600 transition-colors"><Icon name="Clock" size={14}/></div>
                                                                <input type="time" className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 outline-none ring-0" value={modal.data.validStartTime || ''} onChange={e => setModal({...modal, data: {...modal.data, validStartTime: e.target.value}})} />
                                                            </div>
                                                            <span className="text-slate-300 font-bold">~</span>
                                                            <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-slate-100 focus-within:border-slate-300 transition-all group flex-1">
                                                                <div className="pl-3 pr-2 text-slate-400 group-focus-within:text-slate-600 transition-colors"><Icon name="Clock" size={14}/></div>
                                                                <input type="time" className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 outline-none ring-0" value={modal.data.validEndTime || ''} onChange={e => setModal({...modal, data: {...modal.data, validEndTime: e.target.value}})} />
                                                            </div>
                                                        </div>
                                                        <div className="flex flex-wrap gap-2 mt-2">
                                                            {['週一','週二','週三','週四','週五','週六','週日'].map((day, idx) => {
                                                                const validDays = modal.data.validDays || [0,1,2,3,4,5,6];
                                                                const dayIdx = idx + 1;
                                                                const active = validDays.includes(dayIdx);
                                                                return (
                                                                    <button key={day} 
                                                                        onClick={()=>{
                                                                            const newDays = active ? validDays.filter(d=>d!==dayIdx) : [...validDays, dayIdx];
                                                                            setModal({...modal, data:{...modal.data, validDays: newDays}});
                                                                        }}
                                                                        className={`w-10 h-8 rounded-lg text-[10px] font-black border transition-all ${active ? 'bg-orange-100 text-orange-600 border-orange-200' : 'bg-slate-50 text-slate-400 border-slate-100'}`}>
                                                                        {day}
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>

                                                    <div className="mt-4 pt-4 border-t border-slate-100 space-y-1">
                                                        <label className="text-xs font-bold text-slate-700">總使用次數上限 (全體)</label>
                                                        <div className="flex items-center bg-slate-50 border border-slate-200 rounded-xl overflow-hidden focus-within:bg-white focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-200 transition-all group">
                                                            <div className="pl-3 pr-2 text-slate-400 group-focus-within:text-blue-500 transition-colors flex items-center justify-center"><Icon name="Hash" size={14}/></div>
                                                            <input type="number" className="w-full bg-transparent border-none p-3 text-sm font-bold text-slate-700 placeholder:text-slate-300 outline-none ring-0" value={modal.data.usageLimit || ''} onChange={e => setModal({...modal, data: {...modal.data, usageLimit: parseInt(e.target.value)}})} placeholder="0 = 無限制" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Footer */}
                                    <div className="p-4 bg-white border-t border-slate-100 flex justify-end gap-3 shrink-0">
                                        <Button variant="secondary" onClick={() => setModal(null)}>取消</Button>
                                        <Button onClick={async () => {
                                            if(!modal.data.name || !modal.data.code) return alert('請填寫名稱與代碼');
                                            try {
                                                const dataToSave = { ...modal.data };
                                                if(modal.data.id) await dbOp('update', 'coupons', modal.data.id, dataToSave);
                                                else await dbOp('add', 'coupons', null, dataToSave);
                                                setModal(null);
                                            } catch (err) { alert("儲存失敗"); }
                                        }}>儲存優惠券</Button>
                                    </div>
                                </div>
                            ) : modal.type === 'distribute_coupon' ? (
                                <div className="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl relative z-10 flex flex-col overflow-hidden animate-scale-in p-8">
                                    <div className="text-center mb-6">
                                        <div className="w-16 h-16 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm">
                                            <Icon name="Send" size={32} className="-ml-1 mt-1"/>
                                        </div>
                                        <h3 className="text-xl font-[1000] text-slate-800">派發優惠券</h3>
                                        <p className="text-sm font-bold text-slate-400 mt-1">您即將發送「{modal.data.name}」</p>
                                    </div>
                                    
                                    <div className="space-y-4 max-h-[50vh] overflow-y-auto no-scrollbar pr-1">
                                        <div className="space-y-2">
                                            <button onClick={() => handleBulkDistribute(modal.data, 'all')} className="w-full py-4 bg-slate-50 hover:bg-[#5B2274] hover:text-white rounded-2xl border border-slate-200 text-slate-700 font-[900] transition-all flex items-center justify-between px-6 group active:scale-95">
                                                <span className="text-sm">全體會員</span>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xl font-[1000]">{members.length}</span>
                                                    <Icon name="Users" size={18} className="text-slate-300 group-hover:text-white/80"/>
                                                </div>
                                            </button>

                                            <button onClick={() => handleBulkDistribute(modal.data, 'affiliate')} className="w-full py-4 bg-slate-50 hover:bg-orange-500 hover:text-white rounded-2xl border border-slate-200 text-slate-700 font-[900] transition-all flex items-center justify-between px-6 group active:scale-95">
                                                <span className="text-sm">所有特約人員</span>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xl font-[1000]">{members.filter(m => m.role === 'affiliate').length}</span>
                                                    <Icon name="Briefcase" size={18} className="text-slate-300 group-hover:text-white/80"/>
                                                </div>
                                            </button>
                                        </div>

                                        <div className="space-y-2 pt-2 border-t border-slate-100">
                                            <div className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] px-2 mb-2">指定特約機構</div>
                                            {organizations.length > 0 ? organizations.map(org => {
                                                const orgTargets = members.filter(m => m.orgId === org.id);
                                                return (
                                                    <button 
                                                        key={org.id}
                                                        onClick={async () => {
                                                            if(orgTargets.length === 0) return alert("該機構目前沒有會員");
                                                            if(confirm(`確定派發給「${org.name}」的 ${orgTargets.length} 位成員嗎？`)) {
                                                                await handleCustomDistribute(modal.data, orgTargets);
                                                            }
                                                        }}
                                                        className="w-full py-4 bg-slate-50 hover:bg-blue-600 hover:text-white rounded-2xl border border-slate-200 text-slate-700 font-[900] transition-all flex items-center justify-between px-6 group active:scale-95"
                                                    >
                                                        <span className="text-sm">{org.name}</span>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xl font-[1000]">{orgTargets.length}</span>
                                                            <Icon name="Building2" size={18} className="text-slate-300 group-hover:text-white/80"/>
                                                        </div>
                                                    </button>
                                                );
                                            }) : (
                                                <p className="text-center text-xs text-slate-300 py-4 italic">尚未建立任何特約機構</p>
                                            )}
                                        </div>
                                    </div>
                                    <button onClick={()=>setModal(null)} className="mt-6 w-full py-3 text-slate-300 font-black text-xs hover:text-slate-500 transition-colors">取消操作</button>
                                </div>
                            
                            /* [Fix] 會員詳情 Modal - 修正 Hook 錯誤 & 樣式獨立化 */
                            ) : modal.type === 'member_detail' ? (
                                <div className="bg-slate-50 w-full max-w-2xl mt-auto rounded-t-[2.5rem] shadow-[0_-20px_60px_-15px_rgba(0,0,0,0.3)] relative z-10 flex flex-col overflow-hidden animate-slide-up" style={{height: '92vh'}}>
                                    {(() => {
                                        const m = modal.data;
                                        // 1. 整理訂單數據
                                        const allOrders = orders.filter(o => o.customerUid === m.id).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                                        
                                        // 2. 篩選歷史訂單
                                        const filteredHistory = allOrders.filter(o => {
                                            if(memberHistoryFilter !== 'all' && o.status !== memberHistoryFilter) return false;
                                            if(memberHistorySearch) {
                                                const q = memberHistorySearch.toLowerCase();
                                                const dateStr = formatDate(o.createdAt);
                                                return (o.orderId||'').toLowerCase().includes(q) || dateStr.includes(q);
                                            }
                                            return true;
                                        });

                                        // 3. 分頁邏輯
                                        const historyTotalPages = Math.ceil(filteredHistory.length / memberHistoryRows);
                                        const paginatedHistory = filteredHistory.slice((memberHistoryPage - 1) * memberHistoryRows, memberHistoryPage * memberHistoryRows);

                                        // 4. 計算關鍵指標
                                        const totalSpent = allOrders.filter(o => o.status === 'completed').reduce((sum, o) => sum + (o.totalPrice || 0), 0);
                                        const visitCount = allOrders.filter(o => o.status === 'completed').length;
                                        const lastVisit = allOrders[0] ? formatDate(allOrders[0].createdAt).split(' ')[0] : '-';

                                        const isLinked = !!(m.lineDisplayName || m.displayName || m.pictureUrl || m.lineUserId); 
                                        const lineName = m.lineDisplayName || m.displayName || (isLinked ? '已連結' : '未綁定');
                                        const primaryName = m.savedName || m.realName || m.lineDisplayName || m.displayName || '顧客';

                                        // [Fix] 時間格式化輔助函式 (YYYY/MM/DD HH:MM)
                                        const formatFullDateTime = (dateInput) => {
                                            if(!dateInput) return '-';
                                            const d = new Date(dateInput);
                                            const p = (n) => n.toString().padStart(2, '0');
                                            return `${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
                                        };

                                        return (
                                            <div className="flex flex-col h-full bg-[#F8FAFC]">
                                                {/* Header區塊 */}
                                                <div className="px-8 pt-10 pb-2 bg-white shrink-0 border-b border-slate-100 shadow-sm z-20">
                                                    <div className="flex justify-between items-start mb-6">
                                                        <div className="flex flex-col w-full gap-2">
                                                            <div className="flex flex-wrap items-baseline gap-x-4 gap-y-2">
                                                                <div className="flex items-center gap-2">
                                                                    <h2 className="text-3xl font-[1000] text-slate-800 tracking-tight leading-none">{primaryName}</h2>
                                                                    {totalSpent > 5000 && <span className="bg-amber-100 text-amber-600 px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wider border border-amber-200">VIP</span>}
                                                                </div>
                                                                <div className="flex items-center gap-3">
                                                                    <div className="flex items-center gap-1.5 text-xs font-bold text-slate-500 font-mono bg-slate-50 px-2 py-1 rounded border border-slate-100">
                                                                        <Icon name="Phone" size={12} className="text-slate-400"/>
                                                                        <span>{m.phone || '無電話'}</span>
                                                                    </div>
                                                                    <div className={`flex items-center gap-1.5 text-xs font-bold px-2 py-1 rounded border ${isLinked ? 'bg-green-50 text-[#06C755] border-green-100' : 'bg-slate-50 text-slate-300 border-slate-100'}`}>
                                                                        <Icon name="MessageCircle" size={12} className={isLinked ? 'fill-current' : ''}/>
                                                                        <span>{lineName}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {/* [Fix 2] 修正關閉按鈕：改用 handlePopModal 支援返回上一頁 */}
                                                        <button onClick={handlePopModal} className="w-9 h-9 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-400 transition-colors shrink-0"><Icon name="X" size={20}/></button>
                                                    </div>

                                                    <div className="grid grid-cols-3 gap-4 py-4 border-t border-slate-100">
                                                        <div className="text-center border-r border-slate-100"><div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">消費次數</div><div className="text-xl font-[1000] text-slate-700">{visitCount}</div></div>
                                                        <div className="text-center border-r border-slate-100"><div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">累積金額</div><div className="text-xl font-[1000] text-[#5B2274]">${totalSpent.toLocaleString()}</div></div>
                                                        <div className="text-center"><div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-0.5">最近來店</div><div className="text-base font-[1000] text-slate-600">{lastVisit}</div></div>
                                                    </div>

                                                    <div className="flex justify-center gap-8 mt-2">
                                                        {[{id: 'overview', label: '顧客備註', icon: 'StickyNote'}, {id: 'history', label: `消費紀錄 (${allOrders.length})`, icon: 'History'}, {id: 'coupons', label: `優惠券 (${m.coupons?.length||0})`, icon: 'Ticket'}].map(t => (
                                                            <button key={t.id} onClick={()=>setMemberInternalTab(t.id)} className={`pb-3 text-sm font-[900] flex items-center gap-2 border-b-[3px] transition-all ${memberInternalTab===t.id ? 'border-[#5B2274] text-[#5B2274]' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                                                                <Icon name={t.icon} size={16}/> {t.label}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div className="flex-1 overflow-y-auto px-6 py-6 no-scrollbar bg-[#F8FAFC]">
                                                    {/* 分頁 1: 顧客資料 (特約 + 備註) */}
                                                    {memberInternalTab === 'overview' && (
                                                        <div className="space-y-6 animate-fade-in">
                                                            {/* 特約機構設定區塊 */}
                                                            <div className="bg-blue-50/50 border border-blue-100 rounded-2xl p-5 space-y-4">
                                                                <div className="flex items-center gap-2 text-blue-700">
                                                                    <Icon name="Building2" size={18}/>
                                                                    <span className="font-[900] text-sm uppercase tracking-wider">特約身分設定</span>
                                                                </div>
                                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                                    <div className="space-y-1">
                                                                        <label className="text-[10px] font-black text-slate-400 uppercase">所屬特約機構</label>
                                                                        <select 
                                                                            className="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm font-bold text-slate-700 outline-none shadow-sm"
                                                                            value={m.orgId || ''}
                                                                            onChange={async (e) => {
                                                                                const orgId = e.target.value;
                                                                                const org = organizations.find(o => o.id === orgId);
                                                                                let updateData = { orgId: orgId };
                                                                                if (org) {
                                                                                    // 計算到期日：N 個月後的月底
                                                                                    const exp = new Date();
                                                                                    exp.setMonth(exp.getMonth() + (parseInt(org.verificationMonths) || 12) + 1);
                                                                                    exp.setDate(0); 
                                                                                    updateData.affiliateExpiry = exp.toISOString().split('T')[0];
                                                                                    updateData.role = 'affiliate';
                                                                                } else {
                                                                                    updateData.affiliateExpiry = null;
                                                                                    updateData.role = 'member';
                                                                                }
                                                                                await dbOp('update', 'users', m.id, updateData);
                                                                                setModal({ ...modal, data: { ...m, ...updateData } });
                                                                            }}
                                                                        >
                                                                            <option value="">無特約 / 一般會員</option>
                                                                            {organizations.map(org => <option key={org.id} value={org.id}>{org.name}</option>)}
                                                                        </select>
                                                                    </div>
                                                                    <div className="bg-white/60 border border-slate-200 rounded-xl p-3 flex flex-col justify-center">
                                                                        <span className="text-[10px] font-black text-slate-400 uppercase">資格到期日期</span>
                                                                        <span className={`text-sm font-bold ${m.affiliateExpiry ? 'text-blue-600' : 'text-slate-300 italic'}`}>{m.affiliateExpiry || '尚未驗證身分'}</span>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* 黃色備註區 */}
                                                            <div className="bg-[#FEFCE8] border border-yellow-100 rounded-2xl p-5 shadow-sm relative flex flex-col min-h-[200px]">
                                                                <div className="flex justify-between items-center mb-3">
                                                                    <div className="flex items-center gap-2 text-yellow-600/60 pointer-events-none"><Icon name="Star" size={14} className="fill-yellow-400 text-yellow-400"/><span className="text-xs font-black uppercase tracking-wider">永久備註事項</span></div>
                                                                    <button onClick={handleSaveMemberNote} disabled={isMemberSaving} className="bg-yellow-400 text-white px-4 py-1.5 rounded-lg font-bold text-xs shadow-md active:scale-95 transition-all flex items-center gap-1.5">{isMemberSaving ? <Icon name="Loader2" size={14} className="animate-spin"/> : <Icon name="Save" size={14}/>} 儲存</button>
                                                                </div>
                                                                <textarea className="w-full flex-1 bg-transparent border-none p-0 text-slate-700 font-bold text-base resize-none focus:ring-0 outline-none leading-relaxed" placeholder="在此輸入關於此客人的永久備註..." value={memberNote} onChange={(e)=>setMemberNote(e.target.value)}></textarea>
                                                            </div>
                                                        </div>
                                                    )}

                                                    {memberInternalTab === 'history' && (
                                                        <div className="space-y-4 animate-fade-in">
                                                            {/* Filter & Pagination */}
                                                            <div className="flex flex-col gap-3 mb-2 sticky top-0 bg-[#F8FAFC] z-10 pb-2">
                                                                <div className="flex gap-2">
                                                                    <div className="relative flex-1">
                                                                        <Icon name="Search" size={16} className="absolute left-3 top-2.5 text-slate-400"/>
                                                                        <input className="w-full bg-white border border-slate-200 rounded-xl pl-9 pr-3 py-2 text-sm font-bold text-slate-700 outline-none focus:border-[#5B2274] shadow-sm" placeholder="搜尋單號..." value={memberHistorySearch} onChange={e=>{setMemberHistorySearch(e.target.value); setMemberHistoryPage(1);}} />
                                                                    </div>
                                                                    <select className="bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm font-bold text-slate-600 outline-none shadow-sm" value={memberHistoryFilter} onChange={e=>{setMemberHistoryFilter(e.target.value); setMemberHistoryPage(1);}}>
                                                                        <option value="all">全部</option>
                                                                        <option value="completed">完成</option>
                                                                        <option value="cancelled">取消</option>
                                                                    </select>
                                                                </div>
                                                                
                                                                <div className="flex items-center justify-between bg-white px-3 py-2 rounded-xl border border-slate-100 shadow-sm">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-[10px] font-bold text-slate-400">每頁</span>
                                                                        <select className="bg-slate-50 border-none rounded-lg text-xs font-black text-slate-700 py-1" value={memberHistoryRows} onChange={e=>{setMemberHistoryRows(Number(e.target.value)); setMemberHistoryPage(1);}}>
                                                                            <option value={5}>5 筆</option>
                                                                            <option value={10}>10 筆</option>
                                                                            <option value={20}>20 筆</option>
                                                                        </select>
                                                                    </div>
                                                                    <div className="flex gap-2">
                                                                        <button disabled={memberHistoryPage===1} onClick={()=>setMemberHistoryPage(p=>p-1)} className="p-1 rounded-lg hover:bg-slate-50 disabled:opacity-30 text-slate-500"><Icon name="ChevronLeft" size={16}/></button>
                                                                        <span className="text-xs font-black text-slate-600 self-center">{memberHistoryPage} / {historyTotalPages||1}</span>
                                                                        <button disabled={memberHistoryPage>=historyTotalPages} onClick={()=>setMemberHistoryPage(p=>p+1)} className="p-1 rounded-lg hover:bg-slate-50 disabled:opacity-30 text-slate-500"><Icon name="ChevronRight" size={16}/></button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* List */}
                                                            <div className="space-y-3">
                                                                {paginatedHistory.map(o => {
                                                                    const typeCfg = ORDER_TYPES[o.orderType || 'takeout'] || ORDER_TYPES['takeout'];
                                                                    const st = STATUS_STYLE[o.status] || STATUS_STYLE.pending;
                                                                    
                                                                    // [Fix] 格式化時間 (YYYY/MM/DD HH:MM)
                                                                    const orderTimeStr = formatFullDateTime(o.createdAt);
                                                                    const pickupTimeStr = o.userInfo?.pickupDate 
                                                                        ? `${o.userInfo.pickupDate.replace(/-/g, '/')} ${o.userInfo.pickupTime}` 
                                                                        : '-';

                                                                    return (
                                                                        <div key={o.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4 group cursor-pointer hover:border-purple-300 transition-all" 
                                                                            onClick={() => handlePushModal({ type: 'edit_order', data: o })}
                                                                        >
                                                                            {/* 左側狀態圖示 */}
                                                                            <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${st.bg} shrink-0`}>
                                                                                <Icon name={st.icon || 'FileText'} size={20} className={st.text}/>
                                                                            </div>

                                                                            <div className="flex-1 min-w-0">
                                                                                {/* Line 1: 下單時間 */}
                                                                                <div className="flex items-center gap-2 text-xs font-bold text-slate-500">
                                                                                    <span className="text-slate-400 w-20 text-right shrink-0">下單時間：</span>
                                                                                    <span className="font-mono text-slate-700">{orderTimeStr}</span>
                                                                                </div>
                                                                                
                                                                                {/* Line 2: 取餐時間 */}
                                                                                <div className="flex items-center gap-2 text-xs font-bold text-slate-500 mt-0.5">
                                                                                    <span className="text-slate-400 w-20 text-right shrink-0">
                                                                                        {o.orderType === 'delivery' ? '外送時間：' : '取餐時間：'}
                                                                                    </span>
                                                                                    <span className={`font-mono ${o.userInfo?.pickupTime==='ASAP'?'text-red-500':'text-[#5B2274]'}`}>
                                                                                        {pickupTimeStr}
                                                                                    </span>
                                                                                </div>
                                                                                
                                                                                {/* Line 3: 訂單資訊 - [Fix] 訂單編號對齊標題欄位，標籤對齊數值欄位 */}
                                                                                <div className="flex items-center gap-2 mt-1.5">
                                                                                    <div className="w-20 shrink-0 flex justify-end overflow-hidden">
                                                                                        <span className="text-[10px] font-black text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 truncate max-w-full">
                                                                                            {o.orderId}
                                                                                        </span>
                                                                                    </div>
                                                                                    <div className="flex items-center gap-1.5">
                                                                                        <span className={`text-[10px] px-1.5 py-0.5 rounded font-black border ${typeCfg.bg} ${typeCfg.text} ${typeCfg.border}`}>{typeCfg.label}</span>
                                                                                        <span className={`text-[10px] px-1.5 py-0.5 rounded font-black ${st.bg} ${st.text}`}>{st.label}</span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>

                                                                            {/* 右側金額 */}
                                                                            <div className="text-right shrink-0">
                                                                                <div className={`text-xl font-[1000] ${o.status==='cancelled'?'text-slate-300 line-through':'text-slate-800'}`}>${o.totalPrice}</div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                                {paginatedHistory.length === 0 && <div className="text-center py-10 text-slate-400 font-bold text-xs border-2 border-dashed border-slate-200 rounded-xl">查無符合的訂單紀錄</div>}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {memberInternalTab === 'coupons' && (
                                                        <div className="space-y-6 animate-fade-in">
                                                            <div className="flex gap-2 bg-white p-3 rounded-2xl shadow-sm border border-slate-200">
                                                                <div className="relative flex-1">
                                                                    <select id="directCouponSelect" className="w-full bg-slate-50 border-none rounded-xl px-4 py-2.5 text-sm font-bold text-slate-600 outline-none focus:ring-2 focus:ring-purple-100 appearance-none">
                                                                        <option value="">選擇要發送的優惠券...</option>
                                                                        {coupons.filter(c => c.active !== false).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                                                    </select>
                                                                    <Icon name="ChevronDown" size={16} className="absolute right-3 top-3 text-slate-400 pointer-events-none"/>
                                                                </div>
                                                                <button onClick={async () => {
                                                                    const cId = document.getElementById('directCouponSelect').value;
                                                                    if(!cId) return;
                                                                    
                                                                    const coupon = coupons.find(c => c.id === cId);
                                                                    if(!confirm(`確定發送「${coupon.name}」？`)) return;
                                                                    
                                                                    try {
                                                                        // [Fix] 關鍵：從 window.firestore 解構出需要的函式
                                                                        const { doc, updateDoc } = window.firestore;
                                                                        const { db, appId } = window.firebase;
                                                                        
                                                                        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', m.id);
                                                                        const newCoupon = { 
                                                                            ...coupon, 
                                                                            issuedAt: new Date().toISOString(), 
                                                                            used: false, 
                                                                            uniqueId: Date.now() + Math.random().toString(36).substr(2, 9) 
                                                                        };
                                                                        
                                                                        const currentCoupons = m.coupons || [];
                                                                        await updateDoc(userRef, { coupons: [...currentCoupons, newCoupon] });
                                                                        
                                                                        // 更新本地狀態顯示
                                                                        setModal({...modal, data: {...m, coupons: [...currentCoupons, newCoupon]}}); 
                                                                        alert('✅ 發送成功！');
                                                                    } catch(e) { 
                                                                        console.error(e);
                                                                        alert('發送失敗: ' + e.message); 
                                                                    }
                                                                }} className="bg-[#5B2274] hover:bg-[#4a1b5e] text-white px-5 rounded-xl font-bold text-sm shadow-md active:scale-95 transition-all">發送</button>
                                                            </div>
                                                            <div className="space-y-3">
                                                                {(m.coupons||[]).map((c, i) => (
                                                                    <div key={i} className={`p-4 rounded-2xl flex justify-between items-center border shadow-sm ${c.used ? 'bg-slate-50 border-slate-200 opacity-60' : 'bg-white border-slate-200'}`}>
                                                                        <div className="flex items-center gap-4">
                                                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${c.used ? 'bg-slate-200 text-slate-400' : 'bg-rose-100 text-rose-500'}`}><Icon name="Ticket" size={18}/></div>
                                                                            <div><div className="font-[900] text-slate-800 text-sm">{c.name}</div><div className="text-[10px] font-bold text-slate-400 font-mono mt-0.5">{c.code}</div></div>
                                                                        </div>
                                                                        <div className="text-xs font-black text-slate-400">{c.used ? '已使用' : '未使用'}</div>
                                                                    </div>
                                                                ))}
                                                                {(!m.coupons || m.coupons.length === 0) && <div className="text-center py-10 text-slate-300 text-xs font-bold border-2 border-dashed border-slate-200 rounded-xl">無優惠券</div>}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            ) : modal.type === 'edit_cart' ? (
                                <EditCartDrawer 
                                    order={modal.data} 
                                    products={products}
                                    categories={categories}
                                    sets={sets}          // [New] 傳入套餐資料
                                    addons={addons}      // [New] 傳入客製化選項資料
                                    settings={settings}  // [New] 傳入設定(用於判斷選項群組限制)
                                    onClose={() => setModal({ type: 'edit_order', data: modal.data })}
                                    onSave={async (updatedOrder) => {
                                        try {
                                            const { db, appId } = window.firebase;
                                            const { doc, updateDoc } = window.firestore;
                                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', updatedOrder.id), updatedOrder);
                                            setModal({ type: 'edit_order', data: updatedOrder });
                                            alert('✅ 訂單變更已儲存！');
                                        } catch(e) {
                                            console.error(e);
                                            alert('儲存失敗：' + e.message);
                                        }
                                    }}
                                />
							) : (
								
								/* 原本的其他 Modal (如產品、標籤、營運設定) 仍維持中間白色框框 */
								<div className="bg-white w-full max-w-xl max-h-[90vh] rounded-2xl shadow-2xl relative z-10 flex flex-col overflow-hidden animate-fade-in">
									{/* ... Modal Header ... */}
									<div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white"><h3 className="text-lg font-[900] text-slate-800">{modal.type === 'cat' ? '分類設定' : (modal.type === 'prod' ? '餐點詳情' : (modal.type === 'tags' ? '商品標籤設定' : (modal.type === 'group_mgmt' ? '組別管理' : (modal.type === 'item_editor' ? '項目編輯' : (modal.type === 'set' ? '套餐配置' : (modal.type === 'coupon' ? '優惠券設定' : '設定'))))))}</h3><button onClick={() => setModal(null)} className="w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-500"><Icon name="X" size={18}/></button></div>
									<div className="p-6 overflow-y-auto no-scrollbar space-y-6 bg-slate-50/50">
										{/* ... Modal Contents ... */}
										{modal.type === 'group_mgmt' && (
											<div className="space-y-4">
												<div className="p-4 bg-blue-50 text-blue-800 rounded-xl text-xs lg:text-sm font-medium flex items-start gap-2 border border-blue-100">
													<Icon name="Info" size={18} className="mt-0.5 shrink-0"/>
													<p>在此管理組別。您可以排序、重新命名或刪除組別。修改名稱時，該組別下的所有項目會自動更新。</p>
												</div>
												<div className="space-y-2">
													<div className="flex gap-2 pb-2 border-b border-slate-200">
														<input id="newGroupName" className="input-compact flex-1" placeholder="新增組別名稱..." />
														<Button size="small" onClick={()=>{
															const name = document.getElementById('newGroupName').value;
															if(name) {
																const groups = getGroups(modal.dataType);
																saveGroups(modal.dataType, [...groups, { id: Date.now(), name, sortOrder: groups.length }]);
																document.getElementById('newGroupName').value = '';
															}
														}}>新增</Button>
													</div>
													<div className="space-y-2 max-h-[60vh] overflow-y-auto">
														{getGroups(modal.dataType).map((g, idx) => (
															<div key={g.id} className="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center gap-2">
																<div className="flex flex-col gap-0.5">
																	<SortButton direction="up" disabled={idx === 0} onClick={() => handleSortGroup(modal.dataType, idx, 'up')} />
																	<SortButton direction="down" disabled={idx === getGroups(modal.dataType).length - 1} onClick={() => handleSortGroup(modal.dataType, idx, 'down')} />
																</div>
																
																{/* ★★★ 修改重點：原本只有一個 input，現在要改成包含 Min/Max 設定的區塊 ★★★ */}
																<div className="flex-1 space-y-2">
																	{/* 1. 群組名稱 */}
																	<BlurInput className="input-compact font-bold" value={g.name} onSave={(val) => handleRenameGroup(modal.dataType, g.name, val)} />
																	
																	{/* 2. 新增：Min/Max 設定 (只在客製化選項 dataType === 'addons' 時顯示) */}
																	{modal.dataType === 'addons' && (
																		<div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg">
																			<label className="text-[10px] text-slate-500 font-bold whitespace-nowrap">至少選</label>
																			<input 
																				type="number" 
																				className="w-14 input-compact py-1 px-1 text-center font-bold text-sm h-8" 
																				value={g.minSelect !== undefined ? g.minSelect : (g.isRequired ? 1 : 0)} 
																				onChange={(e) => {
																					const groups = [...getGroups('addons')];
																					groups[idx].minSelect = parseInt(e.target.value) || 0;
																					saveGroups('addons', groups);
																				}} 
																			/>
																			<label className="text-[10px] text-slate-500 font-bold whitespace-nowrap ml-2">至多選</label>
																			<input 
																				type="number" 
																				className="w-14 input-compact py-1 px-1 text-center font-bold text-sm h-8" 
																				value={g.maxSelect !== undefined ? g.maxSelect : 99} 
																				onChange={(e) => {
																					const groups = [...getGroups('addons')];
																					groups[idx].maxSelect = parseInt(e.target.value) || 99;
																					saveGroups('addons', groups);
																				}} 
																			/>
																			<span className="text-[10px] text-slate-400 ml-auto">
																				{g.maxSelect === 1 ? '(單選)' : '(多選)'}
																			</span>
																		</div>
																	)}
																</div>
																<button onClick={() => handleCloneGroup(modal.dataType, g.name)} className="p-2 text-blue-400 hover:text-blue-600" title="複製組別"><Icon name="Copy" size={16}/></button>
																<button onClick={() => handleDeleteGroup(modal.dataType, g.name)} className="p-2 text-red-400 hover:text-red-600" title="刪除組別"><Icon name="Trash2" size={16}/></button>
															</div>
														))}
														{getGroups(modal.dataType).length === 0 && <div className="text-center text-slate-400 py-4">無自訂組別</div>}
													</div>
												</div>
											</div>
										)}
										{modal.type === 'item_editor' && (
											<div className="space-y-4 bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
												<div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">名稱</label><input className="w-full input-compact rounded-lg font-bold" value={modal.data.name} onChange={e => setModal({...modal, data: {...modal.data, name: e.target.value}})} /></div>
												<div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">組別</label><CustomSelect value={modal.data.category} options={getGroups(modal.dataType).map(g => ({ value: g.name, label: g.name }))} onChange={val => setModal({...modal, data: {...modal.data, category: val}})} allowCustom={true} placeholder="選擇或輸入新組別..." /></div>
												{modal.dataType === 'addons' && (
													<div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">價格</label><input type="number" className="w-full input-compact rounded-lg font-bold" value={modal.data.price} onChange={e => setModal({...modal, data: {...modal.data, price: parseInt(e.target.value)||0}})} /></div>
												)}
												{modal.dataType === 'materials' && (
													<div className="flex items-center gap-2 pt-2"><ToggleSwitch checked={!modal.data.isOut} variant="danger" onChange={c => setModal({...modal, data: {...modal.data, isOut: !c.target.checked}})} /><span className={`font-bold ${modal.data.isOut ? 'text-red-500' : 'text-slate-500'}`}>{modal.data.isOut ? '目前缺貨' : '供應中'}</span></div>
												)}
											</div>
										)}
										{modal.type === 'tags' && (
											<div className="space-y-6">
												<div className="text-[11px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2">餐點明細內容</div>
												{modal.data.items?.map((item, idx) => (
													<div key={idx} className="space-y-2 group">
														{/* 主品項名稱與金額 */}
														<div className="flex justify-between items-start">
															<div className="flex gap-3">
																<span className="font-[1000] text-[#5B2274] text-sm bg-purple-50 w-8 h-8 flex items-center justify-center rounded-xl shadow-sm">{item.qty}x</span>
																<div className="space-y-0.5">
																	<div className="font-[900] text-slate-800 text-[15px] leading-tight">{item.name}</div>
																	{item.variantName && <div className="text-xs text-slate-400 font-bold mt-0.5">規格：{item.variantName}</div>}
																</div>
															</div>
															<span className="text-[15px] font-[900] text-slate-700">${item.totalPrice}</span>
														</div>

														{/* 層級結構：客製化、附餐、套餐內容與備註 */}
														<div className="order-detail-list-line space-y-1.5 ml-11 border-l-2 border-slate-100 pl-4 py-1">
															{/* 1. 主品項客製化 (addons) */}
															{item.addons?.length > 0 && (
																<div className="text-xs font-bold text-slate-400">
																	{item.addons.map(ad => ad.name).join(' / ')}
																</div>
															)}
															
															{/* 2. 附餐內容 (sideGroups) - 修正抓取邏輯 */}
															{item.sideGroups && Object.keys(item.sideGroups).length > 0 && (
																<div className="space-y-1">
																	<div className="text-[10px] font-black text-[#5B2274] uppercase tracking-tighter">附餐內容：</div>
																	{Object.values(item.sideGroups).map((side, si) => (
																		<div key={si} className="text-xs font-bold text-slate-600 pl-2">
																			• {side.name} {side.variantName && `(${side.variantName})`}
																			{side.addons?.length > 0 && (
																				<div className="text-slate-400 font-medium ml-3">
																					/ {side.addons.map(a => a.name).join(' / ')}
																				</div>
																			)}
																		</div>
																	))}
																</div>
															)}

															{/* 3. 升級套餐內容 (setChoices) - 修正抓取邏輯 */}
															{item.set && (
																<div className="space-y-1">
																	<div className="text-[10px] font-black text-[#5B2274] uppercase tracking-tighter">套餐內容：{item.set.name}</div>
																	{item.setChoices && Object.values(item.setChoices).map((ch, ci) => (
																		<div key={ci} className="text-xs font-bold text-slate-500 pl-2">
																			• {ch.name} {ch.variantName && `(${ch.variantName})`}
																			{ch.addons?.length > 0 && (
																				<div className="text-slate-300 font-medium ml-3">
																					/ {ch.addons.map(a => a.name).join(' / ')}
																				</div>
																			)}
																		</div>
																	))}
																</div>
															)}

															{/* 4. 單項備註 */}
															{item.note && (
																<div className="text-[11px] font-bold text-orange-500 bg-orange-50 px-2 py-1 rounded-lg w-fit mt-1">
																	備註：{item.note}
																</div>
															)}
														</div>
													</div>
												))}
											</div>
										)}
										{modal.type === 'coupon' ? (
											<div className="bg-slate-50 w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl relative z-10 flex flex-col overflow-hidden animate-fade-in">
												{/* Header */}
												<div className="px-6 py-4 bg-white border-b border-slate-100 flex justify-between items-center shrink-0">
													<div className="flex items-center gap-3">
														<div className="bg-rose-100 p-2 rounded-lg text-rose-600"><Icon name="Ticket" size={20}/></div>
														<div>
															<h3 className="text-lg font-[900] text-slate-800">優惠券設定</h3>
															<div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Coupon Management</div>
														</div>
													</div>
													<button onClick={() => setModal(null)} className="w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-500 transition-colors"><Icon name="X" size={18}/></button>
												</div>

												{/* Scrollable Content */}
												<div className="p-6 overflow-y-auto custom-scrollbar bg-[#F8FAFC]">
													<div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
														
														{/* 左欄：核心資訊 (Col-4) */}
														<div className="lg:col-span-4 space-y-6">
															{/* 1. 基本券面設定 */}
															<div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60 space-y-4">
																<h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-1"><Icon name="Tag" size={12}/> 券面資訊</h4>
																
																<div className="space-y-1">
																	<label className="text-xs font-bold text-slate-700">優惠券名稱</label>
																	<input className="input-field w-full font-bold" value={modal.data.name || ''} onChange={e => setModal({...modal, data: {...modal.data, name: e.target.value}})} placeholder="例如: 開幕慶88折" />
																</div>

																<div className="space-y-1">
																	<label className="text-xs font-bold text-slate-700">優惠代碼 (Code)</label>
																	<div className="relative">
																		<input className="input-field w-full font-[1000] text-rose-600 uppercase tracking-widest pl-9" value={modal.data.code || ''} onChange={e => setModal({...modal, data: {...modal.data, code: e.target.value.toUpperCase()}})} placeholder="OPEN88" />
																		<div className="absolute left-3 top-2.5 text-rose-300"><Icon name="Hash" size={14}/></div>
																	</div>
																</div>

																<div className="grid grid-cols-2 gap-3">
																	<div className="space-y-1">
																		<label className="text-xs font-bold text-slate-700">折扣類型</label>
																		<select className="input-field w-full font-bold" value={modal.data.type || 'fixed'} onChange={e => setModal({...modal, data: {...modal.data, type: e.target.value}})}>
																			<option value="fixed">金額折抵 ($)</option>
																			<option value="percent">百分比 (%)</option>
																			<option value="step">滿額累折 (Step Discount)</option>
																		</select>
																	</div>
																	<div className="space-y-1">
																		<label className="text-xs font-bold text-slate-700">折扣數值</label>
																		<input type="number" className="input-field w-full font-[1000] text-slate-800" value={modal.data.value || ''} onChange={e => setModal({...modal, data: {...modal.data, value: parseInt(e.target.value)}})} placeholder={modal.data.type==='percent'?'90 (九折)':'20 (折20元)'} />
																	</div>
																</div>

																<div className="pt-2 border-t border-slate-100 flex items-center justify-between">
																	<span className="text-xs font-bold text-slate-600">啟用狀態</span>
																	<ToggleSwitch checked={modal.data.active !== false} onChange={c => setModal({...modal, data: {...modal.data, active: c}})} />
																</div>
															</div>

															{/* 2. 財務條件 */}
															<div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/60 space-y-4">
																<h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-1"><Icon name="BadgeDollarSign" size={12}/> 訂單條件</h4>
																
																<div className="space-y-1">
																	<label className="text-xs font-bold text-slate-700">最低消費門檻 (低消)</label>
																	<div className="relative">
																		<span className="absolute left-3 top-2.5 text-slate-400 text-xs font-black">$</span>
																		<input type="number" className="input-field w-full pl-6" value={modal.data.minSpend || 0} onChange={e => setModal({...modal, data: {...modal.data, minSpend: parseInt(e.target.value)}})} placeholder="0 = 無限制" />
																	</div>
																</div>

																{/* 只有百分比折扣才顯示最高上限 */}
																{(modal.data.type === 'percent' || modal.data.type === 'step') && (
																	<div className="space-y-1 animate-fade-in">
																		<label className="text-xs font-bold text-slate-700">最高折抵上限</label>
																		<div className="relative">
																			<span className="absolute left-3 top-2.5 text-slate-400 text-xs font-black">$</span>
																			<input type="number" className="input-field w-full pl-6" 
																				value={modal.data.maxDiscount || ''} 
																				onChange={e => setModal({...modal, data: {...modal.data, maxDiscount: parseInt(e.target.value)}})} 
																				placeholder="無上限" 
																			/>
																		</div>
																	</div>
																)}

																<div className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
																	<div className="text-xs font-bold text-slate-600">允許與其他優惠併用</div>
																	<ToggleSwitch checked={modal.data.stackable || false} onChange={c => setModal({...modal, data: {...modal.data, stackable: c}})} />
																</div>
															</div>
														</div>

														{/* 右欄：進階設定 (Col-8) */}
														<div className="lg:col-span-8 space-y-6">
															
															{/* 3. 對象與場景 */}
															<div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/60">
																<h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-1"><Icon name="Users" size={12}/> 對象與場景設定</h4>
																
																<div className="grid grid-cols-1 md:grid-cols-2 gap-6">
																	{/* 會員身分限制 */}
																	<div className="space-y-3">
																		<label className="text-xs font-bold text-slate-700 block">會員身分限定</label>
																		<div className="space-y-2">
																			{[
																				{val: 'all', label: '所有顧客 (無限制)'},
																				{val: 'member_only', label: '僅限註冊會員'},
																				{val: 'first_purchase', label: '首購限定 (需登入會員，第一次下單)'},
																				{val: 'staff', label: '特約/員工限定 (需綁定身分)'}
																			].map(opt => (
																				<label key={opt.val} className={`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition-all ${modal.data.targetAudience === opt.val ? 'bg-rose-50 border-rose-200 ring-1 ring-rose-200' : 'bg-slate-50 border-slate-100 hover:bg-white'}`}>
																					<input type="radio" name="targetAudience" className="accent-rose-500 w-4 h-4" checked={(modal.data.targetAudience || 'all') === opt.val} onChange={()=>setModal({...modal, data:{...modal.data, targetAudience: opt.val}})} />
																					<span className="text-xs font-bold text-slate-700">{opt.label}</span>
																				</label>
																			))}
																		</div>
																	</div>

																	{/* 訂單類型限制 */}
																	<div className="space-y-3">
																		<label className="text-xs font-bold text-slate-700 block">適用訂單類型</label>
																		<div className="grid grid-cols-1 gap-2">
																			{['dinein:內用', 'takeout:外帶自取', 'delivery:外送'].map(type => {
																				const [val, label] = type.split(':');
																				const currentTypes = modal.data.limitOrderTypes || ['dinein', 'takeout', 'delivery'];
																				const isChecked = currentTypes.includes(val);
																				return (
																					<label key={val} className={`flex items-center gap-3 p-3 rounded-xl border cursor-pointer transition-all ${isChecked ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100'}`}>
																						<input type="checkbox" className="accent-blue-500 w-4 h-4" checked={isChecked} onChange={(e)=>{
																							const newTypes = e.target.checked ? [...currentTypes, val] : currentTypes.filter(t=>t!==val);
																							setModal({...modal, data:{...modal.data, limitOrderTypes: newTypes}});
																						}} />
																						<span className="text-xs font-bold text-slate-700">{label}</span>
																					</label>
																				);
																			})}
																			<div className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100 mt-2">
																				<div className="text-xs font-bold text-slate-600">允許用於預約單 (Pre-order)</div>
																				<ToggleSwitch checked={modal.data.allowPreorder !== false} onChange={c => setModal({...modal, data: {...modal.data, allowPreorder: c}})} />
																			</div>
																		</div>
																	</div>
																</div>

																{/* 品項分類限制 */}
																<div className="mt-6 pt-6 border-t border-slate-100">
																	<label className="text-xs font-bold text-slate-700 block mb-3">限定品項分類 (未勾選則代表全品項適用)</label>
																	<div className="flex flex-wrap gap-2">
																		{categories.map(cat => {
																			const limitCats = modal.data.limitCategories || [];
																			const active = limitCats.includes(cat.id);
																			return (
																				<button key={cat.id} 
																					onClick={() => {
																						const newCats = active ? limitCats.filter(c=>c!==cat.id) : [...limitCats, cat.id];
																						setModal({...modal, data:{...modal.data, limitCategories: newCats}});
																					}}
																					className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${active ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200 hover:border-slate-300'}`}>
																					{cat.name}
																				</button>
																			);
																		})}
																	</div>
																</div>
															</div>

															{/* 4. 時間與效期 */}
															<div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/60">
																<h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-1"><Icon name="Clock" size={12}/> 效期設定</h4>
																
																<div className="grid grid-cols-2 gap-4 mb-4">
																	<div className="space-y-1">
																		<label className="text-xs font-bold text-slate-700">生效日期</label>
																		<input type="date" className="input-field w-full" value={modal.data.startDate || ''} onChange={e => setModal({...modal, data: {...modal.data, startDate: e.target.value}})} />
																	</div>
																	<div className="space-y-1">
																		<label className="text-xs font-bold text-slate-700">截止日期</label>
																		<input type="date" className="input-field w-full" value={modal.data.endDate || ''} onChange={e => setModal({...modal, data: {...modal.data, endDate: e.target.value}})} />
																	</div>
																</div>

																<div className="space-y-3 pt-4 border-t border-slate-100">
																	<div className="flex justify-between items-center">
																		<label className="text-xs font-bold text-slate-700">特殊時段限定 (Happy Hour)</label>
																		<span className="text-[10px] text-slate-400">留空則全時段適用</span>
																	</div>
																	<div className="flex items-center gap-2">
																		<input type="time" className="input-field flex-1" value={modal.data.validStartTime || ''} onChange={e => setModal({...modal, data: {...modal.data, validStartTime: e.target.value}})} />
																		<span className="text-slate-300 font-bold">~</span>
																		<input type="time" className="input-field flex-1" value={modal.data.validEndTime || ''} onChange={e => setModal({...modal, data: {...modal.data, validEndTime: e.target.value}})} />
																	</div>
																	<div className="flex flex-wrap gap-2 mt-2">
																		{['週一','週二','週三','週四','週五','週六','週日'].map((day, idx) => {
																			const validDays = modal.data.validDays || [0,1,2,3,4,5,6]; // 0-6 usually implies Mon-Sun or Sun-Sat logic, let's assume UI index mapping
																			const dayIdx = idx + 1; // 1=Mon, 7=Sun
																			const active = validDays.includes(dayIdx);
																			return (
																				<button key={day} 
																					onClick={()=>{
																						const newDays = active ? validDays.filter(d=>d!==dayIdx) : [...validDays, dayIdx];
																						setModal({...modal, data:{...modal.data, validDays: newDays}});
																					}}
																					className={`w-10 h-8 rounded-lg text-[10px] font-black border transition-all ${active ? 'bg-orange-100 text-orange-600 border-orange-200' : 'bg-slate-50 text-slate-400 border-slate-100'}`}>
																					{day}
																				</button>
																			);
																		})}
																	</div>
																</div>

																<div className="mt-4 pt-4 border-t border-slate-100 space-y-1">
																	<label className="text-xs font-bold text-slate-700">總使用次數上限 (全體)</label>
																	<input type="number" className="input-field w-full" value={modal.data.usageLimit || ''} onChange={e => setModal({...modal, data: {...modal.data, usageLimit: parseInt(e.target.value)}})} placeholder="0 = 無限制" />
																</div>
															</div>
														</div>
													</div>
												</div>

												{/* Footer */}
												<div className="p-4 bg-white border-t border-slate-100 flex justify-end gap-3 shrink-0">
													<Button variant="secondary" onClick={() => setModal(null)}>取消</Button>
													<Button onClick={async () => {
														if(!modal.data.name || !modal.data.code) return alert('請填寫名稱與代碼');
														// 儲存邏輯
														const coupons = getCoupons();
														const dataToSave = { ...modal.data, id: modal.data.id || Date.now() };
														if(modal.data.id) {
															const idx = coupons.findIndex(c => c.id === modal.data.id);
															if(idx !== -1) coupons[idx] = dataToSave;
														} else {
															coupons.push(dataToSave);
														}
														saveCoupons(coupons);
														setModal(null);
													}}>儲存設定</Button>
												</div>
											</div>
										) : null}
										{modal.type === 'prod' && (
											<>
												<div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 space-y-4">
													<div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">名稱</label><input className="w-full input-compact rounded-lg font-bold" value={modal.data.name} onChange={e => setModal({...modal, data: {...modal.data, name: e.target.value}})} /></div>
													<div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">分類</label><CustomSelect value={modal.data.categoryId} options={categories.map(c => ({ value: c.id, label: c.name }))} onChange={val => setModal({...modal, data: {...modal.data, categoryId: val}})} /></div>
													<div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">標籤</label><MultiSelect value={modal.data.tags || []} options={(settings.productTags || []).map(t => ({value: t.id, label: t.label}))} onChange={val => setModal({...modal, data: {...modal.data, tags: val}})} placeholder="選擇標籤..." /></div>
													<div className="space-y-2 pt-2">
														<label className="text-[10px] font-bold text-slate-500 uppercase flex justify-between"><span>規格與價格</span><button onClick={()=>{ let n = [...(modal.data.variants||[])]; if(n.length === 0) { n = [{name: '原味/單一', price: modal.data.price, materials: []}, {name: '新規格', price: modal.data.price, materials: []}]; } else { n.push({name: '新規格', price: 0, materials: []}); } setModal({...modal, data: {...modal.data, variants: n}}); }} className="text-[#5B2274] hover:underline">+ 新增規格</button></label>
														
														{(!modal.data.variants || modal.data.variants.length === 0) && (
															<div className="space-y-2">
																<div className="flex gap-2"><div className="bg-slate-100 px-3 py-1.5 rounded-lg text-xs font-bold text-slate-500 flex items-center justify-center w-24">單一規格</div><input type="number" className="flex-1 input-compact rounded-lg font-bold" value={modal.data.price} onChange={e => setModal({...modal, data: {...modal.data, price: parseInt(e.target.value)||0}})} placeholder="價格" /></div>
																<div className="flex gap-2 items-center"><span className="text-xs font-bold text-slate-400 w-24 text-center">綁定原物料</span><div className="flex-1"><MultiSelect value={modal.data.materials || []} options={materials.map(m => ({value: m.id, label: m.name}))} onChange={val => setModal({...modal, data: {...modal.data, materials: val}})} placeholder="選擇原物料 (影響庫存)..." /></div></div>
															</div>
														)}
														
														{modal.data.variants?.map((v, idx) => (
															<div key={idx} className="bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-2">
																<div className="flex gap-2">
																	<input className="flex-1 input-compact rounded-lg font-bold" value={v.name} onChange={e=>{const n=[...modal.data.variants]; n[idx].name=e.target.value; setModal({...modal, data: {...modal.data, variants: n}})}} placeholder="如: 大杯" />
																	<input type="number" className="w-24 input-compact rounded-lg font-bold" value={v.price} onChange={e=>{const n=[...modal.data.variants]; n[idx].price=parseInt(e.target.value)||0; setModal({...modal, data: {...modal.data, variants: n}})}} placeholder="$" />
																	<button onClick={()=>{ let n=modal.data.variants.filter((_,i)=>i!==idx); if (n.length === 1) { setModal({...modal, data: {...modal.data, price: n[0].price, variants: [], materials: []}}); } else { setModal({...modal, data: {...modal.data, variants: n}}); } }} className="p-1.5 text-slate-400 hover:text-red-500"><Icon name="Trash2" size={16}/></button>
																</div>
																<div className="flex items-center gap-2">
																	<Icon name="Link" size={14} className="text-slate-400" />
																	<div className="flex-1"><MultiSelect value={v.materials || []} options={materials.map(m => ({value: m.id, label: m.name}))} onChange={val => { const n = [...modal.data.variants]; n[idx].materials = val; setModal({...modal, data: {...modal.data, variants: n}}); }} placeholder="此規格綁定原物料..." /></div>
																</div>
															</div>
														))}
													</div>
													<div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">圖片 URL</label><div className="flex gap-2"><input className="w-full input-compact rounded-lg font-bold" value={modal.data.image} onChange={e => setModal({...modal, data: {...modal.data, image: e.target.value}})} /><button onClick={() => openCloudinaryWidget((url) => setModal({...modal, data: {...modal.data, image: url}}))} className="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-200 transition-colors font-bold flex items-center gap-1 whitespace-nowrap"><Icon name="UploadCloud" size={16} /> 上傳</button></div></div>
													<div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">描述</label><textarea className="w-full input-compact rounded-lg font-bold h-16 resize-none" value={modal.data.desc} onChange={e => setModal({...modal, data: {...modal.data, desc: e.target.value}})}></textarea></div>
													<div className="space-y-1"><label className="text-[10px] font-bold text-amber-600 uppercase">廚房備註</label><input className="w-full input-compact rounded-lg bg-amber-50 border border-amber-100 font-bold" value={modal.data.note} onChange={e => setModal({...modal, data: {...modal.data, note: e.target.value}})} /></div>
												</div>
												<div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 space-y-3">
													<label className="text-[10px] font-bold text-slate-500 uppercase">適用客製化選項 (勾選開放)</label>
													{processGroups('customization').map((group, gIdx) => (
														<div key={gIdx} className="space-y-1">
															<p className="text-xs font-black text-slate-400">{group.name}</p>
															<div className="flex flex-wrap gap-2">{group.items.map(ad => { const isSelected = modal.data.allowAddons?.includes(ad.id); return ( <button key={ad.id} onClick={()=>{ const current = modal.data.allowAddons || []; const next = isSelected ? current.filter(id => id !== ad.id) : [...current, ad.id]; setModal({...modal, data: {...modal.data, allowAddons: next}}); }} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${isSelected ? 'bg-[#5B2274] text-white border-[#5B2274]' : 'bg-white text-slate-500 border-slate-200'}`}> {ad.name} <span className="opacity-75">+${ad.price}</span> </button> ) })}</div>
														</div>
													))}
													{addons.length === 0 && <span className="text-xs text-slate-400">請先在客製化頁面建立選項</span>}
												</div>
												<div className="bg-purple-50 p-5 rounded-xl border border-purple-100 space-y-4">
													<div className="flex justify-between items-center"><div className="flex items-center gap-2 text-[#5B2274]"><Icon name="Sparkles" size={16}/><span className="font-bold text-sm">附餐群組 (多選)</span></div><Button variant="secondary" size="small" icon="Plus" onClick={()=>{ const n = [...(modal.data.sideGroups||[])]; n.push({id: Date.now(), title: '選擇附餐', categoryId: '', required: true, allowChange: true, defaultProductId: '', defaultVariantName: ''}); setModal({...modal, data: {...modal.data, sideGroups: n}}); }}>新增群組</Button></div>
													{(modal.data.sideGroups||[]).map((group, idx) => {
														const groupProducts = products.filter(p => p.categoryId === group.categoryId);
														const defaultProduct = products.find(p => p.id === group.defaultProductId);
														return (
															<div key={idx} className="bg-white p-4 rounded-xl border border-purple-100 shadow-sm space-y-3 relative group" style={{zIndex: 50 - idx}}>
																<button onClick={()=>{const n=modal.data.sideGroups.filter((_,i)=>i!==idx); setModal({...modal, data: {...modal.data, sideGroups: n}})}} className="absolute top-2 right-2 text-slate-300 hover:text-red-500"><Icon name="X" size={14}/></button>
																<div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">群組標題</label><input className="w-full input-compact rounded-lg font-bold" value={group.title} onChange={e=>{const n=[...modal.data.sideGroups]; n[idx].title=e.target.value; setModal({...modal, data: {...modal.data, sideGroups: n}})}} /></div>
																<div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">來源分類</label><CustomSelect value={group.categoryId} options={categories.map(c => ({ value: c.id, label: c.name }))} onChange={val=>{const n=[...modal.data.sideGroups]; n[idx].categoryId=val; n[idx].defaultProductId=''; n[idx].defaultVariantName=''; setModal({...modal, data: {...modal.data, sideGroups: n}})}} /></div>
																<div className="flex items-center gap-2 pt-2"><ToggleSwitch checked={group.allowChange} onChange={c=>{const n=[...modal.data.sideGroups]; n[idx].allowChange=c; setModal({...modal, data: {...modal.data, sideGroups: n}})}} /><span className="text-[10px] font-bold text-slate-500">允許更換 (開啟即自動補差價)</span></div>
																{group.allowChange && group.categoryId && (
																	<div className="p-2 bg-slate-50 rounded-lg space-y-2 border border-slate-100 mt-2">
																		<div className="space-y-1"><label className="text-[9px] font-bold text-slate-400">基準品項 (差價=0)</label><CustomSelect value={group.defaultProductId} options={groupProducts.map(p => ({ value: p.id, label: p.name + ` ($${p.price})` }))} onChange={val=>{const n=[...modal.data.sideGroups]; n[idx].defaultProductId=val; n[idx].defaultVariantName=''; setModal({...modal, data: {...modal.data, sideGroups: n}})}} searchable={true} /></div>
																		{defaultProduct?.variants?.length > 0 && (<div className="space-y-1"><label className="text-[9px] font-bold text-slate-400">基準規格</label><CustomSelect value={group.defaultVariantName} options={defaultProduct.variants.map(v => ({ value: v.name, label: v.name + ` ($${v.price})` }))} onChange={val=>{const n=[...modal.data.sideGroups]; n[idx].defaultVariantName=val; setModal({...modal, data: {...modal.data, sideGroups: n}})}} /></div>)}
																	</div>
																)}
															</div>
														);
													})}
													{(modal.data.sideGroups||[]).length === 0 && <div className="text-center text-xs text-purple-300 py-2">無附餐設定</div>}
												</div>
												<div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 space-y-3"><label className="text-[10px] font-bold text-slate-500 uppercase">可搭配套餐</label><div className="grid grid-cols-2 gap-2">{sets.map(s => (<button key={s.id} onClick={() => { const current = modal.data.allowSets || []; const next = current.includes(s.id) ? current.filter(id => id !== s.id) : [...current, s.id]; setModal({...modal, data: {...modal.data, allowSets: next}}); }} className={`p-2 rounded-lg border text-xs font-bold flex justify-between transition-all ${modal.data.allowSets?.includes(s.id) ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200'}`}><span>{s.name}</span><span className="opacity-70">+${s.price}</span></button>))}</div></div>
											</>
										)}
										{modal.type === 'member_detail' && (() => {
                                            const m = modal.data;
                                            // 計算會員專屬數據
                                            const mOrders = orders.filter(o => o.customerUid === m.id).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                                            const cancelledCount = mOrders.filter(o => o.status === 'cancelled').length;
                                            
                                            // 定義分頁樣式
                                            const tabBaseClass = "flex-1 py-3 text-center text-sm font-bold border-b-2 transition-colors cursor-pointer";
                                            const activeTabClass = "border-[#5B2274] text-[#5B2274]";
                                            const inactiveTabClass = "border-transparent text-slate-400 hover:text-slate-600";

                                            return (
                                                <div className="bg-white w-full max-w-lg max-h-[85vh] rounded-xl shadow-2xl relative z-10 flex flex-col overflow-hidden animate-scale-in">
                                                    
                                                    {/* Header: Name & Tags only (No Image) */}
                                                    <div className="px-6 pt-6 pb-2 shrink-0">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div>
                                                                <h3 className="text-2xl font-[1000] text-slate-800 tracking-tight">{m.displayName}</h3>
                                                                <div className="flex flex-wrap gap-2 mt-2">
                                                                    {m.totalSpend > 5000 && <span className="px-2 py-0.5 bg-amber-100 text-amber-700 text-[10px] font-black rounded uppercase tracking-wider">VIP 會員</span>}
                                                                    <span className="px-2 py-0.5 bg-slate-100 text-slate-500 text-[10px] font-black rounded border border-slate-200">入會：{formatDate(m.createdAt || Date.now()).split(' ')[0]}</span>
                                                                </div>
                                                            </div>
                                                            <button onClick={handlePopModal} className="w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center text-slate-400 transition-colors"><Icon name="X" size={18}/></button>
                                                        </div>
                                                    </div>

                                                    {/* Stats Row (類似參考圖的數據列) */}
                                                    <div className="px-4 pb-2">
                                                        <div className="grid grid-cols-3 gap-2 bg-slate-50 rounded-lg p-3 border border-slate-100">
                                                            <div className="text-center border-r border-slate-200 last:border-0">
                                                                <div className="text-[10px] font-bold text-slate-400 mb-0.5">總消費次數</div>
                                                                <div className="text-2xl font-[1000] text-orange-500 leading-none">{m.orderCount}</div>
                                                            </div>
                                                            <div className="text-center border-r border-slate-200 last:border-0">
                                                                <div className="text-[10px] font-bold text-slate-400 mb-0.5">累積金額</div>
                                                                <div className="text-2xl font-[1000] text-[#5B2274] leading-none">${m.totalSpend.toLocaleString()}</div>
                                                            </div>
                                                            <div className="text-center">
                                                                <div className="text-[10px] font-bold text-slate-400 mb-0.5">取消次數</div>
                                                                <div className="text-2xl font-[1000] text-slate-600 leading-none">{cancelledCount}</div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Tabs Navigation */}
                                                    <div className="flex border-b border-slate-100 px-4 mt-2">
                                                        <div onClick={() => setMemberModalTab('overview')} className={`${tabBaseClass} ${memberModalTab === 'overview' ? activeTabClass : inactiveTabClass}`}>顧客資料</div>
                                                        <div onClick={() => setMemberModalTab('history')} className={`${tabBaseClass} ${memberModalTab === 'history' ? activeTabClass : inactiveTabClass}`}>消費紀錄 ({mOrders.length})</div>
                                                        <div onClick={() => setMemberModalTab('coupons')} className={`${tabBaseClass} ${memberModalTab === 'coupons' ? activeTabClass : inactiveTabClass}`}>專屬優惠</div>
                                                    </div>

                                                    {/* Tab Content Area */}
                                                    <div className="flex-1 overflow-y-auto p-5 bg-[#F8FAFC]">
                                                        
                                                        {/* Tab 1: Overview & CRM Note */}
                                                        {memberModalTab === 'overview' && (
                                                            <div className="space-y-5 animate-fade-in">
                                                                {/* Basic Info List */}
                                                                <div className="bg-white rounded-xl border border-slate-200 p-4 space-y-3 shadow-sm">
                                                                    <div className="flex justify-between items-center border-b border-slate-50 pb-2">
                                                                        <span className="text-xs font-bold text-slate-400">真實姓名</span>
                                                                        <span className="text-sm font-bold text-slate-700">{m.realName || '未設定'}</span>
                                                                    </div>
                                                                    <div className="flex justify-between items-center border-b border-slate-50 pb-2">
                                                                        <span className="text-xs font-bold text-slate-400">聯絡電話</span>
                                                                        <span className="text-sm font-bold text-slate-700 font-mono">{m.phone || '未設定'}</span>
                                                                    </div>
                                                                    <div className="flex justify-between items-center">
                                                                        <span className="text-xs font-bold text-slate-400">最近消費</span>
                                                                        <span className="text-xs font-bold text-slate-700">{m.lastOrder ? formatDate(m.lastOrder.createdAt) : '無'}</span>
                                                                    </div>
                                                                </div>

                                                                {/* CRM Note */}
                                                                <div className="space-y-2">
                                                                    <label className="text-xs font-black text-amber-600 flex items-center gap-1 uppercase tracking-wider"><Icon name="StickyNote" size={12}/> 顧客永久備註</label>
                                                                    <textarea 
                                                                        className="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm font-bold text-slate-700 resize-none focus:ring-2 focus:ring-amber-200 outline-none transition-all placeholder:text-slate-300 shadow-sm" 
                                                                        rows="5" 
                                                                        placeholder="輸入關於此客人的備註 (例如: 不吃香菜、熟客)..."
                                                                        value={memberNote}
                                                                        onChange={(e) => setMemberNote(e.target.value)}
                                                                    ></textarea>
                                                                    <div className="flex justify-end">
                                                                        <button onClick={handleSaveMemberNote} disabled={isMemberSaving} className="bg-amber-400 hover:bg-amber-500 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-md transition-all active:scale-95 flex items-center gap-2">
                                                                            {isMemberSaving ? <Icon name="Loader2" size={14} className="animate-spin"/> : <Icon name="Save" size={14}/>}
                                                                            儲存備註
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* Tab 2: Order History */}
                                                        {memberModalTab === 'history' && (
                                                            <div className="space-y-3 animate-fade-in">
                                                                {mOrders.map(o => (
                                                                    <div key={o.id} className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center group hover:border-purple-300 transition-all cursor-pointer" onClick={() => handlePushModal({ type: 'edit_order', data: o })}>
                                                                        <div className="flex items-center gap-3">
                                                                            <div className={`w-2 h-10 rounded-full ${STATUS_STYLE[o.status]?.bg.replace('bg-', 'bg-').replace('50', '400')}`}></div>
                                                                            <div>
                                                                                <div className="text-xs font-black text-slate-700">{formatDate(o.createdAt).split(' ')[0]}</div>
                                                                                <div className={`text-[10px] font-bold px-1.5 py-0.5 rounded w-fit mt-0.5 ${STATUS_STYLE[o.status]?.bg} ${STATUS_STYLE[o.status]?.text}`}>
                                                                                    {STATUS_STYLE[o.status]?.label}
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <div className="text-sm font-[1000] text-slate-800">${o.totalPrice}</div>
                                                                            <div className="text-[10px] font-bold text-slate-400">{o.items?.length} 品項</div>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                                {mOrders.length === 0 && <div className="text-center py-10 text-slate-400 font-bold text-xs">尚無消費紀錄</div>}
                                                            </div>
                                                        )}

                                                        {/* Tab 3: Coupons */}
                                                        {memberModalTab === 'coupons' && (
                                                            <div className="space-y-4 animate-fade-in">
                                                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                                                    <label className="text-xs font-black text-[#5B2274] uppercase tracking-widest mb-3 block flex items-center gap-2">
                                                                        <Icon name="Ticket" size={14}/> 發送專屬優惠券
                                                                    </label>
                                                                    <div className="flex gap-2">
                                                                        <div className="relative flex-1">
                                                                            <select id="couponSelect" className="w-full bg-slate-50 border border-slate-200 text-slate-600 text-xs font-bold rounded-lg px-3 py-2.5 appearance-none outline-none focus:border-[#5B2274]">
                                                                                <option value="">選擇一張優惠券...</option>
                                                                                {coupons.filter(c => c.active !== false).map(c => <option key={c.id} value={c.id}>{c.name} ({c.code})</option>)}
                                                                            </select>
                                                                            <Icon name="ChevronDown" size={14} className="absolute right-3 top-3 text-slate-400 pointer-events-none"/>
                                                                        </div>
                                                                        <button onClick={async () => {
                                                                            const cId = document.getElementById('couponSelect').value;
                                                                            if(!cId) return;
                                                                            const coupon = coupons.find(c => c.id === cId);
                                                                            if(!confirm(`確定派發「${coupon.name}」給 ${m.displayName} 嗎？`)) return;
                                                                            try {
                                                                                const { db, appId } = window.firebase;
                                                                                const { doc, setDoc, getDoc } = window.firestore;
                                                                                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', m.id);
                                                                                const userSnap = await getDoc(userRef);
                                                                                const currentCoupons = userSnap.exists() ? (userSnap.data().coupons || []) : [];
                                                                                const newCoupon = { ...coupon, issuedAt: new Date().toISOString(), used: false, uniqueId: Date.now() };
                                                                                await setDoc(userRef, { coupons: [...currentCoupons, newCoupon] }, { merge: true });
                                                                                alert(`✅ 已成功派發！`);
                                                                            } catch(e) { alert("派發失敗: " + e.message); }
                                                                        }} className="bg-[#5B2274] hover:bg-purple-800 text-white px-4 rounded-lg font-bold text-xs shadow-md transition-all active:scale-95 whitespace-nowrap">
                                                                            發送
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div className="space-y-2">
                                                                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1">持有中優惠券 ({m.coupons?.filter(c=>!c.used).length || 0})</div>
                                                                    {m.coupons?.map((c, i) => (
                                                                        <div key={i} className={`p-3 rounded-lg border flex justify-between items-center ${c.used ? 'bg-slate-50 border-slate-100 opacity-60' : 'bg-white border-slate-200'}`}>
                                                                            <div>
                                                                                <div className="font-bold text-xs text-slate-700">{c.name}</div>
                                                                                <div className="text-[10px] text-slate-400">Code: {c.code}</div>
                                                                            </div>
                                                                            <div className={`text-[10px] font-black px-2 py-1 rounded ${c.used ? 'bg-slate-200 text-slate-500' : 'bg-emerald-50 text-emerald-600'}`}>
                                                                                {c.used ? '已使用' : '未使用'}
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                    {(!m.coupons || m.coupons.length === 0) && <div className="text-center py-6 text-slate-300 text-xs font-bold border border-dashed border-slate-200 rounded-xl">無優惠券</div>}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })()}
										
										{modal.type === 'cat' && <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100"><label className="text-[10px] font-bold text-slate-500 uppercase">分類名稱</label><input className="w-full input-compact rounded-lg font-bold mt-1" value={modal.data.name} onChange={e => setModal({...modal, data: {...modal.data, name: e.target.value}})} /></div>}
										{modal.type === 'set' && (
											<div className="space-y-6">
												{/* ... Set Modal Content ... */}
												<div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 grid grid-cols-3 gap-3">
													<div className="col-span-2 space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">名稱</label><input className="w-full input-compact rounded-lg font-bold" value={modal.data.name} onChange={e => setModal({...modal, data: {...modal.data, name: e.target.value}})} /></div>
													<div className="space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">加價</label><input type="number" className="w-full input-compact rounded-lg font-bold" value={modal.data.price} onChange={e => setModal({...modal, data: {...modal.data, price: parseInt(e.target.value)||0}})} /></div>
													<div className="col-span-3 space-y-1"><label className="text-[10px] font-bold text-slate-500 uppercase">圖片 URL</label><div className="flex gap-2"><input className="w-full input-compact rounded-lg font-bold" value={modal.data.image} onChange={e => setModal({...modal, data: {...modal.data, image: e.target.value}})} placeholder="https://..." /><button onClick={() => openCloudinaryWidget((url) => setModal({...modal, data: {...modal.data, image: url}}))} className="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-200 transition-colors font-bold flex items-center gap-1 whitespace-nowrap"><Icon name="UploadCloud" size={16} /> 上傳</button></div></div>
												</div>
												<div className="space-y-3">
													<div className="flex justify-between items-center"><label className="text-[10px] font-black text-[#5B2274] uppercase">套餐結構</label><Button variant="secondary" size="small" icon="Plus" onClick={() => { const newItem = { label: '新項目', type: 'category', defaultProductId: '', allowChange: true }; setModal({...modal, data: {...modal.data, contents: [...(modal.data.contents || []), newItem]}}); }}>新增欄位</Button></div>
													<div className="space-y-2">{(modal.data.contents || []).map((item, idx) => {
														const slotProducts = products.filter(p=>p.categoryId===item.categoryId);
														const defaultProduct = products.find(p=>p.id===item.defaultProductId);
														const fixedProduct = products.find(p=>p.id===item.productId);
														const filterCategoryId = item.tempFilterCategoryId || fixedProduct?.categoryId || '';
														const filteredFixedProducts = products.filter(p => p.categoryId === filterCategoryId);

														return (
															<div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 relative group animate-fade-in" style={{zIndex: 50 - idx}}>
																<button onClick={() => { const next = modal.data.contents.filter((_, i) => i !== idx); setModal({...modal, data: {...modal.data, contents: next}}); }} className="absolute top-2 right-2 text-slate-300 hover:text-red-500"><Icon name="X" size={14}/></button>
																<div className="grid grid-cols-2 gap-3 mb-3"><div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">標籤</label><input className="w-full input-compact rounded-lg font-bold" value={item.label} onChange={e => { const next = [...modal.data.contents]; next[idx].label = e.target.value; setModal({...modal, data: {...modal.data, contents: next}}); }} /></div><div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">類型</label><CustomSelect value={item.type} options={[{value: 'fixed', label: '指定固定品項'}, {value: 'category', label: '開放分類選品'}]} onChange={val => { const next = [...modal.data.contents]; next[idx].type = val; setModal({...modal, data: {...modal.data, contents: next}}); }} /></div></div>
																{item.type === 'category' && (
																	<div className="space-y-3">
																		<div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">來源分類</label><CustomSelect value={item.categoryId} options={categories.map(c => ({value: c.id, label: c.name}))} onChange={val => { const next = [...modal.data.contents]; next[idx].categoryId = val; next[idx].defaultProductId=''; next[idx].defaultVariantName=''; setModal({...modal, data: {...modal.data, contents: next}}); }} /></div>
																		<div className="flex items-center gap-2 pt-1"><ToggleSwitch checked={item.allowChange} onChange={c => { const next = [...modal.data.contents]; next[idx].allowChange = c; setModal({...modal, data: {...modal.data, contents: next}}); }} /><span className="text-xs font-bold text-slate-500">允許更換 (開啟即自動補差價)</span></div>
																		{item.allowChange && (
																			<>
																				<div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">預設品項</label><CustomSelect value={item.defaultProductId} options={slotProducts.map(p => ({value: p.id, label: p.name}))} onChange={val => { const next = [...modal.data.contents]; next[idx].defaultProductId = val; next[idx].defaultVariantName=''; setModal({...modal, data: {...modal.data, contents: next}}); }} searchable={true} /></div>
																				{defaultProduct?.variants?.length > 0 && (<div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">預設規格</label><CustomSelect value={item.defaultVariantName} options={defaultProduct.variants.map(v => ({value: v.name, label: v.name}))} onChange={val => { const next = [...modal.data.contents]; next[idx].defaultVariantName = val; setModal({...modal, data: {...modal.data, contents: next}}); }} /></div>)}
																			</>
																		)}
																	</div>
																)}
																{item.type === 'fixed' && (
																	<div className="space-y-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
																		<div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">篩選分類</label><CustomSelect value={filterCategoryId} options={categories.map(c => ({value: c.id, label: c.name}))} onChange={val => { const next = [...modal.data.contents]; next[idx].tempFilterCategoryId = val; setModal({...modal, data: {...modal.data, contents: next}}); }} /></div>
																		<div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">指定品項</label><CustomSelect value={item.productId} options={filteredFixedProducts.map(p => ({value: p.id, label: p.name}))} onChange={val => { const next = [...modal.data.contents]; next[idx].productId = val; next[idx].variantName=''; setModal({...modal, data: {...modal.data, contents: next}}); }} searchable={true} /></div>
																		{fixedProduct?.variants?.length > 0 && (<div className="space-y-1"><label className="text-[10px] font-bold text-slate-400">指定規格</label><CustomSelect value={item.variantName} options={fixedProduct.variants.map(v => ({value: v.name, label: v.name}))} onChange={val => { const next = [...modal.data.contents]; next[idx].variantName = val; setModal({...modal, data: {...modal.data, contents: next}}); }} /></div>)}
																	</div>
																)}
															</div>
														);
													})}</div>
												</div>
											</div>
										)}
										{modal.type === 'edit_order' && (
											<div className="fixed inset-0 z-[100] flex items-end justify-center">
												<div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={() => setModal(null)} />
												<div className="bg-white w-full max-w-2xl rounded-t-[2.5rem] shadow-2xl relative z-10 flex flex-col overflow-hidden animate-slide-up no-scrollbar" style={{height: '92vh'}}>
													{(() => {
														const st = STATUS_STYLE[modal.data.status] || STATUS_STYLE.pending;
														return (
															<div className="flex flex-col h-full bg-white">
																{/* Header */}
																<div className={`px-6 py-5 flex justify-between items-center border-b shrink-0 ${st.bg} ${st.border}`}>
																	<div className="flex items-center gap-3">
																		<div className="p-2.5 rounded-2xl bg-white/60"><Icon name={st.icon} size={22} className={st.text}/></div>
																		<div>
																			<div className={`text-[10px] font-black uppercase tracking-widest ${st.text}`}>{st.label}</div>
																			<div className="text-xl font-[1000] text-slate-800 tracking-tighter">單號 #{modal.data.orderId?.slice(-6)}</div>
																		</div>
																	</div>
																	<button onClick={() => setModal(null)} className="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-transform active:scale-90"><Icon name="X" size={24}/></button>
																</div>

																<div className="flex-1 overflow-y-auto p-6 space-y-8 no-scrollbar bg-slate-50/30">
																	{/* 顧客核心資訊 */}
																	<div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex justify-between items-center">
																		<div className="space-y-1.5">
																			<div className="text-2xl font-[1000] text-slate-800">{modal.data.userInfo?.name}</div>
																			<a href={`tel:${modal.data.userInfo?.phone}`} className="text-sm font-bold text-blue-500 flex items-center gap-1.5"><Icon name="Phone" size={14}/> {modal.data.userInfo?.phone}</a>
																			<div className="text-[11px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg w-fit border border-slate-100">取餐日：{modal.data.userInfo?.pickupDate}</div>
																		</div>
																		<div className="text-right">
																			<div className="text-[10px] font-black text-slate-400 mb-1 tracking-widest uppercase">預計取餐</div>
																			<div className={`text-4xl font-[1000] tracking-tighter ${modal.data.userInfo?.pickupTime==='ASAP'?'text-red-500 animate-pulse':'text-[#5B2274]'}`}>{modal.data.userInfo?.pickupTime}</div>
																		</div>
																	</div>

																	{/* 餐點明細 (資料讀取修正重點) */}
																	<div className="space-y-6">
																		<div className="flex items-center gap-3">
																			<span className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em]">餐點清單</span>
																			<div className="h-[1px] bg-slate-200 flex-1"></div>
																		</div>
																		{modal.data.items?.map((item, idx) => (
																			<div key={idx} className="space-y-2 group">
																				<div className="flex justify-between items-start">
																					<div className="flex gap-3">
																						<span className="font-[1000] text-[#5B2274] text-sm bg-purple-50 w-8 h-8 flex items-center justify-center rounded-xl shadow-sm border border-purple-100 shrink-0">{item.qty}x</span>
																						<div className="space-y-0.5">
																							<div className="font-[900] text-slate-800 text-[15px] leading-tight">{item.name}</div>
																							{item.variantName && <div className="text-xs font-bold text-slate-400">規格：{item.variantName}</div>}
																						</div>
																					</div>
																					<span className="text-[15px] font-[900] text-slate-700">${item.totalPrice}</span>
																				</div>

																				{/* 子項目顯示區 (修正：正確讀取 SideGroups 與 SetChoices) */}
																				<div className="ml-11 pl-4 border-l-2 border-slate-100 py-1 space-y-2">
																					{/* 客製化 */}
																					{item.addons?.length > 0 && (
																						<div className="text-xs font-bold text-slate-400 leading-relaxed">
																							{item.addons.map(a => a.name).join(' / ')}
																						</div>
																					)}
																					
																					{/* 附餐 (先前遺漏的部分) */}
																					{item.sideGroups && Object.values(item.sideGroups).map((side, si) => (
																						<div key={si} className="text-xs font-bold text-slate-600">
																							<span className="text-[#5B2274] font-black mr-1">附餐：</span>
																							{side.name} {side.variantName && `(${side.variantName})`}
																							{side.addons?.length > 0 && <span className="text-slate-400 font-medium ml-1">/ {side.addons.map(a => a.name).join(' ')}</span>}
																						</div>
																					))}

																					{/* 套餐 (先前遺漏的部分) */}
																					{item.set && (
																						<div className="bg-slate-50 p-2 rounded-lg space-y-1.5">
																							<div className="text-[10px] font-black text-[#5B2274] uppercase tracking-wider">升級套餐：{item.set.name}</div>
																							{item.set.contents?.map((content, cIdx) => {
																								// 嘗試從使用者的選擇中找
																								const choice = item.setChoices?.[cIdx];
																								if (choice) {
																									return (
																										<div key={cIdx} className="text-xs font-bold text-slate-600 pl-1">
																											• {choice.name} {choice.variantName && `(${choice.variantName})`}
																											{choice.addons?.length > 0 && <span className="text-slate-400 font-medium ml-1">/ {choice.addons.map(a => a.name).join(' ')}</span>}
																										</div>
																									);
																								} 
																								// 否則如果是固定餐點，嘗試從產品列表找名稱
																								else if (content.type === 'fixed') {
																									const fp = products.find(p => p.id === content.productId);
																									return (
																										<div key={cIdx} className="text-xs font-bold text-slate-600 pl-1">
																											• {fp ? fp.name : '固定餐點'} {content.variantName && `(${content.variantName})`}
																										</div>
																									);
																								}
																								return null;
																							})}
																						</div>
																					)}

																					{/* 備註 */}
																					{item.note && (
																						<div className="text-[11px] font-bold text-orange-600 bg-orange-50 px-2.5 py-1.5 rounded-lg w-fit mt-1 border border-orange-100">
																							備註：{item.note}
																						</div>
																					)}
																				</div>
																			</div>
																		))}
																	</div>

																	{/* 結算與註記區 */}
																	<div className="pt-6 border-t-2 border-dashed border-slate-200 space-y-3">
																		<div className="flex justify-between text-xs font-bold text-slate-400"><span>小計</span><span>${modal.data.originalPrice || modal.data.totalPrice}</span></div>
																		{modal.data.discountAmount > 0 && <div className="flex justify-between text-xs font-bold text-red-500"><span>折扣優惠</span><span>-${modal.data.discountAmount}</span></div>}
																		<div className="flex justify-between items-center pt-2"><span className="text-base font-black text-slate-800 uppercase tracking-widest">總計金額</span><span className="text-4xl font-[1000] text-[#5B2274] tracking-tighter">${modal.data.totalPrice}</span></div>
																	</div>

																	<div className="space-y-4 pt-4 border-t border-slate-100">
                                                                        <div className="space-y-2">
                                                                            <div className="flex items-center gap-2 text-[10px] font-black text-amber-600 uppercase tracking-widest"><Icon name="User" size={12}/> 顧客永久註記 (跨單連動)</div>
                                                                            <div className="flex gap-2 bg-amber-50 p-1.5 rounded-2xl border border-amber-100">
                                                                                <textarea className="flex-1 bg-transparent border-none px-3 py-2 text-xs font-bold text-slate-700 resize-none outline-none placeholder:text-amber-300" rows="1" value={customerNote} onChange={(e)=>setCustomerNote(e.target.value)} placeholder="輸入關於此客人的備註..."></textarea>
                                                                                <button onClick={saveCustomerNote} className="bg-amber-400 text-white w-10 h-full rounded-xl shadow-sm active:scale-95 flex items-center justify-center transition-all hover:bg-amber-500"><Icon name="Save" size={18}/></button>
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex gap-4">
                                                                            <div className="flex-1 space-y-2">
                                                                                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest">本單備註</div>
                                                                                <input className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold text-slate-600 outline-none focus:border-[#5B2274]" value={modal.data.adminNote || ''} onChange={e => setModal({...modal, data: {...modal.data, adminNote: e.target.value}})} placeholder="輸入..." />
                                                                            </div>
                                                                            <div className="space-y-2">
                                                                                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest">付款核銷</div>
                                                                                <div className="flex items-center h-[42px] px-2"><ToggleSwitch checked={modal.data.verified} onChange={(c)=>setModal({...modal, data:{...modal.data, verified:c}})} /></div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    
																	{/* [New] 變更訂單按鈕 (放置於刪除按鈕上方，避免被遮擋) */}
                                                                    {!['completed', 'cancelled'].includes(modal.data.status) && (
                                                                        <div className="mb-6 px-2">
                                                                            <button onClick={() => setModal({ type: 'edit_cart', data: JSON.parse(JSON.stringify(modal.data)) })} className="w-full py-4 bg-white border-2 border-dashed border-purple-200 text-[#5B2274] font-[900] rounded-2xl hover:bg-purple-50 hover:border-[#5B2274] transition-all flex items-center justify-center gap-2 shadow-sm">
                                                                                <Icon name="Edit3" size={20}/> 變更訂單內容 (補單/改量)
                                                                            </button>
                                                                        </div>
                                                                    )}
																	
                                                                    {/* 永久刪除按鈕 */}
                                                                    <div className="text-center pt-8 pb-12">
                                                                        <button onClick={() => { if(confirm("確定永久刪除？")) { dbOp('delete', 'orders', modal.data.id); setModal(null); }}} className="text-[10px] font-bold text-slate-300 hover:text-red-500 underline tracking-widest flex items-center justify-center gap-2 mx-auto">
                                                                            <Icon name="Trash2" size={12}/> 永久刪除此訂單
                                                                        </button>
                                                                    </div>
                                                                </div>

                                                                {/* --- 這裡開始是固定在底部的操作區 (Flex 佈局外層) --- */}
                                                                
                                                                {/* 1. 變更訂單按鈕 */}
                                                                {!['completed', 'cancelled'].includes(modal.data.status) && (
                                                                    <div className="px-5 pt-4 pb-2 bg-white border-t border-slate-50 relative z-20">
                                                                        <button onClick={() => setModal({ type: 'edit_cart', data: JSON.parse(JSON.stringify(modal.data)) })} className="w-full py-3 bg-white border-2 border-dashed border-purple-200 text-[#5B2274] font-[900] rounded-2xl hover:bg-purple-50 hover:border-[#5B2274] transition-all flex items-center justify-center gap-2">
                                                                            <Icon name="Edit3" size={18}/> 變更訂單內容 (補單/改量)
                                                                        </button>
                                                                    </div>
                                                                )}

                                                                {/* 2. 狀態操作按鈕 (接單/出餐) */}
                                                                {!['completed', 'cancelled'].includes(modal.data.status) && (
                                                                    <div className="p-5 bg-white pb-10 shadow-[0_-10px_30px_rgba(0,0,0,0.05)] relative z-30">
                                                                        <div className="flex gap-3">
                                                                            {modal.data.status === 'pending' && (
                                                                                <>
                                                                                    <button onClick={() => { if(confirm('拒絕？')) handleUpdateOrderStatus(modal.data.id, 'cancelled'); }} className="flex-1 py-5 bg-slate-50 text-slate-400 font-black rounded-2xl text-sm border border-slate-100 hover:bg-red-50 hover:text-red-400 transition-all active:scale-95">拒絕</button>
                                                                                    <button onClick={() => handleUpdateOrderStatus(modal.data.id, 'confirmed')} className="flex-[2.5] py-5 bg-blue-600 text-white font-[1000] rounded-2xl shadow-xl shadow-blue-100 text-[15px] tracking-[0.1em] hover:bg-blue-700 active:scale-95 transition-all">確認接單</button>
                                                                                </>
                                                                            )}
                                                                            {modal.data.status === 'confirmed' && <button onClick={() => handleUpdateOrderStatus(modal.data.id, 'preparing')} className="w-full py-5 rounded-2xl bg-orange-500 text-white font-[1000] flex items-center justify-center gap-2 text-base shadow-xl shadow-orange-100 hover:bg-orange-600 active:scale-95 transition-all"><Icon name="Flame" size={24}/> 開始製作</button>}
                                                                            {modal.data.status === 'preparing' && <button onClick={() => handleUpdateOrderStatus(modal.data.id, 'ready')} className="w-full py-5 rounded-2xl bg-emerald-500 text-white font-[1000] flex items-center justify-center gap-2 text-base shadow-xl shadow-emerald-100 hover:bg-emerald-600 active:scale-95 transition-all"><Icon name="CheckCircle" size={24}/> 製作完成</button>}
                                                                            {modal.data.status === 'ready' && <button onClick={() => handleUpdateOrderStatus(modal.data.id, 'completed')} className="w-full py-5 rounded-2xl bg-[#5B2274] text-white font-[1000] flex items-center justify-center gap-2 text-base shadow-xl shadow-purple-100 hover:bg-[#4a1b5e] active:scale-95 transition-all"><Icon name="ShoppingBag" size={24}/> 完成取餐</button>}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                            </div>
										)}
									</div>
									<div className="p-5 bg-white border-t border-slate-100 flex gap-3">
										<Button variant="secondary" className="flex-1" onClick={() => setModal(null)}>取消</Button>
										<Button className="flex-[2]" icon="Save" onClick={async () => { 
                                                // 1. 處理特殊類型的儲存
                                                if (modal.type === 'tags') {
                                                    await dbOp('set', 'settings', 'config', settings);
                                                    setModal(null);
                                                    return;
                                                }

                                                if (modal.type === 'group_mgmt') {
                                                    // 群組在編輯時已即時儲存，直接關閉即可
                                                    setModal(null);
                                                    return;
                                                }

                                                // 2. 判斷資料表 (Collection)
                                                const coll = (
                                                    modal.type === 'prod' ? 'products' : 
                                                    modal.type === 'cat' ? 'categories' : 
                                                    modal.type === 'set' ? 'sets' : 
                                                    modal.type === 'coupon' ? 'coupons' : 
                                                    (modal.dataType === 'materials' ? 'materials' : 'addons')
                                                );
                                                
                                                // 3. 自動處理新項目的排序 (Sort Order)
                                                let nextSortOrder = 99;
                                                if (!modal.data.id) {
                                                    if (coll === 'products') {
                                                        const currentList = products.filter(i => i.categoryId === modal.data.categoryId);
                                                        nextSortOrder = currentList.length > 0 ? Math.max(...currentList.map(i => i.sortOrder || 0)) + 1 : 0;
                                                    } else if (coll === 'categories') {
                                                        nextSortOrder = categories.length > 0 ? Math.max(...categories.map(i => i.sortOrder || 0)) + 1 : 0;
                                                    } else if (coll === 'sets') {
                                                        nextSortOrder = sets.length > 0 ? Math.max(...sets.map(i => i.sortOrder || 0)) + 1 : 0;
                                                    } else if (coll === 'materials' || coll === 'addons') {
                                                        const items = coll === 'materials' ? materials : addons;
                                                        const currentList = items.filter(i => i.category === modal.data.category);
                                                        nextSortOrder = currentList.length > 0 ? Math.max(...currentList.map(i => i.sortOrder || 0)) + 1 : 0;
                                                    }
                                                }
                                                
                                                // 4. 資料清洗 (清理暫存或不需要存入資料庫的欄位)
                                                const dataToSave = {...modal.data};
                                                
                                                // 若為套餐，移除 UI 顯示用的 tempFilterCategoryId
                                                if(coll === 'sets' && dataToSave.contents) {
                                                    dataToSave.contents = dataToSave.contents.map(c => {
                                                        const { tempFilterCategoryId, ...rest } = c;
                                                        return rest;
                                                    });
                                                }

                                                // 5. 執行資料庫操作
                                                try {
                                                    if(modal.data.id) {
                                                        await dbOp('update', coll, modal.data.id, dataToSave);
                                                    } else {
                                                        await dbOp('add', coll, null, {...dataToSave, sortOrder: nextSortOrder});
                                                    }
                                                    setModal(null); 
                                                } catch (err) {
                                                    console.error("Save failed:", err);
                                                    alert("儲存失敗，請檢查網路連線或權限。");
                                                }
                                            }}>
                                                儲存變更
                                            </Button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // 渲染根節點
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

